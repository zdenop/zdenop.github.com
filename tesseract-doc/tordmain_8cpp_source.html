<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Tesseract: tesseract-ocr/textord/tordmain.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tesseract
   &#160;<span id="projectnumber">3.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('tordmain_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">tesseract-ocr/textord/tordmain.cpp</div>  </div>
</div>
<div class="contents">
<a href="tordmain_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * File:        tordmain.cpp  (Formerly textordp.c)</span>
<a name="l00003"></a>00003 <span class="comment"> * Description: C++ top level textord code.</span>
<a name="l00004"></a>00004 <span class="comment"> * Author:                  Ray Smith</span>
<a name="l00005"></a>00005 <span class="comment"> * Created:                 Tue Jul 28 17:12:33 BST 1992</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * (C) Copyright 1992, Hewlett-Packard Ltd.</span>
<a name="l00008"></a>00008 <span class="comment"> ** Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00009"></a>00009 <span class="comment"> ** you may not use this file except in compliance with the License.</span>
<a name="l00010"></a>00010 <span class="comment"> ** You may obtain a copy of the License at</span>
<a name="l00011"></a>00011 <span class="comment"> ** http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00012"></a>00012 <span class="comment"> ** Unless required by applicable law or agreed to in writing, software</span>
<a name="l00013"></a>00013 <span class="comment"> ** distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00014"></a>00014 <span class="comment"> ** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00015"></a>00015 <span class="comment"> ** See the License for the specific language governing permissions and</span>
<a name="l00016"></a>00016 <span class="comment"> ** limitations under the License.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> **********************************************************************/</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="mfcpch_8h.html">mfcpch.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#ifdef __UNIX__</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#endif</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="stderr_8h.html">stderr.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="globaloc_8h.html">globaloc.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="blread_8h.html">blread.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="blobbox_8h.html">blobbox.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="ccstruct_8h.html">ccstruct.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="edgblob_8h.html">edgblob.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="drawtord_8h.html">drawtord.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="makerow_8h.html">makerow.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="wordseg_8h.html">wordseg.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="imgs_8h.html">imgs.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="textord_8h.html">textord.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="tordmain_8h.html">tordmain.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="secname_8h.html">secname.h</a>&quot;</span>
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="comment">// Include automatically generated configuration file if running autoconf.</span>
<a name="l00038"></a>00038 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="config__auto_8h.html">config_auto.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#endif</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;allheaders.h&quot;</span>
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="tordmain_8cpp.html#a7a53b092d6bf3daee426c9cae5c85b88">00044</a> <span class="keyword">const</span> <a class="code" href="class_e_r_r_c_o_d_e.html">ERRCODE</a> <a class="code" href="tordmain_8cpp.html#a7a53b092d6bf3daee426c9cae5c85b88">BLOCKLESS_BLOBS</a> = <span class="stringliteral">&quot;Warning:some blobs assigned to no block&quot;</span>;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#undef EXTERN</span>
<a name="l00047"></a><a class="code" href="tordmain_8cpp.html#a77366c1bd428629dc898e188bfd182a3">00047</a> <span class="preprocessor"></span><span class="preprocessor">#define EXTERN</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a><a class="code" href="tordmain_8cpp.html#a30f91f3d689a4e4bc4581c5146395219">00049</a> <span class="preprocessor">#define MAX_NEAREST_DIST  600    //for block skew stats</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="comment">/**********************************************************************</span>
<a name="l00052"></a>00052 <span class="comment"> * SetBlobStrokeWidth</span>
<a name="l00053"></a>00053 <span class="comment"> *</span>
<a name="l00054"></a>00054 <span class="comment"> * Set the horizontal and vertical stroke widths in the blob.</span>
<a name="l00055"></a>00055 <span class="comment"> **********************************************************************/</span>
<a name="l00056"></a><a class="code" href="tordmain_8h.html#a741e546e0ade9bf78395d663731a4b64">00056</a> <span class="keywordtype">void</span> <a class="code" href="tordmain_8cpp.html#a741e546e0ade9bf78395d663731a4b64">SetBlobStrokeWidth</a>(Pix* pix, <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob) {
<a name="l00057"></a>00057   <span class="comment">// Cut the blob rectangle into a Pix.</span>
<a name="l00058"></a>00058   <span class="keywordtype">int</span> pix_height = pixGetHeight(pix);
<a name="l00059"></a>00059   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00060"></a>00060   <span class="keywordtype">int</span> width = box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>();
<a name="l00061"></a>00061   <span class="keywordtype">int</span> height = box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l00062"></a>00062   Box* blob_pix_box = boxCreate(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), pix_height - box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>(),
<a name="l00063"></a>00063                                 width, height);
<a name="l00064"></a>00064   Pix* pix_blob = pixClipRectangle(pix, blob_pix_box, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00065"></a>00065   boxDestroy(&amp;blob_pix_box);
<a name="l00066"></a>00066   Pix* dist_pix = pixDistanceFunction(pix_blob, 4, 8, L_BOUNDARY_BG);
<a name="l00067"></a>00067   pixDestroy(&amp;pix_blob);
<a name="l00068"></a>00068   <span class="comment">// Compute the stroke widths.</span>
<a name="l00069"></a>00069   <a class="code" href="host_8h.html#afc8530b39ebe0b6df1e19159d2508d15">uinT32</a>* data = pixGetData(dist_pix);
<a name="l00070"></a>00070   <span class="keywordtype">int</span> wpl = pixGetWpl(dist_pix);
<a name="l00071"></a>00071   <span class="comment">// Horizontal width of stroke.</span>
<a name="l00072"></a>00072   <a class="code" href="class_s_t_a_t_s.html">STATS</a> h_stats(0, width + 1);
<a name="l00073"></a>00073   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; height; ++y) {
<a name="l00074"></a>00074     <a class="code" href="host_8h.html#afc8530b39ebe0b6df1e19159d2508d15">uinT32</a>* pixels = data + y*wpl;
<a name="l00075"></a>00075     <span class="keywordtype">int</span> prev_pixel = 0;
<a name="l00076"></a>00076     <span class="keywordtype">int</span> pixel = GET_DATA_BYTE(pixels, 0);
<a name="l00077"></a>00077     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 1; x &lt; width; ++x) {
<a name="l00078"></a>00078       <span class="keywordtype">int</span> next_pixel = GET_DATA_BYTE(pixels, x);
<a name="l00079"></a>00079       <span class="comment">// We are looking for a pixel that is equal to its vertical neighbours,</span>
<a name="l00080"></a>00080       <span class="comment">// yet greater than its left neighbour.</span>
<a name="l00081"></a>00081       <span class="keywordflow">if</span> (prev_pixel &lt; pixel &amp;&amp;
<a name="l00082"></a>00082           (y == 0 || pixel == GET_DATA_BYTE(pixels - wpl, x - 1)) &amp;&amp;
<a name="l00083"></a>00083           (y == height - 1 || pixel == GET_DATA_BYTE(pixels + wpl, x - 1))) {
<a name="l00084"></a>00084         <span class="keywordflow">if</span> (pixel &gt; next_pixel) {
<a name="l00085"></a>00085           <span class="comment">// Single local max, so an odd width.</span>
<a name="l00086"></a>00086           h_stats.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a>(pixel * 2 - 1, 1);
<a name="l00087"></a>00087         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel == next_pixel &amp;&amp; x + 1 &lt; width &amp;&amp;
<a name="l00088"></a>00088                  pixel &gt; GET_DATA_BYTE(pixels, x + 1)) {
<a name="l00089"></a>00089           <span class="comment">// Double local max, so an even width.</span>
<a name="l00090"></a>00090           h_stats.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a>(pixel * 2, 1);
<a name="l00091"></a>00091         }
<a name="l00092"></a>00092       }
<a name="l00093"></a>00093       prev_pixel = pixel;
<a name="l00094"></a>00094       pixel = next_pixel;
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096   }
<a name="l00097"></a>00097   <span class="comment">// Vertical width of stroke.</span>
<a name="l00098"></a>00098   <a class="code" href="class_s_t_a_t_s.html">STATS</a> v_stats(0, height + 1);
<a name="l00099"></a>00099   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; width; ++x) {
<a name="l00100"></a>00100     <span class="keywordtype">int</span> prev_pixel = 0;
<a name="l00101"></a>00101     <span class="keywordtype">int</span> pixel = GET_DATA_BYTE(data, x);
<a name="l00102"></a>00102     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 1; y &lt; height; ++y) {
<a name="l00103"></a>00103       <a class="code" href="host_8h.html#afc8530b39ebe0b6df1e19159d2508d15">uinT32</a>* pixels = data + y*wpl;
<a name="l00104"></a>00104       <span class="keywordtype">int</span> next_pixel = GET_DATA_BYTE(pixels, x);
<a name="l00105"></a>00105       <span class="comment">// We are looking for a pixel that is equal to its horizontal neighbours,</span>
<a name="l00106"></a>00106       <span class="comment">// yet greater than its upper neighbour.</span>
<a name="l00107"></a>00107       <span class="keywordflow">if</span> (prev_pixel &lt; pixel &amp;&amp;
<a name="l00108"></a>00108           (x == 0 || pixel == GET_DATA_BYTE(pixels - wpl, x - 1)) &amp;&amp;
<a name="l00109"></a>00109           (x == width - 1 || pixel == GET_DATA_BYTE(pixels - wpl, x + 1))) {
<a name="l00110"></a>00110         <span class="keywordflow">if</span> (pixel &gt; next_pixel) {
<a name="l00111"></a>00111           <span class="comment">// Single local max, so an odd width.</span>
<a name="l00112"></a>00112           v_stats.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a>(pixel * 2 - 1, 1);
<a name="l00113"></a>00113         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel == next_pixel &amp;&amp; y + 1 &lt; height &amp;&amp;
<a name="l00114"></a>00114                  pixel &gt; GET_DATA_BYTE(pixels + wpl, x)) {
<a name="l00115"></a>00115           <span class="comment">// Double local max, so an even width.</span>
<a name="l00116"></a>00116           v_stats.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a>(pixel * 2, 1);
<a name="l00117"></a>00117         }
<a name="l00118"></a>00118       }
<a name="l00119"></a>00119       prev_pixel = pixel;
<a name="l00120"></a>00120       pixel = next_pixel;
<a name="l00121"></a>00121     }
<a name="l00122"></a>00122   }
<a name="l00123"></a>00123   pixDestroy(&amp;dist_pix);
<a name="l00124"></a>00124   <span class="comment">// Store the horizontal and vertical width in the blob, keeping both</span>
<a name="l00125"></a>00125   <span class="comment">// widths if there is enough information, otherwse only the one with</span>
<a name="l00126"></a>00126   <span class="comment">// the most samples.</span>
<a name="l00127"></a>00127   <span class="comment">// If there are insufficent samples, store zero, rather than using</span>
<a name="l00128"></a>00128   <span class="comment">// 2*area/perimeter, as the numbers that gives do not match the numbers</span>
<a name="l00129"></a>00129   <span class="comment">// from the distance method.</span>
<a name="l00130"></a>00130   <span class="keywordflow">if</span> (h_stats.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a>() &gt;= (width + height) / 4) {
<a name="l00131"></a>00131     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ab8e3703ad9c72b61dedafb61c4b32358">set_horz_stroke_width</a>(h_stats.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a>(0.5f));
<a name="l00132"></a>00132     <span class="keywordflow">if</span> (v_stats.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a>() &gt;= (width + height) / 4)
<a name="l00133"></a>00133       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aeb808226b8dd08e875eb3cf38a61a6d5">set_vert_stroke_width</a>(v_stats.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a>(0.5f));
<a name="l00134"></a>00134     <span class="keywordflow">else</span>
<a name="l00135"></a>00135       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aeb808226b8dd08e875eb3cf38a61a6d5">set_vert_stroke_width</a>(0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>);
<a name="l00136"></a>00136   } <span class="keywordflow">else</span> {
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (v_stats.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a>() &gt;= (width + height) / 4 ||
<a name="l00138"></a>00138         v_stats.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a>() &gt; h_stats.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a>()) {
<a name="l00139"></a>00139       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ab8e3703ad9c72b61dedafb61c4b32358">set_horz_stroke_width</a>(0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>);
<a name="l00140"></a>00140       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aeb808226b8dd08e875eb3cf38a61a6d5">set_vert_stroke_width</a>(v_stats.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a>(0.5f));
<a name="l00141"></a>00141     } <span class="keywordflow">else</span> {
<a name="l00142"></a>00142       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ab8e3703ad9c72b61dedafb61c4b32358">set_horz_stroke_width</a>(h_stats.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a>() &gt; 2 ? h_stats.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a>(0.5<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>)
<a name="l00143"></a>00143                                                           : 0.0f);
<a name="l00144"></a>00144       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aeb808226b8dd08e875eb3cf38a61a6d5">set_vert_stroke_width</a>(0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>);
<a name="l00145"></a>00145     }
<a name="l00146"></a>00146   }
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="comment">/**********************************************************************</span>
<a name="l00151"></a>00151 <span class="comment"> * assign_blobs_to_blocks2</span>
<a name="l00152"></a>00152 <span class="comment"> *</span>
<a name="l00153"></a>00153 <span class="comment"> * Make a list of TO_BLOCKs for portrait and landscape orientation.</span>
<a name="l00154"></a>00154 <span class="comment"> **********************************************************************/</span>
<a name="l00155"></a>00155 
<a name="l00156"></a><a class="code" href="tordmain_8h.html#a24f7c51950d2ac0dd9968df80de0a577">00156</a> <span class="keywordtype">void</span> <a class="code" href="tordmain_8cpp.html#a24f7c51950d2ac0dd9968df80de0a577">assign_blobs_to_blocks2</a>(Pix* pix,
<a name="l00157"></a>00157                              BLOCK_LIST *blocks,          <span class="comment">// blocks to process</span>
<a name="l00158"></a>00158                              TO_BLOCK_LIST *port_blocks) {  <span class="comment">// output list</span>
<a name="l00159"></a>00159   <a class="code" href="class_b_l_o_c_k.html">BLOCK</a> *block;                  <span class="comment">// current block</span>
<a name="l00160"></a>00160   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a> *newblob;             <span class="comment">// created blob</span>
<a name="l00161"></a>00161   <a class="code" href="class_c___b_l_o_b.html">C_BLOB</a> *blob;                  <span class="comment">// current blob</span>
<a name="l00162"></a>00162   BLOCK_IT block_it = blocks;
<a name="l00163"></a>00163   C_BLOB_IT blob_it;             <span class="comment">// iterator</span>
<a name="l00164"></a>00164   BLOBNBOX_IT port_box_it;       <span class="comment">// iterator</span>
<a name="l00165"></a>00165                                  <span class="comment">// destination iterator</span>
<a name="l00166"></a>00166   TO_BLOCK_IT port_block_it = port_blocks;
<a name="l00167"></a>00167   <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a> *port_block;          <span class="comment">// created block</span>
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="keywordflow">for</span> (block_it.mark_cycle_pt(); !block_it.cycled_list(); block_it.forward()) {
<a name="l00170"></a>00170     block = block_it.data();
<a name="l00171"></a>00171     port_block = <span class="keyword">new</span> <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>(block);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="comment">// Convert the good outlines to block-&gt;blob_list</span>
<a name="l00174"></a>00174     port_box_it.set_to_list(&amp;port_block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l00175"></a>00175     blob_it.set_to_list(block-&gt;<a class="code" href="class_b_l_o_c_k.html#a23196fe0d7230572b44aa77031a1d72a" title="get blobs">blob_list</a>());
<a name="l00176"></a>00176     <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00177"></a>00177       blob = blob_it.extract();
<a name="l00178"></a>00178       newblob = <span class="keyword">new</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>(blob);  <span class="comment">// Convert blob to BLOBNBOX.</span>
<a name="l00179"></a>00179       <a class="code" href="tordmain_8cpp.html#a741e546e0ade9bf78395d663731a4b64">SetBlobStrokeWidth</a>(pix, newblob);
<a name="l00180"></a>00180       port_box_it.add_after_then_move(newblob);
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="comment">// Put the rejected outlines in block-&gt;noise_blobs, which allows them to</span>
<a name="l00184"></a>00184     <span class="comment">// be reconsidered and sorted back into rows and recover outlines mistakenly</span>
<a name="l00185"></a>00185     <span class="comment">// rejected.</span>
<a name="l00186"></a>00186     port_box_it.set_to_list(&amp;port_block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l00187"></a>00187     blob_it.set_to_list(block-&gt;<a class="code" href="class_b_l_o_c_k.html#a08f23fffc748fbb0e7ae8804b7c0c90e">reject_blobs</a>());
<a name="l00188"></a>00188     <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00189"></a>00189       blob = blob_it.extract();
<a name="l00190"></a>00190       newblob = <span class="keyword">new</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>(blob);  <span class="comment">// Convert blob to BLOBNBOX.</span>
<a name="l00191"></a>00191       <a class="code" href="tordmain_8cpp.html#a741e546e0ade9bf78395d663731a4b64">SetBlobStrokeWidth</a>(pix, newblob);
<a name="l00192"></a>00192       port_box_it.add_after_then_move(newblob);
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     port_block_it.add_after_then_move(port_block);
<a name="l00196"></a>00196   }
<a name="l00197"></a>00197 }
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="keyword">namespace </span>tesseract {
<a name="l00200"></a>00200 <span class="comment">/**********************************************************************</span>
<a name="l00201"></a>00201 <span class="comment"> * find_components</span>
<a name="l00202"></a>00202 <span class="comment"> *</span>
<a name="l00203"></a>00203 <span class="comment"> * Find the C_OUTLINEs of the connected components in each block, put them</span>
<a name="l00204"></a>00204 <span class="comment"> * in C_BLOBs, and filter them by size, putting the different size</span>
<a name="l00205"></a>00205 <span class="comment"> * grades on different lists in the matching TO_BLOCK in to_blocks.</span>
<a name="l00206"></a>00206 <span class="comment"> **********************************************************************/</span>
<a name="l00207"></a>00207 
<a name="l00208"></a><a class="code" href="classtesseract_1_1_textord.html#ab478029b49bf4efadd59a547565327a7">00208</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_textord.html#ab478029b49bf4efadd59a547565327a7">Textord::find_components</a>(Pix* pix, BLOCK_LIST *blocks,
<a name="l00209"></a>00209                               TO_BLOCK_LIST *to_blocks) {
<a name="l00210"></a>00210   <span class="keywordtype">int</span> width = pixGetWidth(pix);
<a name="l00211"></a>00211   <span class="keywordtype">int</span> height = pixGetHeight(pix);
<a name="l00212"></a>00212   <span class="keywordflow">if</span> (width &gt; <a class="code" href="host_8h.html#a3905e54374e49708219791e7d59c60fb">MAX_INT16</a> || height &gt; <a class="code" href="host_8h.html#a3905e54374e49708219791e7d59c60fb">MAX_INT16</a>) {
<a name="l00213"></a>00213     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Input image too large! (%d, %d)\n&quot;</span>, width, height);
<a name="l00214"></a>00214     <span class="keywordflow">return</span>;  <span class="comment">// Can&#39;t handle it.</span>
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217   <a class="code" href="errcode_8h.html#ae281080023125653d85cd946e95f626c">set_global_loc_code</a>(<a class="code" href="errcode_8h.html#a6cf3e2234e6e986629417e519a3e75e5">LOC_EDGE_PROG</a>);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219   BLOCK_IT block_it(blocks);    <span class="comment">// iterator</span>
<a name="l00220"></a>00220   <span class="keywordflow">for</span> (block_it.mark_cycle_pt(); !block_it.cycled_list();
<a name="l00221"></a>00221        block_it.forward()) {
<a name="l00222"></a>00222     <a class="code" href="class_b_l_o_c_k.html">BLOCK</a>* block = block_it.data();
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (block-&gt;<a class="code" href="class_p_d_b_l_k.html#a6670779c69aca2d574e4a0590d9b3939">poly_block</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || block-&gt;<a class="code" href="class_p_d_b_l_k.html#a6670779c69aca2d574e4a0590d9b3939">poly_block</a>()-&gt;<a class="code" href="class_p_o_l_y___b_l_o_c_k.html#abd32dee532afe634cdbacffc0b53e660">IsText</a>()) {
<a name="l00224"></a>00224       <a class="code" href="edgblob_8cpp.html#a16ca13da58e65267e7e34355091ca891">extract_edges</a>(pix, block);
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226   }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <a class="code" href="tordmain_8cpp.html#a24f7c51950d2ac0dd9968df80de0a577">assign_blobs_to_blocks2</a>(pix, blocks, to_blocks);
<a name="l00229"></a>00229   <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> page_tr(width, height);
<a name="l00230"></a>00230   <a class="code" href="classtesseract_1_1_textord.html#acaed60ac5b5ef00751e3d307347aa0e9">filter_blobs</a>(page_tr, to_blocks, !<a class="code" href="makerow_8cpp.html#a58237d13dfff6d1379f501ba5e14bc9b">textord_test_landscape</a>);
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="comment">/**********************************************************************</span>
<a name="l00234"></a>00234 <span class="comment"> * filter_blobs</span>
<a name="l00235"></a>00235 <span class="comment"> *</span>
<a name="l00236"></a>00236 <span class="comment"> * Sort the blobs into sizes in all the blocks for later work.</span>
<a name="l00237"></a>00237 <span class="comment"> **********************************************************************/</span>
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="classtesseract_1_1_textord.html#acaed60ac5b5ef00751e3d307347aa0e9">00239</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_textord.html#acaed60ac5b5ef00751e3d307347aa0e9">Textord::filter_blobs</a>(<a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> page_tr,         <span class="comment">// top right</span>
<a name="l00240"></a>00240                            TO_BLOCK_LIST *blocks,  <span class="comment">// output list</span>
<a name="l00241"></a>00241                            <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> testing_on) {     <span class="comment">// for plotting</span>
<a name="l00242"></a>00242   TO_BLOCK_IT block_it = blocks;          <span class="comment">// destination iterator</span>
<a name="l00243"></a>00243   <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a> *block;                        <span class="comment">// created block</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="preprocessor">  #ifndef GRAPHICS_DISABLED</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a> != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00247"></a>00247     <a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>-&gt;<a class="code" href="class_scroll_view.html#a5386b0da16d7cbdd33044e53b95313ac">Clear</a>();
<a name="l00248"></a>00248 <span class="preprocessor">  #endif  // GRAPHICS_DISABLED</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>
<a name="l00250"></a>00250   <span class="keywordflow">for</span> (block_it.mark_cycle_pt(); !block_it.cycled_list();
<a name="l00251"></a>00251        block_it.forward()) {
<a name="l00252"></a>00252     block = block_it.data();
<a name="l00253"></a>00253     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a> = filter_noise_blobs(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>,
<a name="l00254"></a>00254       &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>,
<a name="l00255"></a>00255       &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ad16b1c18225b44c50674ca46841b0f5f">small_blobs</a>,
<a name="l00256"></a>00256       &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aafe2a9baa69300ee71da42e6dc18cfee">large_blobs</a>);
<a name="l00257"></a>00257     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ac17b9c95641b2eebee9d972338c2e5f6">line_spacing</a> = block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a> *
<a name="l00258"></a>00258         (<a class="code" href="classtesseract_1_1_c_c_struct.html#a7e8a361df0831d295edf1c150c3ca3a3">tesseract::CCStruct::kDescenderFraction</a> +
<a name="l00259"></a>00259          <a class="code" href="classtesseract_1_1_c_c_struct.html#a737fdb37b9401ad3d04371c1bd4a0b17">tesseract::CCStruct::kXHeightFraction</a> +
<a name="l00260"></a>00260          2 * <a class="code" href="classtesseract_1_1_c_c_struct.html#a9d71fddad74d9418e106713cd643b919">tesseract::CCStruct::kAscenderFraction</a>) /
<a name="l00261"></a>00261          <a class="code" href="classtesseract_1_1_c_c_struct.html#a737fdb37b9401ad3d04371c1bd4a0b17">tesseract::CCStruct::kXHeightFraction</a>;
<a name="l00262"></a>00262     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a> *= <a class="code" href="makerow_8cpp.html#acb7874c297cd608146eacd6782da2536">textord_min_linesize</a>;
<a name="l00263"></a>00263     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#abda136ff240577928343ca37453aca7a">max_blob_size</a> = block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a> * <a class="code" href="makerow_8cpp.html#a9dcb3e14fc8bb00dcde4f03e25f3ac5b">textord_excess_blobsize</a>;
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="preprocessor">    #ifndef GRAPHICS_DISABLED</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#ac2af687f671ac3518f1daef79a053d59">textord_show_blobs</a> &amp;&amp; testing_on) {
<a name="l00267"></a>00267       <span class="keywordflow">if</span> (<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a> == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00268"></a>00268         <a class="code" href="drawtord_8cpp.html#a5e0654ca01b55c243387c6535b32860b">create_to_win</a>(page_tr);
<a name="l00269"></a>00269       block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#afd0504ca5c8fa605fbea3dbca2d8ee2e">plot_graded_blobs</a>(<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>);
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#a8532e581b3c4777fbe8e69e9b6f00062">textord_show_boxes</a> &amp;&amp; testing_on) {
<a name="l00272"></a>00272       <span class="keywordflow">if</span> (<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a> == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00273"></a>00273         <a class="code" href="drawtord_8cpp.html#a5e0654ca01b55c243387c6535b32860b">create_to_win</a>(page_tr);
<a name="l00274"></a>00274       <a class="code" href="drawtord_8cpp.html#a5408725b0921a22271363f8c1adc293e">plot_box_list</a>(<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>, &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>, <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a0eab2b208fc9a5e2774f92cf3e768982">ScrollView::WHITE</a>);
<a name="l00275"></a>00275       <a class="code" href="drawtord_8cpp.html#a5408725b0921a22271363f8c1adc293e">plot_box_list</a>(<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>, &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ad16b1c18225b44c50674ca46841b0f5f">small_blobs</a>, <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a0eab2b208fc9a5e2774f92cf3e768982">ScrollView::WHITE</a>);
<a name="l00276"></a>00276       <a class="code" href="drawtord_8cpp.html#a5408725b0921a22271363f8c1adc293e">plot_box_list</a>(<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>, &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aafe2a9baa69300ee71da42e6dc18cfee">large_blobs</a>, <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a0eab2b208fc9a5e2774f92cf3e768982">ScrollView::WHITE</a>);
<a name="l00277"></a>00277       <a class="code" href="drawtord_8cpp.html#a5408725b0921a22271363f8c1adc293e">plot_box_list</a>(<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>, &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>, <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a0eab2b208fc9a5e2774f92cf3e768982">ScrollView::WHITE</a>);
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279 <span class="preprocessor">    #endif  // GRAPHICS_DISABLED</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>  }
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 <span class="comment">/**********************************************************************</span>
<a name="l00284"></a>00284 <span class="comment"> * filter_noise_blobs</span>
<a name="l00285"></a>00285 <span class="comment"> *</span>
<a name="l00286"></a>00286 <span class="comment"> * Move small blobs to a separate list.</span>
<a name="l00287"></a>00287 <span class="comment"> **********************************************************************/</span>
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="keywordtype">float</span> Textord::filter_noise_blobs(
<a name="l00290"></a>00290     BLOBNBOX_LIST *src_list,      <span class="comment">// original list</span>
<a name="l00291"></a>00291     BLOBNBOX_LIST *noise_list,    <span class="comment">// noise list</span>
<a name="l00292"></a>00292     BLOBNBOX_LIST *small_list,    <span class="comment">// small blobs</span>
<a name="l00293"></a>00293     BLOBNBOX_LIST *large_list) {  <span class="comment">// large blobs</span>
<a name="l00294"></a>00294   <a class="code" href="host_8h.html#a8d41499d38c24d39b221ab0c158fe5a8">inT16</a> height;                  <span class="comment">//height of blob</span>
<a name="l00295"></a>00295   <a class="code" href="host_8h.html#a8d41499d38c24d39b221ab0c158fe5a8">inT16</a> width;                   <span class="comment">//of blob</span>
<a name="l00296"></a>00296   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a> *blob;                <span class="comment">//current blob</span>
<a name="l00297"></a>00297   <span class="keywordtype">float</span> initial_x;               <span class="comment">//first guess</span>
<a name="l00298"></a>00298   BLOBNBOX_IT src_it = src_list; <span class="comment">//iterators</span>
<a name="l00299"></a>00299   BLOBNBOX_IT noise_it = noise_list;
<a name="l00300"></a>00300   BLOBNBOX_IT small_it = small_list;
<a name="l00301"></a>00301   BLOBNBOX_IT large_it = large_list;
<a name="l00302"></a>00302   <a class="code" href="class_s_t_a_t_s.html">STATS</a> size_stats (0, <a class="code" href="tordmain_8cpp.html#a30f91f3d689a4e4bc4581c5146395219">MAX_NEAREST_DIST</a>);
<a name="l00303"></a>00303   <span class="comment">//blob heights</span>
<a name="l00304"></a>00304   <span class="keywordtype">float</span> min_y;                   <span class="comment">//size limits</span>
<a name="l00305"></a>00305   <span class="keywordtype">float</span> max_y;
<a name="l00306"></a>00306   <span class="keywordtype">float</span> max_x;
<a name="l00307"></a>00307   <span class="keywordtype">float</span> max_height;              <span class="comment">//of good blobs</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309   <span class="keywordflow">for</span> (src_it.mark_cycle_pt (); !src_it.cycled_list (); src_it.forward ()) {
<a name="l00310"></a>00310     blob = src_it.data ();
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &lt; <a class="code" href="classtesseract_1_1_textord.html#aefa72647ee61b8514c1aaa5eaed098fb">textord_max_noise_size</a>)
<a name="l00312"></a>00312       noise_it.add_after_then_move (src_it.extract ());
<a name="l00313"></a>00313     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ae89d284497727130cbb4e072c26c8990">enclosed_area</a> () &gt;= blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ()
<a name="l00314"></a>00314       * blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () * <a class="code" href="classtesseract_1_1_textord.html#abc7b58272999c83a7a53fd1413038ba1">textord_noise_area_ratio</a>)
<a name="l00315"></a>00315       small_it.add_after_then_move (src_it.extract ());
<a name="l00316"></a>00316   }
<a name="l00317"></a>00317   <span class="keywordflow">for</span> (src_it.mark_cycle_pt (); !src_it.cycled_list (); src_it.forward ()) {
<a name="l00318"></a>00318     size_stats.add (src_it.data ()-&gt;bounding_box ().height (), 1);
<a name="l00319"></a>00319   }
<a name="l00320"></a>00320   initial_x = size_stats.ile (<a class="code" href="classtesseract_1_1_textord.html#ad2e50b3af05ac549c90aa14017dfd322">textord_initialx_ile</a>);
<a name="l00321"></a>00321   max_y = ceil(initial_x *
<a name="l00322"></a>00322                (<a class="code" href="classtesseract_1_1_c_c_struct.html#a7e8a361df0831d295edf1c150c3ca3a3">tesseract::CCStruct::kDescenderFraction</a> +
<a name="l00323"></a>00323                 <a class="code" href="classtesseract_1_1_c_c_struct.html#a737fdb37b9401ad3d04371c1bd4a0b17">tesseract::CCStruct::kXHeightFraction</a> +
<a name="l00324"></a>00324                 2 * <a class="code" href="classtesseract_1_1_c_c_struct.html#a9d71fddad74d9418e106713cd643b919">tesseract::CCStruct::kAscenderFraction</a>) /
<a name="l00325"></a>00325                <a class="code" href="classtesseract_1_1_c_c_struct.html#a737fdb37b9401ad3d04371c1bd4a0b17">tesseract::CCStruct::kXHeightFraction</a>);
<a name="l00326"></a>00326   min_y = floor (initial_x / 2);
<a name="l00327"></a>00327   max_x = ceil (initial_x * <a class="code" href="makerow_8cpp.html#aadab669cb0e97eb0aa1b93215c45828b">textord_width_limit</a>);
<a name="l00328"></a>00328   small_it.move_to_first ();
<a name="l00329"></a>00329   <span class="keywordflow">for</span> (small_it.mark_cycle_pt (); !small_it.cycled_list ();
<a name="l00330"></a>00330   small_it.forward ()) {
<a name="l00331"></a>00331     height = small_it.data()-&gt;bounding_box().height();
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (height &gt; max_y)
<a name="l00333"></a>00333       large_it.add_after_then_move(small_it.extract ());
<a name="l00334"></a>00334     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (height &gt;= min_y)
<a name="l00335"></a>00335       src_it.add_after_then_move(small_it.extract ());
<a name="l00336"></a>00336   }
<a name="l00337"></a>00337   size_stats.clear ();
<a name="l00338"></a>00338   <span class="keywordflow">for</span> (src_it.mark_cycle_pt (); !src_it.cycled_list (); src_it.forward ()) {
<a name="l00339"></a>00339     height = src_it.data ()-&gt;bounding_box ().height ();
<a name="l00340"></a>00340     width = src_it.data ()-&gt;bounding_box ().width ();
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (height &lt; min_y)
<a name="l00342"></a>00342       small_it.add_after_then_move (src_it.extract ());
<a name="l00343"></a>00343     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (height &gt; max_y || width &gt; max_x)
<a name="l00344"></a>00344       large_it.add_after_then_move (src_it.extract ());
<a name="l00345"></a>00345     <span class="keywordflow">else</span>
<a name="l00346"></a>00346       size_stats.add (height, 1);
<a name="l00347"></a>00347   }
<a name="l00348"></a>00348   max_height = size_stats.ile (<a class="code" href="classtesseract_1_1_textord.html#a925972489d85bb3cc3ad2731dc8e8cbb">textord_initialasc_ile</a>);
<a name="l00349"></a>00349   <span class="comment">//      printf(&quot;max_y=%g, min_y=%g, initial_x=%g, max_height=%g,&quot;,</span>
<a name="l00350"></a>00350   <span class="comment">//              max_y,min_y,initial_x,max_height);</span>
<a name="l00351"></a>00351   max_height *= <a class="code" href="classtesseract_1_1_c_c_struct.html#a594719f667105487f0c3f78de6f85f77">tesseract::CCStruct::kXHeightCapRatio</a>;
<a name="l00352"></a>00352   <span class="keywordflow">if</span> (max_height &gt; initial_x)
<a name="l00353"></a>00353     initial_x = max_height;
<a name="l00354"></a>00354   <span class="comment">//      printf(&quot; ret=%g\n&quot;,initial_x);</span>
<a name="l00355"></a>00355   <span class="keywordflow">return</span> initial_x;
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="comment">/**********************************************************************</span>
<a name="l00359"></a>00359 <span class="comment"> * cleanup_blocks</span>
<a name="l00360"></a>00360 <span class="comment"> *</span>
<a name="l00361"></a>00361 <span class="comment"> * Delete empty blocks, rows from the page.</span>
<a name="l00362"></a>00362 <span class="comment"> **********************************************************************/</span>
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="keywordtype">void</span> Textord::cleanup_blocks(                    <span class="comment">//remove empties</span>
<a name="l00365"></a>00365                              BLOCK_LIST *blocks  <span class="comment">//list</span>
<a name="l00366"></a>00366                             ) {
<a name="l00367"></a>00367   BLOCK_IT block_it = blocks;    <span class="comment">//iterator</span>
<a name="l00368"></a>00368   ROW_IT row_it;                 <span class="comment">//row iterator</span>
<a name="l00369"></a>00369 
<a name="l00370"></a>00370   <span class="keywordtype">int</span> num_rows = 0;
<a name="l00371"></a>00371   <span class="keywordtype">int</span> num_rows_all = 0;
<a name="l00372"></a>00372   <span class="keywordtype">int</span> num_blocks = 0;
<a name="l00373"></a>00373   <span class="keywordtype">int</span> num_blocks_all = 0;
<a name="l00374"></a>00374   <span class="keywordflow">for</span> (block_it.mark_cycle_pt (); !block_it.cycled_list ();
<a name="l00375"></a>00375        block_it.forward ()) {
<a name="l00376"></a>00376     num_rows = 0;
<a name="l00377"></a>00377     num_rows_all = 0;
<a name="l00378"></a>00378     row_it.set_to_list (block_it.data ()-&gt;row_list ());
<a name="l00379"></a>00379     <span class="keywordflow">for</span> (row_it.mark_cycle_pt (); !row_it.cycled_list (); row_it.forward ()) {
<a name="l00380"></a>00380       ++num_rows_all;
<a name="l00381"></a>00381       clean_small_noise_from_words(row_it.data());
<a name="l00382"></a>00382       <span class="keywordflow">if</span> ((<a class="code" href="classtesseract_1_1_textord.html#a5cd218dea2d83dd9024d0c90494574b0">textord_noise_rejrows</a>
<a name="l00383"></a>00383            &amp;&amp; !row_it.data ()-&gt;word_list ()-&gt;empty ()
<a name="l00384"></a>00384            &amp;&amp; clean_noise_from_row (row_it.data ()))
<a name="l00385"></a>00385           || row_it.data ()-&gt;word_list ()-&gt;empty ())
<a name="l00386"></a>00386         <span class="keyword">delete</span> row_it.extract ();<span class="comment">//lose empty row</span>
<a name="l00387"></a>00387       <span class="keywordflow">else</span> {
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#aecc071304af26ca648cbe745d3c9b247">textord_noise_rejwords</a>)
<a name="l00389"></a>00389           clean_noise_from_words (row_it.data ());
<a name="l00390"></a>00390         <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#aab4348a0c1b664744dd51ea9f2f88429">textord_blshift_maxshift</a> &gt;= 0)
<a name="l00391"></a>00391           <a class="code" href="tordmain_8cpp.html#a76e9891e741722335a7a19c561f5580f">tweak_row_baseline</a>(row_it.data(),
<a name="l00392"></a>00392                              <a class="code" href="classtesseract_1_1_textord.html#aab4348a0c1b664744dd51ea9f2f88429">textord_blshift_maxshift</a>,
<a name="l00393"></a>00393                              <a class="code" href="classtesseract_1_1_textord.html#ac24cbce43d478165e8ea18fd4a7f8557">textord_blshift_xfraction</a>);
<a name="l00394"></a>00394         ++num_rows;
<a name="l00395"></a>00395       }
<a name="l00396"></a>00396     }
<a name="l00397"></a>00397     <span class="keywordflow">if</span> (block_it.data()-&gt;row_list()-&gt;empty() &amp;&amp;
<a name="l00398"></a>00398         (block_it.data()-&gt;poly_block() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l00399"></a>00399          block_it.data()-&gt;poly_block()-&gt;IsText())) {
<a name="l00400"></a>00400       <span class="keyword">delete</span> block_it.extract();  <span class="comment">// Lose empty text blocks but not other types.</span>
<a name="l00401"></a>00401     } <span class="keywordflow">else</span> {
<a name="l00402"></a>00402       ++num_blocks;
<a name="l00403"></a>00403     }
<a name="l00404"></a>00404     ++num_blocks_all;
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#aa06ff5844f7415b3e097f35bd6ae7233">textord_noise_debug</a>)
<a name="l00406"></a>00406       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;cleanup_blocks: # rows = %d / %d\n&quot;</span>, num_rows, num_rows_all);
<a name="l00407"></a>00407   }
<a name="l00408"></a>00408   <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#aa06ff5844f7415b3e097f35bd6ae7233">textord_noise_debug</a>)
<a name="l00409"></a>00409     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;cleanup_blocks: # blocks = %d / %d\n&quot;</span>, num_blocks, num_blocks_all);
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="comment">/**********************************************************************</span>
<a name="l00414"></a>00414 <span class="comment"> * clean_noise_from_row</span>
<a name="l00415"></a>00415 <span class="comment"> *</span>
<a name="l00416"></a>00416 <span class="comment"> * Move blobs of words from rows of garbage into the reject blobs list.</span>
<a name="l00417"></a>00417 <span class="comment"> **********************************************************************/</span>
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> Textord::clean_noise_from_row(          <span class="comment">//remove empties</span>
<a name="l00420"></a>00420                                     <a class="code" href="class_r_o_w.html">ROW</a> *row  <span class="comment">//row to clean</span>
<a name="l00421"></a>00421                                    ) {
<a name="l00422"></a>00422   <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> testing_on;
<a name="l00423"></a>00423   <a class="code" href="class_t_b_o_x.html">TBOX</a> blob_box;                  <span class="comment">//bounding box</span>
<a name="l00424"></a>00424   <a class="code" href="class_c___b_l_o_b.html">C_BLOB</a> *blob;                  <span class="comment">//current blob</span>
<a name="l00425"></a>00425   <a class="code" href="class_c___o_u_t_l_i_n_e.html">C_OUTLINE</a> *outline;            <span class="comment">//current outline</span>
<a name="l00426"></a>00426   <a class="code" href="class_w_e_r_d.html">WERD</a> *word;                    <span class="comment">//current word</span>
<a name="l00427"></a>00427   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> blob_size;               <span class="comment">//biggest size</span>
<a name="l00428"></a>00428   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> trans_count = 0;         <span class="comment">//no of transitions</span>
<a name="l00429"></a>00429   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> trans_threshold;         <span class="comment">//noise tolerance</span>
<a name="l00430"></a>00430   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> dot_count;               <span class="comment">//small objects</span>
<a name="l00431"></a>00431   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> norm_count;              <span class="comment">//normal objects</span>
<a name="l00432"></a>00432   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> super_norm_count;        <span class="comment">//real char-like</span>
<a name="l00433"></a>00433                                  <span class="comment">//words of row</span>
<a name="l00434"></a>00434   WERD_IT word_it = row-&gt;<a class="code" href="class_r_o_w.html#ac9d07f978420b3564bf5508ad294fb70">word_list</a> ();
<a name="l00435"></a>00435   C_BLOB_IT blob_it;             <span class="comment">//blob iterator</span>
<a name="l00436"></a>00436   C_OUTLINE_IT out_it;           <span class="comment">//outline iterator</span>
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   <span class="keywordflow">if</span> (<a class="code" href="makerow_8cpp.html#ac7548cdecc88963c89ab9d235a6c6531">textord_test_y</a> &gt; row-&gt;<a class="code" href="class_r_o_w.html#a097b3543fa3ca5768eb50033d4c4db9c">base_line</a> (<a class="code" href="makerow_8cpp.html#a23b8c104a388b836300c6aaf9592c66f">textord_test_x</a>)
<a name="l00439"></a>00439     &amp;&amp; <a class="code" href="classtesseract_1_1_textord.html#ac2af687f671ac3518f1daef79a053d59">textord_show_blobs</a>
<a name="l00440"></a>00440     &amp;&amp; <a class="code" href="makerow_8cpp.html#ac7548cdecc88963c89ab9d235a6c6531">textord_test_y</a> &lt; row-&gt;<a class="code" href="class_r_o_w.html#a097b3543fa3ca5768eb50033d4c4db9c">base_line</a> (<a class="code" href="makerow_8cpp.html#a23b8c104a388b836300c6aaf9592c66f">textord_test_x</a>) + row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ())
<a name="l00441"></a>00441     testing_on = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00442"></a>00442   <span class="keywordflow">else</span>
<a name="l00443"></a>00443     testing_on = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00444"></a>00444   dot_count = 0;
<a name="l00445"></a>00445   norm_count = 0;
<a name="l00446"></a>00446   super_norm_count = 0;
<a name="l00447"></a>00447   <span class="keywordflow">for</span> (word_it.mark_cycle_pt (); !word_it.cycled_list (); word_it.forward ()) {
<a name="l00448"></a>00448     word = word_it.data ();      <span class="comment">//current word</span>
<a name="l00449"></a>00449                                  <span class="comment">//blobs in word</span>
<a name="l00450"></a>00450     blob_it.set_to_list (word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a> ());
<a name="l00451"></a>00451     <span class="keywordflow">for</span> (blob_it.mark_cycle_pt (); !blob_it.cycled_list ();
<a name="l00452"></a>00452     blob_it.forward ()) {
<a name="l00453"></a>00453       blob = blob_it.data ();
<a name="l00454"></a>00454       <span class="keywordflow">if</span> (!word-&gt;<a class="code" href="class_w_e_r_d.html#a81edde8597a3d9fd8a664d703d332c41">flag</a> (<a class="code" href="werd_8h.html#ad6968adbf8f2cc44adf333ec96efb0beac5f734536428e7e43dffe5c87d72d14e">W_DONT_CHOP</a>)) {
<a name="l00455"></a>00455                                  <span class="comment">//get outlines</span>
<a name="l00456"></a>00456         out_it.set_to_list (blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a> ());
<a name="l00457"></a>00457         <span class="keywordflow">for</span> (out_it.mark_cycle_pt (); !out_it.cycled_list ();
<a name="l00458"></a>00458         out_it.forward ()) {
<a name="l00459"></a>00459           outline = out_it.data ();
<a name="l00460"></a>00460           blob_box = outline-&gt;<a class="code" href="class_c___o_u_t_l_i_n_e.html#a6481db8e9c00281f20f45df48d499679">bounding_box</a> ();
<a name="l00461"></a>00461           blob_size =
<a name="l00462"></a>00462             blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &gt;
<a name="l00463"></a>00463             blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ()? blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () : blob_box.
<a name="l00464"></a>00464             height();
<a name="l00465"></a>00465           <span class="keywordflow">if</span> (blob_size &lt; textord_noise_sizelimit * row-&gt;x_height ())
<a name="l00466"></a>00466             dot_count++;         <span class="comment">//count smal outlines</span>
<a name="l00467"></a>00467           <span class="keywordflow">if</span> (!outline-&gt;<a class="code" href="class_c___o_u_t_l_i_n_e.html#a87880b33bc69fa17ab37a93706ae8d84">child</a> ()-&gt;empty ()
<a name="l00468"></a>00468             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &lt;
<a name="l00469"></a>00469             (1 + <a class="code" href="classtesseract_1_1_textord.html#a871f2c835f67cc0d5fee91ea8d292559">textord_noise_syfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00470"></a>00470             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &gt;
<a name="l00471"></a>00471             (1 - <a class="code" href="classtesseract_1_1_textord.html#a871f2c835f67cc0d5fee91ea8d292559">textord_noise_syfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00472"></a>00472             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &lt;
<a name="l00473"></a>00473             (1 + <a class="code" href="classtesseract_1_1_textord.html#a7b816661fcfb50ad445cbe066de36240">textord_noise_sxfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00474"></a>00474             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &gt;
<a name="l00475"></a>00475             (1 - <a class="code" href="classtesseract_1_1_textord.html#a7b816661fcfb50ad445cbe066de36240">textord_noise_sxfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ())
<a name="l00476"></a>00476             super_norm_count++;  <span class="comment">//count smal outlines</span>
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478       }
<a name="l00479"></a>00479       <span class="keywordflow">else</span>
<a name="l00480"></a>00480         super_norm_count++;
<a name="l00481"></a>00481       blob_box = blob-&gt;<a class="code" href="class_c___b_l_o_b.html#a77e52e29e2c622a3a63bb7edb110f6ab">bounding_box</a> ();
<a name="l00482"></a>00482       blob_size =
<a name="l00483"></a>00483         blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &gt;
<a name="l00484"></a>00484         blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ()? blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () : blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ();
<a name="l00485"></a>00485       <span class="keywordflow">if</span> (blob_size &gt;= <a class="code" href="classtesseract_1_1_textord.html#a8cdf3b52346640bffc1e0b54f15d56a1">textord_noise_sizelimit</a> * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00486"></a>00486           &amp;&amp; blob_size &lt; row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> () * 2) {
<a name="l00487"></a>00487         trans_threshold = blob_size / <a class="code" href="classtesseract_1_1_textord.html#ab3a9a94c765ba4044cc4017aeb919568">textord_noise_sizefraction</a>;
<a name="l00488"></a>00488         trans_count = blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ac765859af9c95ff036afa19361acc4d3">count_transitions</a> (trans_threshold);
<a name="l00489"></a>00489         <span class="keywordflow">if</span> (trans_count &lt; <a class="code" href="classtesseract_1_1_textord.html#a6446c61163e8998feafdbe26f11c8f9e">textord_noise_translimit</a>)
<a name="l00490"></a>00490           norm_count++;
<a name="l00491"></a>00491       }
<a name="l00492"></a>00492       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &gt; row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> () * 2
<a name="l00493"></a>00493         &amp;&amp; (!word_it.at_first () || !blob_it.at_first ()))
<a name="l00494"></a>00494         dot_count += 2;
<a name="l00495"></a>00495 <span class="preprocessor">      #ifndef SECURE_NAMES</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (testing_on) {
<a name="l00497"></a>00497         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>
<a name="l00498"></a>00498           (<span class="stringliteral">&quot;Blob at (%d,%d) -&gt; (%d,%d), ols=%d, tc=%d, bldiff=%g\n&quot;</span>,
<a name="l00499"></a>00499           blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> (), blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> (), blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> (),
<a name="l00500"></a>00500           blob_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a> (), blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a> ()-&gt;length (), trans_count,
<a name="l00501"></a>00501           blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> () - row-&gt;<a class="code" href="class_r_o_w.html#a097b3543fa3ca5768eb50033d4c4db9c">base_line</a> (blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ()));
<a name="l00502"></a>00502       }
<a name="l00503"></a>00503 <span class="preprocessor">      #endif</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>    }
<a name="l00505"></a>00505   }
<a name="l00506"></a>00506 <span class="preprocessor">  #ifndef SECURE_NAMES</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_textord.html#aa06ff5844f7415b3e097f35bd6ae7233">textord_noise_debug</a>) {
<a name="l00508"></a>00508     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Row ending at (%d,%g):&quot;</span>,
<a name="l00509"></a>00509       blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> (), row-&gt;<a class="code" href="class_r_o_w.html#a097b3543fa3ca5768eb50033d4c4db9c">base_line</a> (blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()));
<a name="l00510"></a>00510     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot; R=%g, dc=%d, nc=%d, %s\n&quot;</span>,
<a name="l00511"></a>00511       norm_count &gt; 0 ? (<span class="keywordtype">float</span>) dot_count / norm_count : 9999,
<a name="l00512"></a>00512       dot_count, norm_count,
<a name="l00513"></a>00513       dot_count &gt; norm_count * <a class="code" href="classtesseract_1_1_textord.html#abb3c7b73249c3755df5441af646f71d7">textord_noise_normratio</a>
<a name="l00514"></a>00514       &amp;&amp; dot_count &gt; 2 ? <span class="stringliteral">&quot;REJECTED&quot;</span> : <span class="stringliteral">&quot;ACCEPTED&quot;</span>);
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516 <span class="preprocessor">  #endif</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span>  <span class="keywordflow">return</span> super_norm_count &lt; <a class="code" href="classtesseract_1_1_textord.html#ade728b99ae003f1e95d8168b117deaab">textord_noise_sncount</a>
<a name="l00518"></a>00518     &amp;&amp; dot_count &gt; norm_count * <a class="code" href="classtesseract_1_1_textord.html#ac6212feab8ec9839c8e84cc08855fc95">textord_noise_rowratio</a> &amp;&amp; dot_count &gt; 2;
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="comment">/**********************************************************************</span>
<a name="l00522"></a>00522 <span class="comment"> * clean_noise_from_words</span>
<a name="l00523"></a>00523 <span class="comment"> *</span>
<a name="l00524"></a>00524 <span class="comment"> * Move blobs of words from rows of garbage into the reject blobs list.</span>
<a name="l00525"></a>00525 <span class="comment"> **********************************************************************/</span>
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="keywordtype">void</span> Textord::clean_noise_from_words(          <span class="comment">//remove empties</span>
<a name="l00528"></a>00528                                      <a class="code" href="class_r_o_w.html">ROW</a> *row  <span class="comment">//row to clean</span>
<a name="l00529"></a>00529                                     ) {
<a name="l00530"></a>00530   <a class="code" href="class_t_b_o_x.html">TBOX</a> blob_box;                  <span class="comment">//bounding box</span>
<a name="l00531"></a>00531   <a class="code" href="host_8h.html#a2ba4d271e85baf0d333318985cb3bced">inT8</a> *word_dud;                <span class="comment">//was it chucked</span>
<a name="l00532"></a>00532   <a class="code" href="class_c___b_l_o_b.html">C_BLOB</a> *blob;                  <span class="comment">//current blob</span>
<a name="l00533"></a>00533   <a class="code" href="class_c___o_u_t_l_i_n_e.html">C_OUTLINE</a> *outline;            <span class="comment">//current outline</span>
<a name="l00534"></a>00534   <a class="code" href="class_w_e_r_d.html">WERD</a> *word;                    <span class="comment">//current word</span>
<a name="l00535"></a>00535   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> blob_size;               <span class="comment">//biggest size</span>
<a name="l00536"></a>00536   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> trans_count;             <span class="comment">//no of transitions</span>
<a name="l00537"></a>00537   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> trans_threshold;         <span class="comment">//noise tolerance</span>
<a name="l00538"></a>00538   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> dot_count;               <span class="comment">//small objects</span>
<a name="l00539"></a>00539   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> norm_count;              <span class="comment">//normal objects</span>
<a name="l00540"></a>00540   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> dud_words;               <span class="comment">//number discarded</span>
<a name="l00541"></a>00541   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> ok_words;                <span class="comment">//number remaining</span>
<a name="l00542"></a>00542   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> word_index;              <span class="comment">//current word</span>
<a name="l00543"></a>00543                                  <span class="comment">//words of row</span>
<a name="l00544"></a>00544   WERD_IT word_it = row-&gt;<a class="code" href="class_r_o_w.html#ac9d07f978420b3564bf5508ad294fb70">word_list</a> ();
<a name="l00545"></a>00545   C_BLOB_IT blob_it;             <span class="comment">//blob iterator</span>
<a name="l00546"></a>00546   C_OUTLINE_IT out_it;           <span class="comment">//outline iterator</span>
<a name="l00547"></a>00547 
<a name="l00548"></a>00548   ok_words = word_it.length ();
<a name="l00549"></a>00549   <span class="keywordflow">if</span> (ok_words == 0 || <a class="code" href="classtesseract_1_1_textord.html#a34838ae15dc4966cbbd43c1d9d79e76b">textord_no_rejects</a>)
<a name="l00550"></a>00550     <span class="keywordflow">return</span>;
<a name="l00551"></a>00551   word_dud = (<a class="code" href="host_8h.html#a2ba4d271e85baf0d333318985cb3bced">inT8</a> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (ok_words * <span class="keyword">sizeof</span> (<a class="code" href="host_8h.html#a2ba4d271e85baf0d333318985cb3bced">inT8</a>));
<a name="l00552"></a>00552   dud_words = 0;
<a name="l00553"></a>00553   ok_words = 0;
<a name="l00554"></a>00554   word_index = 0;
<a name="l00555"></a>00555   <span class="keywordflow">for</span> (word_it.mark_cycle_pt (); !word_it.cycled_list (); word_it.forward ()) {
<a name="l00556"></a>00556     word = word_it.data ();      <span class="comment">//current word</span>
<a name="l00557"></a>00557     dot_count = 0;
<a name="l00558"></a>00558     norm_count = 0;
<a name="l00559"></a>00559                                  <span class="comment">//blobs in word</span>
<a name="l00560"></a>00560     blob_it.set_to_list (word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a> ());
<a name="l00561"></a>00561     <span class="keywordflow">for</span> (blob_it.mark_cycle_pt (); !blob_it.cycled_list ();
<a name="l00562"></a>00562     blob_it.forward ()) {
<a name="l00563"></a>00563       blob = blob_it.data ();
<a name="l00564"></a>00564       <span class="keywordflow">if</span> (!word-&gt;<a class="code" href="class_w_e_r_d.html#a81edde8597a3d9fd8a664d703d332c41">flag</a> (<a class="code" href="werd_8h.html#ad6968adbf8f2cc44adf333ec96efb0beac5f734536428e7e43dffe5c87d72d14e">W_DONT_CHOP</a>)) {
<a name="l00565"></a>00565                                  <span class="comment">//get outlines</span>
<a name="l00566"></a>00566         out_it.set_to_list (blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a> ());
<a name="l00567"></a>00567         <span class="keywordflow">for</span> (out_it.mark_cycle_pt (); !out_it.cycled_list ();
<a name="l00568"></a>00568         out_it.forward ()) {
<a name="l00569"></a>00569           outline = out_it.data ();
<a name="l00570"></a>00570           blob_box = outline-&gt;<a class="code" href="class_c___o_u_t_l_i_n_e.html#a6481db8e9c00281f20f45df48d499679">bounding_box</a> ();
<a name="l00571"></a>00571           blob_size =
<a name="l00572"></a>00572             blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &gt;
<a name="l00573"></a>00573             blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ()? blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () : blob_box.
<a name="l00574"></a>00574             height();
<a name="l00575"></a>00575           <span class="keywordflow">if</span> (blob_size &lt; textord_noise_sizelimit * row-&gt;x_height ())
<a name="l00576"></a>00576             dot_count++;         <span class="comment">//count smal outlines</span>
<a name="l00577"></a>00577           <span class="keywordflow">if</span> (!outline-&gt;<a class="code" href="class_c___o_u_t_l_i_n_e.html#a87880b33bc69fa17ab37a93706ae8d84">child</a> ()-&gt;empty ()
<a name="l00578"></a>00578             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &lt;
<a name="l00579"></a>00579             (1 + <a class="code" href="classtesseract_1_1_textord.html#a871f2c835f67cc0d5fee91ea8d292559">textord_noise_syfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00580"></a>00580             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &gt;
<a name="l00581"></a>00581             (1 - <a class="code" href="classtesseract_1_1_textord.html#a871f2c835f67cc0d5fee91ea8d292559">textord_noise_syfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00582"></a>00582             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &lt;
<a name="l00583"></a>00583             (1 + <a class="code" href="classtesseract_1_1_textord.html#a7b816661fcfb50ad445cbe066de36240">textord_noise_sxfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00584"></a>00584             &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &gt;
<a name="l00585"></a>00585             (1 - <a class="code" href="classtesseract_1_1_textord.html#a7b816661fcfb50ad445cbe066de36240">textord_noise_sxfract</a>) * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ())
<a name="l00586"></a>00586             norm_count++;        <span class="comment">//count smal outlines</span>
<a name="l00587"></a>00587         }
<a name="l00588"></a>00588       }
<a name="l00589"></a>00589       <span class="keywordflow">else</span>
<a name="l00590"></a>00590         norm_count++;
<a name="l00591"></a>00591       blob_box = blob-&gt;<a class="code" href="class_c___b_l_o_b.html#a77e52e29e2c622a3a63bb7edb110f6ab">bounding_box</a> ();
<a name="l00592"></a>00592       blob_size =
<a name="l00593"></a>00593         blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () &gt;
<a name="l00594"></a>00594         blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ()? blob_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () : blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ();
<a name="l00595"></a>00595       <span class="keywordflow">if</span> (blob_size &gt;= <a class="code" href="classtesseract_1_1_textord.html#a8cdf3b52346640bffc1e0b54f15d56a1">textord_noise_sizelimit</a> * row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ()
<a name="l00596"></a>00596       &amp;&amp; blob_size &lt; row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> () * 2) {
<a name="l00597"></a>00597         trans_threshold = blob_size / <a class="code" href="classtesseract_1_1_textord.html#ab3a9a94c765ba4044cc4017aeb919568">textord_noise_sizefraction</a>;
<a name="l00598"></a>00598         trans_count = blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ac765859af9c95ff036afa19361acc4d3">count_transitions</a> (trans_threshold);
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (trans_count &lt; <a class="code" href="classtesseract_1_1_textord.html#a6446c61163e8998feafdbe26f11c8f9e">textord_noise_translimit</a>)
<a name="l00600"></a>00600           norm_count++;
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () &gt; row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> () * 2
<a name="l00603"></a>00603         &amp;&amp; (!word_it.at_first () || !blob_it.at_first ()))
<a name="l00604"></a>00604         dot_count += 2;
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606     <span class="keywordflow">if</span> (dot_count &gt; 2) {
<a name="l00607"></a>00607       <span class="keywordflow">if</span> (dot_count &gt; norm_count * <a class="code" href="classtesseract_1_1_textord.html#abb3c7b73249c3755df5441af646f71d7">textord_noise_normratio</a> * 2)
<a name="l00608"></a>00608         word_dud[word_index] = 2;
<a name="l00609"></a>00609       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dot_count &gt; norm_count * textord_noise_normratio)
<a name="l00610"></a>00610         word_dud[word_index] = 1;
<a name="l00611"></a>00611       <span class="keywordflow">else</span>
<a name="l00612"></a>00612         word_dud[word_index] = 0;
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614     <span class="keywordflow">else</span>
<a name="l00615"></a>00615       word_dud[word_index] = 0;
<a name="l00616"></a>00616     <span class="keywordflow">if</span> (word_dud[word_index] == 2)
<a name="l00617"></a>00617       dud_words++;
<a name="l00618"></a>00618     <span class="keywordflow">else</span>
<a name="l00619"></a>00619       ok_words++;
<a name="l00620"></a>00620     word_index++;
<a name="l00621"></a>00621   }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623   word_index = 0;
<a name="l00624"></a>00624   <span class="keywordflow">for</span> (word_it.mark_cycle_pt (); !word_it.cycled_list (); word_it.forward ()) {
<a name="l00625"></a>00625     <span class="keywordflow">if</span> (word_dud[word_index] == 2
<a name="l00626"></a>00626     || (word_dud[word_index] == 1 &amp;&amp; dud_words &gt; ok_words)) {
<a name="l00627"></a>00627       word = word_it.data ();    <span class="comment">//current word</span>
<a name="l00628"></a>00628                                  <span class="comment">//rejected blobs</span>
<a name="l00629"></a>00629       blob_it.set_to_list (word-&gt;<a class="code" href="class_w_e_r_d.html#a0c26b86030e756d76e2425b1d2daf908">rej_cblob_list</a> ());
<a name="l00630"></a>00630                                  <span class="comment">//move from blobs</span>
<a name="l00631"></a>00631       blob_it.add_list_after (word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a> ());
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633     word_index++;
<a name="l00634"></a>00634   }
<a name="l00635"></a>00635   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(word_dud);
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 <span class="comment">// Remove outlines that are a tiny fraction in either width or height</span>
<a name="l00639"></a>00639 <span class="comment">// of the word height.</span>
<a name="l00640"></a>00640 <span class="keywordtype">void</span> Textord::clean_small_noise_from_words(<a class="code" href="class_r_o_w.html">ROW</a> *row) {
<a name="l00641"></a>00641   WERD_IT word_it(row-&gt;<a class="code" href="class_r_o_w.html#ac9d07f978420b3564bf5508ad294fb70">word_list</a>());
<a name="l00642"></a>00642   <span class="keywordflow">for</span> (word_it.mark_cycle_pt(); !word_it.cycled_list(); word_it.forward()) {
<a name="l00643"></a>00643     <a class="code" href="class_w_e_r_d.html">WERD</a>* word = word_it.data();
<a name="l00644"></a>00644     <span class="keywordtype">int</span> min_size = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(
<a name="l00645"></a>00645       <a class="code" href="classtesseract_1_1_textord.html#acf07fa4b7e98c77c64b1dd8103602db9">textord_noise_hfract</a> * word-&gt;<a class="code" href="class_w_e_r_d.html#a151bbfb39ecdef93ab1a14b0f9e4ac74">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() + 0.5);
<a name="l00646"></a>00646     C_BLOB_IT blob_it(word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a>());
<a name="l00647"></a>00647     <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00648"></a>00648       <a class="code" href="class_c___b_l_o_b.html">C_BLOB</a>* blob = blob_it.data();
<a name="l00649"></a>00649       C_OUTLINE_IT out_it(blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a>());
<a name="l00650"></a>00650       <span class="keywordflow">for</span> (out_it.mark_cycle_pt(); !out_it.cycled_list(); out_it.forward()) {
<a name="l00651"></a>00651         <a class="code" href="class_c___o_u_t_l_i_n_e.html">C_OUTLINE</a>* outline = out_it.data();
<a name="l00652"></a>00652         outline-&gt;<a class="code" href="class_c___o_u_t_l_i_n_e.html#ab984e00e52844e0415467db903548624">RemoveSmallRecursive</a>(min_size, &amp;out_it);
<a name="l00653"></a>00653       }
<a name="l00654"></a>00654       <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a>()-&gt;empty()) {
<a name="l00655"></a>00655         <span class="keyword">delete</span> blob_it.extract();
<a name="l00656"></a>00656       }
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a>()-&gt;empty()) {
<a name="l00659"></a>00659       <span class="keywordflow">if</span> (!word_it.at_last()) {
<a name="l00660"></a>00660         <span class="comment">// The next word is no longer a fuzzy non space if it was before,</span>
<a name="l00661"></a>00661         <span class="comment">// since the word before is about to be deleted.</span>
<a name="l00662"></a>00662         <a class="code" href="class_w_e_r_d.html">WERD</a>* next_word = word_it.data_relative(1);
<a name="l00663"></a>00663         <span class="keywordflow">if</span> (next_word-&gt;<a class="code" href="class_w_e_r_d.html#a81edde8597a3d9fd8a664d703d332c41">flag</a>(<a class="code" href="werd_8h.html#ad6968adbf8f2cc44adf333ec96efb0bea675eadd051ea82d1f288751799bfa31c">W_FUZZY_NON</a>)) {
<a name="l00664"></a>00664           next_word-&gt;<a class="code" href="class_w_e_r_d.html#aa42c9f53794ab51c95503cd277e89c60">set_flag</a>(<a class="code" href="werd_8h.html#ad6968adbf8f2cc44adf333ec96efb0bea675eadd051ea82d1f288751799bfa31c">W_FUZZY_NON</a>, <span class="keyword">false</span>);
<a name="l00665"></a>00665         }
<a name="l00666"></a>00666       }
<a name="l00667"></a>00667       <span class="keyword">delete</span> word_it.extract();
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669   }
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 }  <span class="comment">// tesseract</span>
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 <span class="comment">/**********************************************************************</span>
<a name="l00674"></a>00674 <span class="comment"> * tweak_row_baseline</span>
<a name="l00675"></a>00675 <span class="comment"> *</span>
<a name="l00676"></a>00676 <span class="comment"> * Shift baseline to fit the blobs more accurately where they are</span>
<a name="l00677"></a>00677 <span class="comment"> * close enough.</span>
<a name="l00678"></a>00678 <span class="comment"> **********************************************************************/</span>
<a name="l00679"></a>00679 
<a name="l00680"></a><a class="code" href="tordmain_8h.html#a76e9891e741722335a7a19c561f5580f">00680</a> <span class="keywordtype">void</span> <a class="code" href="tordmain_8cpp.html#a76e9891e741722335a7a19c561f5580f">tweak_row_baseline</a>(<a class="code" href="class_r_o_w.html">ROW</a> *row,
<a name="l00681"></a>00681                         <span class="keywordtype">double</span> blshift_maxshift,
<a name="l00682"></a>00682                         <span class="keywordtype">double</span> blshift_xfraction) {
<a name="l00683"></a>00683   <a class="code" href="class_t_b_o_x.html">TBOX</a> blob_box;                 <span class="comment">//bounding box</span>
<a name="l00684"></a>00684   <a class="code" href="class_c___b_l_o_b.html">C_BLOB</a> *blob;                  <span class="comment">//current blob</span>
<a name="l00685"></a>00685   <a class="code" href="class_w_e_r_d.html">WERD</a> *word;                    <span class="comment">//current word</span>
<a name="l00686"></a>00686   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> blob_count;              <span class="comment">//no of blobs</span>
<a name="l00687"></a>00687   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> src_index;               <span class="comment">//source segment</span>
<a name="l00688"></a>00688   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> dest_index;              <span class="comment">//destination segment</span>
<a name="l00689"></a>00689   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> *xstarts;                <span class="comment">//spline segments</span>
<a name="l00690"></a>00690   <span class="keywordtype">double</span> *coeffs;                <span class="comment">//spline coeffs</span>
<a name="l00691"></a>00691   <span class="keywordtype">float</span> ydiff;                   <span class="comment">//baseline error</span>
<a name="l00692"></a>00692   <span class="keywordtype">float</span> x_centre;                <span class="comment">//centre of blob</span>
<a name="l00693"></a>00693                                  <span class="comment">//words of row</span>
<a name="l00694"></a>00694   WERD_IT word_it = row-&gt;<a class="code" href="class_r_o_w.html#ac9d07f978420b3564bf5508ad294fb70">word_list</a> ();
<a name="l00695"></a>00695   C_BLOB_IT blob_it;             <span class="comment">//blob iterator</span>
<a name="l00696"></a>00696 
<a name="l00697"></a>00697   blob_count = 0;
<a name="l00698"></a>00698   <span class="keywordflow">for</span> (word_it.mark_cycle_pt (); !word_it.cycled_list (); word_it.forward ()) {
<a name="l00699"></a>00699     word = word_it.data ();      <span class="comment">//current word</span>
<a name="l00700"></a>00700                                  <span class="comment">//get total blobs</span>
<a name="l00701"></a>00701     blob_count += word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a> ()-&gt;length ();
<a name="l00702"></a>00702   }
<a name="l00703"></a>00703   <span class="keywordflow">if</span> (blob_count == 0)
<a name="l00704"></a>00704     <span class="keywordflow">return</span>;
<a name="l00705"></a>00705   xstarts =
<a name="l00706"></a>00706     (<a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> ((blob_count + row-&gt;baseline.segments + 1) *
<a name="l00707"></a>00707     <span class="keyword">sizeof</span> (<a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a>));
<a name="l00708"></a>00708   coeffs =
<a name="l00709"></a>00709     (<span class="keywordtype">double</span> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> ((blob_count + row-&gt;baseline.segments) * 3 *
<a name="l00710"></a>00710     <span class="keyword">sizeof</span> (double));
<a name="l00711"></a>00711 
<a name="l00712"></a>00712   src_index = 0;
<a name="l00713"></a>00713   dest_index = 0;
<a name="l00714"></a>00714   xstarts[0] = row-&gt;baseline.xcoords[0];
<a name="l00715"></a>00715   <span class="keywordflow">for</span> (word_it.mark_cycle_pt (); !word_it.cycled_list (); word_it.forward ()) {
<a name="l00716"></a>00716     word = word_it.data ();      <span class="comment">//current word</span>
<a name="l00717"></a>00717                                  <span class="comment">//blobs in word</span>
<a name="l00718"></a>00718     blob_it.set_to_list (word-&gt;<a class="code" href="class_w_e_r_d.html#a174baefaa99afbfdbf444e4199f3b529">cblob_list</a> ());
<a name="l00719"></a>00719     <span class="keywordflow">for</span> (blob_it.mark_cycle_pt (); !blob_it.cycled_list ();
<a name="l00720"></a>00720     blob_it.forward ()) {
<a name="l00721"></a>00721       blob = blob_it.data ();
<a name="l00722"></a>00722       blob_box = blob-&gt;<a class="code" href="class_c___b_l_o_b.html#a77e52e29e2c622a3a63bb7edb110f6ab">bounding_box</a> ();
<a name="l00723"></a>00723       x_centre = (blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () + blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) / 2.0;
<a name="l00724"></a>00724       ydiff = blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> () - row-&gt;<a class="code" href="class_r_o_w.html#a097b3543fa3ca5768eb50033d4c4db9c">base_line</a> (x_centre);
<a name="l00725"></a>00725       <span class="keywordflow">if</span> (ydiff &lt; 0)
<a name="l00726"></a>00726         ydiff = -ydiff / row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ();
<a name="l00727"></a>00727       <span class="keywordflow">else</span>
<a name="l00728"></a>00728         ydiff = ydiff / row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> ();
<a name="l00729"></a>00729       <span class="keywordflow">if</span> (ydiff &lt; blshift_maxshift
<a name="l00730"></a>00730         &amp;&amp; blob_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () / row-&gt;<a class="code" href="class_r_o_w.html#a2954f94ec4eefe1e3729912e5b8ea779">x_height</a> () &gt; blshift_xfraction) {
<a name="l00731"></a>00731         <span class="keywordflow">if</span> (xstarts[dest_index] &gt;= x_centre)
<a name="l00732"></a>00732           xstarts[dest_index] = blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ();
<a name="l00733"></a>00733         coeffs[dest_index * 3] = 0;
<a name="l00734"></a>00734         coeffs[dest_index * 3 + 1] = 0;
<a name="l00735"></a>00735         coeffs[dest_index * 3 + 2] = blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ();
<a name="l00736"></a>00736         <span class="comment">//shift it</span>
<a name="l00737"></a>00737         dest_index++;
<a name="l00738"></a>00738         xstarts[dest_index] = blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> () + 1;
<a name="l00739"></a>00739       }
<a name="l00740"></a>00740       <span class="keywordflow">else</span> {
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (xstarts[dest_index] &lt;= x_centre) {
<a name="l00742"></a>00742           <span class="keywordflow">while</span> (row-&gt;baseline.xcoords[src_index + 1] &lt;= x_centre
<a name="l00743"></a>00743           &amp;&amp; src_index &lt; row-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>.segments - 1) {
<a name="l00744"></a>00744             <span class="keywordflow">if</span> (row-&gt;baseline.xcoords[src_index + 1] &gt;
<a name="l00745"></a>00745             xstarts[dest_index]) {
<a name="l00746"></a>00746               coeffs[dest_index * 3] =
<a name="l00747"></a>00747                 row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#aa9ab5e8947242fa1de50d9863165e032">a</a>;
<a name="l00748"></a>00748               coeffs[dest_index * 3 + 1] =
<a name="l00749"></a>00749                 row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#a58eae9f9c9aa7b738c5493b8da560747">b</a>;
<a name="l00750"></a>00750               coeffs[dest_index * 3 + 2] =
<a name="l00751"></a>00751                 row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#a7f5483bdd3103b7f4a732c8fbc0faa91">c</a>;
<a name="l00752"></a>00752               dest_index++;
<a name="l00753"></a>00753               xstarts[dest_index] =
<a name="l00754"></a>00754                 row-&gt;baseline.xcoords[src_index + 1];
<a name="l00755"></a>00755             }
<a name="l00756"></a>00756             src_index++;
<a name="l00757"></a>00757           }
<a name="l00758"></a>00758           coeffs[dest_index * 3] =
<a name="l00759"></a>00759             row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#aa9ab5e8947242fa1de50d9863165e032">a</a>;
<a name="l00760"></a>00760           coeffs[dest_index * 3 + 1] =
<a name="l00761"></a>00761             row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#a58eae9f9c9aa7b738c5493b8da560747">b</a>;
<a name="l00762"></a>00762           coeffs[dest_index * 3 + 2] =
<a name="l00763"></a>00763             row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#a7f5483bdd3103b7f4a732c8fbc0faa91">c</a>;
<a name="l00764"></a>00764           dest_index++;
<a name="l00765"></a>00765           xstarts[dest_index] = row-&gt;baseline.xcoords[src_index + 1];
<a name="l00766"></a>00766         }
<a name="l00767"></a>00767       }
<a name="l00768"></a>00768     }
<a name="l00769"></a>00769   }
<a name="l00770"></a>00770   <span class="keywordflow">while</span> (src_index &lt; row-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>.segments
<a name="l00771"></a>00771     &amp;&amp; row-&gt;baseline.xcoords[src_index + 1] &lt;= xstarts[dest_index])
<a name="l00772"></a>00772     src_index++;
<a name="l00773"></a>00773   <span class="keywordflow">while</span> (src_index &lt; row-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>.segments) {
<a name="l00774"></a>00774     coeffs[dest_index * 3] = row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#aa9ab5e8947242fa1de50d9863165e032">a</a>;
<a name="l00775"></a>00775     coeffs[dest_index * 3 + 1] = row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#a58eae9f9c9aa7b738c5493b8da560747">b</a>;
<a name="l00776"></a>00776     coeffs[dest_index * 3 + 2] = row-&gt;baseline.quadratics[src_index].<a class="code" href="class_q_u_a_d___c_o_e_f_f_s.html#a7f5483bdd3103b7f4a732c8fbc0faa91">c</a>;
<a name="l00777"></a>00777     dest_index++;
<a name="l00778"></a>00778     src_index++;
<a name="l00779"></a>00779     xstarts[dest_index] = row-&gt;baseline.xcoords[src_index];
<a name="l00780"></a>00780   }
<a name="l00781"></a>00781                                  <span class="comment">//turn to spline</span>
<a name="l00782"></a>00782   row-&gt;baseline = <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> (dest_index, xstarts, coeffs);
<a name="l00783"></a>00783   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(xstarts);
<a name="l00784"></a>00784   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(coeffs);
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 <span class="comment">/**********************************************************************</span>
<a name="l00788"></a>00788 <span class="comment"> * blob_y_order</span>
<a name="l00789"></a>00789 <span class="comment"> *</span>
<a name="l00790"></a>00790 <span class="comment"> * Sort function to sort blobs in y from page top.</span>
<a name="l00791"></a>00791 <span class="comment"> **********************************************************************/</span>
<a name="l00792"></a>00792 
<a name="l00793"></a><a class="code" href="tordmain_8h.html#a468e4fe0f28b1a8c1ac7162bf83f1a91">00793</a> <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> <a class="code" href="tordmain_8cpp.html#a468e4fe0f28b1a8c1ac7162bf83f1a91">blob_y_order</a>(              <span class="comment">//sort function</span>
<a name="l00794"></a>00794                    <span class="keywordtype">void</span> *item1,  <span class="comment">//items to compare</span>
<a name="l00795"></a>00795                    <span class="keywordtype">void</span> *item2) {
<a name="l00796"></a>00796                                  <span class="comment">//converted ptr</span>
<a name="l00797"></a>00797   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a> *blob1 = *(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a> **) item1;
<a name="l00798"></a>00798                                  <span class="comment">//converted ptr</span>
<a name="l00799"></a>00799   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a> *blob2 = *(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a> **) item2;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   <span class="keywordflow">if</span> (blob1-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> () &gt; blob2-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ())
<a name="l00802"></a>00802     <span class="keywordflow">return</span> -1;
<a name="l00803"></a>00803   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob1-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> () &lt;
<a name="l00804"></a>00804     blob2-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ())
<a name="l00805"></a>00805     <span class="keywordflow">return</span> 1;
<a name="l00806"></a>00806   <span class="keywordflow">else</span> {
<a name="l00807"></a>00807     <span class="keywordflow">if</span> (blob1-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () &lt; blob2-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ())
<a name="l00808"></a>00808       <span class="keywordflow">return</span> -1;
<a name="l00809"></a>00809     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob1-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () &gt;
<a name="l00810"></a>00810       blob2-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a> ().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ())
<a name="l00811"></a>00811       <span class="keywordflow">return</span> 1;
<a name="l00812"></a>00812     <span class="keywordflow">else</span>
<a name="l00813"></a>00813       <span class="keywordflow">return</span> 0;
<a name="l00814"></a>00814   }
<a name="l00815"></a>00815 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="tordmain_8cpp.html">tordmain.cpp</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Wed Mar 28 2012 22:38:39 for Tesseract by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
