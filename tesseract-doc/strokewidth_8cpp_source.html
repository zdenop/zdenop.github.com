<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Tesseract: tesseract-ocr/textord/strokewidth.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tesseract
   &#160;<span id="projectnumber">3.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('strokewidth_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">tesseract-ocr/textord/strokewidth.cpp</div>  </div>
</div>
<div class="contents">
<a href="strokewidth_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">// File:        strokewidth.cpp</span>
<a name="l00003"></a>00003 <span class="comment">// Description: Subclass of BBGrid to find uniformity of strokewidth.</span>
<a name="l00004"></a>00004 <span class="comment">// Author:      Ray Smith</span>
<a name="l00005"></a>00005 <span class="comment">// Created:     Mon Mar 31 16:17:01 PST 2008</span>
<a name="l00006"></a>00006 <span class="comment">//</span>
<a name="l00007"></a>00007 <span class="comment">// (C) Copyright 2008, Google Inc.</span>
<a name="l00008"></a>00008 <span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00009"></a>00009 <span class="comment">// you may not use this file except in compliance with the License.</span>
<a name="l00010"></a>00010 <span class="comment">// You may obtain a copy of the License at</span>
<a name="l00011"></a>00011 <span class="comment">// http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00012"></a>00012 <span class="comment">// Unless required by applicable law or agreed to in writing, software</span>
<a name="l00013"></a>00013 <span class="comment">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00014"></a>00014 <span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00015"></a>00015 <span class="comment">// See the License for the specific language governing permissions and</span>
<a name="l00016"></a>00016 <span class="comment">// limitations under the License.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="preprocessor">#ifdef _MSC_VER</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#pragma warning(disable:4244)  // Conversion warnings</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="strokewidth_8h.html">strokewidth.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="blobbox_8h.html">blobbox.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="colpartition_8h.html">colpartition.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="colpartitiongrid_8h.html">colpartitiongrid.h</a>&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &quot;<a class="code" href="imagefind_8h.html">imagefind.h</a>&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="linlsq_8h.html">linlsq.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="statistc_8h.html">statistc.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="tabfind_8h.html">tabfind.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="textlineprojection_8h.html">textlineprojection.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="tordmain_8h.html">tordmain.h</a>&quot;</span>  <span class="comment">// For SetBlobStrokeWidth.</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">// Include automatically generated configuration file if running autoconf.</span>
<a name="l00039"></a>00039 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="config__auto_8h.html">config_auto.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#endif</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="keyword">namespace </span>tesseract {
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">00045</a> <a class="code" href="params_8h.html#a554d43d0cf0e3f9552921941d9e147bd">INT_VAR</a>(<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>, 0, <span class="stringliteral">&quot;Show stroke widths&quot;</span>);
<a name="l00046"></a><a class="code" href="namespacetesseract.html#a5822b437edf16b39ca18cec5515d8bcf">00046</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a>(<a class="code" href="namespacetesseract.html#a5822b437edf16b39ca18cec5515d8bcf">textord_tabfind_only_strokewidths</a>, <span class="keyword">false</span>, <span class="stringliteral">&quot;Only run stroke widths&quot;</span>);
<a name="l00047"></a><a class="code" href="namespacetesseract.html#af8cfa4b20dc36de190500367d58c1ae5">00047</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a>(<a class="code" href="namespacetesseract.html#af8cfa4b20dc36de190500367d58c1ae5">textord_tabfind_vertical_text</a>, <span class="keyword">true</span>, <span class="stringliteral">&quot;Enable vertical detection&quot;</span>);
<a name="l00048"></a>00048 <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a>(<a class="code" href="namespacetesseract.html#ac301261d944fad68a80e922f67a02fa6">textord_tabfind_force_vertical_text</a>, <span class="keyword">false</span>,
<a name="l00049"></a><a class="code" href="tabfind_8h.html#a54accb7683d31dc6fb1631f43e8b2427">00049</a>          <span class="stringliteral">&quot;Force using vertical text page mode&quot;</span>);
<a name="l00050"></a>00050 <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a>(<a class="code" href="namespacetesseract.html#a3bd37bbb8e4feac8c429338f90240c46">textord_tabfind_vertical_horizontal_mix</a>, <span class="keyword">true</span>,
<a name="l00051"></a><a class="code" href="tabfind_8h.html#ab94d05aebeb31ddad734796ad579ef90">00051</a>          <span class="stringliteral">&quot;find horizontal lines such as headers in vertical page mode&quot;</span>);
<a name="l00052"></a>00052 <a class="code" href="params_8h.html#aa855c84dbbf962a5533a96e1f458c690">double_VAR</a>(<a class="code" href="namespacetesseract.html#a7d8b2088f3354a58c4ebcf648b6cf700">textord_tabfind_vertical_text_ratio</a>, 0.5,
<a name="l00053"></a><a class="code" href="tabfind_8h.html#aa451cc391fb6a33a85e142221438254f">00053</a>            <span class="stringliteral">&quot;Fraction of textlines deemed vertical to use vertical page mode&quot;</span>);
<a name="l00054"></a>00054 
<a name="l00056"></a>00056 <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#abc28700fa5d19f82a78db318450d7786">kStrokeWidthFractionTolerance</a> = 0.125;
<a name="l00061"></a><a class="code" href="namespacetesseract.html#a5d1f89502955a97f3986e480f45d11ac">00061</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a5d1f89502955a97f3986e480f45d11ac">kStrokeWidthTolerance</a> = 1.5;
<a name="l00062"></a>00062 <span class="comment">// Same but for CJK we are a bit more generous.</span>
<a name="l00063"></a><a class="code" href="namespacetesseract.html#abd67e80f3588f9bbf627ae8b21494513">00063</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#abd67e80f3588f9bbf627ae8b21494513">kStrokeWidthFractionCJK</a> = 0.25;
<a name="l00064"></a><a class="code" href="namespacetesseract.html#ad4cf0379178f03e5f1fc982c6e12a7a3">00064</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#ad4cf0379178f03e5f1fc982c6e12a7a3">kStrokeWidthCJK</a> = 2.0;
<a name="l00065"></a>00065 <span class="comment">// Radius in grid cells of search for broken CJK. Doesn&#39;t need to be very</span>
<a name="l00066"></a>00066 <span class="comment">// large as the grid size should be about the size of a character anyway.</span>
<a name="l00067"></a><a class="code" href="namespacetesseract.html#a73ac9428eb90511e5627135347d561e2">00067</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a73ac9428eb90511e5627135347d561e2">kCJKRadius</a> = 2;
<a name="l00068"></a>00068 <span class="comment">// Max distance fraction of size to join close but broken CJK characters.</span>
<a name="l00069"></a><a class="code" href="namespacetesseract.html#a39569c92bdfdb4178deaac42d588f830">00069</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a39569c92bdfdb4178deaac42d588f830">kCJKBrokenDistanceFraction</a> = 0.25;
<a name="l00070"></a>00070 <span class="comment">// Max number of components in a broken CJK character.</span>
<a name="l00071"></a><a class="code" href="namespacetesseract.html#a308c19587dfea876b3291916f10443ec">00071</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a308c19587dfea876b3291916f10443ec">kCJKMaxComponents</a> = 8;
<a name="l00072"></a>00072 <span class="comment">// Max aspect ratio of CJK broken characters when put back together.</span>
<a name="l00073"></a><a class="code" href="namespacetesseract.html#a4569b4a16846b1c45945534463a09e75">00073</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a4569b4a16846b1c45945534463a09e75">kCJKAspectRatio</a> = 1.25;
<a name="l00074"></a>00074 <span class="comment">// Max increase in aspect ratio of CJK broken characters when merged.</span>
<a name="l00075"></a><a class="code" href="namespacetesseract.html#a62516d3e478bcfb239d046da287150b3">00075</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a62516d3e478bcfb239d046da287150b3">kCJKAspectRatioIncrease</a> = 1.0625;
<a name="l00076"></a>00076 <span class="comment">// Max multiple of the grid size that will be used in computing median CJKsize.</span>
<a name="l00077"></a><a class="code" href="namespacetesseract.html#aa44aa93b17b5967315a229c1b1ed1f31">00077</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#aa44aa93b17b5967315a229c1b1ed1f31">kMaxCJKSizeRatio</a> = 5;
<a name="l00078"></a>00078 <span class="comment">// Min fraction of blobs broken CJK to iterate and run it again.</span>
<a name="l00079"></a><a class="code" href="namespacetesseract.html#a93725c4be688b102564ecc9ef6642366">00079</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a93725c4be688b102564ecc9ef6642366">kBrokenCJKIterationFraction</a> = 0.125;
<a name="l00080"></a>00080 <span class="comment">// Multiple of gridsize as x-padding for a search box for diacritic base</span>
<a name="l00081"></a>00081 <span class="comment">// characters.</span>
<a name="l00082"></a><a class="code" href="namespacetesseract.html#aabf5756c7e5d355517dc1af5df71e750">00082</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#aabf5756c7e5d355517dc1af5df71e750">kDiacriticXPadRatio</a> = 7.0;
<a name="l00083"></a>00083 <span class="comment">// Multiple of gridsize as y-padding for a search box for diacritic base</span>
<a name="l00084"></a>00084 <span class="comment">// characters.</span>
<a name="l00085"></a><a class="code" href="namespacetesseract.html#adfd3b22e2049d8d544208834da403031">00085</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#adfd3b22e2049d8d544208834da403031">kDiacriticYPadRatio</a> = 1.75;
<a name="l00086"></a>00086 <span class="comment">// Min multiple of diacritic height that a neighbour must be to be a</span>
<a name="l00087"></a>00087 <span class="comment">// convincing base character.</span>
<a name="l00088"></a><a class="code" href="namespacetesseract.html#a3883c045452c59e5a80bd9ed73cd9e6f">00088</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a3883c045452c59e5a80bd9ed73cd9e6f">kMinDiacriticSizeRatio</a> = 1.0625;
<a name="l00089"></a>00089 <span class="comment">// Max multiple of a textline&#39;s median height as a threshold for the sum of</span>
<a name="l00090"></a>00090 <span class="comment">// a diacritic&#39;s farthest x and y distances (gap + size).</span>
<a name="l00091"></a><a class="code" href="namespacetesseract.html#a140f97b7a02095877cba6ffaf66edc32">00091</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a140f97b7a02095877cba6ffaf66edc32">kMaxDiacriticDistanceRatio</a> = 1.25;
<a name="l00092"></a>00092 <span class="comment">// Max x-gap between a diacritic and its base char as a fraction of the height</span>
<a name="l00093"></a>00093 <span class="comment">// of the base char (allowing other blobs to fill the gap.)</span>
<a name="l00094"></a><a class="code" href="namespacetesseract.html#aaf71279184a5815428ada7f1b3fa5d5c">00094</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#aaf71279184a5815428ada7f1b3fa5d5c">kMaxDiacriticGapToBaseCharHeight</a> = 1.0;
<a name="l00095"></a>00095 <span class="comment">// Radius of a search for diacritics in grid units.</span>
<a name="l00096"></a><a class="code" href="namespacetesseract.html#aa272bbcbb5d0b8dad555f86a29a1a133">00096</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#aa272bbcbb5d0b8dad555f86a29a1a133">kSearchRadius</a> = 2;
<a name="l00097"></a>00097 <span class="comment">// Ratio between longest side of a line and longest side of a character.</span>
<a name="l00098"></a>00098 <span class="comment">// (neighbor_min &gt; blob_min * kLineTrapShortest &amp;&amp;</span>
<a name="l00099"></a>00099 <span class="comment">//  neighbor_max &lt; blob_max / kLineTrapLongest)</span>
<a name="l00100"></a>00100 <span class="comment">// =&gt; neighbor is a grapheme and blob is a line.</span>
<a name="l00101"></a><a class="code" href="namespacetesseract.html#a3d9a4df05c442729540b7459fbec462c">00101</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a3d9a4df05c442729540b7459fbec462c">kLineTrapLongest</a> = 4;
<a name="l00102"></a>00102 <span class="comment">// Ratio between shortest side of a line and shortest side of a character.</span>
<a name="l00103"></a><a class="code" href="namespacetesseract.html#ab34b32a5ea90db86801786f0f8a83997">00103</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#ab34b32a5ea90db86801786f0f8a83997">kLineTrapShortest</a> = 2;
<a name="l00104"></a>00104 <span class="comment">// Max aspect ratio of the total box before CountNeighbourGaps</span>
<a name="l00105"></a>00105 <span class="comment">// decides immediately based on the aspect ratio.</span>
<a name="l00106"></a><a class="code" href="namespacetesseract.html#afba5db6e43d5f018b1c6bb6dfa43e488">00106</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#afba5db6e43d5f018b1c6bb6dfa43e488">kMostlyOneDirRatio</a> = 3;
<a name="l00107"></a>00107 <span class="comment">// Aspect ratio for a blob to be considered as line residue.</span>
<a name="l00108"></a><a class="code" href="namespacetesseract.html#a84872b3032afddbed37888802b109b56">00108</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a84872b3032afddbed37888802b109b56">kLineResidueAspectRatio</a> = 8.0;
<a name="l00109"></a>00109 <span class="comment">// Padding ratio for line residue search box.</span>
<a name="l00110"></a><a class="code" href="namespacetesseract.html#a1a706351c04a309beaf8be435136baac">00110</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a1a706351c04a309beaf8be435136baac">kLineResiduePadRatio</a> = 3;
<a name="l00111"></a>00111 <span class="comment">// Min multiple of neighbour size for a line residue to be genuine.</span>
<a name="l00112"></a><a class="code" href="namespacetesseract.html#aad875f37920782a2a2e7acedceefb20f">00112</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#aad875f37920782a2a2e7acedceefb20f">kLineResidueSizeRatio</a> = 1.75;
<a name="l00113"></a>00113 <span class="comment">// Aspect ratio filter for OSD.</span>
<a name="l00114"></a><a class="code" href="namespacetesseract.html#af750de0df296b9b48c485e2ec4bb283c">00114</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="namespacetesseract.html#af750de0df296b9b48c485e2ec4bb283c">kSizeRatioToReject</a> = 2.0;
<a name="l00115"></a>00115 <span class="comment">// Max number of normal blobs a large blob may overlap before it is rejected</span>
<a name="l00116"></a>00116 <span class="comment">// and determined to be image</span>
<a name="l00117"></a><a class="code" href="namespacetesseract.html#a349538464d5316e5854eee5dba4bf38e">00117</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a349538464d5316e5854eee5dba4bf38e">kMaxLargeOverlaps</a> = 3;
<a name="l00118"></a>00118 <span class="comment">// Expansion factor for search box for good neighbours.</span>
<a name="l00119"></a><a class="code" href="namespacetesseract.html#a746b69b4c2ec2f296100ebfaf15b2e2b">00119</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a746b69b4c2ec2f296100ebfaf15b2e2b">kNeighbourSearchFactor</a> = 2.5;
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a4551a10f256b1df74832b53b8f0e33b2">00121</a> <a class="code" href="classtesseract_1_1_stroke_width.html#a4551a10f256b1df74832b53b8f0e33b2">StrokeWidth::StrokeWidth</a>(<span class="keywordtype">int</span> gridsize,
<a name="l00122"></a>00122                          <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; bleft, <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; tright)
<a name="l00123"></a>00123   : <a class="code" href="classtesseract_1_1_blob_grid.html">BlobGrid</a>(gridsize, bleft, tright), nontext_map_(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>), projection_(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>),
<a name="l00124"></a>00124     denorm_(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>), grid_box_(bleft, tright), rerotation_(1.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>, 0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>) {
<a name="l00125"></a>00125   leaders_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00126"></a>00126   widths_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00127"></a>00127   initial_widths_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00128"></a>00128   chains_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00129"></a>00129   diacritics_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00130"></a>00130   textlines_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00131"></a>00131   smoothed_win_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a86277000549e608335b9fcbb042d165b">00134</a> <a class="code" href="classtesseract_1_1_stroke_width.html#a86277000549e608335b9fcbb042d165b">StrokeWidth::~StrokeWidth</a>() {
<a name="l00135"></a>00135   <span class="keywordflow">if</span> (widths_win_ != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00136"></a>00136 <span class="preprocessor">    #ifndef GRAPHICS_DISABLED</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    <span class="keyword">delete</span> widths_win_-&gt;<a class="code" href="class_scroll_view.html#a0b820b3fe7a2ce083da0784e9339a1ad">AwaitEvent</a>(<a class="code" href="scrollview_8h.html#a3688a0cf2f95d10a57e095222ccfe9a0adbe9fb2ca110dbf1b838d845d32a89e7">SVET_DESTROY</a>);
<a name="l00138"></a>00138 <span class="preprocessor">    #endif  // GRAPHICS_DISABLED</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a5822b437edf16b39ca18cec5515d8bcf">textord_tabfind_only_strokewidths</a>)
<a name="l00140"></a>00140       exit(0);
<a name="l00141"></a>00141     <span class="keyword">delete</span> widths_win_;
<a name="l00142"></a>00142   }
<a name="l00143"></a>00143   <span class="keyword">delete</span> leaders_win_;
<a name="l00144"></a>00144   <span class="keyword">delete</span> initial_widths_win_;
<a name="l00145"></a>00145   <span class="keyword">delete</span> chains_win_;
<a name="l00146"></a>00146   <span class="keyword">delete</span> textlines_win_;
<a name="l00147"></a>00147   <span class="keyword">delete</span> smoothed_win_;
<a name="l00148"></a>00148   <span class="keyword">delete</span> diacritics_win_;
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">// Sets the neighbours member of the medium-sized blobs in the block.</span>
<a name="l00152"></a>00152 <span class="comment">// Searches on 4 sides of each blob for similar-sized, similar-strokewidth</span>
<a name="l00153"></a>00153 <span class="comment">// blobs and sets pointers to the good neighbours.</span>
<a name="l00154"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a8273b43eb6170be582f30d5049aec523">00154</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a8273b43eb6170be582f30d5049aec523">StrokeWidth::SetNeighboursOnMediumBlobs</a>(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l00155"></a>00155   <span class="comment">// Run a preliminary strokewidth neighbour detection on the medium blobs.</span>
<a name="l00156"></a>00156   <a class="code" href="classtesseract_1_1_blob_grid.html#ae3e2254b403947fc9628221aa3cb5b26">InsertBlobList</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l00157"></a>00157   BLOBNBOX_IT blob_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l00158"></a>00158   <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00159"></a>00159     SetNeighbours(<span class="keyword">false</span>, <span class="keyword">false</span>, blob_it.data());
<a name="l00160"></a>00160   }
<a name="l00161"></a>00161   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="comment">// Sets the neighbour/textline writing direction members of the medium</span>
<a name="l00165"></a>00165 <span class="comment">// and large blobs with optional repair of broken CJK characters first.</span>
<a name="l00166"></a>00166 <span class="comment">// Repair of broken CJK is needed here because broken CJK characters</span>
<a name="l00167"></a>00167 <span class="comment">// can fool the textline direction detection algorithm.</span>
<a name="l00168"></a><a class="code" href="classtesseract_1_1_stroke_width.html#aadfc985b5ed12df5ac545b344a304326">00168</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#aadfc985b5ed12df5ac545b344a304326">StrokeWidth::FindTextlineDirectionAndFixBrokenCJK</a>(<span class="keywordtype">bool</span> cjk_merge,
<a name="l00169"></a>00169                                                        <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* input_block) {
<a name="l00170"></a>00170   <span class="comment">// Setup the grid with the remaining (non-noise) blobs.</span>
<a name="l00171"></a>00171   InsertBlobs(input_block);
<a name="l00172"></a>00172   <span class="comment">// Repair broken CJK characters if needed.</span>
<a name="l00173"></a>00173   <span class="keywordflow">while</span> (cjk_merge &amp;&amp; FixBrokenCJK(input_block));
<a name="l00174"></a>00174   <span class="comment">// Grade blobs by inspection of neighbours.</span>
<a name="l00175"></a>00175   FindTextlineFlowDirection(<span class="keyword">false</span>);
<a name="l00176"></a>00176   <span class="comment">// Clear the grid ready for rotation or leader finding.</span>
<a name="l00177"></a>00177   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="comment">// Helper to collect and count horizontal and vertical blobs from a list.</span>
<a name="l00181"></a>00181 <span class="keyword">static</span> <span class="keywordtype">void</span> CollectHorizVertBlobs(BLOBNBOX_LIST* input_blobs,
<a name="l00182"></a>00182                                   <span class="keywordtype">int</span>* num_vertical_blobs,
<a name="l00183"></a>00183                                   <span class="keywordtype">int</span>* num_horizontal_blobs,
<a name="l00184"></a>00184                                   BLOBNBOX_CLIST* vertical_blobs,
<a name="l00185"></a>00185                                   BLOBNBOX_CLIST* horizontal_blobs,
<a name="l00186"></a>00186                                   BLOBNBOX_CLIST* nondescript_blobs) {
<a name="l00187"></a>00187   BLOBNBOX_C_IT v_it(vertical_blobs);
<a name="l00188"></a>00188   BLOBNBOX_C_IT h_it(horizontal_blobs);
<a name="l00189"></a>00189   BLOBNBOX_C_IT n_it(nondescript_blobs);
<a name="l00190"></a>00190   BLOBNBOX_IT blob_it(input_blobs);
<a name="l00191"></a>00191   <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00192"></a>00192     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l00193"></a>00193     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00194"></a>00194     <span class="keywordtype">float</span> y_x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>()) / box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>();
<a name="l00195"></a>00195     <span class="keywordtype">float</span> x_y = 1.0f / y_x;
<a name="l00196"></a>00196     <span class="comment">// Select a &gt;= 1.0 ratio</span>
<a name="l00197"></a>00197     <span class="keywordtype">float</span> ratio = x_y &gt; y_x ? x_y : y_x;
<a name="l00198"></a>00198     <span class="comment">// If the aspect ratio is small and we want them for osd, save the blob.</span>
<a name="l00199"></a>00199     <span class="keywordtype">bool</span> ok_blob = ratio &lt;= <a class="code" href="namespacetesseract.html#af750de0df296b9b48c485e2ec4bb283c">kSizeRatioToReject</a>;
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aa4e11bd4e9e5903b52bcd363db008f2e">UniquelyVertical</a>()) {
<a name="l00201"></a>00201       ++*num_vertical_blobs;
<a name="l00202"></a>00202       <span class="keywordflow">if</span> (ok_blob) v_it.add_after_then_move(blob);
<a name="l00203"></a>00203     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4faf8ec29ebb0f3c2fbdd158fd33cdc9">UniquelyHorizontal</a>()) {
<a name="l00204"></a>00204       ++*num_horizontal_blobs;
<a name="l00205"></a>00205       <span class="keywordflow">if</span> (ok_blob) h_it.add_after_then_move(blob);
<a name="l00206"></a>00206     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ok_blob) {
<a name="l00207"></a>00207       n_it.add_after_then_move(blob);
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209   }
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">// Types all the blobs as vertical or horizontal text or unknown and</span>
<a name="l00214"></a>00214 <span class="comment">// returns true if the majority are vertical.</span>
<a name="l00215"></a>00215 <span class="comment">// If the blobs are rotated, it is necessary to call CorrectForRotation</span>
<a name="l00216"></a>00216 <span class="comment">// after rotating everything, otherwise the work done here will be enough.</span>
<a name="l00217"></a>00217 <span class="comment">// If osd_blobs is not null, a list of blobs from the dominant textline</span>
<a name="l00218"></a>00218 <span class="comment">// direction are returned for use in orientation and script detection.</span>
<a name="l00219"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a2db693b25f867e5ac21177353f6abcac">00219</a> <span class="keywordtype">bool</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a2db693b25f867e5ac21177353f6abcac">StrokeWidth::TestVerticalTextDirection</a>(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l00220"></a>00220                                             BLOBNBOX_CLIST* osd_blobs) {
<a name="l00221"></a>00221   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#ac301261d944fad68a80e922f67a02fa6">textord_tabfind_force_vertical_text</a>) <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00222"></a>00222   <span class="keywordflow">if</span> (!<a class="code" href="namespacetesseract.html#af8cfa4b20dc36de190500367d58c1ae5">textord_tabfind_vertical_text</a>) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="keywordtype">int</span> vertical_boxes = 0;
<a name="l00225"></a>00225   <span class="keywordtype">int</span> horizontal_boxes = 0;
<a name="l00226"></a>00226   <span class="comment">// Count vertical normal and large blobs.</span>
<a name="l00227"></a>00227   BLOBNBOX_CLIST vertical_blobs;
<a name="l00228"></a>00228   BLOBNBOX_CLIST horizontal_blobs;
<a name="l00229"></a>00229   BLOBNBOX_CLIST nondescript_blobs;
<a name="l00230"></a>00230   CollectHorizVertBlobs(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>, &amp;vertical_boxes, &amp;horizontal_boxes,
<a name="l00231"></a>00231                         &amp;vertical_blobs, &amp;horizontal_blobs, &amp;nondescript_blobs);
<a name="l00232"></a>00232   CollectHorizVertBlobs(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aafe2a9baa69300ee71da42e6dc18cfee">large_blobs</a>, &amp;vertical_boxes, &amp;horizontal_boxes,
<a name="l00233"></a>00233                         &amp;vertical_blobs, &amp;horizontal_blobs, &amp;nondescript_blobs);
<a name="l00234"></a>00234   <span class="keywordflow">if</span> (<a class="code" href="alignedblob_8cpp.html#ace3f88c2ebef0843236018cd170eea14">textord_debug_tabfind</a>)
<a name="l00235"></a>00235     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;TextDir hbox=%d vs vbox=%d, %dH, %dV, %dN osd blobs\n&quot;</span>,
<a name="l00236"></a>00236             horizontal_boxes, vertical_boxes,
<a name="l00237"></a>00237             horizontal_blobs.length(), vertical_blobs.length(),
<a name="l00238"></a>00238             nondescript_blobs.length());
<a name="l00239"></a>00239   <span class="keywordflow">if</span> (osd_blobs != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; vertical_boxes == 0 &amp;&amp; horizontal_boxes == 0) {
<a name="l00240"></a>00240     <span class="comment">// Only nondescript blobs available, so return those.</span>
<a name="l00241"></a>00241     BLOBNBOX_C_IT osd_it(osd_blobs);
<a name="l00242"></a>00242     osd_it.add_list_after(&amp;nondescript_blobs);
<a name="l00243"></a>00243     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00244"></a>00244   }
<a name="l00245"></a>00245   <span class="keywordtype">int</span> min_vert_boxes = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>((vertical_boxes + horizontal_boxes) *
<a name="l00246"></a>00246                                         <a class="code" href="namespacetesseract.html#a7d8b2088f3354a58c4ebcf648b6cf700">textord_tabfind_vertical_text_ratio</a>);
<a name="l00247"></a>00247   <span class="keywordflow">if</span> (vertical_boxes &gt;= min_vert_boxes) {
<a name="l00248"></a>00248     <span class="keywordflow">if</span> (osd_blobs != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00249"></a>00249       BLOBNBOX_C_IT osd_it(osd_blobs);
<a name="l00250"></a>00250       osd_it.add_list_after(&amp;vertical_blobs);
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00253"></a>00253   } <span class="keywordflow">else</span> {
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (osd_blobs != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00255"></a>00255       BLOBNBOX_C_IT osd_it(osd_blobs);
<a name="l00256"></a>00256       osd_it.add_list_after(&amp;horizontal_blobs);
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00259"></a>00259   }
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 <span class="comment">// Corrects the data structures for the given rotation.</span>
<a name="l00263"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a35f8ebba3622b6777da414ce6679158d">00263</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a35f8ebba3622b6777da414ce6679158d">StrokeWidth::CorrectForRotation</a>(<span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rotation,
<a name="l00264"></a>00264                                      <a class="code" href="classtesseract_1_1_col_partition_grid.html">ColPartitionGrid</a>* part_grid) {
<a name="l00265"></a>00265   <a class="code" href="classtesseract_1_1_b_b_grid.html#a1d2990adf323d7910fbf87b6fc3a7415">Init</a>(part_grid-&gt;<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>(), part_grid-&gt;<a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>(), part_grid-&gt;<a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>());
<a name="l00266"></a>00266   grid_box_ = <a class="code" href="class_t_b_o_x.html">TBOX</a>(<a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>(), <a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>());
<a name="l00267"></a>00267   rerotation_.<a class="code" href="class_f_c_o_o_r_d.html#ae2b7e41fa5e065a9ccbf7358b4911920" title="rewrite function">set_x</a>(rotation.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a>());
<a name="l00268"></a>00268   rerotation_.<a class="code" href="class_f_c_o_o_r_d.html#ad1e9f0d2a1f054f70b6f3036db6afcc0" title="rewrite function">set_y</a>(-rotation.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a>());
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 <span class="comment">// Finds leader partitions and inserts them into the given part_grid.</span>
<a name="l00272"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a8418b53298a0a6b71b8d4c804d48980e">00272</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a8418b53298a0a6b71b8d4c804d48980e">StrokeWidth::FindLeaderPartitions</a>(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l00273"></a>00273                                        <a class="code" href="classtesseract_1_1_col_partition_grid.html">ColPartitionGrid</a>* part_grid) {
<a name="l00274"></a>00274   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00275"></a>00275   <span class="comment">// Find and isolate leaders in the noise list.</span>
<a name="l00276"></a>00276   ColPartition_LIST leader_parts;
<a name="l00277"></a>00277   FindLeadersAndMarkNoise(block, &amp;leader_parts);
<a name="l00278"></a>00278   <span class="comment">// Setup the strokewidth grid with the block&#39;s remaining (non-noise) blobs.</span>
<a name="l00279"></a>00279   <a class="code" href="classtesseract_1_1_blob_grid.html#ae3e2254b403947fc9628221aa3cb5b26">InsertBlobList</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l00280"></a>00280   <span class="comment">// Mark blobs that have leader neighbours.</span>
<a name="l00281"></a>00281   <span class="keywordflow">for</span> (ColPartition_IT it(&amp;leader_parts); !it.empty(); it.forward()) {
<a name="l00282"></a>00282     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.extract();
<a name="l00283"></a>00283     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aa6dd9388e18a33fc48e6410e214e1d17">ClaimBoxes</a>();
<a name="l00284"></a>00284     MarkLeaderNeighbours(part, <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071fa83d27ea7b63eb91b9feed005a2f46ec9">LR_LEFT</a>);
<a name="l00285"></a>00285     MarkLeaderNeighbours(part, <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071facb1914d58c6a7acb6ddb9563a46a1046">LR_RIGHT</a>);
<a name="l00286"></a>00286     part_grid-&gt;<a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00287"></a>00287   }
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a>00290 <span class="comment">// Finds and marks noise those blobs that look like bits of vertical lines</span>
<a name="l00291"></a>00291 <span class="comment">// that would otherwise screw up layout analysis.</span>
<a name="l00292"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a726e68e695eceafbf22602ba8c563c4a">00292</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a726e68e695eceafbf22602ba8c563c4a">StrokeWidth::RemoveLineResidue</a>(ColPartition_LIST* big_part_list) {
<a name="l00293"></a>00293   <a class="code" href="classtesseract_1_1_grid_search.html">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00294"></a>00294   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l00295"></a>00295   <span class="comment">// For every vertical line-like bbox in the grid, search its neighbours</span>
<a name="l00296"></a>00296   <span class="comment">// to find the tallest, and if the original box is taller by sufficient</span>
<a name="l00297"></a>00297   <span class="comment">// margin, then call it line residue and delete it.</span>
<a name="l00298"></a>00298   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00299"></a>00299   <span class="keywordflow">while</span> ((bbox = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00300"></a>00300     <a class="code" href="class_t_b_o_x.html">TBOX</a> box = bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00301"></a>00301     <span class="keywordflow">if</span> (box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &lt; box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() * <a class="code" href="namespacetesseract.html#a84872b3032afddbed37888802b109b56">kLineResidueAspectRatio</a>)
<a name="l00302"></a>00302       <span class="keywordflow">continue</span>;
<a name="l00303"></a>00303     <span class="comment">// Set up a rectangle search around the blob to find the size of its</span>
<a name="l00304"></a>00304     <span class="comment">// neighbours.</span>
<a name="l00305"></a>00305     <span class="keywordtype">int</span> padding = box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() * <a class="code" href="namespacetesseract.html#a1a706351c04a309beaf8be435136baac">kLineResiduePadRatio</a>;
<a name="l00306"></a>00306     <a class="code" href="class_t_b_o_x.html">TBOX</a> search_box = box;
<a name="l00307"></a>00307     search_box.<a class="code" href="class_t_b_o_x.html#ad78f4f7e9746def02b0d2e8e8a2b3ceb">pad</a>(padding, padding);
<a name="l00308"></a>00308     <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l00309"></a>00309                                                box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00310"></a>00310     <span class="comment">// Find the largest object in the search box not equal to bbox.</span>
<a name="l00311"></a>00311     <a class="code" href="classtesseract_1_1_grid_search.html">BlobGridSearch</a> rsearch(<span class="keyword">this</span>);
<a name="l00312"></a>00312     <span class="keywordtype">int</span> max_size = 0;
<a name="l00313"></a>00313     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* n;
<a name="l00314"></a>00314     rsearch.StartRectSearch(search_box);
<a name="l00315"></a>00315     <span class="keywordflow">while</span> ((n = rsearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00316"></a>00316       <span class="keywordflow">if</span> (n == bbox) <span class="keywordflow">continue</span>;
<a name="l00317"></a>00317       <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = n-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00318"></a>00318       <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt; max_size) {
<a name="l00319"></a>00319         max_size = nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l00320"></a>00320       }
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322     <span class="keywordflow">if</span> (debug) {
<a name="l00323"></a>00323       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Max neighbour size=%d for candidate line box at:&quot;</span>, max_size);
<a name="l00324"></a>00324       box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326     <span class="keywordflow">if</span> (max_size * <a class="code" href="namespacetesseract.html#aad875f37920782a2a2e7acedceefb20f">kLineResidueSizeRatio</a> &lt; box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>()) {
<a name="l00327"></a>00327 <span class="preprocessor">      #ifndef GRAPHICS_DISABLED</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (leaders_win_ != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00329"></a>00329         <span class="comment">// We are debugging, so display deleted in pink blobs in the same</span>
<a name="l00330"></a>00330         <span class="comment">// window that we use to display leader detection.</span>
<a name="l00331"></a>00331         leaders_win_-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(<a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8aee71d1b0400315f55f86c9723631a10e">ScrollView::PINK</a>);
<a name="l00332"></a>00332         leaders_win_-&gt;<a class="code" href="class_scroll_view.html#ac2a8fdf5d37967ea4a298dc092b6ed0e">Rectangle</a>(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(),
<a name="l00333"></a>00333                                 box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l00334"></a>00334       }
<a name="l00335"></a>00335 <span class="preprocessor">      #endif  // GRAPHICS_DISABLED</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span>      <a class="code" href="classtesseract_1_1_col_partition.html#a2baab68bca77728c6b50521131dc9b1a">ColPartition::MakeBigPartition</a>(bbox, big_part_list);
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338   }
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="comment">// Types all the blobs as vertical text or horizontal text or unknown and</span>
<a name="l00342"></a>00342 <span class="comment">// puts them into initial ColPartitions in the supplied part_grid.</span>
<a name="l00343"></a>00343 <span class="comment">// rerotation determines how to get back to the image coordinates from the</span>
<a name="l00344"></a>00344 <span class="comment">// blob coordinates (since they may have been rotated for vertical text).</span>
<a name="l00345"></a>00345 <span class="comment">// block is the single block for the whole page or rectangle to be OCRed.</span>
<a name="l00346"></a>00346 <span class="comment">// nontext_pix (full-size), is a binary mask used to prevent merges across</span>
<a name="l00347"></a>00347 <span class="comment">// photo/text boundaries. It is not kept beyond this function.</span>
<a name="l00348"></a>00348 <span class="comment">// denorm provides a mapping back to the image from the current blob</span>
<a name="l00349"></a>00349 <span class="comment">// coordinate space.</span>
<a name="l00350"></a>00350 <span class="comment">// projection provides a measure of textline density over the image and</span>
<a name="l00351"></a>00351 <span class="comment">// provides functions to assist with diacritic detection. It should be a</span>
<a name="l00352"></a>00352 <span class="comment">// pointer to a new TextlineProjection, and will be setup here.</span>
<a name="l00353"></a>00353 <span class="comment">// part_grid is the output grid of textline partitions.</span>
<a name="l00354"></a>00354 <span class="comment">// Large blobs that cause overlap are put in separate partitions and added</span>
<a name="l00355"></a>00355 <span class="comment">// to the big_parts list.</span>
<a name="l00356"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a64cc6e7ab7c16c2181dd1fa09d6c765e">00356</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a64cc6e7ab7c16c2181dd1fa09d6c765e">StrokeWidth::GradeBlobsIntoPartitions</a>(<span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rerotation,
<a name="l00357"></a>00357                                            <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l00358"></a>00358                                            Pix* nontext_pix,
<a name="l00359"></a>00359                                            <span class="keyword">const</span> <a class="code" href="class_d_e_n_o_r_m.html">DENORM</a>* denorm,
<a name="l00360"></a>00360                                            <a class="code" href="classtesseract_1_1_textline_projection.html">TextlineProjection</a>* projection,
<a name="l00361"></a>00361                                            <a class="code" href="classtesseract_1_1_col_partition_grid.html">ColPartitionGrid</a>* part_grid,
<a name="l00362"></a>00362                                            ColPartition_LIST* big_parts) {
<a name="l00363"></a>00363   nontext_map_ = nontext_pix;
<a name="l00364"></a>00364   projection_ = projection;
<a name="l00365"></a>00365   denorm_ = denorm;
<a name="l00366"></a>00366   <span class="comment">// Clear and re Insert to take advantage of the tab stops in the blobs.</span>
<a name="l00367"></a>00367   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00368"></a>00368   <span class="comment">// Setup the strokewidth grid with the remaining non-noise, non-leader blobs.</span>
<a name="l00369"></a>00369   InsertBlobs(block);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371   <span class="comment">// Run FixBrokenCJK() again if the page is rotated and the blobs</span>
<a name="l00372"></a>00372   <span class="comment">// lists are reset and re-flitered, because we may have some new</span>
<a name="l00373"></a>00373   <span class="comment">// blobs in the medium blob list.</span>
<a name="l00374"></a>00374   <span class="keywordflow">if</span> (rerotation_.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a>() != 1.0f || rerotation_.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a>() != 0.0f) {
<a name="l00375"></a>00375     FixBrokenCJK(block);
<a name="l00376"></a>00376   }
<a name="l00377"></a>00377   FindTextlineFlowDirection(<span class="keyword">true</span>);
<a name="l00378"></a>00378   projection_-&gt;<a class="code" href="classtesseract_1_1_textline_projection.html#a813c0b50d88ccb86b6457fdd6bbe66e5">ConstructProjection</a>(block, rerotation, nontext_map_);
<a name="l00379"></a>00379   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>) {
<a name="l00380"></a>00380     <a class="code" href="class_scroll_view.html">ScrollView</a>* line_blobs_win = <a class="code" href="classtesseract_1_1_b_b_grid.html#aa716f76c7f04f7112abfc10a3f8c63e0">MakeWindow</a>(0, 0, <span class="stringliteral">&quot;Initial textline Blobs&quot;</span>);
<a name="l00381"></a>00381     projection_-&gt;<a class="code" href="classtesseract_1_1_textline_projection.html#aac6c563b3b6bc5f903f7c4b0061daf32">PlotGradedBlobs</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>, line_blobs_win);
<a name="l00382"></a>00382     projection_-&gt;<a class="code" href="classtesseract_1_1_textline_projection.html#aac6c563b3b6bc5f903f7c4b0061daf32">PlotGradedBlobs</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ad16b1c18225b44c50674ca46841b0f5f">small_blobs</a>, line_blobs_win);
<a name="l00383"></a>00383   }
<a name="l00384"></a>00384   projection_-&gt;<a class="code" href="classtesseract_1_1_textline_projection.html#af2d55a393da9c25220a8a3ec6ca861d4">MoveNonTextlineBlobs</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>, &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l00385"></a>00385   projection_-&gt;<a class="code" href="classtesseract_1_1_textline_projection.html#af2d55a393da9c25220a8a3ec6ca861d4">MoveNonTextlineBlobs</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ad16b1c18225b44c50674ca46841b0f5f">small_blobs</a>, &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l00386"></a>00386   <span class="comment">// Clear and re Insert to take advantage of the removed diacritics.</span>
<a name="l00387"></a>00387   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00388"></a>00388   InsertBlobs(block);
<a name="l00389"></a>00389   FindInitialPartitions(rerotation, block, part_grid, big_parts);
<a name="l00390"></a>00390   nontext_map_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00391"></a>00391   projection_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00392"></a>00392   denorm_ = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="keyword">static</span> <span class="keywordtype">void</span> PrintBoxWidths(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour) {
<a name="l00396"></a>00396   <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00397"></a>00397   <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Box (%d,%d)-&gt;(%d,%d): h-width=%.1f, v-width=%.1f p-width=%1.f\n&quot;</span>,
<a name="l00398"></a>00398           nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), nbox.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), nbox.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), nbox.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>(),
<a name="l00399"></a>00399           neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a8e76ce198ed496c365844807cbbf9338">horz_stroke_width</a>(), neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a0e0f6b25af6e86fd229bfdc53825dcb9">vert_stroke_width</a>(),
<a name="l00400"></a>00400           2.0 * neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>()-&gt;<a class="code" href="class_c___b_l_o_b.html#af8d6cc72e454c97c5e14d7ccd12925e3">area</a>()/neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>()-&gt;<a class="code" href="class_c___b_l_o_b.html#a7bb48c42dd0ab06ebc1d1bd4936e6252">perimeter</a>());
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00404"></a><a class="code" href="classtesseract_1_1_stroke_width.html#a90b53628c521c80302467b8059fc0a5c">00404</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_stroke_width.html#a90b53628c521c80302467b8059fc0a5c">StrokeWidth::HandleClick</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) {
<a name="l00405"></a>00405   <a class="code" href="classtesseract_1_1_stroke_width.html#a90b53628c521c80302467b8059fc0a5c">BBGrid&lt;BLOBNBOX, BLOBNBOX_CLIST, BLOBNBOX_C_IT&gt;::HandleClick</a>(x, y);
<a name="l00406"></a>00406   <span class="comment">// Run a radial search for blobs that overlap.</span>
<a name="l00407"></a>00407   <a class="code" href="classtesseract_1_1_grid_search.html">BlobGridSearch</a> radsearch(<span class="keyword">this</span>);
<a name="l00408"></a>00408   radsearch.<a class="code" href="classtesseract_1_1_grid_search.html#a2c170fae34250472834f9ed50cfb83db">StartRadSearch</a>(x, y, 1);
<a name="l00409"></a>00409   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour;
<a name="l00410"></a>00410   <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a> click(static_cast&lt;float&gt;(x), static_cast&lt;float&gt;(y));
<a name="l00411"></a>00411   <span class="keywordflow">while</span> ((neighbour = radsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aeed540deb91d38e3cd390d4caf1bd44f">NextRadSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00412"></a>00412     <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00413"></a>00413     <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a5d4e2c5f91b791e94d4c94e513180632">contains</a>(click) &amp;&amp; neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>() != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00414"></a>00414       PrintBoxWidths(neighbour);
<a name="l00415"></a>00415       <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00416"></a>00416         PrintBoxWidths(neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>));
<a name="l00417"></a>00417       <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00418"></a>00418         PrintBoxWidths(neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>));
<a name="l00419"></a>00419       <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00420"></a>00420         PrintBoxWidths(neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>));
<a name="l00421"></a>00421       <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00422"></a>00422         PrintBoxWidths(neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>));
<a name="l00423"></a>00423       <span class="keywordtype">int</span> gaps[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>];
<a name="l00424"></a>00424       neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ab4222cadac89dc2c9675d35cf2170042">NeighbourGaps</a>(gaps);
<a name="l00425"></a>00425       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Left gap=%d, right=%d, above=%d, below=%d, horz=%d, vert=%d\n&quot;</span>
<a name="l00426"></a>00426               <span class="stringliteral">&quot;Good=    %d        %d        %d        %d\n&quot;</span>,
<a name="l00427"></a>00427               gaps[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>], gaps[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>],
<a name="l00428"></a>00428               gaps[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>], gaps[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>],
<a name="l00429"></a>00429               neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9009e27a6c6f2025035170850dcf62c2">horz_possible</a>(),
<a name="l00430"></a>00430               neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4ab21b274ede7a7080d5b2bca8f2c268">vert_possible</a>(),
<a name="l00431"></a>00431               neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ac975a83c42bf7f9e07e06eedea3d67a7">good_stroke_neighbour</a>(BND_LEFT),
<a name="l00432"></a>00432               neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ac975a83c42bf7f9e07e06eedea3d67a7">good_stroke_neighbour</a>(BND_RIGHT),
<a name="l00433"></a>00433               neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ac975a83c42bf7f9e07e06eedea3d67a7">good_stroke_neighbour</a>(BND_ABOVE),
<a name="l00434"></a>00434               neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ac975a83c42bf7f9e07e06eedea3d67a7">good_stroke_neighbour</a>(BND_BELOW));
<a name="l00435"></a>00435       <span class="keywordflow">break</span>;
<a name="l00436"></a>00436     }
<a name="l00437"></a>00437   }
<a name="l00438"></a>00438 }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment">// Detects and marks leader dots/dashes.</span>
<a name="l00441"></a>00441 <span class="comment">//    Leaders are horizontal chains of small or noise blobs that look</span>
<a name="l00442"></a>00442 <span class="comment">//    monospace according to ColPartition::MarkAsLeaderIfMonospaced().</span>
<a name="l00443"></a>00443 <span class="comment">// Detected leaders become the only occupants of the block-&gt;small_blobs list.</span>
<a name="l00444"></a>00444 <span class="comment">// Non-leader small blobs get moved to the blobs list.</span>
<a name="l00445"></a>00445 <span class="comment">// Non-leader noise blobs remain singletons in the noise list.</span>
<a name="l00446"></a>00446 <span class="comment">// All small and noise blobs in high density regions are marked BTFT_NONTEXT.</span>
<a name="l00447"></a>00447 <span class="comment">// block is the single block for the whole page or rectangle to be OCRed.</span>
<a name="l00448"></a>00448 <span class="comment">// leader_parts is the output.</span>
<a name="l00449"></a>00449 <span class="keywordtype">void</span> StrokeWidth::FindLeadersAndMarkNoise(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l00450"></a>00450                                           ColPartition_LIST* leader_parts) {
<a name="l00451"></a>00451   <a class="code" href="classtesseract_1_1_blob_grid.html#ae3e2254b403947fc9628221aa3cb5b26">InsertBlobList</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ad16b1c18225b44c50674ca46841b0f5f">small_blobs</a>);
<a name="l00452"></a>00452   <a class="code" href="classtesseract_1_1_blob_grid.html#ae3e2254b403947fc9628221aa3cb5b26">InsertBlobList</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l00453"></a>00453   <a class="code" href="classtesseract_1_1_grid_search.html">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00454"></a>00454   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l00455"></a>00455   <span class="comment">// For every bbox in the grid, set its neighbours.</span>
<a name="l00456"></a>00456   gsearch.StartFullSearch();
<a name="l00457"></a>00457   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00458"></a>00458     SetNeighbours(<span class="keyword">true</span>, <span class="keyword">false</span>, bbox);
<a name="l00459"></a>00459   }
<a name="l00460"></a>00460   ColPartition_IT part_it(leader_parts);
<a name="l00461"></a>00461   gsearch.StartFullSearch();
<a name="l00462"></a>00462   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00463"></a>00463     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a745b15b1c990fa88c0712c50c5cd2202">BTFT_NONE</a>) {
<a name="l00464"></a>00464       <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>) == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l00465"></a>00465           bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>) == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00466"></a>00466         <span class="keywordflow">continue</span>;
<a name="l00467"></a>00467       <span class="comment">// Put all the linked blobs into a ColPartition.</span>
<a name="l00468"></a>00468       ColPartition* part = <span class="keyword">new</span> ColPartition(<a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>, <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(0, 1));
<a name="l00469"></a>00469       <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob;
<a name="l00470"></a>00470       <span class="keywordflow">for</span> (blob = bbox; blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a745b15b1c990fa88c0712c50c5cd2202">BTFT_NONE</a>;
<a name="l00471"></a>00471            blob = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>))
<a name="l00472"></a>00472         part-&gt;AddBox(blob);
<a name="l00473"></a>00473       <span class="keywordflow">for</span> (blob = bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>); blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l00474"></a>00474            blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a745b15b1c990fa88c0712c50c5cd2202">BTFT_NONE</a>;
<a name="l00475"></a>00475            blob = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>))
<a name="l00476"></a>00476         part-&gt;AddBox(blob);
<a name="l00477"></a>00477       <span class="keywordflow">if</span> (part-&gt;MarkAsLeaderIfMonospaced())
<a name="l00478"></a>00478         part_it.add_after_then_move(part);
<a name="l00479"></a>00479       <span class="keywordflow">else</span>
<a name="l00480"></a>00480         <span class="keyword">delete</span> part;
<a name="l00481"></a>00481     }
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>) {
<a name="l00484"></a>00484     leaders_win_ = DisplayGoodBlobs(<span class="stringliteral">&quot;LeaderNeighbours&quot;</span>, 0, 0);
<a name="l00485"></a>00485   }
<a name="l00486"></a>00486   <span class="comment">// Move any non-leaders from the small to the blobs list, as they are</span>
<a name="l00487"></a>00487   <span class="comment">// most likely dashes or broken characters.</span>
<a name="l00488"></a>00488   BLOBNBOX_IT blob_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l00489"></a>00489   BLOBNBOX_IT small_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ad16b1c18225b44c50674ca46841b0f5f">small_blobs</a>);
<a name="l00490"></a>00490   <span class="keywordflow">for</span> (small_it.mark_cycle_pt(); !small_it.cycled_list(); small_it.forward()) {
<a name="l00491"></a>00491     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = small_it.data();
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a64e3e70c4fac4d4e3facdb4638307d7f">BTFT_LEADER</a>) {
<a name="l00493"></a>00493       <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1adac19762bd040a53914be696482c1e53">BTFT_NEIGHBOURS</a>)
<a name="l00494"></a>00494         blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a75340334988feba52ce36ba596750a35">set_flow</a>(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a745b15b1c990fa88c0712c50c5cd2202">BTFT_NONE</a>);
<a name="l00495"></a>00495       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#acdf3cc39226f3378516956b0e33fa533">ClearNeighbours</a>();
<a name="l00496"></a>00496       blob_it.add_to_end(small_it.extract());
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498   }
<a name="l00499"></a>00499   <span class="comment">// Move leaders from the noise list to the small list, leaving the small</span>
<a name="l00500"></a>00500   <span class="comment">// list exclusively leaders, so they don&#39;t get processed further,</span>
<a name="l00501"></a>00501   <span class="comment">// and the remaining small blobs all in the noise list.</span>
<a name="l00502"></a>00502   BLOBNBOX_IT noise_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l00503"></a>00503   <span class="keywordflow">for</span> (noise_it.mark_cycle_pt(); !noise_it.cycled_list(); noise_it.forward()) {
<a name="l00504"></a>00504     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = noise_it.data();
<a name="l00505"></a>00505     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a64e3e70c4fac4d4e3facdb4638307d7f">BTFT_LEADER</a> || blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#af37f373c72851534101f4caf296a3cf7">joined_to_prev</a>()) {
<a name="l00506"></a>00506       small_it.add_to_end(noise_it.extract());
<a name="l00507"></a>00507     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1adac19762bd040a53914be696482c1e53">BTFT_NEIGHBOURS</a>) {
<a name="l00508"></a>00508       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a75340334988feba52ce36ba596750a35">set_flow</a>(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a745b15b1c990fa88c0712c50c5cd2202">BTFT_NONE</a>);
<a name="l00509"></a>00509       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#acdf3cc39226f3378516956b0e33fa533">ClearNeighbours</a>();
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511   }
<a name="l00512"></a>00512   <span class="comment">// Clear the grid as we don&#39;t want the small stuff hanging around in it.</span>
<a name="l00513"></a>00513   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00518"></a>00518 <span class="keywordtype">void</span> StrokeWidth::InsertBlobs(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l00519"></a>00519   <a class="code" href="classtesseract_1_1_blob_grid.html#ae3e2254b403947fc9628221aa3cb5b26">InsertBlobList</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l00520"></a>00520   <a class="code" href="classtesseract_1_1_blob_grid.html#ae3e2254b403947fc9628221aa3cb5b26">InsertBlobList</a>(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aafe2a9baa69300ee71da42e6dc18cfee">large_blobs</a>);
<a name="l00521"></a>00521 }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 <span class="comment">// Checks the left or right side of the given leader partition and sets the</span>
<a name="l00524"></a>00524 <span class="comment">// (opposite) leader_on_right or leader_on_left flags for blobs</span>
<a name="l00525"></a>00525 <span class="comment">// that are next to the given side of the given leader partition.</span>
<a name="l00526"></a>00526 <span class="keywordtype">void</span> StrokeWidth::MarkLeaderNeighbours(<span class="keyword">const</span> ColPartition* part,
<a name="l00527"></a>00527                                        <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071f">LeftOrRight</a> side) {
<a name="l00528"></a>00528   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;bounding_box();
<a name="l00529"></a>00529   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> blobsearch(<span class="keyword">this</span>);
<a name="l00530"></a>00530   <span class="comment">// Search to the side of the leader for the nearest neighbour.</span>
<a name="l00531"></a>00531   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* best_blob = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00532"></a>00532   <span class="keywordtype">int</span> best_gap = 0;
<a name="l00533"></a>00533   blobsearch.StartSideSearch(side == <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071fa83d27ea7b63eb91b9feed005a2f46ec9">LR_LEFT</a> ? part_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>()
<a name="l00534"></a>00534                                              : part_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(),
<a name="l00535"></a>00535                              part_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), part_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l00536"></a>00536   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob;
<a name="l00537"></a>00537   <span class="keywordflow">while</span> ((blob = blobsearch.NextSideSearch(side == <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071fa83d27ea7b63eb91b9feed005a2f46ec9">LR_LEFT</a>)) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00538"></a>00538     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; blob_box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (!blob_box.<a class="code" href="class_t_b_o_x.html#a7ae8e4b8b3af5b23db3d6c959249064c">y_overlap</a>(part_box))
<a name="l00540"></a>00540       <span class="keywordflow">continue</span>;
<a name="l00541"></a>00541     <span class="keywordtype">int</span> x_gap = blob_box.<a class="code" href="class_t_b_o_x.html#a6c296f134aaae6ee544c4d000d76f80e">x_gap</a>(part_box);
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (x_gap &gt; 2 * <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>()) {
<a name="l00543"></a>00543       <span class="keywordflow">break</span>;
<a name="l00544"></a>00544     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (best_blob == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || x_gap &lt; best_gap) {
<a name="l00545"></a>00545       best_blob = blob;
<a name="l00546"></a>00546       best_gap = x_gap;
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548   }
<a name="l00549"></a>00549   <span class="keywordflow">if</span> (best_blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00550"></a>00550     <span class="keywordflow">if</span> (side == <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071fa83d27ea7b63eb91b9feed005a2f46ec9">LR_LEFT</a>)
<a name="l00551"></a>00551       best_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a0bc3500cc908c86d40c828358063797a">set_leader_on_right</a>(<span class="keyword">true</span>);
<a name="l00552"></a>00552     <span class="keywordflow">else</span>
<a name="l00553"></a>00553       best_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a6e6bb579df4620ecf4a1bdc46bc21d60">set_leader_on_left</a>(<span class="keyword">true</span>);
<a name="l00554"></a>00554 <span class="preprocessor">    #ifndef GRAPHICS_DISABLED</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (leaders_win_ != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00556"></a>00556       leaders_win_-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(side == <a class="code" href="namespacetesseract.html#acd121b57d321ca8511db069f603d071fa83d27ea7b63eb91b9feed005a2f46ec9">LR_LEFT</a> ? <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a0959f7470b08ae1a38aa7e38fba29402">ScrollView::RED</a> : <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a9d8c87be486dead41d198d6b97a22174">ScrollView::GREEN</a>);
<a name="l00557"></a>00557       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; blob_box = best_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00558"></a>00558       leaders_win_-&gt;<a class="code" href="class_scroll_view.html#ac2a8fdf5d37967ea4a298dc092b6ed0e">Rectangle</a>(blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(),
<a name="l00559"></a>00559                               blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), blob_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561 <span class="preprocessor">    #endif  // GRAPHICS_DISABLED</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span>  }
<a name="l00563"></a>00563 }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 <span class="comment">// Helper to compute the UQ of the square-ish CJK charcters.</span>
<a name="l00566"></a>00566 <span class="keyword">static</span> <span class="keywordtype">int</span> UpperQuartileCJKSize(<span class="keywordtype">int</span> gridsize, BLOBNBOX_LIST* blobs) {
<a name="l00567"></a>00567   <a class="code" href="class_s_t_a_t_s.html">STATS</a> sizes(0, gridsize * <a class="code" href="namespacetesseract.html#aa44aa93b17b5967315a229c1b1ed1f31">kMaxCJKSizeRatio</a>);
<a name="l00568"></a>00568   BLOBNBOX_IT it(blobs);
<a name="l00569"></a>00569   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00570"></a>00570     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = it.data();
<a name="l00571"></a>00571     <span class="keywordtype">int</span> width = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>();
<a name="l00572"></a>00572     <span class="keywordtype">int</span> height = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l00573"></a>00573     <span class="keywordflow">if</span> (width &lt;= height * <a class="code" href="namespacetesseract.html#a4569b4a16846b1c45945534463a09e75">kCJKAspectRatio</a> &amp;&amp; height &lt; width * <a class="code" href="namespacetesseract.html#a4569b4a16846b1c45945534463a09e75">kCJKAspectRatio</a>)
<a name="l00574"></a>00574       sizes.add(height, 1);
<a name="l00575"></a>00575   }
<a name="l00576"></a>00576   <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(sizes.ile(0.75<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>) + 0.5);
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="comment">// Fix broken CJK characters, using the fake joined blobs mechanism.</span>
<a name="l00580"></a>00580 <span class="comment">// Blobs are really merged, ie the master takes all the outlines and the</span>
<a name="l00581"></a>00581 <span class="comment">// others are deleted.</span>
<a name="l00582"></a>00582 <span class="comment">// Returns true if sufficient blobs are merged that it may be worth running</span>
<a name="l00583"></a>00583 <span class="comment">// again, due to a better estimate of character size.</span>
<a name="l00584"></a>00584 <span class="keywordtype">bool</span> StrokeWidth::FixBrokenCJK(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l00585"></a>00585   BLOBNBOX_LIST* blobs = &amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>;
<a name="l00586"></a>00586   <span class="keywordtype">int</span> median_height = UpperQuartileCJKSize(<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>(), blobs);
<a name="l00587"></a>00587   <span class="keywordtype">int</span> max_dist = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(median_height * <a class="code" href="namespacetesseract.html#a39569c92bdfdb4178deaac42d588f830">kCJKBrokenDistanceFraction</a>);
<a name="l00588"></a>00588   <span class="keywordtype">int</span> max_size = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(median_height * <a class="code" href="namespacetesseract.html#a4569b4a16846b1c45945534463a09e75">kCJKAspectRatio</a>);
<a name="l00589"></a>00589   <span class="keywordtype">int</span> num_fixed = 0;
<a name="l00590"></a>00590   BLOBNBOX_IT blob_it(blobs);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592   <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00593"></a>00593     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l00594"></a>00594     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>()-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a>()-&gt;empty())
<a name="l00595"></a>00595       <span class="keywordflow">continue</span>;
<a name="l00596"></a>00596     <a class="code" href="class_t_b_o_x.html">TBOX</a> bbox = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00597"></a>00597     <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(3, bbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l00598"></a>00598                                                bbox.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (debug) {
<a name="l00600"></a>00600       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Checking for Broken CJK (max size=%d):&quot;</span>, max_size);
<a name="l00601"></a>00601       bbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603     <span class="comment">// Generate a list of blobs that overlap or are near enough to merge.</span>
<a name="l00604"></a>00604     BLOBNBOX_CLIST overlapped_blobs;
<a name="l00605"></a>00605     AccumulateOverlaps(blob, debug, max_size, max_dist,
<a name="l00606"></a>00606                        &amp;bbox, &amp;overlapped_blobs);
<a name="l00607"></a>00607     <span class="keywordflow">if</span> (!overlapped_blobs.empty()) {
<a name="l00608"></a>00608       <span class="comment">// There are overlapping blobs, so qualify them as being satisfactory</span>
<a name="l00609"></a>00609       <span class="comment">// before removing them from the grid and replacing them with the union.</span>
<a name="l00610"></a>00610       <span class="comment">// The final box must be roughly square.</span>
<a name="l00611"></a>00611       <span class="keywordflow">if</span> (bbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() &gt; bbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() * kCJKAspectRatio ||
<a name="l00612"></a>00612           bbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt; bbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() * <a class="code" href="namespacetesseract.html#a4569b4a16846b1c45945534463a09e75">kCJKAspectRatio</a>) {
<a name="l00613"></a>00613         <span class="keywordflow">if</span> (debug) {
<a name="l00614"></a>00614           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Bad final aspectratio:&quot;</span>);
<a name="l00615"></a>00615           bbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617         <span class="keywordflow">continue</span>;
<a name="l00618"></a>00618       }
<a name="l00619"></a>00619       <span class="comment">// There can&#39;t be too many blobs to merge.</span>
<a name="l00620"></a>00620       <span class="keywordflow">if</span> (overlapped_blobs.length() &gt;= <a class="code" href="namespacetesseract.html#a308c19587dfea876b3291916f10443ec">kCJKMaxComponents</a>) {
<a name="l00621"></a>00621         <span class="keywordflow">if</span> (debug)
<a name="l00622"></a>00622           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Too many neighbours: %d\n&quot;</span>, overlapped_blobs.length());
<a name="l00623"></a>00623         <span class="keywordflow">continue</span>;
<a name="l00624"></a>00624       }
<a name="l00625"></a>00625       <span class="comment">// The strokewidths must match amongst the join candidates.</span>
<a name="l00626"></a>00626       BLOBNBOX_C_IT n_it(&amp;overlapped_blobs);
<a name="l00627"></a>00627       <span class="keywordflow">for</span> (n_it.mark_cycle_pt(); !n_it.cycled_list(); n_it.forward()) {
<a name="l00628"></a>00628         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00629"></a>00629         neighbour = n_it.data();
<a name="l00630"></a>00630         <span class="keywordflow">if</span> (!blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a2f6e04e9e729b577e2b9577983a03016">MatchingStrokeWidth</a>(*neighbour, <a class="code" href="namespacetesseract.html#abd67e80f3588f9bbf627ae8b21494513">kStrokeWidthFractionCJK</a>,
<a name="l00631"></a>00631                                        <a class="code" href="namespacetesseract.html#ad4cf0379178f03e5f1fc982c6e12a7a3">kStrokeWidthCJK</a>))
<a name="l00632"></a>00632           <span class="keywordflow">break</span>;
<a name="l00633"></a>00633       }
<a name="l00634"></a>00634       <span class="keywordflow">if</span> (!n_it.cycled_list()) {
<a name="l00635"></a>00635         <span class="keywordflow">if</span> (debug) {
<a name="l00636"></a>00636           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Bad stroke widths:&quot;</span>);
<a name="l00637"></a>00637           PrintBoxWidths(blob);
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639         <span class="keywordflow">continue</span>;  <span class="comment">// Not good enough.</span>
<a name="l00640"></a>00640       }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642       <span class="comment">// Merge all the candidates into blob.</span>
<a name="l00643"></a>00643       <span class="comment">// We must remove blob from the grid and reinsert it after merging</span>
<a name="l00644"></a>00644       <span class="comment">// to maintain the integrity of the grid.</span>
<a name="l00645"></a>00645       <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(blob);
<a name="l00646"></a>00646       <span class="comment">// Everything else will be calculated later.</span>
<a name="l00647"></a>00647       <span class="keywordflow">for</span> (n_it.mark_cycle_pt(); !n_it.cycled_list(); n_it.forward()) {
<a name="l00648"></a>00648         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour = n_it.data();
<a name="l00649"></a>00649         <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(neighbour);
<a name="l00650"></a>00650         blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a35e6f3923186941c2cd0c12b76be914d">really_merge</a>(neighbour);
<a name="l00651"></a>00651         <span class="keywordflow">if</span> (rerotation_.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a>() != 1.0f || rerotation_.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a>() != 0.0f) {
<a name="l00652"></a>00652           blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3f37300a9cdd252ca74df4a725787587">rotate_box</a>(rerotation_);
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654       }
<a name="l00655"></a>00655       <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, blob);
<a name="l00656"></a>00656       ++num_fixed;
<a name="l00657"></a>00657       <span class="keywordflow">if</span> (debug) {
<a name="l00658"></a>00658         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Done! Final box:&quot;</span>);
<a name="l00659"></a>00659         bbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00660"></a>00660       }
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662   }
<a name="l00663"></a>00663   <span class="comment">// Mark for deletion all the empty shell blobs that contain no outlines.</span>
<a name="l00664"></a>00664   <span class="keywordtype">int</span> num_remaining = 0;
<a name="l00665"></a>00665   <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00666"></a>00666     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l00667"></a>00667     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>()-&gt;<a class="code" href="class_c___b_l_o_b.html#ae510f3d0e7398fbb46608082429eac89">out_list</a>()-&gt;empty()) {
<a name="l00668"></a>00668       <span class="comment">// Mark blob for deletion.</span>
<a name="l00669"></a>00669       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9b58644d9ad4f0d01193f47f55dd884f">set_region_type</a>(<a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a>);
<a name="l00670"></a>00670     } <span class="keywordflow">else</span> {
<a name="l00671"></a>00671       ++num_remaining;
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673   }
<a name="l00674"></a>00674   <span class="comment">// Permanently delete all the marked blobs after first removing all</span>
<a name="l00675"></a>00675   <span class="comment">// references in the neighbour members.</span>
<a name="l00676"></a>00676   block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a9ce3c22594b44b4faad5c331ad0265ea">DeleteUnownedNoise</a>();
<a name="l00677"></a>00677   <span class="keywordflow">return</span> num_fixed &gt; num_remaining * <a class="code" href="namespacetesseract.html#a93725c4be688b102564ecc9ef6642366">kBrokenCJKIterationFraction</a>;
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="comment">// Helper function to determine whether it is reasonable to merge the</span>
<a name="l00681"></a>00681 <span class="comment">// bbox and the nbox for repairing broken CJK.</span>
<a name="l00682"></a>00682 <span class="comment">// The distance apart must not exceed max_dist, the combined size must</span>
<a name="l00683"></a>00683 <span class="comment">// not exceed max_size, and the aspect ratio must either improve or at</span>
<a name="l00684"></a>00684 <span class="comment">// least not get worse by much.</span>
<a name="l00685"></a>00685 <span class="keyword">static</span> <span class="keywordtype">bool</span> AcceptableCJKMerge(<span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; bbox, <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; nbox,
<a name="l00686"></a>00686                                <span class="keywordtype">bool</span> debug, <span class="keywordtype">int</span> max_size, <span class="keywordtype">int</span> max_dist,
<a name="l00687"></a>00687                                <span class="keywordtype">int</span>* x_gap, <span class="keywordtype">int</span>* y_gap) {
<a name="l00688"></a>00688   *x_gap = bbox.<a class="code" href="class_t_b_o_x.html#a6c296f134aaae6ee544c4d000d76f80e">x_gap</a>(nbox);
<a name="l00689"></a>00689   *y_gap = bbox.<a class="code" href="class_t_b_o_x.html#a98e0f9a8622eec475ee93b260c57c7ab">y_gap</a>(nbox);
<a name="l00690"></a>00690   <a class="code" href="class_t_b_o_x.html">TBOX</a> merged(nbox);
<a name="l00691"></a>00691   merged += bbox;
<a name="l00692"></a>00692   <span class="keywordflow">if</span> (debug) {
<a name="l00693"></a>00693     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;gaps = %d, %d, merged_box:&quot;</span>, *x_gap, *y_gap);
<a name="l00694"></a>00694     merged.print();
<a name="l00695"></a>00695   }
<a name="l00696"></a>00696   <span class="keywordflow">if</span> (*x_gap &lt;= max_dist &amp;&amp; *y_gap &lt;= max_dist &amp;&amp;
<a name="l00697"></a>00697       merged.width() &lt;= max_size &amp;&amp; merged.height() &lt;= max_size) {
<a name="l00698"></a>00698     <span class="comment">// Close enough to call overlapping. Check aspect ratios.</span>
<a name="l00699"></a>00699     <span class="keywordtype">double</span> old_ratio = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(bbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>()) / bbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (old_ratio &lt; 1.0) old_ratio = 1.0 / old_ratio;
<a name="l00701"></a>00701     <span class="keywordtype">double</span> new_ratio = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(merged.width()) / merged.height();
<a name="l00702"></a>00702     <span class="keywordflow">if</span> (new_ratio &lt; 1.0) new_ratio = 1.0 / new_ratio;
<a name="l00703"></a>00703     <span class="keywordflow">if</span> (new_ratio &lt;= old_ratio * <a class="code" href="namespacetesseract.html#a62516d3e478bcfb239d046da287150b3">kCJKAspectRatioIncrease</a>)
<a name="l00704"></a>00704       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00705"></a>00705   }
<a name="l00706"></a>00706   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00707"></a>00707 }
<a name="l00708"></a>00708 
<a name="l00709"></a>00709 <span class="comment">// Collect blobs that overlap or are within max_dist of the input bbox.</span>
<a name="l00710"></a>00710 <span class="comment">// Return them in the list of blobs and expand the bbox to be the union</span>
<a name="l00711"></a>00711 <span class="comment">// of all the boxes. not_this is excluded from the search, as are blobs</span>
<a name="l00712"></a>00712 <span class="comment">// that cause the merged box to exceed max_size in either dimension.</span>
<a name="l00713"></a>00713 <span class="keywordtype">void</span> StrokeWidth::AccumulateOverlaps(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* not_this, <span class="keywordtype">bool</span> debug,
<a name="l00714"></a>00714                                      <span class="keywordtype">int</span> max_size, <span class="keywordtype">int</span> max_dist,
<a name="l00715"></a>00715                                      <a class="code" href="class_t_b_o_x.html">TBOX</a>* bbox, BLOBNBOX_CLIST* blobs) {
<a name="l00716"></a>00716   <span class="comment">// While searching, nearests holds the nearest failed blob in each</span>
<a name="l00717"></a>00717   <span class="comment">// direction. When we have a nearest in each of the 4 directions, then</span>
<a name="l00718"></a>00718   <span class="comment">// the search is over, and at this point the final bbox must not overlap</span>
<a name="l00719"></a>00719   <span class="comment">// any of the nearests.</span>
<a name="l00720"></a>00720   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* nearests[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>];
<a name="l00721"></a>00721   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++i) {
<a name="l00722"></a>00722     nearests[i] = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00723"></a>00723   }
<a name="l00724"></a>00724   <span class="keywordtype">int</span> x = (bbox-&gt;<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + bbox-&gt;<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>()) / 2;
<a name="l00725"></a>00725   <span class="keywordtype">int</span> y = (bbox-&gt;<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() + bbox-&gt;<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>()) / 2;
<a name="l00726"></a>00726   <span class="comment">// Run a radial search for blobs that overlap or are sufficiently close.</span>
<a name="l00727"></a>00727   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> radsearch(<span class="keyword">this</span>);
<a name="l00728"></a>00728   radsearch.StartRadSearch(x, y, <a class="code" href="namespacetesseract.html#a73ac9428eb90511e5627135347d561e2">kCJKRadius</a>);
<a name="l00729"></a>00729   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour;
<a name="l00730"></a>00730   <span class="keywordflow">while</span> ((neighbour = radsearch.NextRadSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (neighbour == not_this) <span class="keywordflow">continue</span>;
<a name="l00732"></a>00732     <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00733"></a>00733     <span class="keywordtype">int</span> x_gap, y_gap;
<a name="l00734"></a>00734     <span class="keywordflow">if</span> (AcceptableCJKMerge(*bbox, nbox, debug, max_size, max_dist,
<a name="l00735"></a>00735                            &amp;x_gap, &amp;y_gap)) {
<a name="l00736"></a>00736       <span class="comment">// Close enough to call overlapping. Merge boxes.</span>
<a name="l00737"></a>00737       *bbox += nbox;
<a name="l00738"></a>00738       blobs-&gt;add_sorted(SortByBoxLeft&lt;BLOBNBOX&gt;, <span class="keyword">true</span>, neighbour);
<a name="l00739"></a>00739       <span class="keywordflow">if</span> (debug) {
<a name="l00740"></a>00740         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Added:&quot;</span>);
<a name="l00741"></a>00741         nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00742"></a>00742       }
<a name="l00743"></a>00743       <span class="comment">// Since we merged, search the nearests, as some might now me mergeable.</span>
<a name="l00744"></a>00744       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++dir) {
<a name="l00745"></a>00745         <span class="keywordflow">if</span> (nearests[dir] == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l00746"></a>00746         nbox = nearests[dir]-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00747"></a>00747         <span class="keywordflow">if</span> (AcceptableCJKMerge(*bbox, nbox, debug, max_size,
<a name="l00748"></a>00748                                max_dist, &amp;x_gap, &amp;y_gap)) {
<a name="l00749"></a>00749           <span class="comment">// Close enough to call overlapping. Merge boxes.</span>
<a name="l00750"></a>00750           *bbox += nbox;
<a name="l00751"></a>00751           blobs-&gt;add_sorted(SortByBoxLeft&lt;BLOBNBOX&gt;, <span class="keyword">true</span>, nearests[dir]);
<a name="l00752"></a>00752           <span class="keywordflow">if</span> (debug) {
<a name="l00753"></a>00753             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Added:&quot;</span>);
<a name="l00754"></a>00754             nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00755"></a>00755           }
<a name="l00756"></a>00756           nearests[dir] = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00757"></a>00757           dir = -1;  <span class="comment">// Restart the search.</span>
<a name="l00758"></a>00758         }
<a name="l00759"></a>00759       }
<a name="l00760"></a>00760     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x_gap &lt; 0 &amp;&amp; x_gap &lt;= y_gap) {
<a name="l00761"></a>00761       <span class="comment">// A vertical neighbour. Record the nearest.</span>
<a name="l00762"></a>00762       <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> dir = nbox.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>() &gt; bbox-&gt;<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>() ? <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a> : <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>;
<a name="l00763"></a>00763       <span class="keywordflow">if</span> (nearests[dir] == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l00764"></a>00764           y_gap &lt; bbox-&gt;y_gap(nearests[dir]-&gt;bounding_box())) {
<a name="l00765"></a>00765         nearests[dir] = neighbour;
<a name="l00766"></a>00766       }
<a name="l00767"></a>00767     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (y_gap &lt; 0 &amp;&amp; y_gap &lt;= x_gap) {
<a name="l00768"></a>00768       <span class="comment">// A horizontal neighbour. Record the nearest.</span>
<a name="l00769"></a>00769       <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> dir = nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() &gt; bbox-&gt;<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() ? <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a> : <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>;
<a name="l00770"></a>00770       <span class="keywordflow">if</span> (nearests[dir] == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l00771"></a>00771           x_gap &lt; bbox-&gt;x_gap(nearests[dir]-&gt;bounding_box())) {
<a name="l00772"></a>00772         nearests[dir] = neighbour;
<a name="l00773"></a>00773       }
<a name="l00774"></a>00774     }
<a name="l00775"></a>00775     <span class="comment">// If all nearests are non-null, then we have finished.</span>
<a name="l00776"></a>00776     <span class="keywordflow">if</span> (nearests[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>] &amp;&amp; nearests[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>] &amp;&amp;
<a name="l00777"></a>00777         nearests[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>] &amp;&amp; nearests[<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>])
<a name="l00778"></a>00778       <span class="keywordflow">break</span>;
<a name="l00779"></a>00779   }
<a name="l00780"></a>00780   <span class="comment">// Final overlap with a nearest is not allowed.</span>
<a name="l00781"></a>00781   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++dir) {
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (nearests[dir] == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) <span class="keywordflow">continue</span>;
<a name="l00783"></a>00783     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; nbox = nearests[dir]-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (debug) {
<a name="l00785"></a>00785       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Testing for overlap with:&quot;</span>);
<a name="l00786"></a>00786       nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_t_b_o_x.html#adcc7d2858ccb61cd715dbcff32bd5582">overlap</a>(nbox)) {
<a name="l00789"></a>00789       blobs-&gt;shallow_clear();
<a name="l00790"></a>00790       <span class="keywordflow">if</span> (debug)
<a name="l00791"></a>00791         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Final box overlaps nearest\n&quot;</span>);
<a name="l00792"></a>00792       <span class="keywordflow">return</span>;
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794   }
<a name="l00795"></a>00795 }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 <span class="comment">// For each blob in this grid, Finds the textline direction to be horizontal</span>
<a name="l00798"></a>00798 <span class="comment">// or vertical according to distance to neighbours and 1st and 2nd order</span>
<a name="l00799"></a>00799 <span class="comment">// neighbours. Non-text tends to end up without a definite direction.</span>
<a name="l00800"></a>00800 <span class="comment">// Result is setting of the neighbours and vert_possible/horz_possible</span>
<a name="l00801"></a>00801 <span class="comment">// flags in the BLOBNBOXes currently in this grid.</span>
<a name="l00802"></a>00802 <span class="comment">// This function is called more than once if page orientation is uncertain,</span>
<a name="l00803"></a>00803 <span class="comment">// so display_if_debugging is true on the final call to display the results.</span>
<a name="l00804"></a>00804 <span class="keywordtype">void</span> StrokeWidth::FindTextlineFlowDirection(<span class="keywordtype">bool</span> display_if_debugging) {
<a name="l00805"></a>00805   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00806"></a>00806   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l00807"></a>00807   <span class="comment">// For every bbox in the grid, set its neighbours.</span>
<a name="l00808"></a>00808   gsearch.StartFullSearch();
<a name="l00809"></a>00809   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00810"></a>00810     SetNeighbours(<span class="keyword">false</span>, display_if_debugging, bbox);
<a name="l00811"></a>00811   }
<a name="l00812"></a>00812   <span class="comment">// Where vertical or horizontal wins by a big margin, clarify it.</span>
<a name="l00813"></a>00813   gsearch.StartFullSearch();
<a name="l00814"></a>00814   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00815"></a>00815     SimplifyObviousNeighbours(bbox);
<a name="l00816"></a>00816   }
<a name="l00817"></a>00817   <span class="comment">// Now try to make the blobs only vertical or horizontal using neighbours.</span>
<a name="l00818"></a>00818   gsearch.StartFullSearch();
<a name="l00819"></a>00819   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00820"></a>00820     SetNeighbourFlows(bbox);
<a name="l00821"></a>00821   }
<a name="l00822"></a>00822   <span class="keywordflow">if</span> ((<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>  &amp;&amp; display_if_debugging) ||
<a name="l00823"></a>00823       <a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a> &gt; 1) {
<a name="l00824"></a>00824     initial_widths_win_ = DisplayGoodBlobs(<span class="stringliteral">&quot;InitialStrokewidths&quot;</span>, 400, 0);
<a name="l00825"></a>00825   }
<a name="l00826"></a>00826   <span class="comment">// Improve flow direction with neighbours.</span>
<a name="l00827"></a>00827   gsearch.StartFullSearch();
<a name="l00828"></a>00828   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00829"></a>00829     SmoothNeighbourTypes(bbox, <span class="keyword">false</span>);
<a name="l00830"></a>00830   }
<a name="l00831"></a>00831   <span class="comment">// Now allow reset of firm values to fix renegades.</span>
<a name="l00832"></a>00832   gsearch.StartFullSearch();
<a name="l00833"></a>00833   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00834"></a>00834     SmoothNeighbourTypes(bbox, <span class="keyword">true</span>);
<a name="l00835"></a>00835   }
<a name="l00836"></a>00836   <span class="comment">// Repeat.</span>
<a name="l00837"></a>00837   gsearch.StartFullSearch();
<a name="l00838"></a>00838   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00839"></a>00839     SmoothNeighbourTypes(bbox, <span class="keyword">true</span>);
<a name="l00840"></a>00840   }
<a name="l00841"></a>00841   <span class="keywordflow">if</span> ((<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>  &amp;&amp; display_if_debugging) ||
<a name="l00842"></a>00842       <a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a> &gt; 1) {
<a name="l00843"></a>00843     widths_win_ = DisplayGoodBlobs(<span class="stringliteral">&quot;ImprovedStrokewidths&quot;</span>, 800, 0);
<a name="l00844"></a>00844   }
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="comment">// Sets the neighbours and good_stroke_neighbours members of the blob by</span>
<a name="l00848"></a>00848 <span class="comment">// searching close on all 4 sides.</span>
<a name="l00849"></a>00849 <span class="comment">// When finding leader dots/dashes, there is a slightly different rule for</span>
<a name="l00850"></a>00850 <span class="comment">// what makes a good neighbour.</span>
<a name="l00851"></a>00851 <span class="keywordtype">void</span> StrokeWidth::SetNeighbours(<span class="keywordtype">bool</span> leaders, <span class="keywordtype">bool</span> activate_line_trap,
<a name="l00852"></a>00852                                 <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob) {
<a name="l00853"></a>00853   <span class="keywordtype">int</span> line_trap_count = 0;
<a name="l00854"></a>00854   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++dir) {
<a name="l00855"></a>00855     <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> bnd = <span class="keyword">static_cast&lt;</span><a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a><span class="keyword">&gt;</span>(dir);
<a name="l00856"></a>00856     line_trap_count += FindGoodNeighbour(bnd, leaders, blob);
<a name="l00857"></a>00857   }
<a name="l00858"></a>00858   <span class="keywordflow">if</span> (line_trap_count &gt; 0 &amp;&amp; activate_line_trap) {
<a name="l00859"></a>00859     <span class="comment">// It looks like a line so isolate it by clearing its neighbours.</span>
<a name="l00860"></a>00860     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#acdf3cc39226f3378516956b0e33fa533">ClearNeighbours</a>();
<a name="l00861"></a>00861     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00862"></a>00862     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9b58644d9ad4f0d01193f47f55dd884f">set_region_type</a>(box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() &gt; box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() ? <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a56cc149e97b34634dd39babda79ea17d">BRT_HLINE</a> : <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a5d6cbdd0674e727feda3085026646f6a">BRT_VLINE</a>);
<a name="l00863"></a>00863   }
<a name="l00864"></a>00864 }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 
<a name="l00867"></a>00867 <span class="comment">// Sets the good_stroke_neighbours member of the blob if it has a</span>
<a name="l00868"></a>00868 <span class="comment">// GoodNeighbour on the given side.</span>
<a name="l00869"></a>00869 <span class="comment">// Also sets the neighbour in the blob, whether or not a good one is found.</span>
<a name="l00870"></a>00870 <span class="comment">// Returns the number of blobs in the nearby search area that would lead us to</span>
<a name="l00871"></a>00871 <span class="comment">// believe that this blob is a line separator.</span>
<a name="l00872"></a>00872 <span class="comment">// Leaders get extra special lenient treatment.</span>
<a name="l00873"></a>00873 <span class="keywordtype">int</span> StrokeWidth::FindGoodNeighbour(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> dir, <span class="keywordtype">bool</span> leaders,
<a name="l00874"></a>00874                                    <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob) {
<a name="l00875"></a>00875   <span class="comment">// Search for neighbours that overlap vertically.</span>
<a name="l00876"></a>00876   <a class="code" href="class_t_b_o_x.html">TBOX</a> blob_box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00877"></a>00877   <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l00878"></a>00878                                              blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00879"></a>00879   <span class="keywordflow">if</span> (debug) {
<a name="l00880"></a>00880     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;FGN in dir %d for blob:&quot;</span>, dir);
<a name="l00881"></a>00881     blob_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00882"></a>00882   }
<a name="l00883"></a>00883   <span class="keywordtype">int</span> top = blob_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>();
<a name="l00884"></a>00884   <span class="keywordtype">int</span> bottom = blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>();
<a name="l00885"></a>00885   <span class="keywordtype">int</span> left = blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>();
<a name="l00886"></a>00886   <span class="keywordtype">int</span> right = blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>();
<a name="l00887"></a>00887   <span class="keywordtype">int</span> width = right - left;
<a name="l00888"></a>00888   <span class="keywordtype">int</span> height = top - bottom;
<a name="l00889"></a>00889 
<a name="l00890"></a>00890   <span class="comment">// A trap to detect lines tests for the min dimension of neighbours</span>
<a name="l00891"></a>00891   <span class="comment">// being larger than a multiple of the min dimension of the line</span>
<a name="l00892"></a>00892   <span class="comment">// and the larger dimension being smaller than a fraction of the max</span>
<a name="l00893"></a>00893   <span class="comment">// dimension of the line.</span>
<a name="l00894"></a>00894   <span class="keywordtype">int</span> line_trap_max = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(width, height) / <a class="code" href="namespacetesseract.html#a3d9a4df05c442729540b7459fbec462c">kLineTrapLongest</a>;
<a name="l00895"></a>00895   <span class="keywordtype">int</span> line_trap_min = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(width, height) * <a class="code" href="namespacetesseract.html#ab34b32a5ea90db86801786f0f8a83997">kLineTrapShortest</a>;
<a name="l00896"></a>00896   <span class="keywordtype">int</span> line_trap_count = 0;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898   <span class="keywordtype">int</span> min_good_overlap = (dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a> || dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>)
<a name="l00899"></a>00899                        ? height / 2 : width / 2;
<a name="l00900"></a>00900   <span class="keywordtype">int</span> min_decent_overlap = (dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a> || dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>)
<a name="l00901"></a>00901                        ? height / 3 : width / 3;
<a name="l00902"></a>00902   <span class="keywordflow">if</span> (leaders)
<a name="l00903"></a>00903     min_good_overlap = min_decent_overlap = 1;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905   <span class="keywordtype">int</span> search_pad = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(
<a name="l00906"></a>00906       sqrt(static_cast&lt;double&gt;(width * height)) * <a class="code" href="namespacetesseract.html#a746b69b4c2ec2f296100ebfaf15b2e2b">kNeighbourSearchFactor</a>);
<a name="l00907"></a>00907   <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() &gt; search_pad)
<a name="l00908"></a>00908     search_pad = <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>();
<a name="l00909"></a>00909   <a class="code" href="class_t_b_o_x.html">TBOX</a> search_box = blob_box;
<a name="l00910"></a>00910   <span class="comment">// Pad the search in the appropriate direction.</span>
<a name="l00911"></a>00911   <span class="keywordflow">switch</span> (dir) {
<a name="l00912"></a>00912   <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>:
<a name="l00913"></a>00913     search_box.<a class="code" href="class_t_b_o_x.html#ae6151cd794841e100d8a346a0c4a46e6">set_left</a>(search_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() - search_pad);
<a name="l00914"></a>00914     <span class="keywordflow">break</span>;
<a name="l00915"></a>00915   <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>:
<a name="l00916"></a>00916     search_box.<a class="code" href="class_t_b_o_x.html#a2246293d3667b28c52a52353a2d5caea">set_right</a>(search_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() + search_pad);
<a name="l00917"></a>00917     <span class="keywordflow">break</span>;
<a name="l00918"></a>00918   <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>:
<a name="l00919"></a>00919     search_box.<a class="code" href="class_t_b_o_x.html#a6f803b24b046883cb0f3882dc3d92302">set_bottom</a>(search_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() - search_pad);
<a name="l00920"></a>00920     <span class="keywordflow">break</span>;
<a name="l00921"></a>00921   <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>:
<a name="l00922"></a>00922     search_box.<a class="code" href="class_t_b_o_x.html#a7f40dfd290a907200bdc98c196f63f45">set_top</a>(search_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>() + search_pad);
<a name="l00923"></a>00923     <span class="keywordflow">break</span>;
<a name="l00924"></a>00924   <span class="keywordflow">case</span> BND_COUNT:
<a name="l00925"></a>00925     <span class="keywordflow">return</span> 0;
<a name="l00926"></a>00926   }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> rectsearch(<span class="keyword">this</span>);
<a name="l00929"></a>00929   rectsearch.StartRectSearch(search_box);
<a name="l00930"></a>00930   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* best_neighbour = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00931"></a>00931   <span class="keywordtype">double</span> best_goodness = 0.0;
<a name="l00932"></a>00932   <span class="keywordtype">bool</span> best_is_good = <span class="keyword">false</span>;
<a name="l00933"></a>00933   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour;
<a name="l00934"></a>00934   <span class="keywordflow">while</span> ((neighbour = rectsearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00935"></a>00935     <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l00936"></a>00936     <span class="keywordflow">if</span> (neighbour == blob)
<a name="l00937"></a>00937       <span class="keywordflow">continue</span>;
<a name="l00938"></a>00938     <span class="keywordtype">int</span> mid_x = (nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + nbox.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>()) / 2;
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (mid_x &lt; blob-&gt;left_rule() || mid_x &gt; blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9b323abfc9e7e03a3edccab8f725315b">right_rule</a>())
<a name="l00940"></a>00940       <span class="keywordflow">continue</span>;  <span class="comment">// In a different column.</span>
<a name="l00941"></a>00941     <span class="keywordflow">if</span> (debug) {
<a name="l00942"></a>00942       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Neighbour at:&quot;</span>);
<a name="l00943"></a>00943       nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00944"></a>00944     }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946     <span class="comment">// Last-minute line detector. There is a small upper limit to the line</span>
<a name="l00947"></a>00947     <span class="comment">// width accepted by the morphological line detector.</span>
<a name="l00948"></a>00948     <span class="keywordtype">int</span> n_width = nbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>();
<a name="l00949"></a>00949     <span class="keywordtype">int</span> n_height = nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l00950"></a>00950     <span class="keywordflow">if</span> (<a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(n_width, n_height) &gt; line_trap_min &amp;&amp;
<a name="l00951"></a>00951         <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(n_width, n_height) &lt; line_trap_max)
<a name="l00952"></a>00952       ++line_trap_count;
<a name="l00953"></a>00953     <span class="comment">// Heavily joined text, such as Arabic may have very different sizes when</span>
<a name="l00954"></a>00954     <span class="comment">// looking at the maxes, but the heights may be almost identical, so check</span>
<a name="l00955"></a>00955     <span class="comment">// for a difference in height if looking sideways or width vertically.</span>
<a name="l00956"></a>00956     <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_tab_find.html#a924f574abbd5ef84e96bb3cffc6fe4b4">TabFind::VeryDifferentSizes</a>(<a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(n_width, n_height),
<a name="l00957"></a>00957                                     <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(width, height)) &amp;&amp;
<a name="l00958"></a>00958         (((dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a> || dir ==<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>) &amp;&amp;
<a name="l00959"></a>00959             <a class="code" href="classtesseract_1_1_tab_find.html#a386ab5331aecfd3bf73b9dfdc5d23b57">TabFind::DifferentSizes</a>(n_height, height)) ||
<a name="l00960"></a>00960          ((dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a> || dir ==<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>) &amp;&amp;
<a name="l00961"></a>00961              <a class="code" href="classtesseract_1_1_tab_find.html#a386ab5331aecfd3bf73b9dfdc5d23b57">TabFind::DifferentSizes</a>(n_width, width)))) {
<a name="l00962"></a>00962       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Bad size\n&quot;</span>);
<a name="l00963"></a>00963       <span class="keywordflow">continue</span>;  <span class="comment">// Could be a different font size or non-text.</span>
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965     <span class="comment">// Amount of vertical overlap between the blobs.</span>
<a name="l00966"></a>00966     <span class="keywordtype">int</span> overlap;
<a name="l00967"></a>00967     <span class="comment">// If the overlap is along the short side of the neighbour, and it</span>
<a name="l00968"></a>00968     <span class="comment">// is fully overlapped, then perp_overlap holds the length of the long</span>
<a name="l00969"></a>00969     <span class="comment">// side of the neighbour. A measure to include hyphens and dashes as</span>
<a name="l00970"></a>00970     <span class="comment">// legitimate neighbours.</span>
<a name="l00971"></a>00971     <span class="keywordtype">int</span> perp_overlap;
<a name="l00972"></a>00972     <span class="keywordtype">int</span> gap;
<a name="l00973"></a>00973     <span class="keywordflow">if</span> (dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a> || dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>) {
<a name="l00974"></a>00974       overlap = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(nbox.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>(), top) - <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(nbox.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), bottom);
<a name="l00975"></a>00975       <span class="keywordflow">if</span> (overlap == nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &amp;&amp; nbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() &gt; nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>())
<a name="l00976"></a>00976         perp_overlap = nbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>();
<a name="l00977"></a>00977       <span class="keywordflow">else</span>
<a name="l00978"></a>00978         perp_overlap = overlap;
<a name="l00979"></a>00979       gap = dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a> ? left - nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() : nbox.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() - right;
<a name="l00980"></a>00980       <span class="keywordflow">if</span> (gap &lt;= 0) {
<a name="l00981"></a>00981         <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;On wrong side\n&quot;</span>);
<a name="l00982"></a>00982         <span class="keywordflow">continue</span>;  <span class="comment">// On the wrong side.</span>
<a name="l00983"></a>00983       }
<a name="l00984"></a>00984       gap -= n_width;
<a name="l00985"></a>00985     } <span class="keywordflow">else</span> {
<a name="l00986"></a>00986       overlap = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(nbox.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), right) - <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), left);
<a name="l00987"></a>00987       <span class="keywordflow">if</span> (overlap == nbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() &amp;&amp; nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt; nbox.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>())
<a name="l00988"></a>00988         perp_overlap = nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l00989"></a>00989       <span class="keywordflow">else</span>
<a name="l00990"></a>00990         perp_overlap = overlap;
<a name="l00991"></a>00991       gap = dir == <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a> ? bottom - nbox.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() : nbox.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>() - top;
<a name="l00992"></a>00992       <span class="keywordflow">if</span> (gap &lt;= 0) {
<a name="l00993"></a>00993         <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;On wrong side\n&quot;</span>);
<a name="l00994"></a>00994         <span class="keywordflow">continue</span>;  <span class="comment">// On the wrong side.</span>
<a name="l00995"></a>00995       }
<a name="l00996"></a>00996       gap -= n_height;
<a name="l00997"></a>00997     }
<a name="l00998"></a>00998     <span class="keywordflow">if</span> (-gap &gt; overlap) {
<a name="l00999"></a>00999       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Overlaps wrong way\n&quot;</span>);
<a name="l01000"></a>01000       <span class="keywordflow">continue</span>;  <span class="comment">// Overlaps the wrong way.</span>
<a name="l01001"></a>01001     }
<a name="l01002"></a>01002     <span class="keywordflow">if</span> (perp_overlap &lt; min_decent_overlap) {
<a name="l01003"></a>01003       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Doesn&#39;t overlap enough\n&quot;</span>);
<a name="l01004"></a>01004       <span class="keywordflow">continue</span>;  <span class="comment">// Doesn&#39;t overlap enough.</span>
<a name="l01005"></a>01005     }
<a name="l01006"></a>01006     <span class="keywordtype">bool</span> bad_sizes = <a class="code" href="classtesseract_1_1_tab_find.html#a386ab5331aecfd3bf73b9dfdc5d23b57">TabFind::DifferentSizes</a>(height, n_height) &amp;&amp;
<a name="l01007"></a>01007                      <a class="code" href="classtesseract_1_1_tab_find.html#a386ab5331aecfd3bf73b9dfdc5d23b57">TabFind::DifferentSizes</a>(width, n_width);
<a name="l01008"></a>01008     <span class="keywordtype">bool</span> is_good = overlap &gt;= min_good_overlap &amp;&amp; !bad_sizes &amp;&amp;
<a name="l01009"></a>01009                    blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a2f6e04e9e729b577e2b9577983a03016">MatchingStrokeWidth</a>(*neighbour,
<a name="l01010"></a>01010                                              <a class="code" href="namespacetesseract.html#abc28700fa5d19f82a78db318450d7786">kStrokeWidthFractionTolerance</a>,
<a name="l01011"></a>01011                                              <a class="code" href="namespacetesseract.html#a5d1f89502955a97f3986e480f45d11ac">kStrokeWidthTolerance</a>);
<a name="l01012"></a>01012     <span class="comment">// Best is a fuzzy combination of gap, overlap and is good.</span>
<a name="l01013"></a>01013     <span class="comment">// Basically if you make one thing twice as good without making</span>
<a name="l01014"></a>01014     <span class="comment">// anything else twice as bad, then it is better.</span>
<a name="l01015"></a>01015     <span class="keywordflow">if</span> (gap &lt; 1) gap = 1;
<a name="l01016"></a>01016     <span class="keywordtype">double</span> goodness = (1.0 + is_good) * overlap / gap;
<a name="l01017"></a>01017     <span class="keywordflow">if</span> (debug) {
<a name="l01018"></a>01018       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;goodness = %g vs best of %g, good=%d, overlap=%d, gap=%d\n&quot;</span>,
<a name="l01019"></a>01019               goodness, best_goodness, is_good, overlap, gap);
<a name="l01020"></a>01020     }
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (goodness &gt; best_goodness) {
<a name="l01022"></a>01022       best_neighbour = neighbour;
<a name="l01023"></a>01023       best_goodness = goodness;
<a name="l01024"></a>01024       best_is_good = is_good;
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026   }
<a name="l01027"></a>01027   blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(dir, best_neighbour, best_is_good);
<a name="l01028"></a>01028   <span class="keywordflow">return</span> line_trap_count;
<a name="l01029"></a>01029 }
<a name="l01030"></a>01030 
<a name="l01031"></a>01031 <span class="comment">// Helper to get a list of 1st-order neighbours.</span>
<a name="l01032"></a>01032 <span class="keyword">static</span> <span class="keywordtype">void</span> ListNeighbours(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob,
<a name="l01033"></a>01033                            BLOBNBOX_CLIST* neighbours) {
<a name="l01034"></a>01034   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++dir) {
<a name="l01035"></a>01035     <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> bnd = <span class="keyword">static_cast&lt;</span><a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a><span class="keyword">&gt;</span>(dir);
<a name="l01036"></a>01036     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(bnd);
<a name="l01037"></a>01037     <span class="keywordflow">if</span> (neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01038"></a>01038       neighbours-&gt;add_sorted(SortByBoxLeft&lt;BLOBNBOX&gt;, <span class="keyword">true</span>, neighbour);
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040   }
<a name="l01041"></a>01041 }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043 <span class="comment">// Helper to get a list of 1st and 2nd order neighbours.</span>
<a name="l01044"></a>01044 <span class="keyword">static</span> <span class="keywordtype">void</span> List2ndNeighbours(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob,
<a name="l01045"></a>01045                               BLOBNBOX_CLIST* neighbours) {
<a name="l01046"></a>01046   ListNeighbours(blob, neighbours);
<a name="l01047"></a>01047   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++dir) {
<a name="l01048"></a>01048     <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> bnd = <span class="keyword">static_cast&lt;</span><a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a><span class="keyword">&gt;</span>(dir);
<a name="l01049"></a>01049     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(bnd);
<a name="l01050"></a>01050     <span class="keywordflow">if</span> (neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01051"></a>01051       ListNeighbours(neighbour, neighbours);
<a name="l01052"></a>01052     }
<a name="l01053"></a>01053   }
<a name="l01054"></a>01054 }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 <span class="comment">// Helper to get a list of 1st, 2nd and 3rd order neighbours.</span>
<a name="l01057"></a>01057 <span class="keyword">static</span> <span class="keywordtype">void</span> List3rdNeighbours(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob,
<a name="l01058"></a>01058                               BLOBNBOX_CLIST* neighbours) {
<a name="l01059"></a>01059   List2ndNeighbours(blob, neighbours);
<a name="l01060"></a>01060   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dir = 0; dir &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++dir) {
<a name="l01061"></a>01061     <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> bnd = <span class="keyword">static_cast&lt;</span><a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a><span class="keyword">&gt;</span>(dir);
<a name="l01062"></a>01062     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(bnd);
<a name="l01063"></a>01063     <span class="keywordflow">if</span> (neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01064"></a>01064       List2ndNeighbours(neighbour, neighbours);
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066   }
<a name="l01067"></a>01067 }
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 <span class="comment">// Helper to count the evidence for verticalness or horizontalness</span>
<a name="l01070"></a>01070 <span class="comment">// in a list of neighbours.</span>
<a name="l01071"></a>01071 <span class="keyword">static</span> <span class="keywordtype">void</span> CountNeighbourGaps(<span class="keywordtype">bool</span> debug, BLOBNBOX_CLIST* neighbours,
<a name="l01072"></a>01072                                <span class="keywordtype">int</span>* pure_h_count, <span class="keywordtype">int</span>* pure_v_count) {
<a name="l01073"></a>01073   <span class="keywordflow">if</span> (neighbours-&gt;length() &lt;= <a class="code" href="namespacetesseract.html#afba5db6e43d5f018b1c6bb6dfa43e488">kMostlyOneDirRatio</a>)
<a name="l01074"></a>01074     <span class="keywordflow">return</span>;
<a name="l01075"></a>01075   BLOBNBOX_C_IT it(neighbours);
<a name="l01076"></a>01076   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l01077"></a>01077     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = it.data();
<a name="l01078"></a>01078     <span class="keywordtype">int</span> h_min, h_max, v_min, v_max;
<a name="l01079"></a>01079     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a5f17b374b3a0e8b547d1a41e43054ee2">MinMaxGapsClipped</a>(&amp;h_min, &amp;h_max, &amp;v_min, &amp;v_max);
<a name="l01080"></a>01080     <span class="keywordflow">if</span> (debug)
<a name="l01081"></a>01081       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Hgaps [%d,%d], vgaps [%d,%d]:&quot;</span>, h_min, h_max, v_min, v_max);
<a name="l01082"></a>01082     <span class="keywordflow">if</span> (h_max &lt; v_min ||
<a name="l01083"></a>01083         blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a2ac782044b1e472f8ee6bfc9c0072bc9">leader_on_left</a>() || blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a2d3bd49977c92a46d2cedfe410484732">leader_on_right</a>()) {
<a name="l01084"></a>01084       <span class="comment">// Horizontal gaps are clear winners. Count a pure horizontal.</span>
<a name="l01085"></a>01085       ++*pure_h_count;
<a name="l01086"></a>01086       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Horz at:&quot;</span>);
<a name="l01087"></a>01087     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v_max &lt; h_min) {
<a name="l01088"></a>01088       <span class="comment">// Vertical gaps are clear winners. Clear a pure vertical.</span>
<a name="l01089"></a>01089       ++*pure_v_count;
<a name="l01090"></a>01090       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Vert at:&quot;</span>);
<a name="l01091"></a>01091     } <span class="keywordflow">else</span> {
<a name="l01092"></a>01092       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Neither at:&quot;</span>);
<a name="l01093"></a>01093     }
<a name="l01094"></a>01094     <span class="keywordflow">if</span> (debug)
<a name="l01095"></a>01095       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01096"></a>01096   }
<a name="l01097"></a>01097 }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099 <span class="comment">// Makes the blob to be only horizontal or vertical where evidence</span>
<a name="l01100"></a>01100 <span class="comment">// is clear based on gaps of 2nd order neighbours, or definite individual</span>
<a name="l01101"></a>01101 <span class="comment">// blobs.</span>
<a name="l01102"></a>01102 <span class="keywordtype">void</span> StrokeWidth::SetNeighbourFlows(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob) {
<a name="l01103"></a>01103   <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a151439eae2683e30695bbf567df04982">DefiniteIndividualFlow</a>())
<a name="l01104"></a>01104     <span class="keywordflow">return</span>;
<a name="l01105"></a>01105   <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l01106"></a>01106                                              blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l01107"></a>01107   <span class="keywordflow">if</span> (debug) {
<a name="l01108"></a>01108     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;SetNeighbourFlows (current flow=%d, type=%d) on:&quot;</span>,
<a name="l01109"></a>01109             blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>(), blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>());
<a name="l01110"></a>01110     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01111"></a>01111   }
<a name="l01112"></a>01112   BLOBNBOX_CLIST neighbours;
<a name="l01113"></a>01113   List3rdNeighbours(blob, &amp;neighbours);
<a name="l01114"></a>01114   <span class="comment">// The number of pure horizontal and vertical neighbours.</span>
<a name="l01115"></a>01115   <span class="keywordtype">int</span> pure_h_count = 0;
<a name="l01116"></a>01116   <span class="keywordtype">int</span> pure_v_count = 0;
<a name="l01117"></a>01117   CountNeighbourGaps(debug, &amp;neighbours, &amp;pure_h_count, &amp;pure_v_count);
<a name="l01118"></a>01118   <span class="keywordflow">if</span> (debug) {
<a name="l01119"></a>01119     <a class="code" href="classtesseract_1_1_stroke_width.html#a90b53628c521c80302467b8059fc0a5c">HandleClick</a>(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + 1,
<a name="l01120"></a>01120                 blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() + 1);
<a name="l01121"></a>01121     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;SetFlows: h_count=%d, v_count=%d\n&quot;</span>,
<a name="l01122"></a>01122             pure_h_count, pure_v_count);
<a name="l01123"></a>01123   }
<a name="l01124"></a>01124   <span class="keywordflow">if</span> (!neighbours.empty()) {
<a name="l01125"></a>01125     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a500153b288f379ebabbeaa18a7005d04">set_vert_possible</a>(<span class="keyword">true</span>);
<a name="l01126"></a>01126     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a49a43bb4c47b434aa36ad79ea53a0485">set_horz_possible</a>(<span class="keyword">true</span>);
<a name="l01127"></a>01127     <span class="keywordflow">if</span> (pure_h_count &gt; 2 * pure_v_count) {
<a name="l01128"></a>01128       <span class="comment">// Horizontal gaps are clear winners. Clear vertical neighbours.</span>
<a name="l01129"></a>01129       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a500153b288f379ebabbeaa18a7005d04">set_vert_possible</a>(<span class="keyword">false</span>);
<a name="l01130"></a>01130     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pure_v_count &gt; 2 * pure_h_count) {
<a name="l01131"></a>01131       <span class="comment">// Vertical gaps are clear winners. Clear horizontal neighbours.</span>
<a name="l01132"></a>01132       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a49a43bb4c47b434aa36ad79ea53a0485">set_horz_possible</a>(<span class="keyword">false</span>);
<a name="l01133"></a>01133     }
<a name="l01134"></a>01134   } <span class="keywordflow">else</span> {
<a name="l01135"></a>01135     <span class="comment">// Lonely blob. Can&#39;t tell its flow direction.</span>
<a name="l01136"></a>01136     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a500153b288f379ebabbeaa18a7005d04">set_vert_possible</a>(<span class="keyword">false</span>);
<a name="l01137"></a>01137     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a49a43bb4c47b434aa36ad79ea53a0485">set_horz_possible</a>(<span class="keyword">false</span>);
<a name="l01138"></a>01138   }
<a name="l01139"></a>01139 }
<a name="l01140"></a>01140 
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 <span class="comment">// Helper to count the number of horizontal and vertical blobs in a list.</span>
<a name="l01143"></a>01143 <span class="keyword">static</span> <span class="keywordtype">void</span> CountNeighbourTypes(BLOBNBOX_CLIST* neighbours,
<a name="l01144"></a>01144                                 <span class="keywordtype">int</span>* pure_h_count, <span class="keywordtype">int</span>* pure_v_count) {
<a name="l01145"></a>01145   BLOBNBOX_C_IT it(neighbours);
<a name="l01146"></a>01146   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l01147"></a>01147     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = it.data();
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4faf8ec29ebb0f3c2fbdd158fd33cdc9">UniquelyHorizontal</a>())
<a name="l01149"></a>01149       ++*pure_h_count;
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aa4e11bd4e9e5903b52bcd363db008f2e">UniquelyVertical</a>())
<a name="l01151"></a>01151       ++*pure_v_count;
<a name="l01152"></a>01152   }
<a name="l01153"></a>01153 }
<a name="l01154"></a>01154 
<a name="l01155"></a>01155 <span class="comment">// Nullify the neighbours in the wrong directions where the direction</span>
<a name="l01156"></a>01156 <span class="comment">// is clear-cut based on a distance margin. Good for isolating vertical</span>
<a name="l01157"></a>01157 <span class="comment">// text from neighbouring horizontal text.</span>
<a name="l01158"></a>01158 <span class="keywordtype">void</span> StrokeWidth::SimplifyObviousNeighbours(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob) {
<a name="l01159"></a>01159   <span class="comment">// Case 1: We have text that is likely several characters, blurry and joined</span>
<a name="l01160"></a>01160   <span class="comment">//         together.</span>
<a name="l01161"></a>01161   <span class="keywordflow">if</span> ((blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() &gt; 3 * blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a5b86dba65d0679a91c74aeae12630918">area_stroke_width</a>() &amp;&amp;
<a name="l01162"></a>01162        blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt; 3 * blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a5b86dba65d0679a91c74aeae12630918">area_stroke_width</a>())) {
<a name="l01163"></a>01163     <span class="comment">// The blob is complex (not stick-like).</span>
<a name="l01164"></a>01164     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>() &gt; 4 * blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>()) {
<a name="l01165"></a>01165       <span class="comment">// Horizontal conjoined text.</span>
<a name="l01166"></a>01166       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01167"></a>01167       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01168"></a>01168       <span class="keywordflow">return</span>;
<a name="l01169"></a>01169     }
<a name="l01170"></a>01170     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt; 4 * blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>()) {
<a name="l01171"></a>01171       <span class="comment">// Vertical conjoined text.</span>
<a name="l01172"></a>01172       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01173"></a>01173       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01174"></a>01174       <span class="keywordflow">return</span>;
<a name="l01175"></a>01175     }
<a name="l01176"></a>01176   }
<a name="l01177"></a>01177 
<a name="l01178"></a>01178   <span class="comment">// Case 2: This blob is likely a single character.</span>
<a name="l01179"></a>01179   <span class="keywordtype">int</span> margin = <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() / 2;
<a name="l01180"></a>01180   <span class="keywordtype">int</span> h_min, h_max, v_min, v_max;
<a name="l01181"></a>01181   blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a5f17b374b3a0e8b547d1a41e43054ee2">MinMaxGapsClipped</a>(&amp;h_min, &amp;h_max, &amp;v_min, &amp;v_max);
<a name="l01182"></a>01182   <span class="keywordflow">if</span> ((h_max + margin &lt; v_min &amp;&amp; h_max &lt; margin / 2) ||
<a name="l01183"></a>01183       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a2ac782044b1e472f8ee6bfc9c0072bc9">leader_on_left</a>() || blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a2d3bd49977c92a46d2cedfe410484732">leader_on_right</a>()) {
<a name="l01184"></a>01184     <span class="comment">// Horizontal gaps are clear winners. Clear vertical neighbours.</span>
<a name="l01185"></a>01185     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01186"></a>01186     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01187"></a>01187   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v_max + margin &lt; h_min &amp;&amp; v_max &lt; margin / 2) {
<a name="l01188"></a>01188     <span class="comment">// Vertical gaps are clear winners. Clear horizontal neighbours.</span>
<a name="l01189"></a>01189     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01190"></a>01190     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a80beaf33ba73b0145cdc6a53ce774465">set_neighbour</a>(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <span class="keyword">false</span>);
<a name="l01191"></a>01191   }
<a name="l01192"></a>01192 }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <span class="comment">// Smoothes the vertical/horizontal type of the blob based on the</span>
<a name="l01195"></a>01195 <span class="comment">// 2nd-order neighbours. If reset_all is true, then all blobs are</span>
<a name="l01196"></a>01196 <span class="comment">// changed. Otherwise, only ambiguous blobs are processed.</span>
<a name="l01197"></a>01197 <span class="keywordtype">void</span> StrokeWidth::SmoothNeighbourTypes(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob, <span class="keywordtype">bool</span> reset_all) {
<a name="l01198"></a>01198   <span class="keywordflow">if</span> ((blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4ab21b274ede7a7080d5b2bca8f2c268">vert_possible</a>() &amp;&amp; blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9009e27a6c6f2025035170850dcf62c2">horz_possible</a>()) || reset_all) {
<a name="l01199"></a>01199     <span class="comment">// There are both horizontal and vertical so try to fix it.</span>
<a name="l01200"></a>01200     BLOBNBOX_CLIST neighbours;
<a name="l01201"></a>01201     List2ndNeighbours(blob, &amp;neighbours);
<a name="l01202"></a>01202     <span class="comment">// The number of pure horizontal and vertical neighbours.</span>
<a name="l01203"></a>01203     <span class="keywordtype">int</span> pure_h_count = 0;
<a name="l01204"></a>01204     <span class="keywordtype">int</span> pure_v_count = 0;
<a name="l01205"></a>01205     CountNeighbourTypes(&amp;neighbours, &amp;pure_h_count, &amp;pure_v_count);
<a name="l01206"></a>01206     <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l01207"></a>01207                                       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>())) {
<a name="l01208"></a>01208       <a class="code" href="classtesseract_1_1_stroke_width.html#a90b53628c521c80302467b8059fc0a5c">HandleClick</a>(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + 1,
<a name="l01209"></a>01209                   blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() + 1);
<a name="l01210"></a>01210       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;pure_h=%d, pure_v=%d\n&quot;</span>,
<a name="l01211"></a>01211               pure_h_count, pure_v_count);
<a name="l01212"></a>01212     }
<a name="l01213"></a>01213     <span class="keywordflow">if</span> (pure_h_count &gt; pure_v_count) {
<a name="l01214"></a>01214       <span class="comment">// Horizontal gaps are clear winners. Clear vertical neighbours.</span>
<a name="l01215"></a>01215       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a500153b288f379ebabbeaa18a7005d04">set_vert_possible</a>(<span class="keyword">false</span>);
<a name="l01216"></a>01216       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a49a43bb4c47b434aa36ad79ea53a0485">set_horz_possible</a>(<span class="keyword">true</span>);
<a name="l01217"></a>01217     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pure_v_count &gt; pure_h_count) {
<a name="l01218"></a>01218       <span class="comment">// Vertical gaps are clear winners. Clear horizontal neighbours.</span>
<a name="l01219"></a>01219       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a49a43bb4c47b434aa36ad79ea53a0485">set_horz_possible</a>(<span class="keyword">false</span>);
<a name="l01220"></a>01220       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a500153b288f379ebabbeaa18a7005d04">set_vert_possible</a>(<span class="keyword">true</span>);
<a name="l01221"></a>01221     }
<a name="l01222"></a>01222   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l01223"></a>01223                                     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>())) {
<a name="l01224"></a>01224     <a class="code" href="classtesseract_1_1_stroke_width.html#a90b53628c521c80302467b8059fc0a5c">HandleClick</a>(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + 1,
<a name="l01225"></a>01225                 blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() + 1);
<a name="l01226"></a>01226     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Clean on pass 3!\n&quot;</span>);
<a name="l01227"></a>01227   }
<a name="l01228"></a>01228 }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230 <span class="comment">// Partition creation. Accumulates vertical and horizontal text chains,</span>
<a name="l01231"></a>01231 <span class="comment">// puts the remaining blobs in as unknowns, and then merges/splits to</span>
<a name="l01232"></a>01232 <span class="comment">// minimize overlap and smoothes the types with neighbours and the color</span>
<a name="l01233"></a>01233 <span class="comment">// image if provided. rerotation is used to rotate the coordinate space</span>
<a name="l01234"></a>01234 <span class="comment">// back to the nontext_map_ image.</span>
<a name="l01235"></a>01235 <span class="keywordtype">void</span> StrokeWidth::FindInitialPartitions(<span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rerotation,
<a name="l01236"></a>01236                                         <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l01237"></a>01237                                         ColPartitionGrid* part_grid,
<a name="l01238"></a>01238                                         ColPartition_LIST* big_parts) {
<a name="l01239"></a>01239   FindVerticalTextChains(part_grid);
<a name="l01240"></a>01240   FindHorizontalTextChains(part_grid);
<a name="l01241"></a>01241   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>) {
<a name="l01242"></a>01242     chains_win_ = <a class="code" href="classtesseract_1_1_b_b_grid.html#aa716f76c7f04f7112abfc10a3f8c63e0">MakeWindow</a>(0, 400, <span class="stringliteral">&quot;Initial text chains&quot;</span>);
<a name="l01243"></a>01243     part_grid-&gt;DisplayBoxes(chains_win_);
<a name="l01244"></a>01244     projection_-&gt;DisplayProjection();
<a name="l01245"></a>01245   }
<a name="l01246"></a>01246   part_grid-&gt;SplitOverlappingPartitions(big_parts);
<a name="l01247"></a>01247   EasyMerges(part_grid);
<a name="l01248"></a>01248   RemoveLargeUnusedBlobs(block, part_grid, big_parts);
<a name="l01249"></a>01249   <a class="code" href="class_t_b_o_x.html">TBOX</a> grid_box(<a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>(), <a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>());
<a name="l01250"></a>01250   <span class="keywordflow">while</span> (part_grid-&gt;GridSmoothNeighbours(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a>, nontext_map_, grid_box,
<a name="l01251"></a>01251                                          rerotation));
<a name="l01252"></a>01252   <span class="keywordflow">while</span> (part_grid-&gt;GridSmoothNeighbours(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1adac19762bd040a53914be696482c1e53">BTFT_NEIGHBOURS</a>, nontext_map_,
<a name="l01253"></a>01253                                          grid_box, rerotation));
<a name="l01254"></a>01254   TestDiacritics(part_grid, block);
<a name="l01255"></a>01255   MergeDiacritics(block, part_grid);
<a name="l01256"></a>01256   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>) {
<a name="l01257"></a>01257     textlines_win_ = <a class="code" href="classtesseract_1_1_b_b_grid.html#aa716f76c7f04f7112abfc10a3f8c63e0">MakeWindow</a>(400, 400, <span class="stringliteral">&quot;GoodTextline blobs&quot;</span>);
<a name="l01258"></a>01258     part_grid-&gt;DisplayBoxes(textlines_win_);
<a name="l01259"></a>01259     diacritics_win_ = DisplayDiacritics(<span class="stringliteral">&quot;Diacritics&quot;</span>, 0, 0, block);
<a name="l01260"></a>01260   }
<a name="l01261"></a>01261   PartitionRemainingBlobs(part_grid);
<a name="l01262"></a>01262   part_grid-&gt;SplitOverlappingPartitions(big_parts);
<a name="l01263"></a>01263   EasyMerges(part_grid);
<a name="l01264"></a>01264   <span class="keywordflow">while</span> (part_grid-&gt;GridSmoothNeighbours(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a>, nontext_map_, grid_box,
<a name="l01265"></a>01265                                          rerotation));
<a name="l01266"></a>01266   <span class="keywordflow">while</span> (part_grid-&gt;GridSmoothNeighbours(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1adac19762bd040a53914be696482c1e53">BTFT_NEIGHBOURS</a>, nontext_map_,
<a name="l01267"></a>01267                                          grid_box, rerotation));
<a name="l01268"></a>01268   <span class="comment">// Now eliminate strong stuff in a sea of the opposite.</span>
<a name="l01269"></a>01269   <span class="keywordflow">while</span> (part_grid-&gt;GridSmoothNeighbours(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a>, nontext_map_,
<a name="l01270"></a>01270                                          grid_box, rerotation));
<a name="l01271"></a>01271   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>) {
<a name="l01272"></a>01272     smoothed_win_ = <a class="code" href="classtesseract_1_1_b_b_grid.html#aa716f76c7f04f7112abfc10a3f8c63e0">MakeWindow</a>(800, 400, <span class="stringliteral">&quot;Smoothed blobs&quot;</span>);
<a name="l01273"></a>01273     part_grid-&gt;DisplayBoxes(smoothed_win_);
<a name="l01274"></a>01274   }
<a name="l01275"></a>01275 }
<a name="l01276"></a>01276 
<a name="l01277"></a>01277 <span class="comment">// Helper verifies that blob&#39;s neighbour in direction dir is good to add to a</span>
<a name="l01278"></a>01278 <span class="comment">// vertical text chain by returning the neighbour if it is not null, not owned,</span>
<a name="l01279"></a>01279 <span class="comment">// and not uniquely horizontal, as well as its neighbour in the opposite</span>
<a name="l01280"></a>01280 <span class="comment">// direction is blob.</span>
<a name="l01281"></a>01281 <span class="keyword">static</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* MutualUnusedVNeighbour(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob,
<a name="l01282"></a>01282                                         <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> dir) {
<a name="l01283"></a>01283   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* next_blob = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(dir);
<a name="l01284"></a>01284   <span class="keywordflow">if</span> (next_blob == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || next_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l01285"></a>01285       next_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4faf8ec29ebb0f3c2fbdd158fd33cdc9">UniquelyHorizontal</a>())
<a name="l01286"></a>01286     <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01287"></a>01287   <span class="keywordflow">if</span> (next_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a3358f8405c8bd675b0ee84f709373aed">DirOtherWay</a>(dir)) == blob)
<a name="l01288"></a>01288     <span class="keywordflow">return</span> next_blob;
<a name="l01289"></a>01289   <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01290"></a>01290 }
<a name="l01291"></a>01291 
<a name="l01292"></a>01292 <span class="comment">// Finds vertical chains of text-like blobs and puts them in ColPartitions.</span>
<a name="l01293"></a>01293 <span class="keywordtype">void</span> StrokeWidth::FindVerticalTextChains(ColPartitionGrid* part_grid) {
<a name="l01294"></a>01294   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l01295"></a>01295   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l01296"></a>01296   gsearch.StartFullSearch();
<a name="l01297"></a>01297   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01298"></a>01298     <span class="comment">// Only process boxes that have no horizontal hope and have not yet</span>
<a name="l01299"></a>01299     <span class="comment">// been included in a chain.</span>
<a name="l01300"></a>01300     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob;
<a name="l01301"></a>01301     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aa4e11bd4e9e5903b52bcd363db008f2e">UniquelyVertical</a>() &amp;&amp;
<a name="l01302"></a>01302         (blob = MutualUnusedVNeighbour(bbox, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>)) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01303"></a>01303       <span class="comment">// Put all the linked blobs into a ColPartition.</span>
<a name="l01304"></a>01304       ColPartition* part = <span class="keyword">new</span> ColPartition(<a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>, <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(0, 1));
<a name="l01305"></a>01305       part-&gt;AddBox(bbox);
<a name="l01306"></a>01306       <span class="keywordflow">while</span> (blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01307"></a>01307         part-&gt;AddBox(blob);
<a name="l01308"></a>01308         blob = MutualUnusedVNeighbour(blob, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>);
<a name="l01309"></a>01309       }
<a name="l01310"></a>01310       blob = MutualUnusedVNeighbour(bbox, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>);
<a name="l01311"></a>01311       <span class="keywordflow">while</span> (blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01312"></a>01312         part-&gt;AddBox(blob);
<a name="l01313"></a>01313         blob = MutualUnusedVNeighbour(blob, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>);
<a name="l01314"></a>01314       }
<a name="l01315"></a>01315       CompletePartition(part, part_grid);
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317   }
<a name="l01318"></a>01318 }
<a name="l01319"></a>01319 
<a name="l01320"></a>01320 <span class="comment">// Helper verifies that blob&#39;s neighbour in direction dir is good to add to a</span>
<a name="l01321"></a>01321 <span class="comment">// horizontal text chain by returning the neighbour if it is not null, not</span>
<a name="l01322"></a>01322 <span class="comment">// owned, and not uniquely vertical, as well as its neighbour in the opposite</span>
<a name="l01323"></a>01323 <span class="comment">// direction is blob.</span>
<a name="l01324"></a>01324 <span class="keyword">static</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* MutualUnusedHNeighbour(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob,
<a name="l01325"></a>01325                                         <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> dir) {
<a name="l01326"></a>01326   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* next_blob = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(dir);
<a name="l01327"></a>01327   <span class="keywordflow">if</span> (next_blob == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || next_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l01328"></a>01328       next_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aa4e11bd4e9e5903b52bcd363db008f2e">UniquelyVertical</a>())
<a name="l01329"></a>01329     <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01330"></a>01330   <span class="keywordflow">if</span> (next_blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a20cea54041981db2aa2e94cb4db7b4cf">neighbour</a>(<a class="code" href="blobbox_8h.html#a3358f8405c8bd675b0ee84f709373aed">DirOtherWay</a>(dir)) == blob)
<a name="l01331"></a>01331     <span class="keywordflow">return</span> next_blob;
<a name="l01332"></a>01332   <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <span class="comment">// Finds horizontal chains of text-like blobs and puts them in ColPartitions.</span>
<a name="l01336"></a>01336 <span class="keywordtype">void</span> StrokeWidth::FindHorizontalTextChains(ColPartitionGrid* part_grid) {
<a name="l01337"></a>01337   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l01338"></a>01338   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l01339"></a>01339   gsearch.StartFullSearch();
<a name="l01340"></a>01340   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01341"></a>01341     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob;
<a name="l01342"></a>01342     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4faf8ec29ebb0f3c2fbdd158fd33cdc9">UniquelyHorizontal</a>() &amp;&amp;
<a name="l01343"></a>01343         (blob = MutualUnusedHNeighbour(bbox, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>)) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01344"></a>01344       <span class="comment">// Put all the linked blobs into a ColPartition.</span>
<a name="l01345"></a>01345       ColPartition* part = <span class="keyword">new</span> ColPartition(<a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>, <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(0, 1));
<a name="l01346"></a>01346       part-&gt;AddBox(bbox);
<a name="l01347"></a>01347       <span class="keywordflow">while</span> (blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01348"></a>01348         part-&gt;AddBox(blob);
<a name="l01349"></a>01349         blob = MutualUnusedHNeighbour(blob, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>);
<a name="l01350"></a>01350       }
<a name="l01351"></a>01351       blob = MutualUnusedHNeighbour(bbox, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>);
<a name="l01352"></a>01352       <span class="keywordflow">while</span> (blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01353"></a>01353         part-&gt;AddBox(blob);
<a name="l01354"></a>01354         blob = MutualUnusedVNeighbour(blob, <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>);
<a name="l01355"></a>01355       }
<a name="l01356"></a>01356       CompletePartition(part, part_grid);
<a name="l01357"></a>01357     }
<a name="l01358"></a>01358   }
<a name="l01359"></a>01359 }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361 <span class="comment">// Finds diacritics and saves their base character in the blob.</span>
<a name="l01362"></a>01362 <span class="comment">// The objective is to move all diacritics to the noise_blobs list, so</span>
<a name="l01363"></a>01363 <span class="comment">// they don&#39;t mess up early textline finding/merging, or force splits</span>
<a name="l01364"></a>01364 <span class="comment">// on textlines that overlap a bit. Blobs that become diacritics must be</span>
<a name="l01365"></a>01365 <span class="comment">// either part of no ColPartition (NULL owner) or in a small partition in</span>
<a name="l01366"></a>01366 <span class="comment">// which ALL the blobs are diacritics, in which case the partition is</span>
<a name="l01367"></a>01367 <span class="comment">// exploded (deleted) back to its blobs.</span>
<a name="l01368"></a>01368 <span class="keywordtype">void</span> StrokeWidth::TestDiacritics(ColPartitionGrid* part_grid, <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l01369"></a>01369   <a class="code" href="classtesseract_1_1_blob_grid.html#a86754acb30620ac8308d7e178f7618bd">BlobGrid</a> small_grid(<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>(), <a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>(), <a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>());
<a name="l01370"></a>01370   small_grid.InsertBlobList(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l01371"></a>01371   small_grid.InsertBlobList(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l01372"></a>01372   <span class="keywordtype">int</span> medium_diacritics = 0;
<a name="l01373"></a>01373   <span class="keywordtype">int</span> small_diacritics = 0;
<a name="l01374"></a>01374   BLOBNBOX_IT small_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l01375"></a>01375   <span class="keywordflow">for</span> (small_it.mark_cycle_pt(); !small_it.cycled_list(); small_it.forward()) {
<a name="l01376"></a>01376     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = small_it.data();
<a name="l01377"></a>01377     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3dc859a710d5a7473489c2f3e1e36326">IsDiacritic</a>() &amp;&amp;
<a name="l01378"></a>01378         DiacriticBlob(&amp;small_grid, blob)) {
<a name="l01379"></a>01379       ++small_diacritics;
<a name="l01380"></a>01380     }
<a name="l01381"></a>01381   }
<a name="l01382"></a>01382   BLOBNBOX_IT blob_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l01383"></a>01383   <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l01384"></a>01384     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l01385"></a>01385     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3dc859a710d5a7473489c2f3e1e36326">IsDiacritic</a>()) {
<a name="l01386"></a>01386       small_it.add_to_end(blob_it.extract());
<a name="l01387"></a>01387       <span class="keywordflow">continue</span>;  <span class="comment">// Already a diacritic.</span>
<a name="l01388"></a>01388     }
<a name="l01389"></a>01389     ColPartition* part = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>();
<a name="l01390"></a>01390     <span class="keywordflow">if</span> (part == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; DiacriticBlob(&amp;small_grid, blob)) {
<a name="l01391"></a>01391       ++medium_diacritics;
<a name="l01392"></a>01392       <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(blob);
<a name="l01393"></a>01393       small_it.add_to_end(blob_it.extract());
<a name="l01394"></a>01394     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !part-&gt;block_owned() &amp;&amp;
<a name="l01395"></a>01395         part-&gt;boxes_count() &lt; 3) {
<a name="l01396"></a>01396       <span class="comment">// We allow blobs in small partitions to become diacritics if ALL the</span>
<a name="l01397"></a>01397       <span class="comment">// blobs in the partition qualify as we can then cleanly delete the</span>
<a name="l01398"></a>01398       <span class="comment">// partition, turn all the blobs in it to diacritics and they can be</span>
<a name="l01399"></a>01399       <span class="comment">// merged into the base character partition more easily than merging</span>
<a name="l01400"></a>01400       <span class="comment">// the partitions.</span>
<a name="l01401"></a>01401       BLOBNBOX_C_IT box_it(part-&gt;boxes());
<a name="l01402"></a>01402       <span class="keywordflow">for</span> (box_it.mark_cycle_pt(); !box_it.cycled_list() &amp;&amp;
<a name="l01403"></a>01403            DiacriticBlob(&amp;small_grid, box_it.data());
<a name="l01404"></a>01404            box_it.forward());
<a name="l01405"></a>01405       <span class="keywordflow">if</span> (box_it.cycled_list()) {
<a name="l01406"></a>01406         <span class="comment">// They are all good.</span>
<a name="l01407"></a>01407         <span class="keywordflow">while</span> (!box_it.empty()) {
<a name="l01408"></a>01408           <span class="comment">// Liberate the blob from its partition so it can be treated</span>
<a name="l01409"></a>01409           <span class="comment">// as a diacritic and merged explicitly with the base part.</span>
<a name="l01410"></a>01410           <span class="comment">// The blob is really owned by the block. The partition &quot;owner&quot;</span>
<a name="l01411"></a>01411           <span class="comment">// is NULLed to allow the blob to get merged with its base character</span>
<a name="l01412"></a>01412           <span class="comment">// partition.</span>
<a name="l01413"></a>01413           <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* box = box_it.extract();
<a name="l01414"></a>01414           box-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ad573c3bea7351dd2cbdaaffa2ff11c58">set_owner</a>(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01415"></a>01415           box_it.forward();
<a name="l01416"></a>01416           ++medium_diacritics;
<a name="l01417"></a>01417           <span class="comment">// We remove the blob from the grid so it isn&#39;t found by subsequent</span>
<a name="l01418"></a>01418           <span class="comment">// searches where we might not want to include diacritics.</span>
<a name="l01419"></a>01419           <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(box);
<a name="l01420"></a>01420         }
<a name="l01421"></a>01421         <span class="comment">// We only move the one blob to the small list here, but the others</span>
<a name="l01422"></a>01422         <span class="comment">// all get moved by the test at the top of the loop.</span>
<a name="l01423"></a>01423         small_it.add_to_end(blob_it.extract());
<a name="l01424"></a>01424         part_grid-&gt;RemoveBBox(part);
<a name="l01425"></a>01425         <span class="keyword">delete</span> part;
<a name="l01426"></a>01426       }
<a name="l01427"></a>01427     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l01428"></a>01428                                              blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>())) {
<a name="l01429"></a>01429       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Blob not available to be a diacritic at:&quot;</span>);
<a name="l01430"></a>01430       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01431"></a>01431     }
<a name="l01432"></a>01432   }
<a name="l01433"></a>01433   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a69ff5305c7423c6a1e1e7a873aea09a4">textord_tabfind_show_strokewidths</a>) {
<a name="l01434"></a>01434     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Found %d small diacritics, %d medium\n&quot;</span>,
<a name="l01435"></a>01435             small_diacritics, medium_diacritics);
<a name="l01436"></a>01436   }
<a name="l01437"></a>01437 }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439 <span class="comment">// Searches this grid for an appropriately close and sized neighbour of the</span>
<a name="l01440"></a>01440 <span class="comment">// given [small] blob. If such a blob is found, the diacritic base is saved</span>
<a name="l01441"></a>01441 <span class="comment">// in the blob and true is returned.</span>
<a name="l01442"></a>01442 <span class="comment">// The small_grid is a secondary grid that contains the small/noise objects</span>
<a name="l01443"></a>01443 <span class="comment">// that are not in this grid, but may be useful for determining a connection</span>
<a name="l01444"></a>01444 <span class="comment">// between blob and its potential base character. (See DiacriticXGapFilled.)</span>
<a name="l01445"></a>01445 <span class="keywordtype">bool</span> StrokeWidth::DiacriticBlob(BlobGrid* small_grid, <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob) {
<a name="l01446"></a>01446   <span class="keywordflow">if</span> (<a class="code" href="class_b_l_o_b_n_b_o_x.html#aed57b07f933309970d23490dfc5a5e52">BLOBNBOX::UnMergeableType</a>(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>()) ||
<a name="l01447"></a>01447       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>() == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>)
<a name="l01448"></a>01448     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01449"></a>01449   <a class="code" href="class_t_b_o_x.html">TBOX</a> small_box(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>());
<a name="l01450"></a>01450   <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, small_box.left(),
<a name="l01451"></a>01451                                              small_box.bottom());
<a name="l01452"></a>01452   <span class="keywordflow">if</span> (debug) {
<a name="l01453"></a>01453     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Testing blob for diacriticness at:&quot;</span>);
<a name="l01454"></a>01454     small_box.print();
<a name="l01455"></a>01455   }
<a name="l01456"></a>01456   <span class="keywordtype">int</span> x = (small_box.left() + small_box.right()) / 2;
<a name="l01457"></a>01457   <span class="keywordtype">int</span> y = (small_box.bottom() + small_box.top()) / 2;
<a name="l01458"></a>01458   <span class="keywordtype">int</span> grid_x, grid_y;
<a name="l01459"></a>01459   <a class="code" href="classtesseract_1_1_grid_base.html#a9cb158bba184d657c51257b98eea9f8f">GridCoords</a>(x, y, &amp;grid_x, &amp;grid_y);
<a name="l01460"></a>01460   <span class="keywordtype">int</span> height = small_box.height();
<a name="l01461"></a>01461   <span class="comment">// Setup a rectangle search to find its nearest base-character neighbour.</span>
<a name="l01462"></a>01462   <span class="comment">// We keep 2 different best candidates:</span>
<a name="l01463"></a>01463   <span class="comment">// best_x_overlap is a category of base characters that have an overlap in x</span>
<a name="l01464"></a>01464   <span class="comment">// (like a acute) in which we look for the least y-gap, computed using the</span>
<a name="l01465"></a>01465   <span class="comment">// projection to favor base characters in the same textline.</span>
<a name="l01466"></a>01466   <span class="comment">// best_y_overlap is a category of base characters that have no x overlap,</span>
<a name="l01467"></a>01467   <span class="comment">// (nominally a y-overlap is preferrecd but not essential) in which we</span>
<a name="l01468"></a>01468   <span class="comment">// look for the least weighted sum of x-gap and y-gap, with x-gap getting</span>
<a name="l01469"></a>01469   <span class="comment">// a lower weight to catch quotes at the end of a textline.</span>
<a name="l01470"></a>01470   <span class="comment">// NOTE that x-gap and y-gap are measured from the nearest side of the base</span>
<a name="l01471"></a>01471   <span class="comment">// character to the FARTHEST side of the diacritic to allow small diacritics</span>
<a name="l01472"></a>01472   <span class="comment">// to be a reasonable distance away, but not big diacritics.</span>
<a name="l01473"></a>01473   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* best_x_overlap = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01474"></a>01474   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* best_y_overlap = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01475"></a>01475   <span class="keywordtype">int</span> best_total_dist = 0;
<a name="l01476"></a>01476   <span class="keywordtype">int</span> best_y_gap = 0;
<a name="l01477"></a>01477   <a class="code" href="class_t_b_o_x.html">TBOX</a> best_xbox;
<a name="l01478"></a>01478   <span class="comment">// TODO(rays) the search box could be setup using the projection as a guide.</span>
<a name="l01479"></a>01479   <a class="code" href="class_t_b_o_x.html">TBOX</a> search_box(small_box);
<a name="l01480"></a>01480   <span class="keywordtype">int</span> x_pad = <a class="code" href="helpers_8h.html#ab60e4f82956a1f5fdb54d0d8303e95b7">IntCastRounded</a>(<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() * <a class="code" href="namespacetesseract.html#aabf5756c7e5d355517dc1af5df71e750">kDiacriticXPadRatio</a>);
<a name="l01481"></a>01481   <span class="keywordtype">int</span> y_pad = <a class="code" href="helpers_8h.html#ab60e4f82956a1f5fdb54d0d8303e95b7">IntCastRounded</a>(<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() * <a class="code" href="namespacetesseract.html#adfd3b22e2049d8d544208834da403031">kDiacriticYPadRatio</a>);
<a name="l01482"></a>01482   search_box.<a class="code" href="class_t_b_o_x.html#ad78f4f7e9746def02b0d2e8e8a2b3ceb">pad</a>(x_pad, y_pad);
<a name="l01483"></a>01483   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> rsearch(<span class="keyword">this</span>);
<a name="l01484"></a>01484   rsearch.SetUniqueMode(<span class="keyword">true</span>);
<a name="l01485"></a>01485   <span class="keywordtype">int</span> min_height = height * <a class="code" href="namespacetesseract.html#a3883c045452c59e5a80bd9ed73cd9e6f">kMinDiacriticSizeRatio</a>;
<a name="l01486"></a>01486   rsearch.StartRectSearch(search_box);
<a name="l01487"></a>01487   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour;
<a name="l01488"></a>01488   <span class="keywordflow">while</span> ((neighbour = rsearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01489"></a>01489     <span class="keywordflow">if</span> (<a class="code" href="class_b_l_o_b_n_b_o_x.html#aed57b07f933309970d23490dfc5a5e52">BLOBNBOX::UnMergeableType</a>(neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>()) ||
<a name="l01490"></a>01490         neighbour == blob || neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>())
<a name="l01491"></a>01491       <span class="keywordflow">continue</span>;
<a name="l01492"></a>01492     <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01493"></a>01493     <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>()-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aec438c63bf754474982b2bb4e74148b5">IsVerticalType</a>() ||
<a name="l01494"></a>01494         (neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a> &amp;&amp;
<a name="l01495"></a>01495             neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a>)) {
<a name="l01496"></a>01496       <span class="keywordflow">if</span> (debug) {
<a name="l01497"></a>01497         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Neighbour not strong enough:&quot;</span>);
<a name="l01498"></a>01498         nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01499"></a>01499       }
<a name="l01500"></a>01500       <span class="keywordflow">continue</span>;  <span class="comment">// Diacritics must be attached to strong text.</span>
<a name="l01501"></a>01501     }
<a name="l01502"></a>01502     <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &lt; min_height) {
<a name="l01503"></a>01503       <span class="keywordflow">if</span> (debug) {
<a name="l01504"></a>01504         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Neighbour not big enough:&quot;</span>);
<a name="l01505"></a>01505         nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01506"></a>01506       }
<a name="l01507"></a>01507       <span class="keywordflow">continue</span>;  <span class="comment">// Too small to be the base character.</span>
<a name="l01508"></a>01508     }
<a name="l01509"></a>01509     <span class="keywordtype">int</span> x_gap = small_box.x_gap(nbox);
<a name="l01510"></a>01510     <span class="keywordtype">int</span> y_gap = small_box.y_gap(nbox);
<a name="l01511"></a>01511     <span class="keywordtype">int</span> total_distance = projection_-&gt;DistanceOfBoxFromBox(small_box, nbox,
<a name="l01512"></a>01512                                                            <span class="keyword">true</span>, denorm_,
<a name="l01513"></a>01513                                                            debug);
<a name="l01514"></a>01514     <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;xgap=%d, y=%d, total dist=%d\n&quot;</span>,
<a name="l01515"></a>01515                        x_gap, y_gap, total_distance);
<a name="l01516"></a>01516     <span class="keywordflow">if</span> (total_distance &gt;
<a name="l01517"></a>01517         neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>()-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a2ede8f204ed66939a0c4352657da6c94">median_size</a>() * <a class="code" href="namespacetesseract.html#a140f97b7a02095877cba6ffaf66edc32">kMaxDiacriticDistanceRatio</a>) {
<a name="l01518"></a>01518       <span class="keywordflow">if</span> (debug) {
<a name="l01519"></a>01519         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Neighbour with median size %d too far away:&quot;</span>,
<a name="l01520"></a>01520                 neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>()-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a2ede8f204ed66939a0c4352657da6c94">median_size</a>());
<a name="l01521"></a>01521         neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01522"></a>01522       }
<a name="l01523"></a>01523       <span class="keywordflow">continue</span>;  <span class="comment">// Diacritics must not be too distant.</span>
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525     <span class="keywordflow">if</span> (x_gap &lt;= 0) {
<a name="l01526"></a>01526       <span class="keywordflow">if</span> (debug) {
<a name="l01527"></a>01527         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Computing reduced box for :&quot;</span>);
<a name="l01528"></a>01528         nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01529"></a>01529       }
<a name="l01530"></a>01530       <span class="keywordtype">int</span> left = small_box.left() - small_box.width();
<a name="l01531"></a>01531       <span class="keywordtype">int</span> right = small_box.right() + small_box.width();
<a name="l01532"></a>01532       nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a5922e4cbb809ee92c2fbffe2f64be1a7">BoundsWithinLimits</a>(left, right);
<a name="l01533"></a>01533       y_gap = small_box.<a class="code" href="class_t_b_o_x.html#a98e0f9a8622eec475ee93b260c57c7ab">y_gap</a>(nbox);
<a name="l01534"></a>01534       <span class="keywordflow">if</span> (best_x_overlap == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || y_gap &lt; best_y_gap) {
<a name="l01535"></a>01535         best_x_overlap = neighbour;
<a name="l01536"></a>01536         best_xbox = nbox;
<a name="l01537"></a>01537         best_y_gap = y_gap;
<a name="l01538"></a>01538         <span class="keywordflow">if</span> (debug) {
<a name="l01539"></a>01539           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;New best:&quot;</span>);
<a name="l01540"></a>01540           nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01541"></a>01541         }
<a name="l01542"></a>01542       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (debug) {
<a name="l01543"></a>01543         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Shrunken box doesn&#39;t win:&quot;</span>);
<a name="l01544"></a>01544         nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01545"></a>01545       }
<a name="l01546"></a>01546     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a05bf035f2a4e78b71d80c719110be401">ConfirmNoTabViolation</a>(*neighbour)) {
<a name="l01547"></a>01547       <span class="keywordflow">if</span> (best_y_overlap == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || total_distance &lt; best_total_dist) {
<a name="l01548"></a>01548         <span class="keywordflow">if</span> (debug) {
<a name="l01549"></a>01549           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;New best y overlap:&quot;</span>);
<a name="l01550"></a>01550           nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01551"></a>01551         }
<a name="l01552"></a>01552         best_y_overlap = neighbour;
<a name="l01553"></a>01553         best_total_dist = total_distance;
<a name="l01554"></a>01554       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (debug) {
<a name="l01555"></a>01555         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;New y overlap box doesn&#39;t win:&quot;</span>);
<a name="l01556"></a>01556         nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01557"></a>01557       }
<a name="l01558"></a>01558     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (debug) {
<a name="l01559"></a>01559       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Neighbour wrong side of a tab:&quot;</span>);
<a name="l01560"></a>01560       nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01561"></a>01561     }
<a name="l01562"></a>01562   }
<a name="l01563"></a>01563   <span class="keywordflow">if</span> (best_x_overlap != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l01564"></a>01564       (best_y_overlap == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l01565"></a>01565        best_xbox.<a class="code" href="class_t_b_o_x.html#a6b8b3bf99ea363303e11c26866335f23">major_y_overlap</a>(best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>()))) {
<a name="l01566"></a>01566     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#af354be28840859b8a4b593aa6db467f2">set_diacritic_box</a>(best_xbox);
<a name="l01567"></a>01567     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a6f9b52a46f0c77c395c0a03a99270ac8">set_base_char_blob</a>(best_x_overlap);
<a name="l01568"></a>01568     <span class="keywordflow">if</span> (debug) {
<a name="l01569"></a>01569       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;DiacriticBlob OK! (x-overlap:&quot;</span>);
<a name="l01570"></a>01570       small_box.print();
<a name="l01571"></a>01571       best_xbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01572"></a>01572     }
<a name="l01573"></a>01573     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01574"></a>01574   }
<a name="l01575"></a>01575   <span class="keywordflow">if</span> (best_y_overlap != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l01576"></a>01576       DiacriticXGapFilled(small_grid, small_box,
<a name="l01577"></a>01577                           best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>()) &amp;&amp;
<a name="l01578"></a>01578       NoNoiseInBetween(small_box, best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>())) {
<a name="l01579"></a>01579     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#af354be28840859b8a4b593aa6db467f2">set_diacritic_box</a>(best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>());
<a name="l01580"></a>01580     blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a6f9b52a46f0c77c395c0a03a99270ac8">set_base_char_blob</a>(best_y_overlap);
<a name="l01581"></a>01581     <span class="keywordflow">if</span> (debug) {
<a name="l01582"></a>01582       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;DiacriticBlob OK! (y-overlap:&quot;</span>);
<a name="l01583"></a>01583       small_box.print();
<a name="l01584"></a>01584       best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01585"></a>01585     }
<a name="l01586"></a>01586     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01587"></a>01587   }
<a name="l01588"></a>01588   <span class="keywordflow">if</span> (debug) {
<a name="l01589"></a>01589     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;DiacriticBlob fails:&quot;</span>);
<a name="l01590"></a>01590     small_box.print();
<a name="l01591"></a>01591     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Best x+y gap = %d, y = %d\n&quot;</span>, best_total_dist, best_y_gap);
<a name="l01592"></a>01592     <span class="keywordflow">if</span> (best_y_overlap != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01593"></a>01593       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;XGapFilled=%d, NoiseBetween=%d\n&quot;</span>,
<a name="l01594"></a>01594               DiacriticXGapFilled(small_grid, small_box,
<a name="l01595"></a>01595                                   best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>()),
<a name="l01596"></a>01596               NoNoiseInBetween(small_box, best_y_overlap-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>()));
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598   }
<a name="l01599"></a>01599   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01600"></a>01600 }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="comment">// Returns true if there is no gap between the base char and the diacritic</span>
<a name="l01603"></a>01603 <span class="comment">// bigger than a fraction of the height of the base char:</span>
<a name="l01604"></a>01604 <span class="comment">// Eg: line end.....&#39;</span>
<a name="l01605"></a>01605 <span class="comment">// The quote is a long way from the end of the line, yet it needs to be a</span>
<a name="l01606"></a>01606 <span class="comment">// diacritic. To determine that the quote is not part of an image, or</span>
<a name="l01607"></a>01607 <span class="comment">// a different text block, we check for other marks in the gap between</span>
<a name="l01608"></a>01608 <span class="comment">// the base char and the diacritic.</span>
<a name="l01609"></a>01609 <span class="comment">//                          &#39;&lt;--Diacritic</span>
<a name="l01610"></a>01610 <span class="comment">// |---------|</span>
<a name="l01611"></a>01611 <span class="comment">// |         |&lt;-toobig-gap-&gt;</span>
<a name="l01612"></a>01612 <span class="comment">// | Base    |&lt;ok gap&gt;</span>
<a name="l01613"></a>01613 <span class="comment">// |---------|        x&lt;-----Dot occupying gap</span>
<a name="l01614"></a>01614 <span class="comment">// The grid is const really.</span>
<a name="l01615"></a>01615 <span class="keywordtype">bool</span> StrokeWidth::DiacriticXGapFilled(BlobGrid* grid,
<a name="l01616"></a>01616                                       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; diacritic_box,
<a name="l01617"></a>01617                                       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; base_box) {
<a name="l01618"></a>01618   <span class="comment">// Since most gaps are small, use an iterative algorithm to search the gap.</span>
<a name="l01619"></a>01619   <span class="keywordtype">int</span> max_gap = <a class="code" href="helpers_8h.html#ab60e4f82956a1f5fdb54d0d8303e95b7">IntCastRounded</a>(base_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() *
<a name="l01620"></a>01620                                <a class="code" href="namespacetesseract.html#aaf71279184a5815428ada7f1b3fa5d5c">kMaxDiacriticGapToBaseCharHeight</a>);
<a name="l01621"></a>01621   <a class="code" href="class_t_b_o_x.html">TBOX</a> occupied_box(base_box);
<a name="l01622"></a>01622   <span class="keywordtype">int</span> diacritic_gap;
<a name="l01623"></a>01623   <span class="keywordflow">while</span> ((diacritic_gap = diacritic_box.<a class="code" href="class_t_b_o_x.html#a6c296f134aaae6ee544c4d000d76f80e">x_gap</a>(occupied_box)) &gt; max_gap) {
<a name="l01624"></a>01624     <a class="code" href="class_t_b_o_x.html">TBOX</a> search_box(occupied_box);
<a name="l01625"></a>01625     <span class="keywordflow">if</span> (diacritic_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() &gt; search_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>()) {
<a name="l01626"></a>01626       <span class="comment">// We are looking right.</span>
<a name="l01627"></a>01627       search_box.<a class="code" href="class_t_b_o_x.html#ae6151cd794841e100d8a346a0c4a46e6">set_left</a>(search_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>());
<a name="l01628"></a>01628       search_box.<a class="code" href="class_t_b_o_x.html#a2246293d3667b28c52a52353a2d5caea">set_right</a>(search_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + max_gap);
<a name="l01629"></a>01629     } <span class="keywordflow">else</span> {
<a name="l01630"></a>01630       <span class="comment">// We are looking left.</span>
<a name="l01631"></a>01631       search_box.<a class="code" href="class_t_b_o_x.html#a2246293d3667b28c52a52353a2d5caea">set_right</a>(search_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>());
<a name="l01632"></a>01632       search_box.<a class="code" href="class_t_b_o_x.html#ae6151cd794841e100d8a346a0c4a46e6">set_left</a>(search_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() - max_gap);
<a name="l01633"></a>01633     }
<a name="l01634"></a>01634     <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> rsearch(grid);
<a name="l01635"></a>01635     rsearch.StartRectSearch(search_box);
<a name="l01636"></a>01636     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* neighbour;
<a name="l01637"></a>01637     <span class="keywordflow">while</span> ((neighbour = rsearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01638"></a>01638       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; nbox = neighbour-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01639"></a>01639       <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a6c296f134aaae6ee544c4d000d76f80e">x_gap</a>(diacritic_box) &lt; diacritic_gap) {
<a name="l01640"></a>01640         <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() &lt; occupied_box.left())
<a name="l01641"></a>01641           occupied_box.<a class="code" href="class_t_b_o_x.html#ae6151cd794841e100d8a346a0c4a46e6">set_left</a>(nbox.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>());
<a name="l01642"></a>01642         <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() &gt; occupied_box.right())
<a name="l01643"></a>01643           occupied_box.set_right(nbox.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>());
<a name="l01644"></a>01644         <span class="keywordflow">break</span>;
<a name="l01645"></a>01645       }
<a name="l01646"></a>01646     }
<a name="l01647"></a>01647     <span class="keywordflow">if</span> (neighbour == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01648"></a>01648       <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Found a big gap.</span>
<a name="l01649"></a>01649   }
<a name="l01650"></a>01650   <span class="keywordflow">return</span> <span class="keyword">true</span>;  <span class="comment">// The gap was filled.</span>
<a name="l01651"></a>01651 }
<a name="l01652"></a>01652 
<a name="l01653"></a>01653 <span class="comment">// Merges diacritics with the ColPartition of the base character blob.</span>
<a name="l01654"></a>01654 <span class="keywordtype">void</span> StrokeWidth::MergeDiacritics(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l01655"></a>01655                                   ColPartitionGrid* part_grid) {
<a name="l01656"></a>01656   BLOBNBOX_IT small_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l01657"></a>01657   <span class="keywordflow">for</span> (small_it.mark_cycle_pt(); !small_it.cycled_list(); small_it.forward()) {
<a name="l01658"></a>01658     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = small_it.data();
<a name="l01659"></a>01659     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a924df3654c8d3436b30c5a5652e62a89">base_char_blob</a>() != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01660"></a>01660       ColPartition* part = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a924df3654c8d3436b30c5a5652e62a89">base_char_blob</a>()-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>();
<a name="l01661"></a>01661       <span class="comment">// The base character must be owned by a partition and that partition</span>
<a name="l01662"></a>01662       <span class="comment">// must not be on the big_parts list (not block owned).</span>
<a name="l01663"></a>01663       <span class="keywordflow">if</span> (part != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !part-&gt;block_owned() &amp;&amp; blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l01664"></a>01664           blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3dc859a710d5a7473489c2f3e1e36326">IsDiacritic</a>()) {
<a name="l01665"></a>01665         <span class="comment">// The partition has to be removed from the grid and reinserted</span>
<a name="l01666"></a>01666         <span class="comment">// because its bounding box may change.</span>
<a name="l01667"></a>01667         part_grid-&gt;RemoveBBox(part);
<a name="l01668"></a>01668         part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a636e7965ba55518f4e54a75a4a6ee1fd">AddBox</a>(blob);
<a name="l01669"></a>01669         blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9b58644d9ad4f0d01193f47f55dd884f">set_region_type</a>(part-&gt;blob_type());
<a name="l01670"></a>01670         blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a75340334988feba52ce36ba596750a35">set_flow</a>(part-&gt;flow());
<a name="l01671"></a>01671         blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ad573c3bea7351dd2cbdaaffa2ff11c58">set_owner</a>(part);
<a name="l01672"></a>01672         part_grid-&gt;InsertBBox(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l01673"></a>01673       }
<a name="l01674"></a>01674       <span class="comment">// Set all base chars to NULL before any blobs get deleted.</span>
<a name="l01675"></a>01675       blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a6f9b52a46f0c77c395c0a03a99270ac8">set_base_char_blob</a>(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677   }
<a name="l01678"></a>01678 }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680 <span class="comment">// Any blobs on the large_blobs list of block that are still unowned by a</span>
<a name="l01681"></a>01681 <span class="comment">// ColPartition, are probably drop-cap or vertically touching so the blobs</span>
<a name="l01682"></a>01682 <span class="comment">// are removed to the big_parts list and treated separately.</span>
<a name="l01683"></a>01683 <span class="keywordtype">void</span> StrokeWidth::RemoveLargeUnusedBlobs(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block,
<a name="l01684"></a>01684                                          ColPartitionGrid* part_grid,
<a name="l01685"></a>01685                                          ColPartition_LIST* big_parts) {
<a name="l01686"></a>01686   BLOBNBOX_IT large_it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aafe2a9baa69300ee71da42e6dc18cfee">large_blobs</a>);
<a name="l01687"></a>01687   <span class="keywordflow">for</span> (large_it.mark_cycle_pt(); !large_it.cycled_list(); large_it.forward()) {
<a name="l01688"></a>01688     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = large_it.data();
<a name="l01689"></a>01689     ColPartition* big_part = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>();
<a name="l01690"></a>01690     <span class="keywordflow">if</span> (big_part == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01691"></a>01691       <span class="comment">// Large blobs should have gone into partitions by now if they are</span>
<a name="l01692"></a>01692       <span class="comment">// genuine characters, so move any unowned ones out to the big parts</span>
<a name="l01693"></a>01693       <span class="comment">// list. This will include drop caps and vertically touching characters.</span>
<a name="l01694"></a>01694       <a class="code" href="classtesseract_1_1_col_partition.html#a2baab68bca77728c6b50521131dc9b1a">ColPartition::MakeBigPartition</a>(blob, big_parts);
<a name="l01695"></a>01695     }
<a name="l01696"></a>01696   }
<a name="l01697"></a>01697 }
<a name="l01698"></a>01698 
<a name="l01699"></a>01699 <span class="comment">// All remaining unused blobs are put in individual ColPartitions.</span>
<a name="l01700"></a>01700 <span class="keywordtype">void</span> StrokeWidth::PartitionRemainingBlobs(ColPartitionGrid* part_grid) {
<a name="l01701"></a>01701   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l01702"></a>01702   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l01703"></a>01703   <span class="keywordtype">int</span> prev_grid_x = -1;
<a name="l01704"></a>01704   <span class="keywordtype">int</span> prev_grid_y = -1;
<a name="l01705"></a>01705   BLOBNBOX_CLIST cell_list;
<a name="l01706"></a>01706   BLOBNBOX_C_IT cell_it(&amp;cell_list);
<a name="l01707"></a>01707   <span class="keywordtype">bool</span> cell_all_noise = <span class="keyword">true</span>;
<a name="l01708"></a>01708   gsearch.StartFullSearch();
<a name="l01709"></a>01709   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01710"></a>01710     <span class="keywordtype">int</span> grid_x = gsearch.GridX();
<a name="l01711"></a>01711     <span class="keywordtype">int</span> grid_y = gsearch.GridY();
<a name="l01712"></a>01712     <span class="keywordflow">if</span> (grid_x != prev_grid_x || grid_y != prev_grid_y) {
<a name="l01713"></a>01713       <span class="comment">// New cell. Process old cell.</span>
<a name="l01714"></a>01714       MakePartitionsFromCellList(cell_all_noise, part_grid, &amp;cell_list);
<a name="l01715"></a>01715       cell_it.set_to_list(&amp;cell_list);
<a name="l01716"></a>01716       prev_grid_x = grid_x;
<a name="l01717"></a>01717       prev_grid_y = grid_y;
<a name="l01718"></a>01718       cell_all_noise = <span class="keyword">true</span>;
<a name="l01719"></a>01719     }
<a name="l01720"></a>01720     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3fc9ba48fe9dd66461305697568f867a">owner</a>() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01721"></a>01721       cell_it.add_to_end(bbox);
<a name="l01722"></a>01722       <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a>)
<a name="l01723"></a>01723         cell_all_noise = <span class="keyword">false</span>;
<a name="l01724"></a>01724     } <span class="keywordflow">else</span> {
<a name="l01725"></a>01725       cell_all_noise = <span class="keyword">false</span>;
<a name="l01726"></a>01726     }
<a name="l01727"></a>01727   }
<a name="l01728"></a>01728   MakePartitionsFromCellList(cell_all_noise, part_grid, &amp;cell_list);
<a name="l01729"></a>01729 }
<a name="l01730"></a>01730 
<a name="l01731"></a>01731 <span class="comment">// If combine, put all blobs in the cell_list into a single partition, otherwise</span>
<a name="l01732"></a>01732 <span class="comment">// put each one into its own partition.</span>
<a name="l01733"></a>01733 <span class="keywordtype">void</span> StrokeWidth::MakePartitionsFromCellList(<span class="keywordtype">bool</span> combine,
<a name="l01734"></a>01734                                              ColPartitionGrid* part_grid,
<a name="l01735"></a>01735                                              BLOBNBOX_CLIST* cell_list) {
<a name="l01736"></a>01736   <span class="keywordflow">if</span> (cell_list-&gt;empty())
<a name="l01737"></a>01737     <span class="keywordflow">return</span>;
<a name="l01738"></a>01738   BLOBNBOX_C_IT cell_it(cell_list);
<a name="l01739"></a>01739   <span class="keywordflow">if</span> (combine) {
<a name="l01740"></a>01740     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox = cell_it.extract();
<a name="l01741"></a>01741     ColPartition* part = <span class="keyword">new</span> ColPartition(bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>(), <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(0, 1));
<a name="l01742"></a>01742     part-&gt;AddBox(bbox);
<a name="l01743"></a>01743     part-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a75340334988feba52ce36ba596750a35">set_flow</a>(bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>());
<a name="l01744"></a>01744     <span class="keywordflow">for</span> (cell_it.forward(); !cell_it.empty(); cell_it.forward()) {
<a name="l01745"></a>01745       part-&gt;AddBox(cell_it.extract());
<a name="l01746"></a>01746     }
<a name="l01747"></a>01747     CompletePartition(part, part_grid);
<a name="l01748"></a>01748   } <span class="keywordflow">else</span> {
<a name="l01749"></a>01749     <span class="keywordflow">for</span> (; !cell_it.empty(); cell_it.forward()) {
<a name="l01750"></a>01750       <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox = cell_it.extract();
<a name="l01751"></a>01751       ColPartition* part = <span class="keyword">new</span> ColPartition(bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>(), <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(0, 1));
<a name="l01752"></a>01752       part-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a75340334988feba52ce36ba596750a35">set_flow</a>(bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>());
<a name="l01753"></a>01753       part-&gt;AddBox(bbox);
<a name="l01754"></a>01754       CompletePartition(part, part_grid);
<a name="l01755"></a>01755     }
<a name="l01756"></a>01756   }
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759 <span class="comment">// Helper function to finish setting up a ColPartition and insert into</span>
<a name="l01760"></a>01760 <span class="comment">// part_grid.</span>
<a name="l01761"></a>01761 <span class="keywordtype">void</span> StrokeWidth::CompletePartition(ColPartition* part,
<a name="l01762"></a>01762                                     ColPartitionGrid* part_grid) {
<a name="l01763"></a>01763   part-&gt;ComputeLimits();
<a name="l01764"></a>01764   <a class="code" href="class_t_b_o_x.html">TBOX</a> box = part-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01765"></a>01765   <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l01766"></a>01766                                              box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l01767"></a>01767   <span class="keywordtype">int</span> value = projection_-&gt;EvaluateColPartition(*part, denorm_, debug);
<a name="l01768"></a>01768   part-&gt;SetRegionAndFlowTypesFromProjectionValue(value);
<a name="l01769"></a>01769   part-&gt;ClaimBoxes();
<a name="l01770"></a>01770   part_grid-&gt;InsertBBox(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l01771"></a>01771 }
<a name="l01772"></a>01772 
<a name="l01773"></a>01773 <span class="comment">// Merge partitions where the merge appears harmless.</span>
<a name="l01774"></a>01774 <span class="comment">// As this</span>
<a name="l01775"></a>01775 <span class="keywordtype">void</span> StrokeWidth::EasyMerges(ColPartitionGrid* part_grid) {
<a name="l01776"></a>01776   part_grid-&gt;Merges(
<a name="l01777"></a>01777       <a class="code" href="tesscallback_8h.html#ad000c6729bae0f97075ca10a0b5bf7d6">NewPermanentTessCallback</a>(<span class="keyword">this</span>, &amp;StrokeWidth::OrientationSearchBox),
<a name="l01778"></a>01778       <a class="code" href="tesscallback_8h.html#ad000c6729bae0f97075ca10a0b5bf7d6">NewPermanentTessCallback</a>(<span class="keyword">this</span>, &amp;StrokeWidth::ConfirmEasyMerge));
<a name="l01779"></a>01779 }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781 <span class="comment">// Compute a search box based on the orientation of the partition.</span>
<a name="l01782"></a>01782 <span class="comment">// Returns true if a suitable box can be calculated.</span>
<a name="l01783"></a>01783 <span class="comment">// Callback for EasyMerges.</span>
<a name="l01784"></a>01784 <span class="keywordtype">bool</span> StrokeWidth::OrientationSearchBox(ColPartition* part, <a class="code" href="class_t_b_o_x.html">TBOX</a>* box) {
<a name="l01785"></a>01785   <span class="keywordflow">if</span> (part-&gt;IsVerticalType()) {
<a name="l01786"></a>01786     box-&gt;<a class="code" href="class_t_b_o_x.html#a7f40dfd290a907200bdc98c196f63f45">set_top</a>(box-&gt;<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>() + box-&gt;<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>());
<a name="l01787"></a>01787     box-&gt;<a class="code" href="class_t_b_o_x.html#a6f803b24b046883cb0f3882dc3d92302">set_bottom</a>(box-&gt;<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>() - box-&gt;<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>());
<a name="l01788"></a>01788   } <span class="keywordflow">else</span> {
<a name="l01789"></a>01789     box-&gt;<a class="code" href="class_t_b_o_x.html#ae6151cd794841e100d8a346a0c4a46e6">set_left</a>(box-&gt;<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() - box-&gt;<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>());
<a name="l01790"></a>01790     box-&gt;<a class="code" href="class_t_b_o_x.html#a2246293d3667b28c52a52353a2d5caea">set_right</a>(box-&gt;<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() + box-&gt;<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>());
<a name="l01791"></a>01791   }
<a name="l01792"></a>01792   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01793"></a>01793 }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795 <span class="comment">// Merge confirmation callback for EasyMerges.</span>
<a name="l01796"></a>01796 <span class="keywordtype">bool</span> StrokeWidth::ConfirmEasyMerge(<span class="keyword">const</span> ColPartition* p1,
<a name="l01797"></a>01797                                    <span class="keyword">const</span> ColPartition* p2) {
<a name="l01798"></a>01798   <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(p1 != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; p2 != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01799"></a>01799   <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(!p1-&gt;IsEmpty() &amp;&amp; !p2-&gt;IsEmpty());
<a name="l01800"></a>01800   <span class="keywordflow">if</span> ((p1-&gt;flow() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a> &amp;&amp; p2-&gt;flow() &gt;= <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a>) ||
<a name="l01801"></a>01801       (p1-&gt;flow() &gt;= <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a> &amp;&amp; p2-&gt;flow() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a>))
<a name="l01802"></a>01802     <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Don&#39;t merge confirmed image with text.</span>
<a name="l01803"></a>01803   <span class="keywordflow">if</span> ((p1-&gt;IsVerticalType() || p2-&gt;IsVerticalType()) &amp;&amp;
<a name="l01804"></a>01804        p1-&gt;HCoreOverlap(*p2) &lt;= 0 &amp;&amp;
<a name="l01805"></a>01805        ((!p1-&gt;IsSingleton() &amp;&amp;
<a name="l01806"></a>01806          !p2-&gt;IsSingleton()) ||
<a name="l01807"></a>01807         !p1-&gt;bounding_box().major_overlap(p2-&gt;bounding_box())))
<a name="l01808"></a>01808     <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Overlap must be in the text line.</span>
<a name="l01809"></a>01809   <span class="keywordflow">if</span> ((p1-&gt;IsHorizontalType() || p2-&gt;IsHorizontalType()) &amp;&amp;
<a name="l01810"></a>01810       p1-&gt;VCoreOverlap(*p2) &lt;= 0 &amp;&amp;
<a name="l01811"></a>01811       ((!p1-&gt;IsSingleton() &amp;&amp;
<a name="l01812"></a>01812         !p2-&gt;IsSingleton()) ||
<a name="l01813"></a>01813        (!p1-&gt;bounding_box().major_overlap(p2-&gt;bounding_box()) &amp;&amp;
<a name="l01814"></a>01814         !p1-&gt;OKDiacriticMerge(*p2, <span class="keyword">false</span>) &amp;&amp;
<a name="l01815"></a>01815         !p2-&gt;OKDiacriticMerge(*p1, <span class="keyword">false</span>))))
<a name="l01816"></a>01816     <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Overlap must be in the text line.</span>
<a name="l01817"></a>01817   <span class="keywordflow">if</span> (!p1-&gt;ConfirmNoTabViolation(*p2))
<a name="l01818"></a>01818     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01819"></a>01819   <span class="keywordflow">if</span> (p1-&gt;flow() &lt;= <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a> &amp;&amp; p2-&gt;flow() &lt;= <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a>)
<a name="l01820"></a>01820     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01821"></a>01821   <span class="keywordflow">return</span> NoNoiseInBetween(p1-&gt;bounding_box(), p2-&gt;bounding_box());
<a name="l01822"></a>01822 }
<a name="l01823"></a>01823 
<a name="l01824"></a>01824 <span class="comment">// Returns true if there is no significant noise in between the boxes.</span>
<a name="l01825"></a>01825 <span class="keywordtype">bool</span> StrokeWidth::NoNoiseInBetween(<span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box1, <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box2)<span class="keyword"> const </span>{
<a name="l01826"></a>01826   <span class="keywordflow">return</span> <a class="code" href="classtesseract_1_1_image_find.html#a958b710c77aa2f60d139dbd50f2bb4d6">ImageFind::BlankImageInBetween</a>(box1, box2, grid_box_, rerotation_,
<a name="l01827"></a>01827                                         nontext_map_);
<a name="l01828"></a>01828 }
<a name="l01829"></a>01829 
<a name="l01833"></a>01833 <a class="code" href="class_scroll_view.html">ScrollView</a>* StrokeWidth::DisplayGoodBlobs(<span class="keyword">const</span> <span class="keywordtype">char</span>* window_name,
<a name="l01834"></a>01834                                           <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) {
<a name="l01835"></a>01835   <a class="code" href="class_scroll_view.html">ScrollView</a>* window = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01836"></a>01836 <span class="preprocessor">#ifndef GRAPHICS_DISABLED</span>
<a name="l01837"></a>01837 <span class="preprocessor"></span>  window = <a class="code" href="classtesseract_1_1_b_b_grid.html#aa716f76c7f04f7112abfc10a3f8c63e0">MakeWindow</a>(x, y, window_name);
<a name="l01838"></a>01838   <span class="comment">// For every blob in the grid, display it.</span>
<a name="l01839"></a>01839   window-&gt;<a class="code" href="class_scroll_view.html#ad5f03af259325c42eaaffa843cd1fdde">Brush</a>(<a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a77673d8f27617bcfe50a6ebdd81e8c79">ScrollView::NONE</a>);
<a name="l01840"></a>01840 
<a name="l01841"></a>01841   <span class="comment">// For every bbox in the grid, display it.</span>
<a name="l01842"></a>01842   <a class="code" href="namespacetesseract.html#a2681de132e11a73d6fc4f281b2750109">BlobGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l01843"></a>01843   gsearch.StartFullSearch();
<a name="l01844"></a>01844   <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* bbox;
<a name="l01845"></a>01845   <span class="keywordflow">while</span> ((bbox = gsearch.NextFullSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01846"></a>01846     <a class="code" href="class_t_b_o_x.html">TBOX</a> box = bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01847"></a>01847     <span class="keywordtype">int</span> left_x = box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>();
<a name="l01848"></a>01848     <span class="keywordtype">int</span> right_x = box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>();
<a name="l01849"></a>01849     <span class="keywordtype">int</span> top_y = box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>();
<a name="l01850"></a>01850     <span class="keywordtype">int</span> bottom_y = box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>();
<a name="l01851"></a>01851     <span class="keywordtype">int</span> goodness = bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a17600c15bdfd57f24bb7ec5b2765a48f">GoodTextBlob</a>();
<a name="l01852"></a>01852     <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> blob_type = bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>();
<a name="l01853"></a>01853     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#aa4e11bd4e9e5903b52bcd363db008f2e">UniquelyVertical</a>())
<a name="l01854"></a>01854       blob_type = <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>;
<a name="l01855"></a>01855     <span class="keywordflow">if</span> (bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a4faf8ec29ebb0f3c2fbdd158fd33cdc9">UniquelyHorizontal</a>())
<a name="l01856"></a>01856       blob_type = <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>;
<a name="l01857"></a>01857     <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> flow = bbox-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>();
<a name="l01858"></a>01858     <span class="keywordflow">if</span> (flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a745b15b1c990fa88c0712c50c5cd2202">BTFT_NONE</a>) {
<a name="l01859"></a>01859       <span class="keywordflow">if</span> (goodness == 0)
<a name="l01860"></a>01860         flow = <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1adac19762bd040a53914be696482c1e53">BTFT_NEIGHBOURS</a>;
<a name="l01861"></a>01861       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (goodness == 1)
<a name="l01862"></a>01862         flow = <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a>;
<a name="l01863"></a>01863       <span class="keywordflow">else</span>
<a name="l01864"></a>01864         flow = <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a>;
<a name="l01865"></a>01865     }
<a name="l01866"></a>01866     window-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7351d74f423975d676f47e4dc05e267f">BLOBNBOX::TextlineColor</a>(blob_type, flow));
<a name="l01867"></a>01867     window-&gt;<a class="code" href="class_scroll_view.html#ac2a8fdf5d37967ea4a298dc092b6ed0e">Rectangle</a>(left_x, bottom_y, right_x, top_y);
<a name="l01868"></a>01868   }
<a name="l01869"></a>01869   window-&gt;<a class="code" href="class_scroll_view.html#a0830a51981a20c8700b5ec49137e46e9">Update</a>();
<a name="l01870"></a>01870 <span class="preprocessor">#endif</span>
<a name="l01871"></a>01871 <span class="preprocessor"></span>  <span class="keywordflow">return</span> window;
<a name="l01872"></a>01872 }
<a name="l01873"></a>01873 
<a name="l01874"></a>01874 <span class="keyword">static</span> <span class="keywordtype">void</span> DrawDiacriticJoiner(<span class="keyword">const</span> <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob, <a class="code" href="class_scroll_view.html">ScrollView</a>* window) {
<a name="l01875"></a>01875   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; blob_box(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>());
<a name="l01876"></a>01876   <span class="keywordtype">int</span> top = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(blob_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>(), blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#af83ee964739e33a2611a1ba4b21f7a4c">base_char_top</a>());
<a name="l01877"></a>01877   <span class="keywordtype">int</span> bottom = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(blob_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a6fd24eab699bad3b00917fea0a82792b">base_char_bottom</a>());
<a name="l01878"></a>01878   <span class="keywordtype">int</span> x = (blob_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + blob_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>()) / 2;
<a name="l01879"></a>01879 <span class="preprocessor">  #ifndef GRAPHICS_DISABLED</span>
<a name="l01880"></a>01880 <span class="preprocessor"></span>  window-&gt;<a class="code" href="class_scroll_view.html#a2ba16f17fc401bb28be1a08160207e45">Line</a>(x, top, x, bottom);
<a name="l01881"></a>01881 <span class="preprocessor">  #endif  // GRAPHICS_DISABLED</span>
<a name="l01882"></a>01882 <span class="preprocessor"></span>}
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 <span class="comment">// Displays blobs colored according to whether or not they are diacritics.</span>
<a name="l01885"></a>01885 <a class="code" href="class_scroll_view.html">ScrollView</a>* StrokeWidth::DisplayDiacritics(<span class="keyword">const</span> <span class="keywordtype">char</span>* window_name,
<a name="l01886"></a>01886                                            <span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l01887"></a>01887   <a class="code" href="class_scroll_view.html">ScrollView</a>* window = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01888"></a>01888 <span class="preprocessor">#ifndef GRAPHICS_DISABLED</span>
<a name="l01889"></a>01889 <span class="preprocessor"></span>  window = <a class="code" href="classtesseract_1_1_b_b_grid.html#aa716f76c7f04f7112abfc10a3f8c63e0">MakeWindow</a>(x, y, window_name);
<a name="l01890"></a>01890   <span class="comment">// For every blob in the grid, display it.</span>
<a name="l01891"></a>01891   window-&gt;<a class="code" href="class_scroll_view.html#ad5f03af259325c42eaaffa843cd1fdde">Brush</a>(<a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a77673d8f27617bcfe50a6ebdd81e8c79">ScrollView::NONE</a>);
<a name="l01892"></a>01892 
<a name="l01893"></a>01893   BLOBNBOX_IT it(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a5dd67c54162a6b60b0fd11500d4a3025">blobs</a>);
<a name="l01894"></a>01894   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l01895"></a>01895     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = it.data();
<a name="l01896"></a>01896     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3dc859a710d5a7473489c2f3e1e36326">IsDiacritic</a>()) {
<a name="l01897"></a>01897       window-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(ScrollView::GREEN);
<a name="l01898"></a>01898       DrawDiacriticJoiner(blob, window);
<a name="l01899"></a>01899     } <span class="keywordflow">else</span> {
<a name="l01900"></a>01900       window-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a88b94d1e2384a734dba0b553e86307b1">BoxColor</a>());
<a name="l01901"></a>01901     }
<a name="l01902"></a>01902     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01903"></a>01903     window-&gt;<a class="code" href="class_scroll_view.html#ac2a8fdf5d37967ea4a298dc092b6ed0e">Rectangle</a>(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box. bottom(), box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l01904"></a>01904   }
<a name="l01905"></a>01905   it.set_to_list(&amp;block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#aa6a3757d385e79ab76f34afb6e8fc684">noise_blobs</a>);
<a name="l01906"></a>01906   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l01907"></a>01907     <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = it.data();
<a name="l01908"></a>01908     <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a3dc859a710d5a7473489c2f3e1e36326">IsDiacritic</a>()) {
<a name="l01909"></a>01909       window-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(ScrollView::GREEN);
<a name="l01910"></a>01910       DrawDiacriticJoiner(blob, window);
<a name="l01911"></a>01911     } <span class="keywordflow">else</span> {
<a name="l01912"></a>01912       window-&gt;<a class="code" href="class_scroll_view.html#a79855c525ec660b452382e9813d2edb5">Pen</a>(<a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a0eab2b208fc9a5e2774f92cf3e768982">ScrollView::WHITE</a>);
<a name="l01913"></a>01913     }
<a name="l01914"></a>01914     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01915"></a>01915     window-&gt;<a class="code" href="class_scroll_view.html#ac2a8fdf5d37967ea4a298dc092b6ed0e">Rectangle</a>(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box. bottom(), box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l01916"></a>01916   }
<a name="l01917"></a>01917   window-&gt;<a class="code" href="class_scroll_view.html#a0830a51981a20c8700b5ec49137e46e9">Update</a>();
<a name="l01918"></a>01918 <span class="preprocessor">#endif</span>
<a name="l01919"></a>01919 <span class="preprocessor"></span>  <span class="keywordflow">return</span> window;
<a name="l01920"></a>01920 }
<a name="l01921"></a>01921 
<a name="l01922"></a>01922 }  <span class="comment">// namespace tesseract.</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="strokewidth_8cpp.html">strokewidth.cpp</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Fri Mar 30 2012 23:21:39 for Tesseract by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
