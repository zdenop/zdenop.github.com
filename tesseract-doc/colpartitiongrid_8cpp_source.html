<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Tesseract: tesseract-ocr/textord/colpartitiongrid.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tesseract
   &#160;<span id="projectnumber">3.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('colpartitiongrid_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">tesseract-ocr/textord/colpartitiongrid.cpp</div>  </div>
</div>
<div class="contents">
<a href="colpartitiongrid_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">// File:        colpartitionrid.h</span>
<a name="l00003"></a>00003 <span class="comment">// Description: Class collecting code that acts on a BBGrid of ColPartitions.</span>
<a name="l00004"></a>00004 <span class="comment">// Author:      Ray Smith</span>
<a name="l00005"></a>00005 <span class="comment">// Created:     Mon Oct 05 08:42:01 PDT 2009</span>
<a name="l00006"></a>00006 <span class="comment">//</span>
<a name="l00007"></a>00007 <span class="comment">// (C) Copyright 2009, Google Inc.</span>
<a name="l00008"></a>00008 <span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00009"></a>00009 <span class="comment">// you may not use this file except in compliance with the License.</span>
<a name="l00010"></a>00010 <span class="comment">// You may obtain a copy of the License at</span>
<a name="l00011"></a>00011 <span class="comment">// http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00012"></a>00012 <span class="comment">// Unless required by applicable law or agreed to in writing, software</span>
<a name="l00013"></a>00013 <span class="comment">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00014"></a>00014 <span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00015"></a>00015 <span class="comment">// See the License for the specific language governing permissions and</span>
<a name="l00016"></a>00016 <span class="comment">// limitations under the License.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00019"></a>00019 <span class="comment"></span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="colpartitiongrid_8h.html">colpartitiongrid.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="colpartitionset_8h.html">colpartitionset.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="imagefind_8h.html">imagefind.h</a>&quot;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="keyword">namespace </span>tesseract {
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="namespacetesseract.html#a93b5f759bbf4ffd7d98bca6a31391235">00026</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a>(<a class="code" href="namespacetesseract.html#a93b5f759bbf4ffd7d98bca6a31391235">textord_tabfind_show_color_fit</a>, <span class="keyword">false</span>, <span class="stringliteral">&quot;Show stroke widths&quot;</span>);
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">// Max pad factor used to search the neighbourhood of a partition to smooth</span>
<a name="l00029"></a>00029 <span class="comment">// partition types.</span>
<a name="l00030"></a><a class="code" href="namespacetesseract.html#aae8f2f2cc0e41a6cc4a6d1bf322f4b2a">00030</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#aae8f2f2cc0e41a6cc4a6d1bf322f4b2a">kMaxPadFactor</a> = 6;
<a name="l00031"></a>00031 <span class="comment">// Max multiple of size (min(height, width)) for the distance of the nearest</span>
<a name="l00032"></a>00032 <span class="comment">// neighbour for the change of type to be used.</span>
<a name="l00033"></a><a class="code" href="namespacetesseract.html#ae4ffbfaa120044bd1f22b6f95ead9dce">00033</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#ae4ffbfaa120044bd1f22b6f95ead9dce">kMaxNeighbourDistFactor</a> = 4;
<a name="l00034"></a>00034 <span class="comment">// Max RMS color noise to compare colors.</span>
<a name="l00035"></a>00035 <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#abf95c90bc0630ea9218c2eb0d70472dd">kMaxRMSColorNoise</a> = 128;
<a name="l00036"></a>00036 <span class="comment">// Minimum number of blobs in text to make a strong text partition.</span>
<a name="l00037"></a>00037 <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a32f2825c55e218c93202c88eb0a9e9cd">kHorzStrongTextlineCount</a> = 10;
<a name="l00038"></a>00038 <span class="comment">// Maximum number of lines in a credible figure caption.</span>
<a name="l00039"></a><a class="code" href="namespacetesseract.html#a0c0112882a0fd4d5db231341b276748f">00039</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a0c0112882a0fd4d5db231341b276748f">kMaxCaptionLines</a> = 7;
<a name="l00040"></a>00040 <span class="comment">// Min ratio between biggest and smallest gap to bound a caption.</span>
<a name="l00041"></a><a class="code" href="namespacetesseract.html#aede50c5fa6fdad612c08e73757501178">00041</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#aede50c5fa6fdad612c08e73757501178">kMinCaptionGapRatio</a> = 2.0;
<a name="l00042"></a>00042 <span class="comment">// Min ratio between biggest gap and mean line height to bound a caption.</span>
<a name="l00043"></a><a class="code" href="namespacetesseract.html#a3edae94975001932766025af12aa9615">00043</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a3edae94975001932766025af12aa9615">kMinCaptionGapHeightRatio</a> = 0.5;
<a name="l00044"></a>00044 <span class="comment">// Min fraction of ColPartition height to be overlapping for margin purposes.</span>
<a name="l00045"></a>00045 <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#acea5cf3f3fc7999a57079cc1bb4104f7">kMarginOverlapFraction</a> = 0.25;
<a name="l00046"></a>00046 <span class="comment">// Size ratio required to consider an unmerged overlapping partition to be big.</span>
<a name="l00047"></a><a class="code" href="namespacetesseract.html#a45530b4b5280b8d2f185a531cab4169b">00047</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a45530b4b5280b8d2f185a531cab4169b">kBigPartSizeRatio</a> = 1.75;
<a name="l00048"></a>00048 <span class="comment">// Allowed proportional change in stroke width to match for smoothing.</span>
<a name="l00049"></a><a class="code" href="namespacetesseract.html#abc28700fa5d19f82a78db318450d7786">00049</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#abc28700fa5d19f82a78db318450d7786">kStrokeWidthFractionTolerance</a> = 0.25;
<a name="l00050"></a>00050 <span class="comment">// Allowed constant change in stroke width to match for smoothing.</span>
<a name="l00051"></a><a class="code" href="namespacetesseract.html#a7dc74940f73222c81918e8701c301516">00051</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a7dc74940f73222c81918e8701c301516">kStrokeWidthConstantTolerance</a> = 2.0;
<a name="l00052"></a>00052 <span class="comment">// Fraction of gridsize to allow arbitrary overlap between partitions.</span>
<a name="l00053"></a><a class="code" href="namespacetesseract.html#a1fa28613a5db6fb9d0c7fdef0f151872">00053</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a1fa28613a5db6fb9d0c7fdef0f151872">kTinyEnoughTextlineOverlapFraction</a> = 0.25;
<a name="l00054"></a>00054 <span class="comment">// Max vertical distance of neighbouring ColPartition as a multiple of</span>
<a name="l00055"></a>00055 <span class="comment">// partition height for it to be a partner.</span>
<a name="l00056"></a>00056 <span class="comment">// TODO(rays) fix the problem that causes a larger number to not work well.</span>
<a name="l00057"></a>00057 <span class="comment">// The value needs to be larger as sparse text blocks in a page that gets</span>
<a name="l00058"></a>00058 <span class="comment">// marked as single column will not find adjacent lines as partners, and</span>
<a name="l00059"></a>00059 <span class="comment">// will merge horizontally distant, but aligned lines. See rep.4B3 p5.</span>
<a name="l00060"></a>00060 <span class="comment">// The value needs to be small because double-spaced legal docs written</span>
<a name="l00061"></a>00061 <span class="comment">// in a single column, but justified courier have widely spaced lines</span>
<a name="l00062"></a>00062 <span class="comment">// that need to get merged before they partner-up with the lines above</span>
<a name="l00063"></a>00063 <span class="comment">// and below. See legal.3B5 p13/17. Neither of these should depend on</span>
<a name="l00064"></a>00064 <span class="comment">// the value of kMaxPartitionSpacing to be successful, and ColPartition</span>
<a name="l00065"></a>00065 <span class="comment">// merging needs attention to fix this problem.</span>
<a name="l00066"></a><a class="code" href="namespacetesseract.html#a03ac774c4cfbfe5f2b611e59b1e3f74b">00066</a> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#a03ac774c4cfbfe5f2b611e59b1e3f74b">kMaxPartitionSpacing</a> = 1.75;
<a name="l00067"></a>00067 <span class="comment">// Margin by which text has to beat image or vice-versa to make a firm</span>
<a name="l00068"></a>00068 <span class="comment">// decision in GridSmoothNeighbour.</span>
<a name="l00069"></a><a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">00069</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a> = 4;
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#af3cb4db916111aede6f4afde7fed8dca">00071</a> <a class="code" href="classtesseract_1_1_col_partition_grid.html#af3cb4db916111aede6f4afde7fed8dca">ColPartitionGrid::ColPartitionGrid</a>() {
<a name="l00072"></a>00072 }
<a name="l00073"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a29878383f06cd732816107b672efa42f">00073</a> <a class="code" href="classtesseract_1_1_col_partition_grid.html#af3cb4db916111aede6f4afde7fed8dca">ColPartitionGrid::ColPartitionGrid</a>(<span class="keywordtype">int</span> gridsize,
<a name="l00074"></a>00074                                    <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; bleft, <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; tright)
<a name="l00075"></a>00075   : <a class="code" href="classtesseract_1_1_b_b_grid.html">BBGrid</a>&lt;<a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>, ColPartition_CLIST, ColPartition_C_IT&gt;(gridsize,
<a name="l00076"></a>00076                                                                 bleft, tright) {
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ac05ecda9fea55d1456474fe368681c43">00079</a> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ac05ecda9fea55d1456474fe368681c43">ColPartitionGrid::~ColPartitionGrid</a>() {
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">// Handles a click event in a display window.</span>
<a name="l00083"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ace404c79d8fae1a884f15ea234a5a1a1">00083</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ace404c79d8fae1a884f15ea234a5a1a1">ColPartitionGrid::HandleClick</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) {
<a name="l00084"></a>00084   <a class="code" href="classtesseract_1_1_b_b_grid.html">BBGrid</a>&lt;<a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>,
<a name="l00085"></a>00085          ColPartition_CLIST, ColPartition_C_IT&gt;<a class="code" href="classtesseract_1_1_col_partition_grid.html#ace404c79d8fae1a884f15ea234a5a1a1">::HandleClick</a>(x, y);
<a name="l00086"></a>00086   <span class="comment">// Run a radial search for partitions that overlap.</span>
<a name="l00087"></a>00087   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> radsearch(<span class="keyword">this</span>);
<a name="l00088"></a>00088   radsearch.<a class="code" href="classtesseract_1_1_grid_search.html#a3c44b7c8272584600153d8249a841e73">SetUniqueMode</a>(<span class="keyword">true</span>);
<a name="l00089"></a>00089   radsearch.<a class="code" href="classtesseract_1_1_grid_search.html#a2c170fae34250472834f9ed50cfb83db">StartRadSearch</a>(x, y, 1);
<a name="l00090"></a>00090   ColPartition* neighbour;
<a name="l00091"></a>00091   <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a> click(x, y);
<a name="l00092"></a>00092   <span class="keywordflow">while</span> ((neighbour = radsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aeed540deb91d38e3cd390d4caf1bd44f">NextRadSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00093"></a>00093     <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00094"></a>00094     <span class="keywordflow">if</span> (nbox.<a class="code" href="class_t_b_o_x.html#a5d4e2c5f91b791e94d4c94e513180632">contains</a>(click)) {
<a name="l00095"></a>00095       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Block box:&quot;</span>);
<a name="l00096"></a>00096       neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00097"></a>00097       neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099   }
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="comment">// Merges ColPartitions in the grid that look like they belong in the same</span>
<a name="l00103"></a>00103 <span class="comment">// textline.</span>
<a name="l00104"></a>00104 <span class="comment">// For all partitions in the grid, calls the box_cb permanent callback</span>
<a name="l00105"></a>00105 <span class="comment">// to compute the search box, seaches the box, and if a candidate is found,</span>
<a name="l00106"></a>00106 <span class="comment">// calls the confirm_cb to check any more rules. If the confirm_cb returns</span>
<a name="l00107"></a>00107 <span class="comment">// true, then the partitions are merged.</span>
<a name="l00108"></a>00108 <span class="comment">// Both callbacks are deleted before returning.</span>
<a name="l00109"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a5a2c2f6ef0b1b5a0febab87ffb0f764d">00109</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a5a2c2f6ef0b1b5a0febab87ffb0f764d">ColPartitionGrid::Merges</a>(
<a name="l00110"></a>00110     <a class="code" href="class_tess_result_callback2.html">TessResultCallback2&lt;bool, ColPartition*, TBOX*&gt;</a>* box_cb,
<a name="l00111"></a>00111     <a class="code" href="class_tess_result_callback2.html">TessResultCallback2</a>&lt;<span class="keywordtype">bool</span>, <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>*,
<a name="l00112"></a>00112                         <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>*&gt;* confirm_cb) {
<a name="l00113"></a>00113   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00114"></a>00114   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00115"></a>00115   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00116"></a>00116   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00117"></a>00117   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_col_partition_grid.html#a9e8324dcf738819305dfec86b504f27c">MergePart</a>(box_cb, confirm_cb, part))
<a name="l00119"></a>00119       gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l00120"></a>00120   }
<a name="l00121"></a>00121   <span class="keyword">delete</span> box_cb;
<a name="l00122"></a>00122   <span class="keyword">delete</span> confirm_cb;
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="comment">// For the given partition, calls the box_cb permanent callback</span>
<a name="l00126"></a>00126 <span class="comment">// to compute the search box, searches the box, and if a candidate is found,</span>
<a name="l00127"></a>00127 <span class="comment">// calls the confirm_cb to check any more rules. If the confirm_cb returns</span>
<a name="l00128"></a>00128 <span class="comment">// true, then the partitions are merged.</span>
<a name="l00129"></a>00129 <span class="comment">// Returns true if the partition is consumed by one or more merges.</span>
<a name="l00130"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a9e8324dcf738819305dfec86b504f27c">00130</a> <span class="keywordtype">bool</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a9e8324dcf738819305dfec86b504f27c">ColPartitionGrid::MergePart</a>(
<a name="l00131"></a>00131     <a class="code" href="class_tess_result_callback2.html">TessResultCallback2&lt;bool, ColPartition*, TBOX*&gt;</a>* box_cb,
<a name="l00132"></a>00132     <a class="code" href="class_tess_result_callback2.html">TessResultCallback2</a>&lt;<span class="keywordtype">bool</span>, <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>*,
<a name="l00133"></a>00133                         <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>*&gt;* confirm_cb,
<a name="l00134"></a>00134     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part) {
<a name="l00135"></a>00135   <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a186886f273a6120362badb64ae4d79ce">IsUnMergeableType</a>())
<a name="l00136"></a>00136     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00137"></a>00137   <span class="keywordtype">bool</span> any_done = <span class="keyword">false</span>;
<a name="l00138"></a>00138   <span class="comment">// Repeatedly merge part while we find a best merge candidate that works.</span>
<a name="l00139"></a>00139   <span class="keywordtype">bool</span> merge_done = <span class="keyword">false</span>;
<a name="l00140"></a>00140   <span class="keywordflow">do</span> {
<a name="l00141"></a>00141     merge_done = <span class="keyword">false</span>;
<a name="l00142"></a>00142     <a class="code" href="class_t_b_o_x.html">TBOX</a> box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00143"></a>00143     <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (debug) {
<a name="l00145"></a>00145       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Merge candidate:&quot;</span>);
<a name="l00146"></a>00146       box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00147"></a>00147     }
<a name="l00148"></a>00148     <span class="comment">// Set up a rectangle search bounded by the part.</span>
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (!box_cb-&gt;<a class="code" href="class_tess_result_callback2.html#a61bd799697bce338fc064326a7b764e3">Run</a>(part, &amp;box))
<a name="l00150"></a>00150       <span class="keywordflow">continue</span>;
<a name="l00151"></a>00151     <span class="comment">// Create a list of merge candidates.</span>
<a name="l00152"></a>00152     ColPartition_CLIST merge_candidates;
<a name="l00153"></a>00153     FindMergeCandidates(part, box, debug, &amp;merge_candidates);
<a name="l00154"></a>00154     <span class="comment">// Find the best merge candidate based on minimal overlap increase.</span>
<a name="l00155"></a>00155     <span class="keywordtype">int</span> overlap_increase;
<a name="l00156"></a>00156     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* neighbour = <a class="code" href="classtesseract_1_1_col_partition_grid.html#a2d5a64ce0293feaa94880ee1397bd65a">BestMergeCandidate</a>(part, &amp;merge_candidates, debug,
<a name="l00157"></a>00157                                                  confirm_cb,
<a name="l00158"></a>00158                                                  &amp;overlap_increase);
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; overlap_increase &lt;= 0) {
<a name="l00160"></a>00160       <span class="keywordflow">if</span> (debug) {
<a name="l00161"></a>00161         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Merging:hoverlap=%d, voverlap=%d, OLI=%d\n&quot;</span>,
<a name="l00162"></a>00162                 part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#adbe1f191ede26132fc0437dfd969f2b2">HCoreOverlap</a>(*neighbour), part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a4f7962f226fc6e687a5dfff0f9e40e94">VCoreOverlap</a>(*neighbour),
<a name="l00163"></a>00163                 overlap_increase);
<a name="l00164"></a>00164       }
<a name="l00165"></a>00165       <span class="comment">// Looks like a good candidate so merge it.</span>
<a name="l00166"></a>00166       <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(neighbour);
<a name="l00167"></a>00167       <span class="comment">// We will modify the box of part, so remove it from the grid, merge</span>
<a name="l00168"></a>00168       <span class="comment">// it and then re-insert it into the grid.</span>
<a name="l00169"></a>00169       <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(part);
<a name="l00170"></a>00170       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aedb906fb73709c79d702f0f95a85b300">Absorb</a>(neighbour, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00171"></a>00171       <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00172"></a>00172       merge_done = <span class="keyword">true</span>;
<a name="l00173"></a>00173       any_done = <span class="keyword">true</span>;
<a name="l00174"></a>00174     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00175"></a>00175       <span class="keywordflow">if</span> (debug) {
<a name="l00176"></a>00176         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Overlapped when merged with increase %d: &quot;</span>, overlap_increase);
<a name="l00177"></a>00177         neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00178"></a>00178       }
<a name="l00179"></a>00179     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (debug) {
<a name="l00180"></a>00180       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;No candidate neighbour returned\n&quot;</span>);
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182   } <span class="keywordflow">while</span> (merge_done);
<a name="l00183"></a>00183   <span class="keywordflow">return</span> any_done;
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">// Returns true if the given part and merge candidate might believably</span>
<a name="l00187"></a>00187 <span class="comment">// be part of a single text line according to the default rules.</span>
<a name="l00188"></a>00188 <span class="comment">// In general we only want to merge partitions that look like they</span>
<a name="l00189"></a>00189 <span class="comment">// are on the same text line, ie their median limits overlap, but we have</span>
<a name="l00190"></a>00190 <span class="comment">// to make exceptions for diacritics and stray punctuation.</span>
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">bool</span> OKMergeCandidate(<span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part,
<a name="l00192"></a>00192                              <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* candidate,
<a name="l00193"></a>00193                              <span class="keywordtype">bool</span> debug) {
<a name="l00194"></a>00194   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00195"></a>00195   <span class="keywordflow">if</span> (candidate == part)
<a name="l00196"></a>00196     <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Ignore itself.</span>
<a name="l00197"></a>00197   <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a774f9c6444621a78264fa2a2a401cf9a">TypesMatch</a>(*candidate) || candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a186886f273a6120362badb64ae4d79ce">IsUnMergeableType</a>())
<a name="l00198"></a>00198     <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Don&#39;t mix inappropriate types.</span>
<a name="l00199"></a>00199 
<a name="l00200"></a>00200   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; c_box = candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00201"></a>00201   <span class="keywordflow">if</span> (debug) {
<a name="l00202"></a>00202     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Examining merge candidate:&quot;</span>);
<a name="l00203"></a>00203     c_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00204"></a>00204   }
<a name="l00205"></a>00205   <span class="comment">// Candidates must be within a reasonable distance.</span>
<a name="l00206"></a>00206   <span class="keywordflow">if</span> (candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aec438c63bf754474982b2bb4e74148b5">IsVerticalType</a>() || part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aec438c63bf754474982b2bb4e74148b5">IsVerticalType</a>()) {
<a name="l00207"></a>00207     <span class="keywordtype">int</span> h_dist = -part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#adbe1f191ede26132fc0437dfd969f2b2">HCoreOverlap</a>(*candidate);
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (h_dist &gt;= <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(part_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>(), c_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>()) / 2) {
<a name="l00209"></a>00209       <span class="keywordflow">if</span> (debug)
<a name="l00210"></a>00210         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Too far away: h_dist = %d\n&quot;</span>, h_dist);
<a name="l00211"></a>00211       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213   } <span class="keywordflow">else</span> {
<a name="l00214"></a>00214     <span class="comment">// Coarse filter by vertical distance between partitions.</span>
<a name="l00215"></a>00215     <span class="keywordtype">int</span> v_dist = -part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a4f7962f226fc6e687a5dfff0f9e40e94">VCoreOverlap</a>(*candidate);
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (v_dist &gt;= <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(part_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>(), c_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>()) / 2) {
<a name="l00217"></a>00217       <span class="keywordflow">if</span> (debug)
<a name="l00218"></a>00218         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Too far away: v_dist = %d\n&quot;</span>, v_dist);
<a name="l00219"></a>00219       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221     <span class="comment">// Candidates must either overlap in median y,</span>
<a name="l00222"></a>00222     <span class="comment">// or part or candidate must be an acceptable diacritic.</span>
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aa1eda3b89ee0c745279bbb8911db00b6">VSignificantCoreOverlap</a>(*candidate) &amp;&amp;
<a name="l00224"></a>00224         !part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a050a14aa4fa9b11f90e058ca242c4fcf">OKDiacriticMerge</a>(*candidate, debug) &amp;&amp;
<a name="l00225"></a>00225         !candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a050a14aa4fa9b11f90e058ca242c4fcf">OKDiacriticMerge</a>(*part, debug)) {
<a name="l00226"></a>00226       <span class="keywordflow">if</span> (debug)
<a name="l00227"></a>00227         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Candidate fails overlap and diacritic tests!\n&quot;</span>);
<a name="l00228"></a>00228       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230   }
<a name="l00231"></a>00231   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <span class="comment">// Helper function to compute the increase in overlap of the parts list of</span>
<a name="l00235"></a>00235 <span class="comment">// Colpartitions with the combination of merge1 and merge2, compared to</span>
<a name="l00236"></a>00236 <span class="comment">// the overlap with them uncombined.</span>
<a name="l00237"></a>00237 <span class="comment">// An overlap is not counted if passes the OKMergeOverlap test with ok_overlap</span>
<a name="l00238"></a>00238 <span class="comment">// as the pixel overlap limit. merge1 and merge2 must both be non-NULL.</span>
<a name="l00239"></a>00239 <span class="keyword">static</span> <span class="keywordtype">int</span> IncreaseInOverlap(<span class="keyword">const</span> ColPartition* merge1,
<a name="l00240"></a>00240                              <span class="keyword">const</span> ColPartition* merge2,
<a name="l00241"></a>00241                              <span class="keywordtype">int</span> ok_overlap,
<a name="l00242"></a>00242                              ColPartition_CLIST* parts) {
<a name="l00243"></a>00243   <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(merge1 != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; merge2 != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00244"></a>00244   <span class="keywordtype">int</span> total_area = 0;
<a name="l00245"></a>00245   ColPartition_C_IT it(parts);
<a name="l00246"></a>00246   <a class="code" href="class_t_b_o_x.html">TBOX</a> merged_box(merge1-&gt;bounding_box());
<a name="l00247"></a>00247   merged_box += merge2-&gt;bounding_box();
<a name="l00248"></a>00248   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00249"></a>00249     ColPartition* part = it.data();
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (part == merge1 || part == merge2)
<a name="l00251"></a>00251       <span class="keywordflow">continue</span>;
<a name="l00252"></a>00252     <a class="code" href="class_t_b_o_x.html">TBOX</a> part_box = part-&gt;bounding_box();
<a name="l00253"></a>00253     <span class="comment">// Compute the overlap of the merged box with part.</span>
<a name="l00254"></a>00254     <span class="keywordtype">int</span> overlap_area = part_box.<a class="code" href="class_t_b_o_x.html#a33e45c7389737cdf1a908bca0af315c4">intersection</a>(merged_box).<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>();
<a name="l00255"></a>00255     <span class="keywordflow">if</span> (overlap_area &gt; 0 &amp;&amp; !part-&gt;OKMergeOverlap(*merge1, *merge2,
<a name="l00256"></a>00256                                                   ok_overlap, <span class="keyword">false</span>)) {
<a name="l00257"></a>00257       total_area += overlap_area;
<a name="l00258"></a>00258       <span class="comment">// Subtract the overlap of merge1 and merge2 individually.</span>
<a name="l00259"></a>00259       overlap_area = part_box.<a class="code" href="class_t_b_o_x.html#a33e45c7389737cdf1a908bca0af315c4">intersection</a>(merge1-&gt;bounding_box()).area();
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (overlap_area &gt; 0)
<a name="l00261"></a>00261         total_area -= overlap_area;
<a name="l00262"></a>00262       <a class="code" href="class_t_b_o_x.html">TBOX</a> intersection_box = part_box.<a class="code" href="class_t_b_o_x.html#a33e45c7389737cdf1a908bca0af315c4">intersection</a>(merge2-&gt;bounding_box());
<a name="l00263"></a>00263       overlap_area = intersection_box.<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>();
<a name="l00264"></a>00264       <span class="keywordflow">if</span> (overlap_area &gt; 0) {
<a name="l00265"></a>00265         total_area -= overlap_area;
<a name="l00266"></a>00266         <span class="comment">// Add back the 3-way area.</span>
<a name="l00267"></a>00267         intersection_box &amp;= merge1-&gt;bounding_box();  <span class="comment">// In-place intersection.</span>
<a name="l00268"></a>00268         overlap_area = intersection_box.<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>();
<a name="l00269"></a>00269         <span class="keywordflow">if</span> (overlap_area &gt; 0)
<a name="l00270"></a>00270           total_area += overlap_area;
<a name="l00271"></a>00271       }
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273   }
<a name="l00274"></a>00274   <span class="keywordflow">return</span> total_area;
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="comment">// Helper function to test that each partition in candidates is either a</span>
<a name="l00278"></a>00278 <span class="comment">// good diacritic merge with part or an OK merge candidate with all others</span>
<a name="l00279"></a>00279 <span class="comment">// in the candidates list.</span>
<a name="l00280"></a>00280 <span class="comment">// ASCII Art Scenario:</span>
<a name="l00281"></a>00281 <span class="comment">// We sometimes get text such as &quot;join-this&quot; where the - is actually a long</span>
<a name="l00282"></a>00282 <span class="comment">// dash culled from a standard set of extra characters that don&#39;t match the</span>
<a name="l00283"></a>00283 <span class="comment">// font of the text. This makes its strokewidth not match and forms a broken</span>
<a name="l00284"></a>00284 <span class="comment">// set of 3 partitions for &quot;join&quot;, &quot;-&quot; and &quot;this&quot; and the dash may slightly</span>
<a name="l00285"></a>00285 <span class="comment">// overlap BOTH words.</span>
<a name="l00286"></a>00286 <span class="comment">// -------  -------</span>
<a name="l00287"></a>00287 <span class="comment">// |     ====     |</span>
<a name="l00288"></a>00288 <span class="comment">// -------  -------</span>
<a name="l00289"></a>00289 <span class="comment">// The standard merge rule: &quot;you can merge 2 partitions as long as there is</span>
<a name="l00290"></a>00290 <span class="comment">// no increase in overlap elsewhere&quot; fails miserably here. Merge any pair</span>
<a name="l00291"></a>00291 <span class="comment">// of partitions and the combined box overlaps more with the third than</span>
<a name="l00292"></a>00292 <span class="comment">// before. To allow the merge, we need to consider whether it is safe to</span>
<a name="l00293"></a>00293 <span class="comment">// merge everything, without merging separate text lines. For that we need</span>
<a name="l00294"></a>00294 <span class="comment">// everything to be an OKMergeCandidate (which is supposed to prevent</span>
<a name="l00295"></a>00295 <span class="comment">// separate text lines merging), but this is hard for diacritics to satisfy,</span>
<a name="l00296"></a>00296 <span class="comment">// so an alternative to being OKMergeCandidate with everything is to be an</span>
<a name="l00297"></a>00297 <span class="comment">// OKDiacriticMerge with part as the base character.</span>
<a name="l00298"></a>00298 <span class="keyword">static</span> <span class="keywordtype">bool</span> TestCompatibleCandidates(<span class="keyword">const</span> ColPartition&amp; part, <span class="keywordtype">bool</span> debug,
<a name="l00299"></a>00299                                      ColPartition_CLIST* candidates) {
<a name="l00300"></a>00300   ColPartition_C_IT it(candidates);
<a name="l00301"></a>00301   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00302"></a>00302     ColPartition* candidate = it.data();
<a name="l00303"></a>00303     <span class="keywordflow">if</span> (!candidate-&gt;OKDiacriticMerge(part, <span class="keyword">false</span>)) {
<a name="l00304"></a>00304       ColPartition_C_IT it2(it);
<a name="l00305"></a>00305       <span class="keywordflow">for</span> (it2.mark_cycle_pt(); !it2.cycled_list(); it2.forward()) {
<a name="l00306"></a>00306         ColPartition* candidate2 = it2.data();
<a name="l00307"></a>00307         <span class="keywordflow">if</span> (candidate2 != candidate &amp;&amp;
<a name="l00308"></a>00308             !OKMergeCandidate(candidate, candidate2, <span class="keyword">false</span>)) {
<a name="l00309"></a>00309           <span class="keywordflow">if</span> (debug) {
<a name="l00310"></a>00310             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;NC overlap failed:Candidate:&quot;</span>);
<a name="l00311"></a>00311             candidate2-&gt;bounding_box().print();
<a name="l00312"></a>00312             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;fails to be a good merge with:&quot;</span>);
<a name="l00313"></a>00313             candidate-&gt;bounding_box().print();
<a name="l00314"></a>00314           }
<a name="l00315"></a>00315           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317       }
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319   }
<a name="l00320"></a>00320   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00321"></a>00321 }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="comment">// Finds all the ColPartitions in the grid that overlap with the given</span>
<a name="l00324"></a>00324 <span class="comment">// box and returns them SortByBoxLeft(ed) and uniqued in the given list.</span>
<a name="l00325"></a>00325 <span class="comment">// Any partition equal to not_this (may be NULL) is excluded.</span>
<a name="l00326"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ad5beb0b5d583b9160299ccd5262359dd">00326</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ad5beb0b5d583b9160299ccd5262359dd">ColPartitionGrid::FindOverlappingPartitions</a>(<span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box,
<a name="l00327"></a>00327                                                  <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* not_this,
<a name="l00328"></a>00328                                                  ColPartition_CLIST* parts) {
<a name="l00329"></a>00329   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> rsearch(<span class="keyword">this</span>);
<a name="l00330"></a>00330   rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9661d7b80a279a93a4bdd5ecb347871">StartRectSearch</a>(box);
<a name="l00331"></a>00331   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00332"></a>00332   <span class="keywordflow">while</span> ((part = rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ab2699cb16c4514663963d2e2aa1dadc3">NextRectSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00333"></a>00333     <span class="keywordflow">if</span> (part != not_this)
<a name="l00334"></a>00334       parts-&gt;add_sorted(SortByBoxLeft&lt;ColPartition&gt;, <span class="keyword">true</span>, part);
<a name="l00335"></a>00335   }
<a name="l00336"></a>00336 }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338 <span class="comment">// Finds and returns the best candidate ColPartition to merge with part,</span>
<a name="l00339"></a>00339 <span class="comment">// selected from the candidates list, based on the minimum increase in</span>
<a name="l00340"></a>00340 <span class="comment">// pairwise overlap among all the partitions overlapped by the combined box.</span>
<a name="l00341"></a>00341 <span class="comment">// If overlap_increase is not NULL then it returns the increase in overlap</span>
<a name="l00342"></a>00342 <span class="comment">// that would result from the merge.</span>
<a name="l00343"></a>00343 <span class="comment">// confirm_cb is a permanent callback that (if non-null) will be used to</span>
<a name="l00344"></a>00344 <span class="comment">// confirm the validity of a proposed merge candidate before selecting it.</span>
<a name="l00345"></a>00345 <span class="comment">//</span>
<a name="l00346"></a>00346 <span class="comment">// ======HOW MERGING WORKS======</span>
<a name="l00347"></a>00347 <span class="comment">// The problem:</span>
<a name="l00348"></a>00348 <span class="comment">// We want to merge all the parts of a textline together, but avoid merging</span>
<a name="l00349"></a>00349 <span class="comment">// separate textlines. Diacritics, i dots, punctuation, and broken characters</span>
<a name="l00350"></a>00350 <span class="comment">// are examples of small bits that need merging with the main textline.</span>
<a name="l00351"></a>00351 <span class="comment">// Drop-caps and descenders in one line that touch ascenders in the one below</span>
<a name="l00352"></a>00352 <span class="comment">// are examples of cases where we don&#39;t want to merge.</span>
<a name="l00353"></a>00353 <span class="comment">//</span>
<a name="l00354"></a>00354 <span class="comment">// The solution:</span>
<a name="l00355"></a>00355 <span class="comment">// Merges that increase overlap among other partitions are generally bad.</span>
<a name="l00356"></a>00356 <span class="comment">// Those that don&#39;t increase overlap (much) and minimize the total area</span>
<a name="l00357"></a>00357 <span class="comment">// seem to be good.</span>
<a name="l00358"></a>00358 <span class="comment">//</span>
<a name="l00359"></a>00359 <span class="comment">// Ascii art example:</span>
<a name="l00360"></a>00360 <span class="comment">// The text:</span>
<a name="l00361"></a>00361 <span class="comment">// groggy descenders</span>
<a name="l00362"></a>00362 <span class="comment">// minimum ascenders</span>
<a name="l00363"></a>00363 <span class="comment">// The boxes: The === represents a small box near or overlapping the lower box.</span>
<a name="l00364"></a>00364 <span class="comment">// -----------------</span>
<a name="l00365"></a>00365 <span class="comment">// |               |</span>
<a name="l00366"></a>00366 <span class="comment">// -----------------</span>
<a name="l00367"></a>00367 <span class="comment">// -===-------------</span>
<a name="l00368"></a>00368 <span class="comment">// |               |</span>
<a name="l00369"></a>00369 <span class="comment">// -----------------</span>
<a name="l00370"></a>00370 <span class="comment">// In considering what to do with the small === box, we find the 2 larger</span>
<a name="l00371"></a>00371 <span class="comment">// boxes as neighbours and possible merge candidates, but merging with the</span>
<a name="l00372"></a>00372 <span class="comment">// upper box increases overlap with the lower box, whereas merging with the</span>
<a name="l00373"></a>00373 <span class="comment">// lower box does not increase overlap.</span>
<a name="l00374"></a>00374 <span class="comment">// If the small === box didn&#39;t overlap either to start with, total area</span>
<a name="l00375"></a>00375 <span class="comment">// would be minimized by merging with the nearer (lower) box.</span>
<a name="l00376"></a>00376 <span class="comment">//</span>
<a name="l00377"></a>00377 <span class="comment">// This is a simple example. In reality, we have to allow some increase</span>
<a name="l00378"></a>00378 <span class="comment">// in overlap, or tightly spaced text would end up in bits.</span>
<a name="l00379"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a2d5a64ce0293feaa94880ee1397bd65a">00379</a> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* <a class="code" href="classtesseract_1_1_col_partition_grid.html#a2d5a64ce0293feaa94880ee1397bd65a">ColPartitionGrid::BestMergeCandidate</a>(
<a name="l00380"></a>00380     <span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part, ColPartition_CLIST* candidates, <span class="keywordtype">bool</span> debug,
<a name="l00381"></a>00381     <a class="code" href="class_tess_result_callback2.html">TessResultCallback2&lt;bool, const ColPartition*, const ColPartition*&gt;</a>* confirm_cb,
<a name="l00382"></a>00382     <span class="keywordtype">int</span>* overlap_increase) {
<a name="l00383"></a>00383   <span class="keywordflow">if</span> (overlap_increase != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00384"></a>00384     *overlap_increase = 0;
<a name="l00385"></a>00385   <span class="keywordflow">if</span> (candidates-&gt;empty())
<a name="l00386"></a>00386     <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00387"></a>00387   <span class="keywordtype">int</span> ok_overlap =
<a name="l00388"></a>00388       <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="namespacetesseract.html#a1fa28613a5db6fb9d0c7fdef0f151872">kTinyEnoughTextlineOverlapFraction</a> * <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() + 0.5);
<a name="l00389"></a>00389   <span class="comment">// The best neighbour to merge with is the one that causes least</span>
<a name="l00390"></a>00390   <span class="comment">// total pairwise overlap among all the neighbours.</span>
<a name="l00391"></a>00391   <span class="comment">// If more than one offers the same total overlap, choose the one</span>
<a name="l00392"></a>00392   <span class="comment">// with the least total area.</span>
<a name="l00393"></a>00393   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00394"></a>00394   ColPartition_C_IT it(candidates);
<a name="l00395"></a>00395   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* best_candidate = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00396"></a>00396   <span class="comment">// Find the total combined box of all candidates and the original.</span>
<a name="l00397"></a>00397   <a class="code" href="class_t_b_o_x.html">TBOX</a> full_box(part_box);
<a name="l00398"></a>00398   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00399"></a>00399     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* candidate = it.data();
<a name="l00400"></a>00400     full_box += candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00401"></a>00401   }
<a name="l00402"></a>00402   <span class="comment">// Keep valid neighbours in a list.</span>
<a name="l00403"></a>00403   ColPartition_CLIST neighbours;
<a name="l00404"></a>00404   <span class="comment">// Now run a rect search of the merged box for overlapping neighbours, as</span>
<a name="l00405"></a>00405   <span class="comment">// we need anything that might be overlapped by the merged box.</span>
<a name="l00406"></a>00406   <a class="code" href="classtesseract_1_1_col_partition_grid.html#ad5beb0b5d583b9160299ccd5262359dd">FindOverlappingPartitions</a>(full_box, part, &amp;neighbours);
<a name="l00407"></a>00407   <span class="keywordflow">if</span> (debug) {
<a name="l00408"></a>00408     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Finding best merge candidate from %d, %d neighbours for box:&quot;</span>,
<a name="l00409"></a>00409             candidates-&gt;length(), neighbours.length());
<a name="l00410"></a>00410     part_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00411"></a>00411   }
<a name="l00412"></a>00412   <span class="comment">// If the best increase in overlap is positive, then we also check the</span>
<a name="l00413"></a>00413   <span class="comment">// worst non-candidate overlap. This catches the case of multiple good</span>
<a name="l00414"></a>00414   <span class="comment">// candidates that overlap each other when merged. If the worst</span>
<a name="l00415"></a>00415   <span class="comment">// non-candidate overlap is better than the best overlap, then return</span>
<a name="l00416"></a>00416   <span class="comment">// the worst non-candidate overlap instead.</span>
<a name="l00417"></a>00417   ColPartition_CLIST non_candidate_neighbours;
<a name="l00418"></a>00418   non_candidate_neighbours.set_subtract(SortByBoxLeft&lt;ColPartition&gt;, <span class="keyword">true</span>,
<a name="l00419"></a>00419                                         &amp;neighbours, candidates);
<a name="l00420"></a>00420   <span class="keywordtype">int</span> worst_nc_increase = 0;
<a name="l00421"></a>00421   <span class="keywordtype">int</span> best_increase = <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l00422"></a>00422   <span class="keywordtype">int</span> best_area = 0;
<a name="l00423"></a>00423   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00424"></a>00424     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* candidate = it.data();
<a name="l00425"></a>00425     <span class="keywordflow">if</span> (confirm_cb != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !confirm_cb-&gt;<a class="code" href="class_tess_result_callback2.html#a61bd799697bce338fc064326a7b764e3">Run</a>(part, candidate)) {
<a name="l00426"></a>00426       <span class="keywordflow">if</span> (debug) {
<a name="l00427"></a>00427         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Candidate not confirmed:&quot;</span>);
<a name="l00428"></a>00428         candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00429"></a>00429       }
<a name="l00430"></a>00430       <span class="keywordflow">continue</span>;
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432     <span class="keywordtype">int</span> increase = IncreaseInOverlap(part, candidate, ok_overlap, &amp;neighbours);
<a name="l00433"></a>00433     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; cand_box = candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00434"></a>00434     <span class="keywordflow">if</span> (best_candidate == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || increase &lt; best_increase) {
<a name="l00435"></a>00435       best_candidate = candidate;
<a name="l00436"></a>00436       best_increase = increase;
<a name="l00437"></a>00437       best_area = cand_box.<a class="code" href="class_t_b_o_x.html#ab8ae7b66782fa1802f78ff034da16089">bounding_union</a>(part_box).<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>() - cand_box.<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>();
<a name="l00438"></a>00438       <span class="keywordflow">if</span> (debug) {
<a name="l00439"></a>00439         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;New best merge candidate has increase %d, area %d, over box:&quot;</span>,
<a name="l00440"></a>00440                 increase, best_area);
<a name="l00441"></a>00441         full_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l00442"></a>00442         candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00443"></a>00443       }
<a name="l00444"></a>00444     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (increase == best_increase) {
<a name="l00445"></a>00445       <span class="keywordtype">int</span> area = cand_box.<a class="code" href="class_t_b_o_x.html#ab8ae7b66782fa1802f78ff034da16089">bounding_union</a>(part_box).<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>() - cand_box.<a class="code" href="class_t_b_o_x.html#a46fca3df91dc271b30b69531e9d8178a">area</a>();
<a name="l00446"></a>00446       <span class="keywordflow">if</span> (area &lt; best_area) {
<a name="l00447"></a>00447         best_area = area;
<a name="l00448"></a>00448         best_candidate = candidate;
<a name="l00449"></a>00449       }
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451     increase = IncreaseInOverlap(part, candidate, ok_overlap,
<a name="l00452"></a>00452                                  &amp;non_candidate_neighbours);
<a name="l00453"></a>00453     <span class="keywordflow">if</span> (increase &gt; worst_nc_increase)
<a name="l00454"></a>00454       worst_nc_increase = increase;
<a name="l00455"></a>00455   }
<a name="l00456"></a>00456   <span class="keywordflow">if</span> (best_increase &gt; 0) {
<a name="l00457"></a>00457     <span class="comment">// If the worst non-candidate increase is less than the best increase</span>
<a name="l00458"></a>00458     <span class="comment">// including the candidates, then all the candidates can merge together</span>
<a name="l00459"></a>00459     <span class="comment">// and the increase in outside overlap would be less, so use that result,</span>
<a name="l00460"></a>00460     <span class="comment">// but only if each candidate is either a good diacritic merge with part,</span>
<a name="l00461"></a>00461     <span class="comment">// or an ok merge candidate with all the others.</span>
<a name="l00462"></a>00462     <span class="comment">// See TestCompatibleCandidates for more explanation and a picture.</span>
<a name="l00463"></a>00463     <span class="keywordflow">if</span> (worst_nc_increase &lt; best_increase &amp;&amp;
<a name="l00464"></a>00464         TestCompatibleCandidates(*part, debug, candidates)) {
<a name="l00465"></a>00465       best_increase = worst_nc_increase;
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467   }
<a name="l00468"></a>00468   <span class="keywordflow">if</span> (overlap_increase != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00469"></a>00469     *overlap_increase = best_increase;
<a name="l00470"></a>00470   <span class="keywordflow">return</span> best_candidate;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="comment">// Helper to remove the given box from the given partition, put it in its</span>
<a name="l00474"></a>00474 <span class="comment">// own partition, and add to the partition list.</span>
<a name="l00475"></a>00475 <span class="keyword">static</span> <span class="keywordtype">void</span> RemoveBadBox(<a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* box, <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part,
<a name="l00476"></a>00476                          ColPartition_LIST* part_list) {
<a name="l00477"></a>00477   part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aef96e5e328fbc0a20e267f820b6376c0">RemoveBox</a>(box);
<a name="l00478"></a>00478   <a class="code" href="classtesseract_1_1_col_partition.html#a2baab68bca77728c6b50521131dc9b1a">ColPartition::MakeBigPartition</a>(box, part_list);
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="comment">// Split partitions where it reduces overlap between their bounding boxes.</span>
<a name="l00483"></a>00483 <span class="comment">// ColPartitions are after all supposed to be a partitioning of the blobs</span>
<a name="l00484"></a>00484 <span class="comment">// AND of the space on the page!</span>
<a name="l00485"></a>00485 <span class="comment">// Blobs that cause overlaps get removed, put in individual partitions</span>
<a name="l00486"></a>00486 <span class="comment">// and added to the big_parts list. They are most likely characters on</span>
<a name="l00487"></a>00487 <span class="comment">// 2 textlines that touch, or something big like a dropcap.</span>
<a name="l00488"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a82e8b8c81fca51c36744a859831154e7">00488</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a82e8b8c81fca51c36744a859831154e7">ColPartitionGrid::SplitOverlappingPartitions</a>(
<a name="l00489"></a>00489     ColPartition_LIST* big_parts) {
<a name="l00490"></a>00490   <span class="keywordtype">int</span> ok_overlap =
<a name="l00491"></a>00491       <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="namespacetesseract.html#a1fa28613a5db6fb9d0c7fdef0f151872">kTinyEnoughTextlineOverlapFraction</a> * <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() + 0.5);
<a name="l00492"></a>00492   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00493"></a>00493   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00494"></a>00494   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00495"></a>00495   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00496"></a>00496   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00497"></a>00497     <span class="comment">// Set up a rectangle search bounded by the part.</span>
<a name="l00498"></a>00498     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00499"></a>00499     <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> rsearch(<span class="keyword">this</span>);
<a name="l00500"></a>00500     rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#a3c44b7c8272584600153d8249a841e73">SetUniqueMode</a>(<span class="keyword">true</span>);
<a name="l00501"></a>00501     rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9661d7b80a279a93a4bdd5ecb347871">StartRectSearch</a>(box);
<a name="l00502"></a>00502     <span class="keywordtype">int</span> unresolved_overlaps = 0;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* neighbour;
<a name="l00505"></a>00505     <span class="keywordflow">while</span> ((neighbour = rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ab2699cb16c4514663963d2e2aa1dadc3">NextRectSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00506"></a>00506       <span class="keywordflow">if</span> (neighbour == part)
<a name="l00507"></a>00507         <span class="keywordflow">continue</span>;
<a name="l00508"></a>00508       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; neighbour_box = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00509"></a>00509       <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea7f1476b335624a5e11985491dc589">OKMergeOverlap</a>(*part, *part, ok_overlap, <span class="keyword">false</span>) &amp;&amp;
<a name="l00510"></a>00510           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea7f1476b335624a5e11985491dc589">OKMergeOverlap</a>(*neighbour, *neighbour, ok_overlap, <span class="keyword">false</span>))
<a name="l00511"></a>00511         <span class="keywordflow">continue</span>;  <span class="comment">// The overlap is OK both ways.</span>
<a name="l00512"></a>00512 
<a name="l00513"></a>00513       <span class="comment">// If removal of the biggest box from either partition eliminates the</span>
<a name="l00514"></a>00514       <span class="comment">// overlap, and it is much bigger than the box left behind, then</span>
<a name="l00515"></a>00515       <span class="comment">// it is either a drop-cap, an inter-line join, or some junk that</span>
<a name="l00516"></a>00516       <span class="comment">// we don&#39;t want anyway, so put it in the big_parts list.</span>
<a name="l00517"></a>00517       <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac34862007d633ee3d726492150e8c672">IsSingleton</a>()) {
<a name="l00518"></a>00518         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* excluded = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0c2b7eaa5daff22412a5931534e8c804">BiggestBox</a>();
<a name="l00519"></a>00519         <a class="code" href="class_t_b_o_x.html">TBOX</a> shrunken = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a27b24bf50ade80dcd1b25f6630f3a298">BoundsWithoutBox</a>(excluded);
<a name="l00520"></a>00520         <span class="keywordflow">if</span> (!shrunken.<a class="code" href="class_t_b_o_x.html#adcc7d2858ccb61cd715dbcff32bd5582">overlap</a>(neighbour_box) &amp;&amp;
<a name="l00521"></a>00521             excluded-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt;
<a name="l00522"></a>00522               <a class="code" href="namespacetesseract.html#a45530b4b5280b8d2f185a531cab4169b">kBigPartSizeRatio</a> * shrunken.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>()) {
<a name="l00523"></a>00523           <span class="comment">// Removing the biggest box fixes the overlap, so do it!</span>
<a name="l00524"></a>00524           gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aa6a2166899235a22f58e607786ffd25e">RemoveBBox</a>();
<a name="l00525"></a>00525           RemoveBadBox(excluded, part, big_parts);
<a name="l00526"></a>00526           <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00527"></a>00527           gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l00528"></a>00528           <span class="keywordflow">break</span>;
<a name="l00529"></a>00529         }
<a name="l00530"></a>00530       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box.<a class="code" href="class_t_b_o_x.html#a5d4e2c5f91b791e94d4c94e513180632">contains</a>(neighbour_box)) {
<a name="l00531"></a>00531         ++unresolved_overlaps;
<a name="l00532"></a>00532         <span class="keywordflow">continue</span>;  <span class="comment">// No amount of splitting will fix it.</span>
<a name="l00533"></a>00533       }
<a name="l00534"></a>00534       <span class="keywordflow">if</span> (!neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac34862007d633ee3d726492150e8c672">IsSingleton</a>()) {
<a name="l00535"></a>00535         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* excluded = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0c2b7eaa5daff22412a5931534e8c804">BiggestBox</a>();
<a name="l00536"></a>00536         <a class="code" href="class_t_b_o_x.html">TBOX</a> shrunken = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a27b24bf50ade80dcd1b25f6630f3a298">BoundsWithoutBox</a>(excluded);
<a name="l00537"></a>00537         <span class="keywordflow">if</span> (!shrunken.<a class="code" href="class_t_b_o_x.html#adcc7d2858ccb61cd715dbcff32bd5582">overlap</a>(box) &amp;&amp;
<a name="l00538"></a>00538             excluded-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>() &gt;
<a name="l00539"></a>00539               <a class="code" href="namespacetesseract.html#a45530b4b5280b8d2f185a531cab4169b">kBigPartSizeRatio</a> * shrunken.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>()) {
<a name="l00540"></a>00540           <span class="comment">// Removing the biggest box fixes the overlap, so do it!</span>
<a name="l00541"></a>00541           rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aa6a2166899235a22f58e607786ffd25e">RemoveBBox</a>();
<a name="l00542"></a>00542           RemoveBadBox(excluded, neighbour, big_parts);
<a name="l00543"></a>00543           <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, neighbour);
<a name="l00544"></a>00544           gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l00545"></a>00545           <span class="keywordflow">break</span>;
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547       }
<a name="l00548"></a>00548       <span class="keywordtype">int</span> part_overlap_count = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a85049818069c9a89322235b286b9915d">CountOverlappingBoxes</a>(neighbour_box);
<a name="l00549"></a>00549       <span class="keywordtype">int</span> neighbour_overlap_count = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a85049818069c9a89322235b286b9915d">CountOverlappingBoxes</a>(box);
<a name="l00550"></a>00550       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* right_part = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00551"></a>00551       <span class="keywordflow">if</span> (neighbour_overlap_count &lt;= part_overlap_count ||
<a name="l00552"></a>00552           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac34862007d633ee3d726492150e8c672">IsSingleton</a>()) {
<a name="l00553"></a>00553         <span class="comment">// Try to split the neighbour to reduce overlap.</span>
<a name="l00554"></a>00554         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* split_blob = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a665821774d2bfdd59db589683a4cf87b">OverlapSplitBlob</a>(box);
<a name="l00555"></a>00555         <span class="keywordflow">if</span> (split_blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00556"></a>00556           rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aa6a2166899235a22f58e607786ffd25e">RemoveBBox</a>();
<a name="l00557"></a>00557           right_part = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab629b53eb1420cf5947f3c003d2d4761">SplitAtBlob</a>(split_blob);
<a name="l00558"></a>00558           <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, neighbour);
<a name="l00559"></a>00559           <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(right_part != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561       } <span class="keywordflow">else</span> {
<a name="l00562"></a>00562         <span class="comment">// Try to split part to reduce overlap.</span>
<a name="l00563"></a>00563         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* split_blob = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a665821774d2bfdd59db589683a4cf87b">OverlapSplitBlob</a>(neighbour_box);
<a name="l00564"></a>00564         <span class="keywordflow">if</span> (split_blob != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00565"></a>00565           gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aa6a2166899235a22f58e607786ffd25e">RemoveBBox</a>();
<a name="l00566"></a>00566           right_part = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab629b53eb1420cf5947f3c003d2d4761">SplitAtBlob</a>(split_blob);
<a name="l00567"></a>00567           <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00568"></a>00568           <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(right_part != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570       }
<a name="l00571"></a>00571       <span class="keywordflow">if</span> (right_part != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00572"></a>00572         <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, right_part);
<a name="l00573"></a>00573         gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l00574"></a>00574         rsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l00575"></a>00575         <span class="keywordflow">break</span>;
<a name="l00576"></a>00576       }
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (unresolved_overlaps &gt; 2 &amp;&amp; part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac34862007d633ee3d726492150e8c672">IsSingleton</a>()) {
<a name="l00579"></a>00579       <span class="comment">// This part is no good so just add to big_parts.</span>
<a name="l00580"></a>00580       <a class="code" href="classtesseract_1_1_b_b_grid.html#adc713153c1282d8727f85ee6d38d7d31">RemoveBBox</a>(part);
<a name="l00581"></a>00581       ColPartition_IT big_it(big_parts);
<a name="l00582"></a>00582       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ae8aad6eec822b60c3387627910989270">set_block_owned</a>(<span class="keyword">true</span>);
<a name="l00583"></a>00583       big_it.add_to_end(part);
<a name="l00584"></a>00584       gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="comment">// Filters partitions of source_type by looking at local neighbours.</span>
<a name="l00590"></a>00590 <span class="comment">// Where a majority of neighbours have a text type, the partitions are</span>
<a name="l00591"></a>00591 <span class="comment">// changed to text, where the neighbours have image type, they are changed</span>
<a name="l00592"></a>00592 <span class="comment">// to image, and partitions that have no definite neighbourhood type are</span>
<a name="l00593"></a>00593 <span class="comment">// left unchanged.</span>
<a name="l00594"></a>00594 <span class="comment">// im_box and rerotation are used to map blob coordinates onto the</span>
<a name="l00595"></a>00595 <span class="comment">// nontext_map, which is used to prevent the spread of text neighbourhoods</span>
<a name="l00596"></a>00596 <span class="comment">// into images.</span>
<a name="l00597"></a>00597 <span class="comment">// Returns true if anything was changed.</span>
<a name="l00598"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a88a22ddb5578787c2819536b9152ca15">00598</a> <span class="keywordtype">bool</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a88a22ddb5578787c2819536b9152ca15">ColPartitionGrid::GridSmoothNeighbours</a>(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> source_type,
<a name="l00599"></a>00599                                             Pix* nontext_map,
<a name="l00600"></a>00600                                             <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; im_box,
<a name="l00601"></a>00601                                             <span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rotation) {
<a name="l00602"></a>00602   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00603"></a>00603   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00604"></a>00604   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00605"></a>00605   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00606"></a>00606   <span class="keywordtype">bool</span> any_changed = <span class="keyword">false</span>;
<a name="l00607"></a>00607   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00608"></a>00608     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a811bd892dfa5eeba0b17b77794d79754">flow</a>() != source_type || <a class="code" href="class_b_l_o_b_n_b_o_x.html#a86decfe35457329f062098901d56015f">BLOBNBOX::IsLineType</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>()))
<a name="l00609"></a>00609       <span class="keywordflow">continue</span>;
<a name="l00610"></a>00610     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00611"></a>00611     <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00612"></a>00612     <span class="keywordflow">if</span> (SmoothRegionType(nontext_map, im_box, rotation, debug, part))
<a name="l00613"></a>00613       any_changed = <span class="keyword">true</span>;
<a name="l00614"></a>00614   }
<a name="l00615"></a>00615   <span class="keywordflow">return</span> any_changed;
<a name="l00616"></a>00616 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="comment">// Compute the mean RGB of the light and dark pixels in each ColPartition</span>
<a name="l00619"></a>00619 <span class="comment">// and also the rms error in the linearity of color.</span>
<a name="l00620"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ac83fa786cb4ce07219f64a8db367dcdd">00620</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ac83fa786cb4ce07219f64a8db367dcdd">ColPartitionGrid::ComputePartitionColors</a>(Pix* scaled_color,
<a name="l00621"></a>00621                                               <span class="keywordtype">int</span> scaled_factor,
<a name="l00622"></a>00622                                               <span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rerotation) {
<a name="l00623"></a>00623   <span class="keywordflow">if</span> (scaled_color == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00624"></a>00624     <span class="keywordflow">return</span>;
<a name="l00625"></a>00625   Pix* color_map1 = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00626"></a>00626   Pix* color_map2 = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00627"></a>00627   Pix* rms_map = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00628"></a>00628   <span class="keywordflow">if</span> (<a class="code" href="namespacetesseract.html#a93b5f759bbf4ffd7d98bca6a31391235">textord_tabfind_show_color_fit</a>) {
<a name="l00629"></a>00629     <span class="keywordtype">int</span> width = pixGetWidth(scaled_color);
<a name="l00630"></a>00630     <span class="keywordtype">int</span> height = pixGetHeight(scaled_color);
<a name="l00631"></a>00631     color_map1 = pixCreate(width, height, 32);
<a name="l00632"></a>00632     color_map2 = pixCreate(width, height, 32);
<a name="l00633"></a>00633     rms_map = pixCreate(width, height, 8);
<a name="l00634"></a>00634   }
<a name="l00635"></a>00635   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00636"></a>00636   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00637"></a>00637   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00638"></a>00638   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00639"></a>00639   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00640"></a>00640     <a class="code" href="class_t_b_o_x.html">TBOX</a> part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00641"></a>00641     part_box.<a class="code" href="class_t_b_o_x.html#a56b4e1cc91e8abcb9f97622da7468e98">rotate_large</a>(rerotation);
<a name="l00642"></a>00642     <a class="code" href="classtesseract_1_1_image_find.html#a642f61eaa3639dfe013615737ea02c41">ImageFind::ComputeRectangleColors</a>(part_box, scaled_color,
<a name="l00643"></a>00643                                       scaled_factor,
<a name="l00644"></a>00644                                       color_map1, color_map2, rms_map,
<a name="l00645"></a>00645                                       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a944cdc529d0028111080627854c8bbc0">color1</a>(), part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a4b52103bab1483c16849f0ac8666a9fe">color2</a>());
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647   <span class="keywordflow">if</span> (color_map1 != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00648"></a>00648     pixWrite(<span class="stringliteral">&quot;swcolorinput.png&quot;</span>, scaled_color, IFF_PNG);
<a name="l00649"></a>00649     pixWrite(<span class="stringliteral">&quot;swcolor1.png&quot;</span>, color_map1, IFF_PNG);
<a name="l00650"></a>00650     pixWrite(<span class="stringliteral">&quot;swcolor2.png&quot;</span>, color_map2, IFF_PNG);
<a name="l00651"></a>00651     pixWrite(<span class="stringliteral">&quot;swrms.png&quot;</span>, rms_map, IFF_PNG);
<a name="l00652"></a>00652     pixDestroy(&amp;color_map1);
<a name="l00653"></a>00653     pixDestroy(&amp;color_map2);
<a name="l00654"></a>00654     pixDestroy(&amp;rms_map);
<a name="l00655"></a>00655   }
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="comment">// Reflects the grid and its colpartitions in the y-axis, assuming that</span>
<a name="l00659"></a>00659 <span class="comment">// all blob boxes have already been done.</span>
<a name="l00660"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a423a93040be0e2075dce35597ab30d3a">00660</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a423a93040be0e2075dce35597ab30d3a">ColPartitionGrid::ReflectInYAxis</a>() {
<a name="l00661"></a>00661   ColPartition_LIST parts;
<a name="l00662"></a>00662   ColPartition_IT part_it(&amp;parts);
<a name="l00663"></a>00663   <span class="comment">// Iterate the ColPartitions in the grid to extract them.</span>
<a name="l00664"></a>00664   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00665"></a>00665   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00666"></a>00666   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00667"></a>00667   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00668"></a>00668     part_it.add_after_then_move(part);
<a name="l00669"></a>00669   }
<a name="l00670"></a>00670   <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> bot_left(-<a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>().x(), <a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>().y());
<a name="l00671"></a>00671   <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> top_right(-<a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>().x(), <a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>().y());
<a name="l00672"></a>00672   <span class="comment">// Reinitializing the grid with reflected coords also clears all the</span>
<a name="l00673"></a>00673   <span class="comment">// pointers, so parts will now own the ColPartitions. (Briefly).</span>
<a name="l00674"></a>00674   <a class="code" href="classtesseract_1_1_b_b_grid.html#a1d2990adf323d7910fbf87b6fc3a7415">Init</a>(<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>(), bot_left, top_right);
<a name="l00675"></a>00675   <span class="keywordflow">for</span> (part_it.move_to_first(); !part_it.empty(); part_it.forward()) {
<a name="l00676"></a>00676     part = part_it.extract();
<a name="l00677"></a>00677     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a77e212fc8da6ee21a817291c2180e2ad">ReflectInYAxis</a>();
<a name="l00678"></a>00678     <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00679"></a>00679   }
<a name="l00680"></a>00680 }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 <span class="comment">// Rotates the grid and its colpartitions by the given angle, assuming that</span>
<a name="l00683"></a>00683 <span class="comment">// all blob boxes have already been done.</span>
<a name="l00684"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ae184cea03e3195e505140c200c70b335">00684</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ae184cea03e3195e505140c200c70b335">ColPartitionGrid::Deskew</a>(<span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; deskew) {
<a name="l00685"></a>00685   ColPartition_LIST parts;
<a name="l00686"></a>00686   ColPartition_IT part_it(&amp;parts);
<a name="l00687"></a>00687   <span class="comment">// Iterate the ColPartitions in the grid to extract them.</span>
<a name="l00688"></a>00688   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00689"></a>00689   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00690"></a>00690   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00691"></a>00691   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00692"></a>00692     part_it.add_after_then_move(part);
<a name="l00693"></a>00693   }
<a name="l00694"></a>00694   <span class="comment">// Rebuild the grid to the new size.</span>
<a name="l00695"></a>00695   <a class="code" href="class_t_b_o_x.html">TBOX</a> grid_box(<a class="code" href="classtesseract_1_1_grid_base.html#a5f09e93ec22c3f7a245eb6611309d8d6">bleft_</a>, <a class="code" href="classtesseract_1_1_grid_base.html#ac348165d112922b3d956f924405012cd">tright_</a>);
<a name="l00696"></a>00696   grid_box.<a class="code" href="class_t_b_o_x.html#a56b4e1cc91e8abcb9f97622da7468e98">rotate_large</a>(deskew);
<a name="l00697"></a>00697   <a class="code" href="classtesseract_1_1_b_b_grid.html#a1d2990adf323d7910fbf87b6fc3a7415">Init</a>(<a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>(), grid_box.<a class="code" href="class_t_b_o_x.html#a9f46d9e51b8b69c5cb6d031e9ac34978">botleft</a>(), grid_box.<a class="code" href="class_t_b_o_x.html#a02511fc69b598b332ac1f4af6c943f8f">topright</a>());
<a name="l00698"></a>00698   <span class="comment">// Reinitializing the grid with rotated coords also clears all the</span>
<a name="l00699"></a>00699   <span class="comment">// pointers, so parts will now own the ColPartitions. (Briefly).</span>
<a name="l00700"></a>00700   <span class="keywordflow">for</span> (part_it.move_to_first(); !part_it.empty(); part_it.forward()) {
<a name="l00701"></a>00701     part = part_it.extract();
<a name="l00702"></a>00702     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a18f2c4bd514ea700d7d4f6d0a6541d17">ComputeLimits</a>();
<a name="l00703"></a>00703     <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00704"></a>00704   }
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="comment">// Sets the left and right tabs of the partitions in the grid.</span>
<a name="l00708"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a40b0e4db617400d53951521ab11b5b8a">00708</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a40b0e4db617400d53951521ab11b5b8a">ColPartitionGrid::SetTabStops</a>(<a class="code" href="classtesseract_1_1_tab_find.html">TabFind</a>* tabgrid) {
<a name="l00709"></a>00709   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00710"></a>00710   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00711"></a>00711   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00712"></a>00712   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00713"></a>00713   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00714"></a>00714     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00715"></a>00715     <a class="code" href="classtesseract_1_1_tab_vector.html">TabVector</a>* left_line = tabgrid-&gt;<a class="code" href="classtesseract_1_1_tab_find.html#aedfe0f86dd7916bf5c6dfc2e2b4dbe22">LeftTabForBox</a>(part_box, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l00716"></a>00716     <span class="comment">// If the overlapping line is not a left tab, try for non-overlapping.</span>
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (left_line != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !left_line-&gt;<a class="code" href="classtesseract_1_1_tab_vector.html#a2f25166aafb6fc9931586f9643a93be9">IsLeftTab</a>())
<a name="l00718"></a>00718       left_line = tabgrid-&gt;<a class="code" href="classtesseract_1_1_tab_find.html#aedfe0f86dd7916bf5c6dfc2e2b4dbe22">LeftTabForBox</a>(part_box, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (left_line != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; left_line-&gt;<a class="code" href="classtesseract_1_1_tab_vector.html#a2f25166aafb6fc9931586f9643a93be9">IsLeftTab</a>())
<a name="l00720"></a>00720       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a770d020fe98100499e1a1bedfca9b1fc">SetLeftTab</a>(left_line);
<a name="l00721"></a>00721     <a class="code" href="classtesseract_1_1_tab_vector.html">TabVector</a>* right_line = tabgrid-&gt;<a class="code" href="classtesseract_1_1_tab_find.html#adac7971311bbdade2aa87ebb0691a408">RightTabForBox</a>(part_box, <span class="keyword">true</span>, <span class="keyword">false</span>);
<a name="l00722"></a>00722     <span class="keywordflow">if</span> (right_line != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !right_line-&gt;<a class="code" href="classtesseract_1_1_tab_vector.html#aca11c6133632349da7728b88f0301b86">IsRightTab</a>())
<a name="l00723"></a>00723       right_line = tabgrid-&gt;<a class="code" href="classtesseract_1_1_tab_find.html#adac7971311bbdade2aa87ebb0691a408">RightTabForBox</a>(part_box, <span class="keyword">false</span>, <span class="keyword">false</span>);
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (right_line != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; right_line-&gt;<a class="code" href="classtesseract_1_1_tab_vector.html#aca11c6133632349da7728b88f0301b86">IsRightTab</a>())
<a name="l00725"></a>00725       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a426461a98a3feccd03ba68894dc8d4d2">SetRightTab</a>(right_line);
<a name="l00726"></a>00726     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea991fccc4013feadaa1cc2b8f35051">SetColumnGoodness</a>(tabgrid-&gt;<a class="code" href="classtesseract_1_1_tab_find.html#a580534816073eb4327fbe24611499a5c">WidthCB</a>());
<a name="l00727"></a>00727   }
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730 <span class="comment">// Makes the ColPartSets and puts them in the PartSetVector ready</span>
<a name="l00731"></a>00731 <span class="comment">// for finding column bounds. Returns false if no partitions were found.</span>
<a name="l00732"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a6dbb1d12ebe468f00e2b63265fdda569">00732</a> <span class="keywordtype">bool</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a6dbb1d12ebe468f00e2b63265fdda569">ColPartitionGrid::MakeColPartSets</a>(<a class="code" href="class_generic_vector.html">PartSetVector</a>* part_sets) {
<a name="l00733"></a>00733   ColPartition_LIST* part_lists = <span class="keyword">new</span> ColPartition_LIST[<a class="code" href="classtesseract_1_1_grid_base.html#a07e6b230c150180d009ef1f317e642f2">gridheight</a>()];
<a name="l00734"></a>00734   part_sets-&gt;<a class="code" href="class_generic_vector.html#aa225ea3fc9374961482bc804028317eb">reserve</a>(<a class="code" href="classtesseract_1_1_grid_base.html#a07e6b230c150180d009ef1f317e642f2">gridheight</a>());
<a name="l00735"></a>00735   <span class="comment">// Iterate the ColPartitions in the grid to get parts onto lists for the</span>
<a name="l00736"></a>00736   <span class="comment">// y bottom of each.</span>
<a name="l00737"></a>00737   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00738"></a>00738   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00739"></a>00739   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00740"></a>00740   <span class="keywordtype">bool</span> any_parts_found = <span class="keyword">false</span>;
<a name="l00741"></a>00741   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00742"></a>00742     <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> blob_type = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>();
<a name="l00743"></a>00743     <span class="keywordflow">if</span> (blob_type != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a> &amp;&amp;
<a name="l00744"></a>00744         (blob_type != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a> || !part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>()-&gt;singleton())) {
<a name="l00745"></a>00745       <span class="keywordtype">int</span> grid_x, grid_y;
<a name="l00746"></a>00746       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00747"></a>00747       <a class="code" href="classtesseract_1_1_grid_base.html#a9cb158bba184d657c51257b98eea9f8f">GridCoords</a>(part_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), part_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), &amp;grid_x, &amp;grid_y);
<a name="l00748"></a>00748       ColPartition_IT part_it(&amp;part_lists[grid_y]);
<a name="l00749"></a>00749       part_it.add_to_end(part);
<a name="l00750"></a>00750       any_parts_found = <span class="keyword">true</span>;
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752   }
<a name="l00753"></a>00753   <span class="keywordflow">if</span> (any_parts_found) {
<a name="l00754"></a>00754     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> grid_y = 0; grid_y &lt; <a class="code" href="classtesseract_1_1_grid_base.html#a07e6b230c150180d009ef1f317e642f2">gridheight</a>(); ++grid_y) {
<a name="l00755"></a>00755       <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* line_set = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00756"></a>00756       <span class="keywordflow">if</span> (!part_lists[grid_y].empty()) {
<a name="l00757"></a>00757         line_set = <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>(&amp;part_lists[grid_y]);
<a name="l00758"></a>00758       }
<a name="l00759"></a>00759       part_sets-&gt;<a class="code" href="class_generic_vector.html#a0dc89fe2a365b04a61017f9d78c1a303">push_back</a>(line_set);
<a name="l00760"></a>00760     }
<a name="l00761"></a>00761   }
<a name="l00762"></a>00762   <span class="keyword">delete</span> [] part_lists;
<a name="l00763"></a>00763   <span class="keywordflow">return</span> any_parts_found;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="comment">// Makes a single ColPartitionSet consisting of a single ColPartition that</span>
<a name="l00767"></a>00767 <span class="comment">// represents the total horizontal extent of the significant content on the</span>
<a name="l00768"></a>00768 <span class="comment">// page. Used for the single column setting in place of automatic detection.</span>
<a name="l00769"></a>00769 <span class="comment">// Returns NULL if the page is empty of significant content.</span>
<a name="l00770"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a804a04162511d6952635ba8713a751a8">00770</a> <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* <a class="code" href="classtesseract_1_1_col_partition_grid.html#a804a04162511d6952635ba8713a751a8">ColPartitionGrid::MakeSingleColumnSet</a>(<a class="code" href="class_tess_result_callback1.html">WidthCallback</a>* cb) {
<a name="l00771"></a>00771   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* single_column_part = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00772"></a>00772   <span class="comment">// Iterate the ColPartitions in the grid to get parts onto lists for the</span>
<a name="l00773"></a>00773   <span class="comment">// y bottom of each.</span>
<a name="l00774"></a>00774   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00775"></a>00775   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00776"></a>00776   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00777"></a>00777   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00778"></a>00778     <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> blob_type = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>();
<a name="l00779"></a>00779     <span class="keywordflow">if</span> (blob_type != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a> &amp;&amp;
<a name="l00780"></a>00780         (blob_type != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a> || !part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>()-&gt;singleton())) {
<a name="l00781"></a>00781       <span class="comment">// Consider for single column.</span>
<a name="l00782"></a>00782       <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> flow = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a811bd892dfa5eeba0b17b77794d79754">flow</a>();
<a name="l00783"></a>00783       <span class="keywordflow">if</span> ((blob_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a> &amp;&amp;
<a name="l00784"></a>00784           (flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a> || flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a> ||
<a name="l00785"></a>00785            flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a64e3e70c4fac4d4e3facdb4638307d7f">BTFT_LEADER</a> || flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a1936f281ab87277e7ef0ba576920dc10">BTFT_TEXT_ON_IMAGE</a>)) ||
<a name="l00786"></a>00786           blob_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a15e526e8dd226bd4d7678da6dcddb49b">BRT_RECTIMAGE</a> || blob_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a3b72528ad70da88719f0479bc8c5a190">BRT_POLYIMAGE</a>) {
<a name="l00787"></a>00787         <span class="keywordflow">if</span> (single_column_part == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00788"></a>00788           single_column_part = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a70116af39898d43ca19ecb189faccfa1">ShallowCopy</a>();
<a name="l00789"></a>00789           single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a67554d4553f198980b504091557442c7">set_blob_type</a>(<a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>);
<a name="l00790"></a>00790           <span class="comment">// Copy the tabs from itself to properly setup the margins.</span>
<a name="l00791"></a>00791           single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aff9a74526321b24bbafcdbc359f9d161">CopyLeftTab</a>(*single_column_part, <span class="keyword">false</span>);
<a name="l00792"></a>00792           single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab4ec7202d19f98517fd32bce150ebbb0">CopyRightTab</a>(*single_column_part, <span class="keyword">false</span>);
<a name="l00793"></a>00793         } <span class="keywordflow">else</span> {
<a name="l00794"></a>00794           <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>() &lt; single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>())
<a name="l00795"></a>00795             single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aff9a74526321b24bbafcdbc359f9d161">CopyLeftTab</a>(*part, <span class="keyword">false</span>);
<a name="l00796"></a>00796           <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>() &gt; single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>())
<a name="l00797"></a>00797             single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab4ec7202d19f98517fd32bce150ebbb0">CopyRightTab</a>(*part, <span class="keyword">false</span>);
<a name="l00798"></a>00798         }
<a name="l00799"></a>00799       }
<a name="l00800"></a>00800     }
<a name="l00801"></a>00801   }
<a name="l00802"></a>00802   <span class="keywordflow">if</span> (single_column_part != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00803"></a>00803     <span class="comment">// Make a ColPartitionSet out of the single_column_part as a candidate</span>
<a name="l00804"></a>00804     <span class="comment">// for the single column case.</span>
<a name="l00805"></a>00805     single_column_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea991fccc4013feadaa1cc2b8f35051">SetColumnGoodness</a>(cb);
<a name="l00806"></a>00806     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>(single_column_part);
<a name="l00807"></a>00807   }
<a name="l00808"></a>00808   <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 <span class="comment">// Mark the BLOBNBOXes in each partition as being owned by that partition.</span>
<a name="l00812"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#aed47e56ca1a0b658811e4cf287582f04">00812</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#aed47e56ca1a0b658811e4cf287582f04">ColPartitionGrid::ClaimBoxes</a>() {
<a name="l00813"></a>00813   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00814"></a>00814   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00815"></a>00815   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00816"></a>00816   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00817"></a>00817   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00818"></a>00818     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aa6dd9388e18a33fc48e6410e214e1d17">ClaimBoxes</a>();
<a name="l00819"></a>00819   }
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="comment">// Retypes all the blobs referenced by the partitions in the grid.</span>
<a name="l00823"></a>00823 <span class="comment">// Image blobs are found and returned in the im_blobs list, as they are not</span>
<a name="l00824"></a>00824 <span class="comment">// owned by the block.</span>
<a name="l00825"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#aecd8e56c6111338a9f7a42ce00d3636f">00825</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#aecd8e56c6111338a9f7a42ce00d3636f">ColPartitionGrid::ReTypeBlobs</a>(BLOBNBOX_LIST* im_blobs) {
<a name="l00826"></a>00826   BLOBNBOX_IT im_blob_it(im_blobs);
<a name="l00827"></a>00827   ColPartition_LIST dead_parts;
<a name="l00828"></a>00828   ColPartition_IT dead_part_it(&amp;dead_parts);
<a name="l00829"></a>00829   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00830"></a>00830   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00831"></a>00831   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00832"></a>00832   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00833"></a>00833   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00834"></a>00834     <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> blob_type = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>();
<a name="l00835"></a>00835     <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> flow = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a811bd892dfa5eeba0b17b77794d79754">flow</a>();
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (blob_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a3b72528ad70da88719f0479bc8c5a190">BRT_POLYIMAGE</a> || blob_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a15e526e8dd226bd4d7678da6dcddb49b">BRT_RECTIMAGE</a>) {
<a name="l00837"></a>00837       BLOBNBOX_C_IT blob_it(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>());
<a name="l00838"></a>00838       <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00839"></a>00839         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l00840"></a>00840         im_blob_it.add_after_then_move(blob);
<a name="l00841"></a>00841       }
<a name="l00842"></a>00842     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blob_type != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a>) {
<a name="l00843"></a>00843       <span class="comment">// Make sure the blobs are marked with the correct type and flow.</span>
<a name="l00844"></a>00844       BLOBNBOX_C_IT blob_it(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>());
<a name="l00845"></a>00845       <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00846"></a>00846         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l00847"></a>00847         <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9e7100e6d08c78cca5f9c0453e11565d">region_type</a>() == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a>) {
<a name="l00848"></a>00848           <span class="comment">// TODO(rays) Deprecated. Change this section to an assert to verify</span>
<a name="l00849"></a>00849           <span class="comment">// and then delete.</span>
<a name="l00850"></a>00850           <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>()-&gt;<a class="code" href="class_c___b_l_o_b.html#af8d6cc72e454c97c5e14d7ccd12925e3">area</a>() != 0);
<a name="l00851"></a>00851           blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#ad573c3bea7351dd2cbdaaffa2ff11c58">set_owner</a>(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00852"></a>00852           blob_it.extract();
<a name="l00853"></a>00853         } <span class="keywordflow">else</span> {
<a name="l00854"></a>00854           blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a9b58644d9ad4f0d01193f47f55dd884f">set_region_type</a>(blob_type);
<a name="l00855"></a>00855           <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#afafe7113396a8cc27b882d622db46f05">flow</a>() != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a64e3e70c4fac4d4e3facdb4638307d7f">BTFT_LEADER</a>)
<a name="l00856"></a>00856             blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a75340334988feba52ce36ba596750a35">set_flow</a>(flow);
<a name="l00857"></a>00857         }
<a name="l00858"></a>00858       }
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860     <span class="keywordflow">if</span> (blob_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a> || part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>()-&gt;empty()) {
<a name="l00861"></a>00861       BLOBNBOX_C_IT blob_it(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>());
<a name="l00862"></a>00862       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a00ada2372a982efadbd4fb6da128bbb3">DisownBoxes</a>();
<a name="l00863"></a>00863       dead_part_it.add_to_end(part);
<a name="l00864"></a>00864       gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aa6a2166899235a22f58e607786ffd25e">RemoveBBox</a>();
<a name="l00865"></a>00865       <span class="keywordflow">for</span> (blob_it.mark_cycle_pt(); !blob_it.cycled_list(); blob_it.forward()) {
<a name="l00866"></a>00866         <a class="code" href="class_b_l_o_b_n_b_o_x.html">BLOBNBOX</a>* blob = blob_it.data();
<a name="l00867"></a>00867         <span class="keywordflow">if</span> (blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>()-&gt;<a class="code" href="class_c___b_l_o_b.html#af8d6cc72e454c97c5e14d7ccd12925e3">area</a>() == 0) {
<a name="l00868"></a>00868           <span class="comment">// Any blob with zero area is a fake image blob and should be deleted.</span>
<a name="l00869"></a>00869           <span class="keyword">delete</span> blob-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a483f44541a4dd818f02225c92f030e07">cblob</a>();
<a name="l00870"></a>00870           <span class="keyword">delete</span> blob;
<a name="l00871"></a>00871         }
<a name="l00872"></a>00872       }
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874   }
<a name="l00875"></a>00875 }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877 <span class="comment">// The boxes within the partitions have changed (by deskew) so recompute</span>
<a name="l00878"></a>00878 <span class="comment">// the bounds of all the partitions and reinsert them into the grid.</span>
<a name="l00879"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a4f9c81b3be7d951e96338488d66fbdcd">00879</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a4f9c81b3be7d951e96338488d66fbdcd">ColPartitionGrid::RecomputeBounds</a>(<span class="keywordtype">int</span> gridsize,
<a name="l00880"></a>00880                                        <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; bleft,
<a name="l00881"></a>00881                                        <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; tright,
<a name="l00882"></a>00882                                        <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; vertical) {
<a name="l00883"></a>00883   ColPartition_LIST saved_parts;
<a name="l00884"></a>00884   ColPartition_IT part_it(&amp;saved_parts);
<a name="l00885"></a>00885   <span class="comment">// Iterate the ColPartitions in the grid to get parts onto a list.</span>
<a name="l00886"></a>00886   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00887"></a>00887   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00888"></a>00888   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00889"></a>00889   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00890"></a>00890     part_it.add_to_end(part);
<a name="l00891"></a>00891   }
<a name="l00892"></a>00892   <span class="comment">// Reinitialize grid to the new size.</span>
<a name="l00893"></a>00893   <a class="code" href="classtesseract_1_1_b_b_grid.html#a1d2990adf323d7910fbf87b6fc3a7415">Init</a>(gridsize, bleft, tright);
<a name="l00894"></a>00894   <span class="comment">// Recompute the bounds of the parts and put them back in the new grid.</span>
<a name="l00895"></a>00895   <span class="keywordflow">for</span> (part_it.move_to_first(); !part_it.empty(); part_it.forward()) {
<a name="l00896"></a>00896     part = part_it.extract();
<a name="l00897"></a>00897     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8a60c7f2c817055b9331028495cb25b1">set_vertical</a>(vertical);
<a name="l00898"></a>00898     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a18f2c4bd514ea700d7d4f6d0a6541d17">ComputeLimits</a>();
<a name="l00899"></a>00899     <a class="code" href="classtesseract_1_1_b_b_grid.html#a7b379525e3d60c68e583352ae4b8a750">InsertBBox</a>(<span class="keyword">true</span>, <span class="keyword">true</span>, part);
<a name="l00900"></a>00900   }
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="comment">// Improves the margins of the ColPartitions in the grid by calling</span>
<a name="l00904"></a>00904 <span class="comment">// FindPartitionMargins on each.</span>
<a name="l00905"></a>00905 <span class="comment">// best_columns, which may be NULL, is an array of pointers indicating the</span>
<a name="l00906"></a>00906 <span class="comment">// column set at each y-coordinate in the grid.</span>
<a name="l00907"></a>00907 <span class="comment">// best_columns is usually the best_columns_ member of ColumnFinder.</span>
<a name="l00908"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a6840942249ec02a7c24c051a6f51f14c">00908</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a6840942249ec02a7c24c051a6f51f14c">ColPartitionGrid::GridFindMargins</a>(<a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>** best_columns) {
<a name="l00909"></a>00909   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l00910"></a>00910   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00911"></a>00911   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00912"></a>00912   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00913"></a>00913   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00914"></a>00914     <span class="comment">// Set up a rectangle search x-bounded by the column and y by the part.</span>
<a name="l00915"></a>00915     <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* columns = best_columns != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>
<a name="l00916"></a>00916                              ? best_columns[gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#abb4fccc7685ba0e893b8b638a11b5cde">GridY</a>()]
<a name="l00917"></a>00917                              : <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00918"></a>00918     FindPartitionMargins(columns, part);
<a name="l00919"></a>00919     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00920"></a>00920     <span class="keywordflow">if</span> (<a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>())) {
<a name="l00921"></a>00921       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Computed margins for part:&quot;</span>);
<a name="l00922"></a>00922       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924   }
<a name="l00925"></a>00925 }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927 <span class="comment">// Improves the margins of the ColPartitions in the list by calling</span>
<a name="l00928"></a>00928 <span class="comment">// FindPartitionMargins on each.</span>
<a name="l00929"></a>00929 <span class="comment">// best_columns, which may be NULL, is an array of pointers indicating the</span>
<a name="l00930"></a>00930 <span class="comment">// column set at each y-coordinate in the grid.</span>
<a name="l00931"></a>00931 <span class="comment">// best_columns is usually the best_columns_ member of ColumnFinder.</span>
<a name="l00932"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#af60361b4951944acc282c87f9d2dfd88">00932</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#af60361b4951944acc282c87f9d2dfd88">ColPartitionGrid::ListFindMargins</a>(<a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>** best_columns,
<a name="l00933"></a>00933                                        ColPartition_LIST* parts) {
<a name="l00934"></a>00934   ColPartition_IT part_it(parts);
<a name="l00935"></a>00935   <span class="keywordflow">for</span> (part_it.mark_cycle_pt(); !part_it.cycled_list(); part_it.forward()) {
<a name="l00936"></a>00936     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = part_it.data();
<a name="l00937"></a>00937     <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* columns = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00938"></a>00938     <span class="keywordflow">if</span> (best_columns != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00939"></a>00939       <a class="code" href="class_t_b_o_x.html">TBOX</a> part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00940"></a>00940       <span class="comment">// Get the columns from the y grid coord.</span>
<a name="l00941"></a>00941       <span class="keywordtype">int</span> grid_x, grid_y;
<a name="l00942"></a>00942       <a class="code" href="classtesseract_1_1_grid_base.html#a9cb158bba184d657c51257b98eea9f8f">GridCoords</a>(part_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), part_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), &amp;grid_x, &amp;grid_y);
<a name="l00943"></a>00943       columns = best_columns[grid_y];
<a name="l00944"></a>00944     }
<a name="l00945"></a>00945     FindPartitionMargins(columns, part);
<a name="l00946"></a>00946   }
<a name="l00947"></a>00947 }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 <span class="comment">// Deletes all the partitions in the grid after disowning all the blobs.</span>
<a name="l00950"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a274c6b7670b91545b63dd8f44c79782e">00950</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a274c6b7670b91545b63dd8f44c79782e">ColPartitionGrid::DeleteParts</a>() {
<a name="l00951"></a>00951   ColPartition_LIST dead_parts;
<a name="l00952"></a>00952   ColPartition_IT dead_it(&amp;dead_parts);
<a name="l00953"></a>00953   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00954"></a>00954   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00955"></a>00955   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00956"></a>00956   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00957"></a>00957     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a00ada2372a982efadbd4fb6da128bbb3">DisownBoxes</a>();
<a name="l00958"></a>00958     dead_it.add_to_end(part);  <span class="comment">// Parts will be deleted on return.</span>
<a name="l00959"></a>00959   }
<a name="l00960"></a>00960   <a class="code" href="classtesseract_1_1_b_b_grid.html#a0b373075bdfda41719d6fb9a64bcfee0">Clear</a>();
<a name="l00961"></a>00961 }
<a name="l00962"></a>00962 
<a name="l00963"></a>00963 <span class="comment">// Deletes all the partitions in the grid that are of type BRT_UNKNOWN and</span>
<a name="l00964"></a>00964 <span class="comment">// all the blobs in them.</span>
<a name="l00965"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ab4756f20467daf31de174d0da440a279">00965</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ab4756f20467daf31de174d0da440a279">ColPartitionGrid::DeleteUnknownParts</a>(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l00966"></a>00966   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00967"></a>00967   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00968"></a>00968   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00969"></a>00969   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00970"></a>00970     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>() == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>) {
<a name="l00971"></a>00971       gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#aa6a2166899235a22f58e607786ffd25e">RemoveBBox</a>();
<a name="l00972"></a>00972       <span class="comment">// Once marked, the blobs will be swept up by DeleteUnownedNoise.</span>
<a name="l00973"></a>00973       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aff449be10b9bb6e480b65cd1042e38e4">set_flow</a>(<a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a>);
<a name="l00974"></a>00974       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a67554d4553f198980b504091557442c7">set_blob_type</a>(<a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575ae09c6f7e99c3a3885c3469d52d0292d2">BRT_NOISE</a>);
<a name="l00975"></a>00975       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#abfa13ecb273fa29166a663daf82a2254">SetBlobTypes</a>();
<a name="l00976"></a>00976       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a00ada2372a982efadbd4fb6da128bbb3">DisownBoxes</a>();
<a name="l00977"></a>00977       <span class="keyword">delete</span> part;
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979   }
<a name="l00980"></a>00980   block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a9ce3c22594b44b4faad5c331ad0265ea">DeleteUnownedNoise</a>();
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 <span class="comment">// Finds and marks text partitions that represent figure captions.</span>
<a name="l00984"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#ae99dfe01a80478cc1ef370aa74b79773">00984</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#ae99dfe01a80478cc1ef370aa74b79773">ColPartitionGrid::FindFigureCaptions</a>() {
<a name="l00985"></a>00985   <span class="comment">// For each image region find its best candidate text caption region,</span>
<a name="l00986"></a>00986   <span class="comment">// if any and mark it as such.</span>
<a name="l00987"></a>00987   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l00988"></a>00988   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l00989"></a>00989   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l00990"></a>00990   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00991"></a>00991     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0ae19652d302dcc8bfd9cab1bed18770">IsImageType</a>()) {
<a name="l00992"></a>00992       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l00993"></a>00993       <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">AlignedBlob::WithinTestRegion</a>(2, part_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l00994"></a>00994                                                  part_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00995"></a>00995       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* best_caption = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00996"></a>00996       <span class="keywordtype">int</span> best_dist = 0;   <span class="comment">// Distance to best_caption.</span>
<a name="l00997"></a>00997       <span class="keywordtype">int</span> best_upper = 0;  <span class="comment">// Direction of best_caption.</span>
<a name="l00998"></a>00998       <span class="comment">// Handle both lower and upper directions.</span>
<a name="l00999"></a>00999       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> upper = 0; upper &lt; 2; ++upper) {
<a name="l01000"></a>01000         ColPartition_C_IT partner_it(upper ? part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a30fcadc2cf28369bb4634988ace3fd5a">upper_partners</a>()
<a name="l01001"></a>01001                                            : part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#abe20d8e0d6b3a347f3b9d4e43023fec4">lower_partners</a>());
<a name="l01002"></a>01002         <span class="comment">// If there are no image partners, then this direction is ok.</span>
<a name="l01003"></a>01003         <span class="keywordflow">for</span> (partner_it.mark_cycle_pt(); !partner_it.cycled_list();
<a name="l01004"></a>01004              partner_it.forward()) {
<a name="l01005"></a>01005           <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* partner = partner_it.data();
<a name="l01006"></a>01006           <span class="keywordflow">if</span> (partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0ae19652d302dcc8bfd9cab1bed18770">IsImageType</a>()) {
<a name="l01007"></a>01007             <span class="keywordflow">break</span>;
<a name="l01008"></a>01008           }
<a name="l01009"></a>01009         }
<a name="l01010"></a>01010         <span class="keywordflow">if</span> (!partner_it.cycled_list()) <span class="keywordflow">continue</span>;
<a name="l01011"></a>01011         <span class="comment">// Find the nearest totally overlapping text partner.</span>
<a name="l01012"></a>01012         <span class="keywordflow">for</span> (partner_it.mark_cycle_pt(); !partner_it.cycled_list();
<a name="l01013"></a>01013              partner_it.forward()) {
<a name="l01014"></a>01014           <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* partner = partner_it.data();
<a name="l01015"></a>01015           <span class="keywordflow">if</span> (!partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aaeb1d34b6b937a9d028f06562c985bd5">IsTextType</a>()) <span class="keywordflow">continue</span>;
<a name="l01016"></a>01016           <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; partner_box = partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l01017"></a>01017           <span class="keywordflow">if</span> (debug) {
<a name="l01018"></a>01018             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Finding figure captions for image part:&quot;</span>);
<a name="l01019"></a>01019             part_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01020"></a>01020             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Considering partner:&quot;</span>);
<a name="l01021"></a>01021             partner_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01022"></a>01022           }
<a name="l01023"></a>01023           <span class="keywordflow">if</span> (partner_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() &gt;= part_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() &amp;&amp;
<a name="l01024"></a>01024               partner_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() &lt;= part_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>()) {
<a name="l01025"></a>01025             <span class="keywordtype">int</span> dist = partner_box.<a class="code" href="class_t_b_o_x.html#a98e0f9a8622eec475ee93b260c57c7ab">y_gap</a>(part_box);
<a name="l01026"></a>01026             <span class="keywordflow">if</span> (best_caption == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || dist &lt; best_dist) {
<a name="l01027"></a>01027               best_dist = dist;
<a name="l01028"></a>01028               best_caption = partner;
<a name="l01029"></a>01029               best_upper = upper;
<a name="l01030"></a>01030             }
<a name="l01031"></a>01031           }
<a name="l01032"></a>01032         }
<a name="l01033"></a>01033       }
<a name="l01034"></a>01034       <span class="keywordflow">if</span> (best_caption != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01035"></a>01035         <span class="keywordflow">if</span> (debug) {
<a name="l01036"></a>01036           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Best caption candidate:&quot;</span>);
<a name="l01037"></a>01037           best_caption-&gt;bounding_box().print();
<a name="l01038"></a>01038         }
<a name="l01039"></a>01039         <span class="comment">// We have a candidate caption. Qualify it as being separable from</span>
<a name="l01040"></a>01040         <span class="comment">// any body text. We are looking for either a small number of lines</span>
<a name="l01041"></a>01041         <span class="comment">// or a big gap that indicates a separation from the body text.</span>
<a name="l01042"></a>01042         <span class="keywordtype">int</span> line_count = 0;
<a name="l01043"></a>01043         <span class="keywordtype">int</span> biggest_gap = 0;
<a name="l01044"></a>01044         <span class="keywordtype">int</span> smallest_gap = <a class="code" href="host_8h.html#a3905e54374e49708219791e7d59c60fb">MAX_INT16</a>;
<a name="l01045"></a>01045         <span class="keywordtype">int</span> total_height = 0;
<a name="l01046"></a>01046         <span class="keywordtype">int</span> mean_height = 0;
<a name="l01047"></a>01047         <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* end_partner = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01048"></a>01048         <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* next_partner = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01049"></a>01049         <span class="keywordflow">for</span> (<a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* partner = best_caption; partner != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l01050"></a>01050              line_count &lt;= <a class="code" href="namespacetesseract.html#a0c0112882a0fd4d5db231341b276748f">kMaxCaptionLines</a>;
<a name="l01051"></a>01051              partner = next_partner) {
<a name="l01052"></a>01052           <span class="keywordflow">if</span> (!partner-&gt;IsTextType()) {
<a name="l01053"></a>01053             end_partner = partner;
<a name="l01054"></a>01054             <span class="keywordflow">break</span>;
<a name="l01055"></a>01055           }
<a name="l01056"></a>01056           ++line_count;
<a name="l01057"></a>01057           total_height += partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>();
<a name="l01058"></a>01058           next_partner = partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#abb824820c4ebf82ee1dfc9c2a30c17ce">SingletonPartner</a>(best_upper);
<a name="l01059"></a>01059           <span class="keywordflow">if</span> (next_partner != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01060"></a>01060             <span class="keywordtype">int</span> gap = partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a98e0f9a8622eec475ee93b260c57c7ab">y_gap</a>(
<a name="l01061"></a>01061                 next_partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>());
<a name="l01062"></a>01062             <span class="keywordflow">if</span> (gap &gt; biggest_gap) {
<a name="l01063"></a>01063               biggest_gap = gap;
<a name="l01064"></a>01064               end_partner = next_partner;
<a name="l01065"></a>01065               mean_height = total_height / line_count;
<a name="l01066"></a>01066             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (gap &lt; smallest_gap) {
<a name="l01067"></a>01067               smallest_gap = gap;
<a name="l01068"></a>01068             }
<a name="l01069"></a>01069             <span class="comment">// If the gap looks big compared to the text size and the smallest</span>
<a name="l01070"></a>01070             <span class="comment">// gap seen so far, then we can stop.</span>
<a name="l01071"></a>01071             <span class="keywordflow">if</span> (biggest_gap &gt; mean_height * <a class="code" href="namespacetesseract.html#a3edae94975001932766025af12aa9615">kMinCaptionGapHeightRatio</a> &amp;&amp;
<a name="l01072"></a>01072                 biggest_gap &gt; smallest_gap * <a class="code" href="namespacetesseract.html#aede50c5fa6fdad612c08e73757501178">kMinCaptionGapRatio</a>)
<a name="l01073"></a>01073               <span class="keywordflow">break</span>;
<a name="l01074"></a>01074           }
<a name="l01075"></a>01075         }
<a name="l01076"></a>01076         <span class="keywordflow">if</span> (debug) {
<a name="l01077"></a>01077           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Line count=%d, biggest gap %d, smallest%d, mean height %d\n&quot;</span>,
<a name="l01078"></a>01078                   line_count, biggest_gap, smallest_gap, mean_height);
<a name="l01079"></a>01079           <span class="keywordflow">if</span> (end_partner != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01080"></a>01080             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;End partner:&quot;</span>);
<a name="l01081"></a>01081             end_partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01082"></a>01082           }
<a name="l01083"></a>01083         }
<a name="l01084"></a>01084         <span class="keywordflow">if</span> (next_partner == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; line_count &lt;= <a class="code" href="namespacetesseract.html#a0c0112882a0fd4d5db231341b276748f">kMaxCaptionLines</a>)
<a name="l01085"></a>01085           end_partner = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;  <span class="comment">// No gap, but line count is small.</span>
<a name="l01086"></a>01086         <span class="keywordflow">if</span> (line_count &lt;= <a class="code" href="namespacetesseract.html#a0c0112882a0fd4d5db231341b276748f">kMaxCaptionLines</a>) {
<a name="l01087"></a>01087           <span class="comment">// This is a qualified caption. Mark the text as caption.</span>
<a name="l01088"></a>01088           <span class="keywordflow">for</span> (<a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* partner = best_caption; partner != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l01089"></a>01089                partner != end_partner;
<a name="l01090"></a>01090                partner = next_partner) {
<a name="l01091"></a>01091             partner-&gt;set_type(<a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60af25906cdd91c91c56489f5878b89b99b">PT_CAPTION_TEXT</a>);
<a name="l01092"></a>01092             partner-&gt;SetBlobTypes();
<a name="l01093"></a>01093             <span class="keywordflow">if</span> (debug) {
<a name="l01094"></a>01094               <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Set caption type for partition:&quot;</span>);
<a name="l01095"></a>01095               partner-&gt;bounding_box().print();
<a name="l01096"></a>01096             }
<a name="l01097"></a>01097             next_partner = partner-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#abb824820c4ebf82ee1dfc9c2a30c17ce">SingletonPartner</a>(best_upper);
<a name="l01098"></a>01098           }
<a name="l01099"></a>01099         }
<a name="l01100"></a>01100       }
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102   }
<a name="l01103"></a>01103 }
<a name="l01104"></a>01104 
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 <span class="comment">// For every ColPartition in the grid, finds its upper and lower neighbours.</span>
<a name="l01109"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a7ed32c7b4717fc000dd55796f6bf86d7">01109</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a7ed32c7b4717fc000dd55796f6bf86d7">ColPartitionGrid::FindPartitionPartners</a>() {
<a name="l01110"></a>01110   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l01111"></a>01111   gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l01112"></a>01112   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l01113"></a>01113   <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01114"></a>01114     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aec438c63bf754474982b2bb4e74148b5">IsVerticalType</a>()) {
<a name="l01115"></a>01115       <a class="code" href="classtesseract_1_1_col_partition_grid.html#a14732f02e00e801e979f0b51daa3f34b">FindVPartitionPartners</a>(<span class="keyword">true</span>, part);
<a name="l01116"></a>01116       <a class="code" href="classtesseract_1_1_col_partition_grid.html#a14732f02e00e801e979f0b51daa3f34b">FindVPartitionPartners</a>(<span class="keyword">false</span>, part);
<a name="l01117"></a>01117     } <span class="keywordflow">else</span> {
<a name="l01118"></a>01118       <a class="code" href="classtesseract_1_1_col_partition_grid.html#a7ed32c7b4717fc000dd55796f6bf86d7">FindPartitionPartners</a>(<span class="keyword">true</span>, part);
<a name="l01119"></a>01119       <a class="code" href="classtesseract_1_1_col_partition_grid.html#a7ed32c7b4717fc000dd55796f6bf86d7">FindPartitionPartners</a>(<span class="keyword">false</span>, part);
<a name="l01120"></a>01120     }
<a name="l01121"></a>01121   }
<a name="l01122"></a>01122 }
<a name="l01123"></a>01123 
<a name="l01124"></a>01124 <span class="comment">// Finds the best partner in the given direction for the given partition.</span>
<a name="l01125"></a>01125 <span class="comment">// Stores the result with AddPartner.</span>
<a name="l01126"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#aaef9daa17449a94a02bf984759b30029">01126</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a7ed32c7b4717fc000dd55796f6bf86d7">ColPartitionGrid::FindPartitionPartners</a>(<span class="keywordtype">bool</span> upper, <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part) {
<a name="l01127"></a>01127   <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a32e3f08af42cf1e5ad99118b6fd66df2">type</a>() == <a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60a639c79458d7bb60c9d6f26f661dee484">PT_NOISE</a>)
<a name="l01128"></a>01128     <span class="keywordflow">return</span>;  <span class="comment">// Noise is not allowed to partner anything.</span>
<a name="l01129"></a>01129   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l01130"></a>01130   <span class="keywordtype">int</span> top = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3d4e0280ce16c899b22ecb5741c7f4db">median_top</a>();
<a name="l01131"></a>01131   <span class="keywordtype">int</span> bottom = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a9f0978c738e29da8c7474beb0024a62f">median_bottom</a>();
<a name="l01132"></a>01132   <span class="keywordtype">int</span> height = top - bottom;
<a name="l01133"></a>01133   <span class="keywordtype">int</span> mid_y = (bottom + top) / 2;
<a name="l01134"></a>01134   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> vsearch(<span class="keyword">this</span>);
<a name="l01135"></a>01135   <span class="comment">// Search down for neighbour below</span>
<a name="l01136"></a>01136   vsearch.<a class="code" href="classtesseract_1_1_grid_search.html#a071abe1128e59e6ccf1f98a8c6002744">StartVerticalSearch</a>(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#acfb9938222780d3957049698e2bde9e6">MidY</a>());
<a name="l01137"></a>01137   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* neighbour;
<a name="l01138"></a>01138   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* best_neighbour = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01139"></a>01139   <span class="keywordtype">int</span> best_dist = <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l01140"></a>01140   <span class="keywordflow">while</span> ((neighbour = vsearch.<a class="code" href="classtesseract_1_1_grid_search.html#adfe2bf527306cdd264be5bdcdd5ac351">NextVerticalSearch</a>(!upper)) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01141"></a>01141     <span class="keywordflow">if</span> (neighbour == part || neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a32e3f08af42cf1e5ad99118b6fd66df2">type</a>() == <a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60a639c79458d7bb60c9d6f26f661dee484">PT_NOISE</a>)
<a name="l01142"></a>01142       <span class="keywordflow">continue</span>;  <span class="comment">// Noise is not allowed to partner anything.</span>
<a name="l01143"></a>01143     <span class="keywordtype">int</span> neighbour_bottom = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a9f0978c738e29da8c7474beb0024a62f">median_bottom</a>();
<a name="l01144"></a>01144     <span class="keywordtype">int</span> neighbour_top = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3d4e0280ce16c899b22ecb5741c7f4db">median_top</a>();
<a name="l01145"></a>01145     <span class="keywordtype">int</span> neighbour_y = (neighbour_bottom + neighbour_top) / 2;
<a name="l01146"></a>01146     <span class="keywordflow">if</span> (upper != (neighbour_y &gt; mid_y))
<a name="l01147"></a>01147       <span class="keywordflow">continue</span>;
<a name="l01148"></a>01148     <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a43b5ff6a41c8f72876ca2d2c9683a2e6">HOverlaps</a>(*neighbour) &amp;&amp; !part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a975eb2892ed042fcfe94dc506d5f4c5b">WithinSameMargins</a>(*neighbour))
<a name="l01149"></a>01149       <span class="keywordflow">continue</span>;
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a774f9c6444621a78264fa2a2a401cf9a">TypesMatch</a>(*neighbour)) {
<a name="l01151"></a>01151       <span class="keywordflow">if</span> (best_neighbour == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01152"></a>01152         best_neighbour = neighbour;
<a name="l01153"></a>01153       <span class="keywordflow">continue</span>;
<a name="l01154"></a>01154     }
<a name="l01155"></a>01155     <span class="keywordtype">int</span> dist = upper ? neighbour_bottom - top : bottom - neighbour_top;
<a name="l01156"></a>01156     <span class="keywordflow">if</span> (dist &lt;= <a class="code" href="namespacetesseract.html#a03ac774c4cfbfe5f2b611e59b1e3f74b">kMaxPartitionSpacing</a> * height) {
<a name="l01157"></a>01157       <span class="keywordflow">if</span> (dist &lt; best_dist) {
<a name="l01158"></a>01158         best_dist = dist;
<a name="l01159"></a>01159         best_neighbour = neighbour;
<a name="l01160"></a>01160       }
<a name="l01161"></a>01161     } <span class="keywordflow">else</span> {
<a name="l01162"></a>01162       <span class="keywordflow">break</span>;
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164   }
<a name="l01165"></a>01165   <span class="keywordflow">if</span> (best_neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01166"></a>01166     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aefd307b4da338376d4cadc4a2f424b60">AddPartner</a>(upper, best_neighbour);
<a name="l01167"></a>01167 }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169 <span class="comment">// Finds the best partner in the given direction for the given partition.</span>
<a name="l01170"></a>01170 <span class="comment">// Stores the result with AddPartner.</span>
<a name="l01171"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a14732f02e00e801e979f0b51daa3f34b">01171</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a14732f02e00e801e979f0b51daa3f34b">ColPartitionGrid::FindVPartitionPartners</a>(<span class="keywordtype">bool</span> to_the_left,
<a name="l01172"></a>01172                                               <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part) {
<a name="l01173"></a>01173   <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a32e3f08af42cf1e5ad99118b6fd66df2">type</a>() == <a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60a639c79458d7bb60c9d6f26f661dee484">PT_NOISE</a>)
<a name="l01174"></a>01174     <span class="keywordflow">return</span>;  <span class="comment">// Noise is not allowed to partner anything.</span>
<a name="l01175"></a>01175   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l01176"></a>01176   <span class="keywordtype">int</span> left = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a74ee9a13d1b383a8550bfdfbc2c58eab">median_left</a>();
<a name="l01177"></a>01177   <span class="keywordtype">int</span> right = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a61a0716cd755a616b0d967ae51c02251">median_right</a>();
<a name="l01178"></a>01178   <span class="keywordtype">int</span> width = right - left;
<a name="l01179"></a>01179   <span class="keywordtype">int</span> mid_x = (left + right) / 2;
<a name="l01180"></a>01180   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> hsearch(<span class="keyword">this</span>);
<a name="l01181"></a>01181   <span class="comment">// Search left for neighbour to_the_left</span>
<a name="l01182"></a>01182   hsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ab4eb5b4d43442c26b598b45672713fab">StartSideSearch</a>(mid_x, box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l01183"></a>01183   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* neighbour;
<a name="l01184"></a>01184   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* best_neighbour = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01185"></a>01185   <span class="keywordtype">int</span> best_dist = <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l01186"></a>01186   <span class="keywordflow">while</span> ((neighbour = hsearch.<a class="code" href="classtesseract_1_1_grid_search.html#a7515ca407e452687f762349f1c3113ff">NextSideSearch</a>(to_the_left)) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (neighbour == part || neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a32e3f08af42cf1e5ad99118b6fd66df2">type</a>() == <a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60a639c79458d7bb60c9d6f26f661dee484">PT_NOISE</a>)
<a name="l01188"></a>01188       <span class="keywordflow">continue</span>;  <span class="comment">// Noise is not allowed to partner anything.</span>
<a name="l01189"></a>01189     <span class="keywordtype">int</span> neighbour_left = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a74ee9a13d1b383a8550bfdfbc2c58eab">median_left</a>();
<a name="l01190"></a>01190     <span class="keywordtype">int</span> neighbour_right = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a61a0716cd755a616b0d967ae51c02251">median_right</a>();
<a name="l01191"></a>01191     <span class="keywordtype">int</span> neighbour_x = (neighbour_left + neighbour_right) / 2;
<a name="l01192"></a>01192     <span class="keywordflow">if</span> (to_the_left != (neighbour_x &lt; mid_x))
<a name="l01193"></a>01193       <span class="keywordflow">continue</span>;
<a name="l01194"></a>01194     <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af57cf2b0dd0f197b1d48ad670eb0c8fc">VOverlaps</a>(*neighbour))
<a name="l01195"></a>01195       <span class="keywordflow">continue</span>;
<a name="l01196"></a>01196     <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a774f9c6444621a78264fa2a2a401cf9a">TypesMatch</a>(*neighbour))
<a name="l01197"></a>01197       <span class="keywordflow">continue</span>;  <span class="comment">// Only match to other vertical text.</span>
<a name="l01198"></a>01198     <span class="keywordtype">int</span> dist = to_the_left ? left - neighbour_right : neighbour_left - right;
<a name="l01199"></a>01199     <span class="keywordflow">if</span> (dist &lt;= <a class="code" href="namespacetesseract.html#a03ac774c4cfbfe5f2b611e59b1e3f74b">kMaxPartitionSpacing</a> * width) {
<a name="l01200"></a>01200       <span class="keywordflow">if</span> (dist &lt; best_dist || best_neighbour == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01201"></a>01201         best_dist = dist;
<a name="l01202"></a>01202         best_neighbour = neighbour;
<a name="l01203"></a>01203       }
<a name="l01204"></a>01204     } <span class="keywordflow">else</span> {
<a name="l01205"></a>01205       <span class="keywordflow">break</span>;
<a name="l01206"></a>01206     }
<a name="l01207"></a>01207   }
<a name="l01208"></a>01208   <span class="comment">// For vertical partitions, the upper partner is to the left, and lower is</span>
<a name="l01209"></a>01209   <span class="comment">// to the right.</span>
<a name="l01210"></a>01210   <span class="keywordflow">if</span> (best_neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01211"></a>01211     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aefd307b4da338376d4cadc4a2f424b60">AddPartner</a>(to_the_left, best_neighbour);
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 <span class="comment">// For every ColPartition with multiple partners in the grid, reduces the</span>
<a name="l01215"></a>01215 <span class="comment">// number of partners to 0 or 1. If get_desperate is true, goes to more</span>
<a name="l01216"></a>01216 <span class="comment">// desperate merge methods to merge flowing text before breaking partnerships.</span>
<a name="l01217"></a><a class="code" href="classtesseract_1_1_col_partition_grid.html#a4781167f958ee8cc47549d8b39b9f1b5">01217</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_grid.html#a4781167f958ee8cc47549d8b39b9f1b5">ColPartitionGrid::RefinePartitionPartners</a>(<span class="keywordtype">bool</span> get_desperate) {
<a name="l01218"></a>01218   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> gsearch(<span class="keyword">this</span>);
<a name="l01219"></a>01219   <span class="comment">// Refine in type order so that chasing multiple partners can be done</span>
<a name="l01220"></a>01220   <span class="comment">// before eliminating type mis-matching partners.</span>
<a name="l01221"></a>01221   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> type = <a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60ac0b3cd1b4592e1a3c609ff4273fb505b">PT_UNKNOWN</a> + 1; type &lt;= <a class="code" href="publictypes_8h.html#a03566528a98c079dafeebf00502f2b60a1cfce41c30bf1aefe403aaa66d271da1">PT_COUNT</a>; type++) {
<a name="l01222"></a>01222     <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l01223"></a>01223     gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ad7f7e99bcda5e0daeb682b772e445f60">StartFullSearch</a>();
<a name="l01224"></a>01224     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part;
<a name="l01225"></a>01225     <span class="keywordflow">while</span> ((part = gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae9cd15b1815e744caf0650320aecfc2c">NextFullSearch</a>()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01226"></a>01226       part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a008e1c29b009f6d8f24ebf022bcc63b3">RefinePartners</a>(static_cast&lt;PolyBlockType&gt;(type),
<a name="l01227"></a>01227                            get_desperate, <span class="keyword">this</span>);
<a name="l01228"></a>01228       <span class="comment">// Iterator may have been messed up by a merge.</span>
<a name="l01229"></a>01229       gsearch.<a class="code" href="classtesseract_1_1_grid_search.html#ae43afa517cd9b682f10ca1d54dad4ab0">RepositionIterator</a>();
<a name="l01230"></a>01230     }
<a name="l01231"></a>01231   }
<a name="l01232"></a>01232 }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234 
<a name="l01235"></a>01235 <span class="comment">// ========================== PRIVATE CODE ========================</span>
<a name="l01236"></a>01236 
<a name="l01237"></a>01237 <span class="comment">// Finds and returns a list of candidate ColPartitions to merge with part.</span>
<a name="l01238"></a>01238 <span class="comment">// The candidates must overlap search_box, and when merged must not</span>
<a name="l01239"></a>01239 <span class="comment">// overlap any other partitions that are not overlapped by each individually.</span>
<a name="l01240"></a>01240 <span class="keywordtype">void</span> ColPartitionGrid::FindMergeCandidates(<span class="keyword">const</span> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part,
<a name="l01241"></a>01241                                            <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; search_box, <span class="keywordtype">bool</span> debug,
<a name="l01242"></a>01242                                            ColPartition_CLIST* candidates) {
<a name="l01243"></a>01243   <span class="keywordtype">int</span> ok_overlap =
<a name="l01244"></a>01244       <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(<a class="code" href="namespacetesseract.html#a1fa28613a5db6fb9d0c7fdef0f151872">kTinyEnoughTextlineOverlapFraction</a> * <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() + 0.5);
<a name="l01245"></a>01245   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l01246"></a>01246   <span class="comment">// Now run the rect search.</span>
<a name="l01247"></a>01247   <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> rsearch(<span class="keyword">this</span>);
<a name="l01248"></a>01248   rsearch.SetUniqueMode(<span class="keyword">true</span>);
<a name="l01249"></a>01249   rsearch.StartRectSearch(search_box);
<a name="l01250"></a>01250   <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* candidate;
<a name="l01251"></a>01251   <span class="keywordflow">while</span> ((candidate = rsearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01252"></a>01252     <span class="keywordflow">if</span> (!OKMergeCandidate(part, candidate, debug))
<a name="l01253"></a>01253       <span class="keywordflow">continue</span>;
<a name="l01254"></a>01254     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; c_box = candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l01255"></a>01255     <span class="comment">// Candidate seems to be a potential merge with part. If one contains</span>
<a name="l01256"></a>01256     <span class="comment">// the other, then the merge is a no-brainer. Otherwise, search the</span>
<a name="l01257"></a>01257     <span class="comment">// combined box to see if anything else is inappropriately overlapped.</span>
<a name="l01258"></a>01258     <span class="keywordflow">if</span> (!part_box.<a class="code" href="class_t_b_o_x.html#a5d4e2c5f91b791e94d4c94e513180632">contains</a>(c_box) &amp;&amp; !c_box.<a class="code" href="class_t_b_o_x.html#a5d4e2c5f91b791e94d4c94e513180632">contains</a>(part_box)) {
<a name="l01259"></a>01259       <span class="comment">// Search the combined rectangle to see if anything new is overlapped.</span>
<a name="l01260"></a>01260       <span class="comment">// This is a preliminary test designed to quickly weed-out stupid</span>
<a name="l01261"></a>01261       <span class="comment">// merge candidates that would create a big list of overlapped objects</span>
<a name="l01262"></a>01262       <span class="comment">// for the squared-order overlap analysis. Eg. vertical and horizontal</span>
<a name="l01263"></a>01263       <span class="comment">// line-like objects that overlap real text when merged:</span>
<a name="l01264"></a>01264       <span class="comment">// || ==========================</span>
<a name="l01265"></a>01265       <span class="comment">// ||</span>
<a name="l01266"></a>01266       <span class="comment">// ||  r e a l  t e x t</span>
<a name="l01267"></a>01267       <span class="comment">// ||</span>
<a name="l01268"></a>01268       <span class="comment">// ||</span>
<a name="l01269"></a>01269       <a class="code" href="class_t_b_o_x.html">TBOX</a> merged_box(part_box);
<a name="l01270"></a>01270       merged_box += c_box;
<a name="l01271"></a>01271       <a class="code" href="classtesseract_1_1_grid_search.html">ColPartitionGridSearch</a> msearch(<span class="keyword">this</span>);
<a name="l01272"></a>01272       msearch.SetUniqueMode(<span class="keyword">true</span>);
<a name="l01273"></a>01273       msearch.StartRectSearch(merged_box);
<a name="l01274"></a>01274       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* neighbour;
<a name="l01275"></a>01275       <span class="keywordflow">while</span> ((neighbour = msearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01276"></a>01276         <span class="keywordflow">if</span> (neighbour == part || neighbour == candidate)
<a name="l01277"></a>01277           <span class="keywordflow">continue</span>;  <span class="comment">// Ignore itself.</span>
<a name="l01278"></a>01278         <span class="keywordflow">if</span> (neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea7f1476b335624a5e11985491dc589">OKMergeOverlap</a>(*part, *candidate, ok_overlap, <span class="keyword">false</span>))
<a name="l01279"></a>01279           <span class="keywordflow">continue</span>;  <span class="comment">// This kind of merge overlap is OK.</span>
<a name="l01280"></a>01280         <a class="code" href="class_t_b_o_x.html">TBOX</a> n_box = neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>();
<a name="l01281"></a>01281         <span class="comment">// The overlap is OK if:</span>
<a name="l01282"></a>01282         <span class="comment">// * the n_box already overlapped the part or the candidate OR</span>
<a name="l01283"></a>01283         <span class="comment">// * the n_box is a suitable merge with either part or candidate</span>
<a name="l01284"></a>01284         <span class="keywordflow">if</span> (!n_box.<a class="code" href="class_t_b_o_x.html#adcc7d2858ccb61cd715dbcff32bd5582">overlap</a>(part_box) &amp;&amp; !n_box.<a class="code" href="class_t_b_o_x.html#adcc7d2858ccb61cd715dbcff32bd5582">overlap</a>(c_box) &amp;&amp;
<a name="l01285"></a>01285             !OKMergeCandidate(part, neighbour, <span class="keyword">false</span>) &amp;&amp;
<a name="l01286"></a>01286             !OKMergeCandidate(candidate, neighbour, <span class="keyword">false</span>))
<a name="l01287"></a>01287           <span class="keywordflow">break</span>;
<a name="l01288"></a>01288       }
<a name="l01289"></a>01289       <span class="keywordflow">if</span> (neighbour != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01290"></a>01290         <span class="keywordflow">if</span> (debug) {
<a name="l01291"></a>01291           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Combined box overlaps another that is not OK despite&quot;</span>
<a name="l01292"></a>01292                   <span class="stringliteral">&quot; allowance of %d:&quot;</span>, ok_overlap);
<a name="l01293"></a>01293           neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01294"></a>01294           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Reason:&quot;</span>);
<a name="l01295"></a>01295           OKMergeCandidate(part, neighbour, <span class="keyword">true</span>);
<a name="l01296"></a>01296           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;...and:&quot;</span>);
<a name="l01297"></a>01297           OKMergeCandidate(candidate, neighbour, <span class="keyword">true</span>);
<a name="l01298"></a>01298           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Overlap:&quot;</span>);
<a name="l01299"></a>01299           neighbour-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea7f1476b335624a5e11985491dc589">OKMergeOverlap</a>(*part, *candidate, ok_overlap, <span class="keyword">true</span>);
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301         <span class="keywordflow">continue</span>;
<a name="l01302"></a>01302       }
<a name="l01303"></a>01303     }
<a name="l01304"></a>01304     <span class="keywordflow">if</span> (debug) {
<a name="l01305"></a>01305       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Adding candidate:&quot;</span>);
<a name="l01306"></a>01306       candidate-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308     <span class="comment">// Unique elements as they arrive.</span>
<a name="l01309"></a>01309     candidates-&gt;add_sorted(SortByBoxLeft&lt;ColPartition&gt;, <span class="keyword">true</span>, candidate);
<a name="l01310"></a>01310   }
<a name="l01311"></a>01311 }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313 <span class="comment">// Smoothes the region type/flow type of the given part by looking at local</span>
<a name="l01314"></a>01314 <span class="comment">// neigbours and the given image mask. Searches a padded rectangle with the</span>
<a name="l01315"></a>01315 <span class="comment">// padding truncated on one size of the part&#39;s box in turn for each side,</span>
<a name="l01316"></a>01316 <span class="comment">// using the result (if any) that has the least distance to all neighbours</span>
<a name="l01317"></a>01317 <span class="comment">// that contribute to the decision. This biases in favor of rectangular</span>
<a name="l01318"></a>01318 <span class="comment">// regions without completely enforcing them.</span>
<a name="l01319"></a>01319 <span class="comment">// If a good decision cannot be reached, the part is left unchanged.</span>
<a name="l01320"></a>01320 <span class="comment">// im_box and rerotation are used to map blob coordinates onto the</span>
<a name="l01321"></a>01321 <span class="comment">// nontext_map, which is used to prevent the spread of text neighbourhoods</span>
<a name="l01322"></a>01322 <span class="comment">// into images.</span>
<a name="l01323"></a>01323 <span class="comment">// Returns true if the partition was changed.</span>
<a name="l01324"></a>01324 <span class="keywordtype">bool</span> ColPartitionGrid::SmoothRegionType(Pix* nontext_map,
<a name="l01325"></a>01325                                         <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; im_box,
<a name="l01326"></a>01326                                         <span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rerotation,
<a name="l01327"></a>01327                                         <span class="keywordtype">bool</span> debug,
<a name="l01328"></a>01328                                         ColPartition* part) {
<a name="l01329"></a>01329   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = part-&gt;bounding_box();
<a name="l01330"></a>01330   <span class="keywordflow">if</span> (debug) {
<a name="l01331"></a>01331     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Smooothing part at:&quot;</span>);
<a name="l01332"></a>01332     part_box.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01333"></a>01333   }
<a name="l01334"></a>01334   <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> best_type = <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>;
<a name="l01335"></a>01335   <span class="keywordtype">int</span> best_dist = <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l01336"></a>01336   <span class="keywordtype">int</span> max_dist = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(part_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>(), part_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>());
<a name="l01337"></a>01337   max_dist = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(max_dist * <a class="code" href="namespacetesseract.html#ae4ffbfaa120044bd1f22b6f95ead9dce">kMaxNeighbourDistFactor</a>, <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>() * 2);
<a name="l01338"></a>01338   <span class="comment">// Search with the pad truncated on each side of the box in turn.</span>
<a name="l01339"></a>01339   <span class="keywordtype">bool</span> any_image = <span class="keyword">false</span>;
<a name="l01340"></a>01340   <span class="keywordtype">bool</span> all_image = <span class="keyword">true</span>;
<a name="l01341"></a>01341   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = 0; d &lt; <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a0f3b81ac0cbf413ac18c6de98cd69921">BND_COUNT</a>; ++d) {
<a name="l01342"></a>01342     <span class="keywordtype">int</span> dist;
<a name="l01343"></a>01343     <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> dir = <span class="keyword">static_cast&lt;</span><a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a><span class="keyword">&gt;</span>(d);
<a name="l01344"></a>01344     <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> type = SmoothInOneDirection(dir, nontext_map, im_box,
<a name="l01345"></a>01345                                                rerotation, debug, *part,
<a name="l01346"></a>01346                                                &amp;dist);
<a name="l01347"></a>01347     <span class="keywordflow">if</span> (debug) {
<a name="l01348"></a>01348       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Result in dir %d = %d at dist %d\n&quot;</span>, dir, type, dist);
<a name="l01349"></a>01349     }
<a name="l01350"></a>01350     <span class="keywordflow">if</span> (type != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a> &amp;&amp; dist &lt; best_dist) {
<a name="l01351"></a>01351       best_dist = dist;
<a name="l01352"></a>01352       best_type = type;
<a name="l01353"></a>01353     }
<a name="l01354"></a>01354     <span class="keywordflow">if</span> (type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a3b72528ad70da88719f0479bc8c5a190">BRT_POLYIMAGE</a>)
<a name="l01355"></a>01355       any_image = <span class="keyword">true</span>;
<a name="l01356"></a>01356     <span class="keywordflow">else</span>
<a name="l01357"></a>01357       all_image = <span class="keyword">false</span>;
<a name="l01358"></a>01358   }
<a name="l01359"></a>01359   <span class="keywordflow">if</span> (best_dist &gt; max_dist)
<a name="l01360"></a>01360     <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Too far away to set the type with it.</span>
<a name="l01361"></a>01361   <span class="keywordflow">if</span> (part-&gt;flow() == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a> &amp;&amp; !all_image) {
<a name="l01362"></a>01362       <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// We are not modifying it.</span>
<a name="l01363"></a>01363   }
<a name="l01364"></a>01364   <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> new_type = part-&gt;blob_type();
<a name="l01365"></a>01365   <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> new_flow = part-&gt;flow();
<a name="l01366"></a>01366   <span class="keywordflow">if</span> (best_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a> &amp;&amp; !any_image) {
<a name="l01367"></a>01367     new_flow = <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a>;
<a name="l01368"></a>01368     new_type = <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>;
<a name="l01369"></a>01369   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (best_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a> &amp;&amp; !any_image) {
<a name="l01370"></a>01370     new_flow = <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a>;
<a name="l01371"></a>01371     new_type = <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>;
<a name="l01372"></a>01372   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (best_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a3b72528ad70da88719f0479bc8c5a190">BRT_POLYIMAGE</a>) {
<a name="l01373"></a>01373     new_flow = <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1af99f0c54b98b6c7a0dd5d5f0b5dc635d">BTFT_NONTEXT</a>;
<a name="l01374"></a>01374     new_type = <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>;
<a name="l01375"></a>01375   }
<a name="l01376"></a>01376   <span class="keywordflow">if</span> (new_type != part-&gt;blob_type() || new_flow != part-&gt;flow()) {
<a name="l01377"></a>01377     part-&gt;set_flow(new_flow);
<a name="l01378"></a>01378     part-&gt;set_blob_type(new_type);
<a name="l01379"></a>01379     part-&gt;SetBlobTypes();
<a name="l01380"></a>01380     <span class="keywordflow">if</span> (debug) {
<a name="l01381"></a>01381       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Modified part:&quot;</span>);
<a name="l01382"></a>01382       part-&gt;Print();
<a name="l01383"></a>01383     }
<a name="l01384"></a>01384     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01385"></a>01385   } <span class="keywordflow">else</span> {
<a name="l01386"></a>01386     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01387"></a>01387   }
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 <span class="comment">// Sets up a search box based on the part_box, padded in all directions</span>
<a name="l01391"></a>01391 <span class="comment">// except direction. Also setup dist_scaling to weight x,y distances according</span>
<a name="l01392"></a>01392 <span class="comment">// to the given direction.</span>
<a name="l01393"></a>01393 <span class="keyword">static</span> <span class="keywordtype">void</span> ComputeSearchBoxAndScaling(<a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> <a class="code" href="vecfuncs_8cpp.html#a57d4a186a22b01e2110793bc22a5d8f0">direction</a>,
<a name="l01394"></a>01394                                        <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box,
<a name="l01395"></a>01395                                        <span class="keywordtype">int</span> min_padding,
<a name="l01396"></a>01396                                        <a class="code" href="class_t_b_o_x.html">TBOX</a>* search_box,
<a name="l01397"></a>01397                                        <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>* dist_scaling) {
<a name="l01398"></a>01398   *search_box = part_box;
<a name="l01399"></a>01399   <span class="comment">// Generate a pad value based on the min dimension of part_box, but at least</span>
<a name="l01400"></a>01400   <span class="comment">// min_padding and then scaled by kMaxPadFactor.</span>
<a name="l01401"></a>01401   <span class="keywordtype">int</span> padding = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(part_box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>(), part_box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>());
<a name="l01402"></a>01402   padding = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(padding, min_padding);
<a name="l01403"></a>01403   padding *= <a class="code" href="namespacetesseract.html#aae8f2f2cc0e41a6cc4a6d1bf322f4b2a">kMaxPadFactor</a>;
<a name="l01404"></a>01404   search_box-&gt;<a class="code" href="class_t_b_o_x.html#ad78f4f7e9746def02b0d2e8e8a2b3ceb">pad</a>(padding, padding);
<a name="l01405"></a>01405   <span class="comment">// Truncate the box in the appropriate direction and make the distance</span>
<a name="l01406"></a>01406   <span class="comment">// metric slightly biased in the truncated direction.</span>
<a name="l01407"></a>01407   <span class="keywordflow">switch</span> (direction) {
<a name="l01408"></a>01408     <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a34eeb3a076f3bbcb32d47b74ee3cee86">BND_LEFT</a>:
<a name="l01409"></a>01409       search_box-&gt;<a class="code" href="class_t_b_o_x.html#ae6151cd794841e100d8a346a0c4a46e6">set_left</a>(part_box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>());
<a name="l01410"></a>01410       *dist_scaling = <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(2, 1);
<a name="l01411"></a>01411       <span class="keywordflow">break</span>;
<a name="l01412"></a>01412     <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a898fc0442f50593b8ce360d3253d254d">BND_BELOW</a>:
<a name="l01413"></a>01413       search_box-&gt;<a class="code" href="class_t_b_o_x.html#a6f803b24b046883cb0f3882dc3d92302">set_bottom</a>(part_box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l01414"></a>01414       *dist_scaling = <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(1, 2);
<a name="l01415"></a>01415       <span class="keywordflow">break</span>;
<a name="l01416"></a>01416     <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883ac0391ea6a5bf43f7735142e9ae87a62f">BND_RIGHT</a>:
<a name="l01417"></a>01417       search_box-&gt;<a class="code" href="class_t_b_o_x.html#a2246293d3667b28c52a52353a2d5caea">set_right</a>(part_box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>());
<a name="l01418"></a>01418       *dist_scaling = <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(2, 1);
<a name="l01419"></a>01419       <span class="keywordflow">break</span>;
<a name="l01420"></a>01420     <span class="keywordflow">case</span> <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883a29aa5ffa693a9ac7e91c8c59e037509c">BND_ABOVE</a>:
<a name="l01421"></a>01421       search_box-&gt;<a class="code" href="class_t_b_o_x.html#a7f40dfd290a907200bdc98c196f63f45">set_top</a>(part_box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l01422"></a>01422       *dist_scaling = <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>(1, 2);
<a name="l01423"></a>01423       <span class="keywordflow">break</span>;
<a name="l01424"></a>01424     <span class="keywordflow">default</span>:
<a name="l01425"></a>01425       <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(<span class="keyword">false</span>);
<a name="l01426"></a>01426   }
<a name="l01427"></a>01427 }
<a name="l01428"></a>01428 
<a name="l01429"></a>01429 <span class="comment">// Local enum used by SmoothInOneDirection and AccumulatePartDistances</span>
<a name="l01430"></a>01430 <span class="comment">// for the different types of partition neighbour.</span>
<a name="l01431"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20f">01431</a> <span class="keyword">enum</span> <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20f">NeighbourPartitionType</a> {
<a name="l01432"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">01432</a>   <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">NPT_HTEXT</a>,       <span class="comment">// Definite horizontal text.</span>
<a name="l01433"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">01433</a>   <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">NPT_VTEXT</a>,       <span class="comment">// Definite vertical text.</span>
<a name="l01434"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">01434</a>   <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>,  <span class="comment">// Weakly horizontal text. Counts as HTEXT for HTEXT, but</span>
<a name="l01435"></a>01435                    <span class="comment">// image for image and VTEXT.</span>
<a name="l01436"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">01436</a>   <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>,  <span class="comment">// Weakly vertical text. Counts as VTEXT for VTEXT, but</span>
<a name="l01437"></a>01437                    <span class="comment">// image for image and HTEXT.</span>
<a name="l01438"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa5ed965ae2d40e930c7cda6c0797c6626">01438</a>   <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa5ed965ae2d40e930c7cda6c0797c6626">NPT_IMAGE</a>,       <span class="comment">// Defininte non-text.</span>
<a name="l01439"></a><a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">01439</a>   <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>        <span class="comment">// Number of array elements.</span>
<a name="l01440"></a>01440 };
<a name="l01441"></a>01441 
<a name="l01442"></a>01442 <span class="comment">// Executes the search for SmoothRegionType in a single direction.</span>
<a name="l01443"></a>01443 <span class="comment">// Creates a bounding box that is padded in all directions except direction,</span>
<a name="l01444"></a>01444 <span class="comment">// and searches it for other partitions. Finds the nearest collection of</span>
<a name="l01445"></a>01445 <span class="comment">// partitions that makes a decisive result (if any) and returns the type</span>
<a name="l01446"></a>01446 <span class="comment">// and the distance of the collection. If there are any pixels in the</span>
<a name="l01447"></a>01447 <span class="comment">// nontext_map, then the decision is biased towards image.</span>
<a name="l01448"></a>01448 <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> ColPartitionGrid::SmoothInOneDirection(
<a name="l01449"></a>01449     <a class="code" href="blobbox_8h.html#a4974474b3b161b68355d9a16eeaa3883">BlobNeighbourDir</a> direction, Pix* nontext_map,
<a name="l01450"></a>01450     <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; im_box, <span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rerotation,
<a name="l01451"></a>01451     <span class="keywordtype">bool</span> debug, <span class="keyword">const</span> ColPartition&amp; part, <span class="keywordtype">int</span>* best_distance) {
<a name="l01452"></a>01452   <span class="comment">// Set up a rectangle search bounded by the part.</span>
<a name="l01453"></a>01453   <a class="code" href="class_t_b_o_x.html">TBOX</a> part_box = part.bounding_box();
<a name="l01454"></a>01454   <a class="code" href="class_t_b_o_x.html">TBOX</a> search_box;
<a name="l01455"></a>01455   <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> dist_scaling;
<a name="l01456"></a>01456   ComputeSearchBoxAndScaling(direction, part_box, <a class="code" href="classtesseract_1_1_grid_base.html#afff2cee730084711205977b5fcb4901e">gridsize</a>(),
<a name="l01457"></a>01457                              &amp;search_box, &amp;dist_scaling);
<a name="l01458"></a>01458   <span class="keywordtype">bool</span> image_region = <a class="code" href="classtesseract_1_1_image_find.html#a8b562438d65621d641ed0d7a66d60a8f">ImageFind::CountPixelsInRotatedBox</a>(search_box, im_box,
<a name="l01459"></a>01459                                                          rerotation,
<a name="l01460"></a>01460                                                          nontext_map) &gt; 0;
<a name="l01461"></a>01461   <a class="code" href="class_generic_vector.html">GenericVector&lt;int&gt;</a> dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>];
<a name="l01462"></a>01462   AccumulatePartDistances(part, dist_scaling, search_box,
<a name="l01463"></a>01463                           nontext_map, im_box, rerotation, debug, dists);
<a name="l01464"></a>01464   <span class="comment">// By iteratively including the next smallest distance across the vectors,</span>
<a name="l01465"></a>01465   <span class="comment">// (as in a merge sort) we can use the vector indices as counts of each type</span>
<a name="l01466"></a>01466   <span class="comment">// and find the nearest set of objects that give us a definite decision.</span>
<a name="l01467"></a>01467   <span class="keywordtype">int</span> counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>];
<a name="l01468"></a>01468   memset(counts, 0, <span class="keyword">sizeof</span>(counts[0]) * <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>);
<a name="l01469"></a>01469   <span class="comment">// If there is image in the search box, tip the balance in image&#39;s favor.</span>
<a name="l01470"></a>01470   <span class="keywordtype">int</span> image_bias = image_region ? <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a> / 2 : 0;
<a name="l01471"></a>01471   <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> text_dir = part.blob_type();
<a name="l01472"></a>01472   <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> flow_type = part.flow();
<a name="l01473"></a>01473   <span class="keywordtype">int</span> min_dist = 0;
<a name="l01474"></a>01474   <span class="keywordflow">do</span> {
<a name="l01475"></a>01475     <span class="comment">// Find the minimum new entry across the vectors</span>
<a name="l01476"></a>01476     min_dist = <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l01477"></a>01477     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>; ++i) {
<a name="l01478"></a>01478       <span class="keywordflow">if</span> (counts[i] &lt; dists[i].size() &amp;&amp; dists[i][counts[i]] &lt; min_dist)
<a name="l01479"></a>01479         min_dist = dists[i][counts[i]];
<a name="l01480"></a>01480     }
<a name="l01481"></a>01481     <span class="comment">// Step all the indices/counts forward to include min_dist.</span>
<a name="l01482"></a>01482     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>; ++i) {
<a name="l01483"></a>01483       <span class="keywordflow">while</span> (counts[i] &lt; dists[i].size() &amp;&amp; dists[i][counts[i]] &lt;= min_dist)
<a name="l01484"></a>01484         ++counts[i];
<a name="l01485"></a>01485     }
<a name="l01486"></a>01486     *best_distance = min_dist;
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (debug) {
<a name="l01488"></a>01488       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Totals: htext=%d+%d, vtext=%d+%d, image=%d+%d, at dist=%d\n&quot;</span>,
<a name="l01489"></a>01489               counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">NPT_HTEXT</a>], counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>],
<a name="l01490"></a>01490               counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">NPT_VTEXT</a>], counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>],
<a name="l01491"></a>01491               counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa5ed965ae2d40e930c7cda6c0797c6626">NPT_IMAGE</a>], image_bias, min_dist);
<a name="l01492"></a>01492     }
<a name="l01493"></a>01493     <span class="comment">// See if we have a decision yet.</span>
<a name="l01494"></a>01494     <span class="keywordtype">int</span> image_count = counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa5ed965ae2d40e930c7cda6c0797c6626">NPT_IMAGE</a>];
<a name="l01495"></a>01495     <span class="keywordtype">int</span> htext_score = counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">NPT_HTEXT</a>] + counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>] -
<a name="l01496"></a>01496         (image_count + counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>]);
<a name="l01497"></a>01497     <span class="keywordtype">int</span> vtext_score = counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">NPT_VTEXT</a>] + counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>] -
<a name="l01498"></a>01498         (image_count + counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>]);
<a name="l01499"></a>01499     <span class="keywordflow">if</span> (image_count &gt; 0 &amp;&amp;
<a name="l01500"></a>01500         image_bias - htext_score &gt;= <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a> &amp;&amp;
<a name="l01501"></a>01501         image_bias - vtext_score &gt;= <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a>) {
<a name="l01502"></a>01502       *best_distance = dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa5ed965ae2d40e930c7cda6c0797c6626">NPT_IMAGE</a>][0];
<a name="l01503"></a>01503       <span class="keywordflow">if</span> (dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>].size() &gt; 0 &amp;&amp;
<a name="l01504"></a>01504           *best_distance &gt; dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>][0])
<a name="l01505"></a>01505         *best_distance = dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>][0];
<a name="l01506"></a>01506       <span class="keywordflow">if</span> (dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>].size() &gt; 0 &amp;&amp;
<a name="l01507"></a>01507           *best_distance &gt; dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>][0])
<a name="l01508"></a>01508         *best_distance = dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>][0];
<a name="l01509"></a>01509       <span class="keywordflow">return</span> <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a3b72528ad70da88719f0479bc8c5a190">BRT_POLYIMAGE</a>;
<a name="l01510"></a>01510     }
<a name="l01511"></a>01511     <span class="keywordflow">if</span> ((text_dir != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a> || flow_type != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a>) &amp;&amp;
<a name="l01512"></a>01512         counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">NPT_HTEXT</a>] &gt; 0 &amp;&amp; htext_score &gt;= <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a>) {
<a name="l01513"></a>01513       *best_distance = dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">NPT_HTEXT</a>][0];
<a name="l01514"></a>01514       <span class="keywordflow">return</span> <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>;
<a name="l01515"></a>01515     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((text_dir != <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a> || flow_type != <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a>) &amp;&amp;
<a name="l01516"></a>01516         counts[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">NPT_VTEXT</a>] &gt; 0 &amp;&amp; vtext_score &gt;= <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a>) {
<a name="l01517"></a>01517       *best_distance = dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">NPT_VTEXT</a>][0];
<a name="l01518"></a>01518       <span class="keywordflow">return</span> <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>;
<a name="l01519"></a>01519     }
<a name="l01520"></a>01520   } <span class="keywordflow">while</span> (min_dist &lt; <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>);
<a name="l01521"></a>01521   <span class="keywordflow">return</span> <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>;
<a name="l01522"></a>01522 }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524 <span class="comment">// Counts the partitions in the given search_box by appending the gap</span>
<a name="l01525"></a>01525 <span class="comment">// distance (scaled by dist_scaling) of the part from the base_part to the</span>
<a name="l01526"></a>01526 <span class="comment">// vector of the appropriate type for the partition. Prior to return, the</span>
<a name="l01527"></a>01527 <span class="comment">// vectors in the dists array are sorted in increasing order.</span>
<a name="l01528"></a>01528 <span class="comment">// The nontext_map (+im_box, rerotation) is used to make text invisible if</span>
<a name="l01529"></a>01529 <span class="comment">// there is non-text in between.</span>
<a name="l01530"></a>01530 <span class="comment">// dists must be an array of GenericVectors of size NPT_COUNT.</span>
<a name="l01531"></a>01531 <span class="keywordtype">void</span> ColPartitionGrid::AccumulatePartDistances(<span class="keyword">const</span> ColPartition&amp; base_part,
<a name="l01532"></a>01532                                                <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; dist_scaling,
<a name="l01533"></a>01533                                                <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; search_box,
<a name="l01534"></a>01534                                                Pix* nontext_map,
<a name="l01535"></a>01535                                                <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; im_box,
<a name="l01536"></a>01536                                                <span class="keyword">const</span> <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a>&amp; rerotation,
<a name="l01537"></a>01537                                                <span class="keywordtype">bool</span> debug,
<a name="l01538"></a>01538                                                <a class="code" href="class_generic_vector.html">GenericVector&lt;int&gt;</a>* dists) {
<a name="l01539"></a>01539   <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; part_box = base_part.bounding_box();
<a name="l01540"></a>01540   <a class="code" href="namespacetesseract.html#a990e3f25988f7d70c40a13225e645492">ColPartitionGridSearch</a> rsearch(<span class="keyword">this</span>);
<a name="l01541"></a>01541   rsearch.SetUniqueMode(<span class="keyword">true</span>);
<a name="l01542"></a>01542   rsearch.StartRectSearch(search_box);
<a name="l01543"></a>01543   ColPartition* neighbour;
<a name="l01544"></a>01544   <span class="comment">// Search for compatible neighbours with a similar strokewidth, but not</span>
<a name="l01545"></a>01545   <span class="comment">// on the other side of a tab vector.</span>
<a name="l01546"></a>01546   <span class="keywordflow">while</span> ((neighbour = rsearch.NextRectSearch()) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01547"></a>01547     <span class="keywordflow">if</span> (neighbour-&gt;IsUnMergeableType() ||
<a name="l01548"></a>01548         !base_part.ConfirmNoTabViolation(*neighbour) ||
<a name="l01549"></a>01549         neighbour == &amp;base_part)
<a name="l01550"></a>01550       <span class="keywordflow">continue</span>;
<a name="l01551"></a>01551     <a class="code" href="class_t_b_o_x.html">TBOX</a> nbox = neighbour-&gt;bounding_box();
<a name="l01552"></a>01552     <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575">BlobRegionType</a> n_type = neighbour-&gt;blob_type();
<a name="l01553"></a>01553     <span class="keywordflow">if</span> ((n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a> || n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>) &amp;&amp;
<a name="l01554"></a>01554         !<a class="code" href="classtesseract_1_1_image_find.html#a958b710c77aa2f60d139dbd50f2bb4d6">ImageFind::BlankImageInBetween</a>(part_box, nbox, im_box, rerotation,
<a name="l01555"></a>01555                                         nontext_map))
<a name="l01556"></a>01556       <span class="keywordflow">continue</span>;  <span class="comment">// Text not visible the other side of image.</span>
<a name="l01557"></a>01557     <span class="keywordflow">if</span> (<a class="code" href="class_b_l_o_b_n_b_o_x.html#a86decfe35457329f062098901d56015f">BLOBNBOX::IsLineType</a>(n_type))
<a name="l01558"></a>01558       <span class="keywordflow">continue</span>;  <span class="comment">// Don&#39;t use horizontal lines as neighbours.</span>
<a name="l01559"></a>01559     <span class="keywordtype">int</span> x_gap = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(part_box.<a class="code" href="class_t_b_o_x.html#a6c296f134aaae6ee544c4d000d76f80e">x_gap</a>(nbox), 0);
<a name="l01560"></a>01560     <span class="keywordtype">int</span> y_gap = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(part_box.<a class="code" href="class_t_b_o_x.html#a98e0f9a8622eec475ee93b260c57c7ab">y_gap</a>(nbox), 0);
<a name="l01561"></a>01561     <span class="keywordtype">int</span> n_dist = x_gap * dist_scaling.<a class="code" href="class_i_c_o_o_r_d.html#a59722a47c540007c58a539f0e35b3f33" title="access function">x</a>() + y_gap* dist_scaling.<a class="code" href="class_i_c_o_o_r_d.html#a66bba6ff8a5f060775e1c2ca511f7f29" title="access_function">y</a>();
<a name="l01562"></a>01562     <span class="keywordflow">if</span> (debug) {
<a name="l01563"></a>01563       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Part has x-gap=%d, y=%d, dist=%d at:&quot;</span>,
<a name="l01564"></a>01564               x_gap, y_gap, n_dist);
<a name="l01565"></a>01565       nbox.<a class="code" href="class_t_b_o_x.html#a2e753aa9943276301d68e9f9cad99620">print</a>();
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567     <span class="comment">// Truncate the number of boxes, so text doesn&#39;t get too much advantage.</span>
<a name="l01568"></a>01568     <span class="keywordtype">int</span> n_boxes = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(neighbour-&gt;boxes_count(), <a class="code" href="namespacetesseract.html#a0683cf2a8cb220b4bf8f5719b4846b09">kSmoothDecisionMargin</a>);
<a name="l01569"></a>01569     <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1">BlobTextFlowType</a> n_flow = neighbour-&gt;flow();
<a name="l01570"></a>01570     <a class="code" href="class_generic_vector.html">GenericVector&lt;int&gt;</a>* count_vector = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01571"></a>01571     <span class="keywordflow">if</span> (n_flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1ac6822a7999424340562c785a3fd95daa">BTFT_STRONG_CHAIN</a>) {
<a name="l01572"></a>01572       <span class="keywordflow">if</span> (n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>)
<a name="l01573"></a>01573         count_vector = &amp;dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20faf11849d4adc5e8047d5d66a4b4bbcb0f">NPT_HTEXT</a>];
<a name="l01574"></a>01574       <span class="keywordflow">else</span>
<a name="l01575"></a>01575         count_vector = &amp;dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa27c8da6ed042fcd7739cc43deb47d877">NPT_VTEXT</a>];
<a name="l01576"></a>01576       <span class="keywordflow">if</span> (debug) {
<a name="l01577"></a>01577         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;%s %d\n&quot;</span>, n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a> ? <span class="stringliteral">&quot;Htext&quot;</span> : <span class="stringliteral">&quot;Vtext&quot;</span>, n_boxes);
<a name="l01578"></a>01578       }
<a name="l01579"></a>01579     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a> || n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575aea2da025a50db20db8213f96495dd4a6">BRT_VERT_TEXT</a>) &amp;&amp;
<a name="l01580"></a>01580                (n_flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1a8fa903eb3c633ef681659563769a8007">BTFT_CHAIN</a> || n_flow == <a class="code" href="blobbox_8h.html#aa72f1499398e9694bf46752e1cc895e1adac19762bd040a53914be696482c1e53">BTFT_NEIGHBOURS</a>)) {
<a name="l01581"></a>01581       <span class="comment">// Medium text counts as weak, and all else counts as image.</span>
<a name="l01582"></a>01582       <span class="keywordflow">if</span> (n_type == <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a4f0b1431532d0e838187df32f2e822d7">BRT_TEXT</a>)
<a name="l01583"></a>01583         count_vector = &amp;dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4fb3395899c584480e12d1e5f57013cc">NPT_WEAK_HTEXT</a>];
<a name="l01584"></a>01584       <span class="keywordflow">else</span>
<a name="l01585"></a>01585         count_vector = &amp;dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa4af22b9c01e35695839b9cb11c0be594">NPT_WEAK_VTEXT</a>];
<a name="l01586"></a>01586       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Weak %d\n&quot;</span>, n_boxes);
<a name="l01587"></a>01587     } <span class="keywordflow">else</span> {
<a name="l01588"></a>01588       count_vector = &amp;dists[<a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa5ed965ae2d40e930c7cda6c0797c6626">NPT_IMAGE</a>];
<a name="l01589"></a>01589       <span class="keywordflow">if</span> (debug) <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Image %d\n&quot;</span>, n_boxes);
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591     <span class="keywordflow">if</span> (count_vector != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01592"></a>01592       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_boxes; ++i)
<a name="l01593"></a>01593         count_vector-&gt;<a class="code" href="class_generic_vector.html#a0dc89fe2a365b04a61017f9d78c1a303">push_back</a>(n_dist);
<a name="l01594"></a>01594     }
<a name="l01595"></a>01595     <span class="keywordflow">if</span> (debug) {
<a name="l01596"></a>01596       neighbour-&gt;Print();
<a name="l01597"></a>01597     }
<a name="l01598"></a>01598   }
<a name="l01599"></a>01599   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="namespacetesseract.html#ac6b87c14191b9d8faad9933a7334d20fa962f103650d31bd5ec341006e04ec61b">NPT_COUNT</a>; ++i)
<a name="l01600"></a>01600     dists[i].sort();
<a name="l01601"></a>01601 }
<a name="l01602"></a>01602 
<a name="l01603"></a>01603 <span class="comment">// Improves the margins of the part ColPartition by searching for</span>
<a name="l01604"></a>01604 <span class="comment">// neighbours that vertically overlap significantly.</span>
<a name="l01605"></a>01605 <span class="comment">// columns may be NULL, and indicates the assigned column structure this</span>
<a name="l01606"></a>01606 <span class="comment">// is applicable to part.</span>
<a name="l01607"></a>01607 <span class="keywordtype">void</span> ColPartitionGrid::FindPartitionMargins(ColPartitionSet* columns,
<a name="l01608"></a>01608                                             ColPartition* part) {
<a name="l01609"></a>01609   <span class="comment">// Set up a rectangle search x-bounded by the column and y by the part.</span>
<a name="l01610"></a>01610   <a class="code" href="class_t_b_o_x.html">TBOX</a> box = part-&gt;<a class="code" href="class_b_l_o_b_n_b_o_x.html#a7b97b8bc16b1473a28f9c44011522f4e">bounding_box</a>();
<a name="l01611"></a>01611   <span class="keywordtype">int</span> y = part-&gt;MidY();
<a name="l01612"></a>01612   <span class="comment">// Initial left margin is based on the column, if there is one.</span>
<a name="l01613"></a>01613   <span class="keywordtype">int</span> left_margin = <a class="code" href="classtesseract_1_1_grid_base.html#ad20b2cb8eb2bf52871d5260c04949cce">bleft</a>().<a class="code" href="class_i_c_o_o_r_d.html#a59722a47c540007c58a539f0e35b3f33" title="access function">x</a>();
<a name="l01614"></a>01614   <span class="keywordtype">int</span> right_margin = <a class="code" href="classtesseract_1_1_grid_base.html#aa94e147841b6a4fae0b28e7e872685a5">tright</a>().<a class="code" href="class_i_c_o_o_r_d.html#a59722a47c540007c58a539f0e35b3f33" title="access function">x</a>();
<a name="l01615"></a>01615   <span class="keywordflow">if</span> (columns != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01616"></a>01616     ColPartition* column = columns-&gt;ColumnContaining(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), y);
<a name="l01617"></a>01617     <span class="keywordflow">if</span> (column != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01618"></a>01618       left_margin = column-&gt;LeftAtY(y);
<a name="l01619"></a>01619     column = columns-&gt;ColumnContaining(box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), y);
<a name="l01620"></a>01620     <span class="keywordflow">if</span> (column != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01621"></a>01621       right_margin = column-&gt;RightAtY(y);
<a name="l01622"></a>01622   }
<a name="l01623"></a>01623   left_margin -= <a class="code" href="namespacetesseract.html#a09df286c02619a6b22c2cd6f89e42267">kColumnWidthFactor</a>;
<a name="l01624"></a>01624   right_margin += <a class="code" href="namespacetesseract.html#a09df286c02619a6b22c2cd6f89e42267">kColumnWidthFactor</a>;
<a name="l01625"></a>01625   <span class="comment">// Search for ColPartitions that reduce the margin.</span>
<a name="l01626"></a>01626   left_margin = FindMargin(box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>(), <span class="keyword">true</span>, left_margin,
<a name="l01627"></a>01627                            box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>(), part);
<a name="l01628"></a>01628   part-&gt;set_left_margin(left_margin);
<a name="l01629"></a>01629   <span class="comment">// Search for ColPartitions that reduce the margin.</span>
<a name="l01630"></a>01630   right_margin = FindMargin(box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() - box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>(), <span class="keyword">false</span>, right_margin,
<a name="l01631"></a>01631                             box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(), box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>(), part);
<a name="l01632"></a>01632   part-&gt;set_right_margin(right_margin);
<a name="l01633"></a>01633 }
<a name="l01634"></a>01634 
<a name="l01635"></a>01635 <span class="comment">// Starting at x, and going in the specified direction, upto x_limit, finds</span>
<a name="l01636"></a>01636 <span class="comment">// the margin for the given y range by searching sideways,</span>
<a name="l01637"></a>01637 <span class="comment">// and ignoring not_this.</span>
<a name="l01638"></a>01638 <span class="keywordtype">int</span> ColPartitionGrid::FindMargin(<span class="keywordtype">int</span> x, <span class="keywordtype">bool</span> right_to_left, <span class="keywordtype">int</span> x_limit,
<a name="l01639"></a>01639                                  <span class="keywordtype">int</span> y_bottom, <span class="keywordtype">int</span> y_top,
<a name="l01640"></a>01640                                  <span class="keyword">const</span> ColPartition* not_this) {
<a name="l01641"></a>01641   <span class="keywordtype">int</span> height = y_top - y_bottom;
<a name="l01642"></a>01642   <span class="comment">// Iterate the ColPartitions in the grid.</span>
<a name="l01643"></a>01643   <a class="code" href="namespacetesseract.html#a990e3f25988f7d70c40a13225e645492">ColPartitionGridSearch</a> side_search(<span class="keyword">this</span>);
<a name="l01644"></a>01644   side_search.SetUniqueMode(<span class="keyword">true</span>);
<a name="l01645"></a>01645   side_search.StartSideSearch(x, y_bottom, y_top);
<a name="l01646"></a>01646   ColPartition* part;
<a name="l01647"></a>01647   <span class="keywordflow">while</span> ((part = side_search.NextSideSearch(right_to_left)) != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01648"></a>01648     <span class="comment">// Ignore itself.</span>
<a name="l01649"></a>01649     <span class="keywordflow">if</span> (part == not_this)  <span class="comment">// || part-&gt;IsLineType())</span>
<a name="l01650"></a>01650       <span class="keywordflow">continue</span>;
<a name="l01651"></a>01651     <span class="comment">// Must overlap by enough, based on the min of the heights, so</span>
<a name="l01652"></a>01652     <span class="comment">// large partitions can&#39;t smash through small ones.</span>
<a name="l01653"></a>01653     <a class="code" href="class_t_b_o_x.html">TBOX</a> box = part-&gt;bounding_box();
<a name="l01654"></a>01654     <span class="keywordtype">int</span> min_overlap = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(height, box.<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a>());
<a name="l01655"></a>01655     min_overlap = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(min_overlap * <a class="code" href="namespacetesseract.html#acea5cf3f3fc7999a57079cc1bb4104f7">kMarginOverlapFraction</a> + 0.5);
<a name="l01656"></a>01656     <span class="keywordtype">int</span> y_overlap = <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(y_top, box.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>()) - <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(y_bottom, box.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l01657"></a>01657     <span class="keywordflow">if</span> (y_overlap &lt; min_overlap)
<a name="l01658"></a>01658       <span class="keywordflow">continue</span>;
<a name="l01659"></a>01659     <span class="comment">// Must be going the right way.</span>
<a name="l01660"></a>01660     <span class="keywordtype">int</span> x_edge = right_to_left ? box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>() : box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>();
<a name="l01661"></a>01661     <span class="keywordflow">if</span> ((x_edge &lt; x) != right_to_left)
<a name="l01662"></a>01662       <span class="keywordflow">continue</span>;
<a name="l01663"></a>01663     <span class="comment">// If we have gone past x_limit, then x_limit will do.</span>
<a name="l01664"></a>01664     <span class="keywordflow">if</span> ((x_edge &lt; x_limit) == right_to_left)
<a name="l01665"></a>01665       <span class="keywordflow">break</span>;
<a name="l01666"></a>01666     <span class="comment">// It reduces x limit, so save the new one.</span>
<a name="l01667"></a>01667     x_limit = x_edge;
<a name="l01668"></a>01668   }
<a name="l01669"></a>01669   <span class="keywordflow">return</span> x_limit;
<a name="l01670"></a>01670 }
<a name="l01671"></a>01671 
<a name="l01672"></a>01672 
<a name="l01673"></a>01673 }  <span class="comment">// namespace tesseract.</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="colpartitiongrid_8cpp.html">colpartitiongrid.cpp</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Thu Mar 29 2012 23:42:12 for Tesseract by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
