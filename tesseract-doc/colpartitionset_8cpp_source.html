<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Tesseract: tesseract-ocr/textord/colpartitionset.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tesseract
   &#160;<span id="projectnumber">3.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('colpartitionset_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">tesseract-ocr/textord/colpartitionset.cpp</div>  </div>
</div>
<div class="contents">
<a href="colpartitionset_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">// File:        colpartitionset.cpp</span>
<a name="l00003"></a>00003 <span class="comment">// Description: Class to hold a list of ColPartitions of the page that</span>
<a name="l00004"></a>00004 <span class="comment">//              correspond roughly to columns.</span>
<a name="l00005"></a>00005 <span class="comment">// Author:      Ray Smith</span>
<a name="l00006"></a>00006 <span class="comment">// Created:     Thu Aug 14 10:54:01 PDT 2008</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// (C) Copyright 2008, Google Inc.</span>
<a name="l00009"></a>00009 <span class="comment">// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00010"></a>00010 <span class="comment">// you may not use this file except in compliance with the License.</span>
<a name="l00011"></a>00011 <span class="comment">// You may obtain a copy of the License at</span>
<a name="l00012"></a>00012 <span class="comment">// http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00013"></a>00013 <span class="comment">// Unless required by applicable law or agreed to in writing, software</span>
<a name="l00014"></a>00014 <span class="comment">// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00015"></a>00015 <span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00016"></a>00016 <span class="comment">// See the License for the specific language governing permissions and</span>
<a name="l00017"></a>00017 <span class="comment">// limitations under the License.</span>
<a name="l00018"></a>00018 <span class="comment">//</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="colpartitionset_8h.html">colpartitionset.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="ndminx_8h.html">ndminx.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="workingpartset_8h.html">workingpartset.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="tablefind_8h.html">tablefind.h</a>&quot;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keyword">namespace </span>tesseract {
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">// Minimum width of a column to be interesting as a multiple of resolution.</span>
<a name="l00029"></a>00029 <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespacetesseract.html#aa5d3fda875a0c1990a5e99213d6dc942">kMinColumnWidth</a> = 2.0 / 3;
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <a class="code" href="namespacetesseract.html#a7c9c6594de104bda28d30b82eb3f65a9">ELISTIZE</a>(ColPartitionSet)
<a name="l00032"></a>00032 
<a name="l00033"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a56d9224144d2911b2c631c078a2d0a76">00033</a> <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>::<a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>(ColPartition_LIST* partitions) {
<a name="l00034"></a>00034   ColPartition_IT it(&amp;parts_);
<a name="l00035"></a>00035   it.add_list_after(partitions);
<a name="l00036"></a>00036   ComputeCoverage();
<a name="l00037"></a>00037 }
<a name="l00038"></a>00038 
<a name="l00039"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a9a2e5194a5ad227e5a3fa389766acc6d">00039</a> <a class="code" href="classtesseract_1_1_col_partition_set.html#a96ae4c04676ab794a249bf4c8ae9d82b">ColPartitionSet::ColPartitionSet</a>(<a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part) {
<a name="l00040"></a>00040   ColPartition_IT it(&amp;parts_);
<a name="l00041"></a>00041   it.add_after_then_move(part);
<a name="l00042"></a>00042   ComputeCoverage();
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a40c51443b9abc135469fe23e7cf10f8f">00045</a> <a class="code" href="classtesseract_1_1_col_partition_set.html#a40c51443b9abc135469fe23e7cf10f8f">ColPartitionSet::~ColPartitionSet</a>() {
<a name="l00046"></a>00046 }
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="comment">// Return an element of the parts_ list from its index.</span>
<a name="l00049"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a4e4928726f63e6d53e67dc82007703e1">00049</a> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* <a class="code" href="classtesseract_1_1_col_partition_set.html#a4e4928726f63e6d53e67dc82007703e1">ColPartitionSet::GetColumnByIndex</a>(<span class="keywordtype">int</span> index) {
<a name="l00050"></a>00050   ColPartition_IT it(&amp;parts_);
<a name="l00051"></a>00051   it.mark_cycle_pt();
<a name="l00052"></a>00052   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; index &amp;&amp; !it.cycled_list(); ++i, it.forward());
<a name="l00053"></a>00053   <span class="keywordflow">if</span> (it.cycled_list())
<a name="l00054"></a>00054     <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00055"></a>00055   <span class="keywordflow">return</span> it.data();
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="comment">// Return the ColPartition that contains the given coords, if any, else NULL.</span>
<a name="l00059"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a9a65bec02d946f263f18aa86a186c91c">00059</a> <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* <a class="code" href="classtesseract_1_1_col_partition_set.html#a9a65bec02d946f263f18aa86a186c91c">ColPartitionSet::ColumnContaining</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y) {
<a name="l00060"></a>00060   ColPartition_IT it(&amp;parts_);
<a name="l00061"></a>00061   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00062"></a>00062     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00063"></a>00063     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac7729e02ee4765d7612a0ec045681512">ColumnContains</a>(x, y))
<a name="l00064"></a>00064       <span class="keywordflow">return</span> part;
<a name="l00065"></a>00065   }
<a name="l00066"></a>00066   <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="comment">// Extract all the parts from the list, relinquishing ownership.</span>
<a name="l00070"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#ae221122d16d0eb0233029e524de378d6">00070</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#ae221122d16d0eb0233029e524de378d6">ColPartitionSet::RelinquishParts</a>() {
<a name="l00071"></a>00071   ColPartition_IT it(&amp;parts_);
<a name="l00072"></a>00072   <span class="keywordflow">while</span> (!it.empty()) {
<a name="l00073"></a>00073     it.extract();
<a name="l00074"></a>00074     it.forward();
<a name="l00075"></a>00075   }
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">// Attempt to improve this by adding partitions or expanding partitions.</span>
<a name="l00079"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a772763e56afc044cc330bae623bc117a">00079</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a772763e56afc044cc330bae623bc117a">ColPartitionSet::ImproveColumnCandidate</a>(<a class="code" href="class_tess_result_callback1.html">WidthCallback</a>* cb,
<a name="l00080"></a>00080                                              <a class="code" href="class_generic_vector.html">PartSetVector</a>* src_sets) {
<a name="l00081"></a>00081   <span class="keywordtype">int</span> set_size = src_sets-&gt;<a class="code" href="class_generic_vector.html#a111b51dd0bf1324cfb69ef70703d8e70">size</a>();
<a name="l00082"></a>00082   <span class="comment">// Iterate over the provided column sets, as each one may have something</span>
<a name="l00083"></a>00083   <span class="comment">// to improve this.</span>
<a name="l00084"></a>00084   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; set_size; ++i) {
<a name="l00085"></a>00085     <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* column_set = src_sets-&gt;<a class="code" href="class_generic_vector.html#a33070cfea2a16a20c6b30bbcfecd8ecc">get</a>(i);
<a name="l00086"></a>00086     <span class="keywordflow">if</span> (column_set == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00087"></a>00087       <span class="keywordflow">continue</span>;
<a name="l00088"></a>00088     <span class="comment">// Iterate over the parts in this and column_set, adding bigger or</span>
<a name="l00089"></a>00089     <span class="comment">// new parts in column_set to this.</span>
<a name="l00090"></a>00090     ColPartition_IT part_it(&amp;parts_);
<a name="l00091"></a>00091     <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(!part_it.empty());
<a name="l00092"></a>00092     <span class="keywordtype">int</span> prev_right = <a class="code" href="host_8h.html#ae6f88d5bb15e97510f484289f2fc89fd">MIN_INT32</a>;
<a name="l00093"></a>00093     part_it.mark_cycle_pt();
<a name="l00094"></a>00094     ColPartition_IT col_it(&amp;column_set-&gt;parts_);
<a name="l00095"></a>00095     <span class="keywordflow">for</span> (col_it.mark_cycle_pt(); !col_it.cycled_list(); col_it.forward()) {
<a name="l00096"></a>00096       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* col_part = col_it.data();
<a name="l00097"></a>00097       <span class="keywordflow">if</span> (col_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>() &lt; <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>)
<a name="l00098"></a>00098         <span class="keywordflow">continue</span>;  <span class="comment">// Ignore image partitions.</span>
<a name="l00099"></a>00099       <span class="keywordtype">int</span> col_left = col_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>();
<a name="l00100"></a>00100       <span class="keywordtype">int</span> col_right = col_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>();
<a name="l00101"></a>00101       <span class="comment">// Sync-up part_it (in this) so it matches the col_part in column_set.</span>
<a name="l00102"></a>00102       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = part_it.data();
<a name="l00103"></a>00103       <span class="keywordflow">while</span> (!part_it.at_last() &amp;&amp; part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>() &lt; col_left) {
<a name="l00104"></a>00104         prev_right = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>();
<a name="l00105"></a>00105         part_it.forward();
<a name="l00106"></a>00106         part = part_it.data();
<a name="l00107"></a>00107       }
<a name="l00108"></a>00108       <span class="keywordtype">int</span> part_left = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>();
<a name="l00109"></a>00109       <span class="keywordtype">int</span> part_right = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>();
<a name="l00110"></a>00110       <span class="keywordflow">if</span> (part_right &lt; col_left || col_right &lt; part_left) {
<a name="l00111"></a>00111         <span class="comment">// There is no overlap so this is a new partition.</span>
<a name="l00112"></a>00112         AddPartition(col_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a70116af39898d43ca19ecb189faccfa1">ShallowCopy</a>(), &amp;part_it);
<a name="l00113"></a>00113         <span class="keywordflow">continue</span>;
<a name="l00114"></a>00114       }
<a name="l00115"></a>00115       <span class="comment">// Check the edges of col_part to see if they can improve part.</span>
<a name="l00116"></a>00116       <span class="keywordtype">bool</span> part_width_ok = cb-&gt;<a class="code" href="class_tess_result_callback1.html#a15949cddc2970f837e3eef7e7dc84fce">Run</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac45a47a9427bf943acba1c0ae7d8ed0b">KeyWidth</a>(part_left, part_right));
<a name="l00117"></a>00117       <span class="keywordflow">if</span> (col_left &lt; part_left &amp;&amp; col_left &gt; prev_right) {
<a name="l00118"></a>00118         <span class="comment">// The left edge of the column is better and it doesn&#39;t overlap,</span>
<a name="l00119"></a>00119         <span class="comment">// so we can potentially expand it.</span>
<a name="l00120"></a>00120         <span class="keywordtype">int</span> col_box_left = col_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8679f5d1f87946bcd821dd2ffe1e80e">BoxLeftKey</a>();
<a name="l00121"></a>00121         <span class="keywordtype">bool</span> tab_width_ok = cb-&gt;<a class="code" href="class_tess_result_callback1.html#a15949cddc2970f837e3eef7e7dc84fce">Run</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac45a47a9427bf943acba1c0ae7d8ed0b">KeyWidth</a>(col_left, part_right));
<a name="l00122"></a>00122         <span class="keywordtype">bool</span> box_width_ok = cb-&gt;<a class="code" href="class_tess_result_callback1.html#a15949cddc2970f837e3eef7e7dc84fce">Run</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac45a47a9427bf943acba1c0ae7d8ed0b">KeyWidth</a>(col_box_left, part_right));
<a name="l00123"></a>00123         <span class="keywordflow">if</span> (tab_width_ok || (!part_width_ok )) {
<a name="l00124"></a>00124           <span class="comment">// The tab is leaving the good column metric at least as good as</span>
<a name="l00125"></a>00125           <span class="comment">// it was before, so use the tab.</span>
<a name="l00126"></a>00126           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aff9a74526321b24bbafcdbc359f9d161">CopyLeftTab</a>(*col_part, <span class="keyword">false</span>);
<a name="l00127"></a>00127           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea991fccc4013feadaa1cc2b8f35051">SetColumnGoodness</a>(cb);
<a name="l00128"></a>00128         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (col_box_left &lt; part_left &amp;&amp;
<a name="l00129"></a>00129                    (box_width_ok || !part_width_ok)) {
<a name="l00130"></a>00130           <span class="comment">// The box is leaving the good column metric at least as good as</span>
<a name="l00131"></a>00131           <span class="comment">// it was before, so use the box.</span>
<a name="l00132"></a>00132           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aff9a74526321b24bbafcdbc359f9d161">CopyLeftTab</a>(*col_part, <span class="keyword">true</span>);
<a name="l00133"></a>00133           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea991fccc4013feadaa1cc2b8f35051">SetColumnGoodness</a>(cb);
<a name="l00134"></a>00134         }
<a name="l00135"></a>00135         part_left = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>();
<a name="l00136"></a>00136       }
<a name="l00137"></a>00137       <span class="keywordflow">if</span> (col_right &gt; part_right &amp;&amp;
<a name="l00138"></a>00138           (part_it.at_last() ||
<a name="l00139"></a>00139            part_it.data_relative(1)-&gt;left_key() &gt; col_right)) {
<a name="l00140"></a>00140         <span class="comment">// The right edge is better, so we can possibly expand it.</span>
<a name="l00141"></a>00141         <span class="keywordtype">int</span> col_box_right = col_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a498b82d4970d0c0fe24c59e27d5933e7">BoxRightKey</a>();
<a name="l00142"></a>00142         <span class="keywordtype">bool</span> tab_width_ok = cb-&gt;<a class="code" href="class_tess_result_callback1.html#a15949cddc2970f837e3eef7e7dc84fce">Run</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac45a47a9427bf943acba1c0ae7d8ed0b">KeyWidth</a>(part_left, col_right));
<a name="l00143"></a>00143         <span class="keywordtype">bool</span> box_width_ok = cb-&gt;<a class="code" href="class_tess_result_callback1.html#a15949cddc2970f837e3eef7e7dc84fce">Run</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac45a47a9427bf943acba1c0ae7d8ed0b">KeyWidth</a>(part_left, col_box_right));
<a name="l00144"></a>00144         <span class="keywordflow">if</span> (tab_width_ok || (!part_width_ok )) {
<a name="l00145"></a>00145           <span class="comment">// The tab is leaving the good column metric at least as good as</span>
<a name="l00146"></a>00146           <span class="comment">// it was before, so use the tab.</span>
<a name="l00147"></a>00147           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab4ec7202d19f98517fd32bce150ebbb0">CopyRightTab</a>(*col_part, <span class="keyword">false</span>);
<a name="l00148"></a>00148           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea991fccc4013feadaa1cc2b8f35051">SetColumnGoodness</a>(cb);
<a name="l00149"></a>00149         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (col_box_right &gt; part_right &amp;&amp;
<a name="l00150"></a>00150                    (box_width_ok || !part_width_ok)) {
<a name="l00151"></a>00151           <span class="comment">// The box is leaving the good column metric at least as good as</span>
<a name="l00152"></a>00152           <span class="comment">// it was before, so use the box.</span>
<a name="l00153"></a>00153           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab4ec7202d19f98517fd32bce150ebbb0">CopyRightTab</a>(*col_part, <span class="keyword">true</span>);
<a name="l00154"></a>00154           part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a8ea991fccc4013feadaa1cc2b8f35051">SetColumnGoodness</a>(cb);
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156       }
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158   }
<a name="l00159"></a>00159   ComputeCoverage();
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">// If this set is good enough to represent a new partitioning into columns,</span>
<a name="l00163"></a>00163 <span class="comment">// add it to the vector of sets, otherwise delete it.</span>
<a name="l00164"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a2bc71914f948cda279ea34f6d34a5cbe">00164</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a2bc71914f948cda279ea34f6d34a5cbe">ColPartitionSet::AddToColumnSetsIfUnique</a>(<a class="code" href="class_generic_vector.html">PartSetVector</a>* column_sets,
<a name="l00165"></a>00165                                               <a class="code" href="class_tess_result_callback1.html">WidthCallback</a>* cb) {
<a name="l00166"></a>00166   <span class="keywordtype">bool</span> debug = <a class="code" href="classtesseract_1_1_aligned_blob.html#a357ff9e1d9bac2b1d88fb0d335fa7f3e">TabFind::WithinTestRegion</a>(2, bounding_box_.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(),
<a name="l00167"></a>00167                                          bounding_box_.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>());
<a name="l00168"></a>00168   <span class="keywordflow">if</span> (debug) {
<a name="l00169"></a>00169     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Considering new column candidate:\n&quot;</span>);
<a name="l00170"></a>00170     <a class="code" href="classtesseract_1_1_col_partition_set.html#a51f3aa3845b8ea00943fac4ca72e905f">Print</a>();
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172   <span class="keywordflow">if</span> (!<a class="code" href="classtesseract_1_1_col_partition_set.html#a9d821d919ed86c9e7eafeda711c2e33d">LegalColumnCandidate</a>()) {
<a name="l00173"></a>00173     <span class="keywordflow">if</span> (debug) {
<a name="l00174"></a>00174       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Not a legal column candidate:\n&quot;</span>);
<a name="l00175"></a>00175       <a class="code" href="classtesseract_1_1_col_partition_set.html#a51f3aa3845b8ea00943fac4ca72e905f">Print</a>();
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     <span class="keyword">delete</span> <span class="keyword">this</span>;
<a name="l00178"></a>00178     <span class="keywordflow">return</span>;
<a name="l00179"></a>00179   }
<a name="l00180"></a>00180   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; column_sets-&gt;<a class="code" href="class_generic_vector.html#a111b51dd0bf1324cfb69ef70703d8e70">size</a>(); ++i) {
<a name="l00181"></a>00181     <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* columns = column_sets-&gt;<a class="code" href="class_generic_vector.html#a33070cfea2a16a20c6b30bbcfecd8ecc">get</a>(i);
<a name="l00182"></a>00182     <span class="comment">// In ordering the column set candidates, good_coverage_ is king,</span>
<a name="l00183"></a>00183     <span class="comment">// followed by good_column_count_ and then bad_coverage_.</span>
<a name="l00184"></a>00184     <span class="keywordtype">bool</span> better = good_coverage_ &gt; columns-&gt;good_coverage_;
<a name="l00185"></a>00185     <span class="keywordflow">if</span> (good_coverage_ == columns-&gt;good_coverage_) {
<a name="l00186"></a>00186       better = good_column_count_ &gt; columns-&gt;good_column_count_;
<a name="l00187"></a>00187       <span class="keywordflow">if</span> (good_column_count_ == columns-&gt;good_column_count_) {
<a name="l00188"></a>00188           better = bad_coverage_ &gt; columns-&gt;bad_coverage_;
<a name="l00189"></a>00189       }
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     <span class="keywordflow">if</span> (better) {
<a name="l00192"></a>00192       <span class="comment">// The new one is better so add it.</span>
<a name="l00193"></a>00193       <span class="keywordflow">if</span> (debug)
<a name="l00194"></a>00194         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Good one\n&quot;</span>);
<a name="l00195"></a>00195       column_sets-&gt;<a class="code" href="class_generic_vector.html#a57ca5259541548a97bcfd4d0925a27ff">insert</a>(<span class="keyword">this</span>, i);
<a name="l00196"></a>00196       <span class="keywordflow">return</span>;
<a name="l00197"></a>00197     }
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (columns-&gt;<a class="code" href="classtesseract_1_1_col_partition_set.html#a473a52c7a5b02694be17c9864d61ada0">CompatibleColumns</a>(<span class="keyword">false</span>, <span class="keyword">this</span>, cb)) {
<a name="l00199"></a>00199       <span class="keywordflow">if</span> (debug)
<a name="l00200"></a>00200         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Duplicate\n&quot;</span>);
<a name="l00201"></a>00201       <span class="keyword">delete</span> <span class="keyword">this</span>;
<a name="l00202"></a>00202       <span class="keywordflow">return</span>;  <span class="comment">// It is not unique.</span>
<a name="l00203"></a>00203     }
<a name="l00204"></a>00204   }
<a name="l00205"></a>00205   <span class="keywordflow">if</span> (debug)
<a name="l00206"></a>00206     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Added to end\n&quot;</span>);
<a name="l00207"></a>00207   column_sets-&gt;<a class="code" href="class_generic_vector.html#a0dc89fe2a365b04a61017f9d78c1a303">push_back</a>(<span class="keyword">this</span>);
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="comment">// Return true if the partitions in other are all compatible with the columns</span>
<a name="l00211"></a>00211 <span class="comment">// in this.</span>
<a name="l00212"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a473a52c7a5b02694be17c9864d61ada0">00212</a> <span class="keywordtype">bool</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a473a52c7a5b02694be17c9864d61ada0">ColPartitionSet::CompatibleColumns</a>(<span class="keywordtype">bool</span> debug, <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* other,
<a name="l00213"></a>00213                                         <a class="code" href="class_tess_result_callback1.html">WidthCallback</a>* cb) {
<a name="l00214"></a>00214   <span class="keywordflow">if</span> (debug) {
<a name="l00215"></a>00215     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns testing compatibility\n&quot;</span>);
<a name="l00216"></a>00216     <a class="code" href="classtesseract_1_1_col_partition_set.html#a51f3aa3845b8ea00943fac4ca72e905f">Print</a>();
<a name="l00217"></a>00217     other-&gt;<a class="code" href="classtesseract_1_1_col_partition_set.html#a51f3aa3845b8ea00943fac4ca72e905f">Print</a>();
<a name="l00218"></a>00218   }
<a name="l00219"></a>00219   <span class="keywordflow">if</span> (other-&gt;parts_.empty()) {
<a name="l00220"></a>00220     <span class="keywordflow">if</span> (debug)
<a name="l00221"></a>00221       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns true due to empty other\n&quot;</span>);
<a name="l00222"></a>00222     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00223"></a>00223   }
<a name="l00224"></a>00224   ColPartition_IT it(&amp;other-&gt;parts_);
<a name="l00225"></a>00225   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00226"></a>00226     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>() &lt; <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>) {
<a name="l00228"></a>00228       <span class="keywordflow">if</span> (debug) {
<a name="l00229"></a>00229         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns ignoring image partition\n&quot;</span>);
<a name="l00230"></a>00230         part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00231"></a>00231       }
<a name="l00232"></a>00232       <span class="keywordflow">continue</span>;  <span class="comment">// Image partitions are irrelevant to column compatibility.</span>
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234     <span class="keywordtype">int</span> y = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#acfb9938222780d3957049698e2bde9e6">MidY</a>();
<a name="l00235"></a>00235     <span class="keywordtype">int</span> left = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>();
<a name="l00236"></a>00236     <span class="keywordtype">int</span> right = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>();
<a name="l00237"></a>00237     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* left_col = <a class="code" href="classtesseract_1_1_col_partition_set.html#a9a65bec02d946f263f18aa86a186c91c">ColumnContaining</a>(left, y);
<a name="l00238"></a>00238     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* right_col = <a class="code" href="classtesseract_1_1_col_partition_set.html#a9a65bec02d946f263f18aa86a186c91c">ColumnContaining</a>(right, y);
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (right_col == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || left_col == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00240"></a>00240       <span class="keywordflow">if</span> (debug) {
<a name="l00241"></a>00241         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns false due to partition edge outside\n&quot;</span>);
<a name="l00242"></a>00242         part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00243"></a>00243       }
<a name="l00244"></a>00244       <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// A partition edge lies outside of all columns</span>
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (right_col != left_col &amp;&amp; cb-&gt;<a class="code" href="class_tess_result_callback1.html#a15949cddc2970f837e3eef7e7dc84fce">Run</a>(right - left)) {
<a name="l00247"></a>00247       <span class="keywordflow">if</span> (debug) {
<a name="l00248"></a>00248         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns false due to good width in multiple cols\n&quot;</span>);
<a name="l00249"></a>00249         part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00250"></a>00250       }
<a name="l00251"></a>00251       <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Partition with a good width must be in a single column.</span>
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     ColPartition_IT it2= it;
<a name="l00255"></a>00255     <span class="keywordflow">while</span> (!it2.at_last()) {
<a name="l00256"></a>00256       it2.forward();
<a name="l00257"></a>00257       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* next_part = it2.data();
<a name="l00258"></a>00258       <span class="keywordflow">if</span> (!<a class="code" href="class_b_l_o_b_n_b_o_x.html#a07444bc838d7efe7c41f8b00913447ac">BLOBNBOX::IsTextType</a>(next_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>()))
<a name="l00259"></a>00259         <span class="keywordflow">continue</span>;  <span class="comment">// Non-text partitions are irrelevant.</span>
<a name="l00260"></a>00260       <span class="keywordtype">int</span> next_left = next_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>();
<a name="l00261"></a>00261       <span class="keywordflow">if</span> (next_left == right) {
<a name="l00262"></a>00262         <span class="keywordflow">break</span>;  <span class="comment">// They share the same edge, so one must be a pull-out.</span>
<a name="l00263"></a>00263       }
<a name="l00264"></a>00264       <span class="comment">// Search to see if right and next_left fall within a single column.</span>
<a name="l00265"></a>00265       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* next_left_col = <a class="code" href="classtesseract_1_1_col_partition_set.html#a9a65bec02d946f263f18aa86a186c91c">ColumnContaining</a>(next_left, y);
<a name="l00266"></a>00266       <span class="keywordflow">if</span> (right_col == next_left_col) {
<a name="l00267"></a>00267         <span class="comment">// There is a column break in this column.</span>
<a name="l00268"></a>00268         <span class="comment">// This can be due to a figure caption within a column, a pull-out</span>
<a name="l00269"></a>00269         <span class="comment">// block, or a simple broken textline that remains to be merged:</span>
<a name="l00270"></a>00270         <span class="comment">// all allowed, or a change in column layout: not allowed.</span>
<a name="l00271"></a>00271         <span class="comment">// If both partitions are of good width, then it is likely</span>
<a name="l00272"></a>00272         <span class="comment">// a change in column layout, otherwise probably an allowed situation.</span>
<a name="l00273"></a>00273         <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0bd194403074c23e54e840c6a5d7214b">good_width</a>() &amp;&amp; next_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0bd194403074c23e54e840c6a5d7214b">good_width</a>()) {
<a name="l00274"></a>00274           <span class="keywordflow">if</span> (debug) {
<a name="l00275"></a>00275             <span class="keywordtype">int</span> next_right = next_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#aeb52b4505d6766abfd0a2a3ce92a6596">bounding_box</a>().<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>();
<a name="l00276"></a>00276             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns false due to 2 parts of good width\n&quot;</span>);
<a name="l00277"></a>00277             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;part1 %d-%d, part2 %d-%d\n&quot;</span>,
<a name="l00278"></a>00278                     left, right, next_left, next_right);
<a name="l00279"></a>00279             right_col-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00280"></a>00280           }
<a name="l00281"></a>00281           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283       }
<a name="l00284"></a>00284       <span class="keywordflow">break</span>;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286   }
<a name="l00287"></a>00287   <span class="keywordflow">if</span> (debug)
<a name="l00288"></a>00288     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;CompatibleColumns true!\n&quot;</span>);
<a name="l00289"></a>00289   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00290"></a>00290 }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292 <span class="comment">// Returns the total width of all blobs in the part_set that do not lie</span>
<a name="l00293"></a>00293 <span class="comment">// within an approved column. Used as a cost measure for using this</span>
<a name="l00294"></a>00294 <span class="comment">// column set over another that might be compatible.</span>
<a name="l00295"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#ae2ac889a0a2b3d8297a7c52667f5d6f4">00295</a> <span class="keywordtype">int</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#ae2ac889a0a2b3d8297a7c52667f5d6f4">ColPartitionSet::UnmatchedWidth</a>(<a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* part_set) {
<a name="l00296"></a>00296   <span class="keywordtype">int</span> total_width = 0;
<a name="l00297"></a>00297   ColPartition_IT it(&amp;part_set-&gt;parts_);
<a name="l00298"></a>00298   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00299"></a>00299     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00300"></a>00300     <span class="keywordflow">if</span> (!<a class="code" href="class_b_l_o_b_n_b_o_x.html#a07444bc838d7efe7c41f8b00913447ac">BLOBNBOX::IsTextType</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>())) {
<a name="l00301"></a>00301       <span class="keywordflow">continue</span>;  <span class="comment">// Non-text partitions are irrelevant to column compatibility.</span>
<a name="l00302"></a>00302     }
<a name="l00303"></a>00303     <span class="keywordtype">int</span> y = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#acfb9938222780d3957049698e2bde9e6">MidY</a>();
<a name="l00304"></a>00304     BLOBNBOX_C_IT box_it(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3fc2dd797ede7a62546b2565811e9ce0">boxes</a>());
<a name="l00305"></a>00305     <span class="keywordflow">for</span> (box_it.mark_cycle_pt(); !box_it.cycled_list(); box_it.forward()) {
<a name="l00306"></a>00306       <span class="keyword">const</span> <a class="code" href="class_t_b_o_x.html">TBOX</a>&amp; box = it.data()-&gt;bounding_box();
<a name="l00307"></a>00307       <span class="comment">// Assume that the whole blob is outside any column iff its x-middle</span>
<a name="l00308"></a>00308       <span class="comment">// is outside.</span>
<a name="l00309"></a>00309       <span class="keywordtype">int</span> x = (box.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>() + box.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>()) / 2;
<a name="l00310"></a>00310       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* col = <a class="code" href="classtesseract_1_1_col_partition_set.html#a9a65bec02d946f263f18aa86a186c91c">ColumnContaining</a>(x, y);
<a name="l00311"></a>00311       <span class="keywordflow">if</span> (col == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00312"></a>00312         total_width += box.<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a>();
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314   }
<a name="l00315"></a>00315   <span class="keywordflow">return</span> total_width;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 <span class="comment">// Return true if this ColPartitionSet makes a legal column candidate by</span>
<a name="l00319"></a>00319 <span class="comment">// having legal individual partitions and non-overlapping adjacent pairs.</span>
<a name="l00320"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a9d821d919ed86c9e7eafeda711c2e33d">00320</a> <span class="keywordtype">bool</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a9d821d919ed86c9e7eafeda711c2e33d">ColPartitionSet::LegalColumnCandidate</a>() {
<a name="l00321"></a>00321   ColPartition_IT it(&amp;parts_);
<a name="l00322"></a>00322   <span class="keywordflow">if</span> (it.empty())
<a name="l00323"></a>00323     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00324"></a>00324   <span class="keywordtype">bool</span> any_text_parts = <span class="keyword">false</span>;
<a name="l00325"></a>00325   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00326"></a>00326     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00327"></a>00327     <span class="keywordflow">if</span> (<a class="code" href="class_b_l_o_b_n_b_o_x.html#a07444bc838d7efe7c41f8b00913447ac">BLOBNBOX::IsTextType</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>())) {
<a name="l00328"></a>00328       <span class="keywordflow">if</span> (!part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#affa76b0b726f75d996a9e5dbe8b3e408">IsLegal</a>())
<a name="l00329"></a>00329         <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// Individual partition is illegal.</span>
<a name="l00330"></a>00330       any_text_parts = <span class="keyword">true</span>;
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (!it.at_last()) {
<a name="l00333"></a>00333       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* next_part = it.data_relative(1);
<a name="l00334"></a>00334       <span class="keywordflow">if</span> (next_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>() &lt; part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>()) {
<a name="l00335"></a>00335         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00336"></a>00336       }
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338   }
<a name="l00339"></a>00339   <span class="keywordflow">return</span> any_text_parts;
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 <span class="comment">// Return a copy of this. If good_only will only copy the Good ColPartitions.</span>
<a name="l00343"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a99232d52ed5fd8b56f165923562a9cab">00343</a> <a class="code" href="classtesseract_1_1_col_partition_set.html">ColPartitionSet</a>* <a class="code" href="classtesseract_1_1_col_partition_set.html#a99232d52ed5fd8b56f165923562a9cab">ColPartitionSet::Copy</a>(<span class="keywordtype">bool</span> good_only) {
<a name="l00344"></a>00344   ColPartition_LIST copy_parts;
<a name="l00345"></a>00345   ColPartition_IT src_it(&amp;parts_);
<a name="l00346"></a>00346   ColPartition_IT dest_it(&amp;copy_parts);
<a name="l00347"></a>00347   <span class="keywordflow">for</span> (src_it.mark_cycle_pt(); !src_it.cycled_list(); src_it.forward()) {
<a name="l00348"></a>00348     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = src_it.data();
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (<a class="code" href="class_b_l_o_b_n_b_o_x.html#a07444bc838d7efe7c41f8b00913447ac">BLOBNBOX::IsTextType</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a644ec0c0a7bf20b9aca71b8413b2a87e">blob_type</a>()) &amp;&amp;
<a name="l00350"></a>00350         (!good_only || part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0bd194403074c23e54e840c6a5d7214b">good_width</a>() || part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a0ddb453820cf0860bef4a27ed649e2b0">good_column</a>()))
<a name="l00351"></a>00351       dest_it.add_after_then_move(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a70116af39898d43ca19ecb189faccfa1">ShallowCopy</a>());
<a name="l00352"></a>00352   }
<a name="l00353"></a>00353   <span class="keywordflow">if</span> (dest_it.empty())
<a name="l00354"></a>00354     <span class="keywordflow">return</span> <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00355"></a>00355   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a96ae4c04676ab794a249bf4c8ae9d82b">ColPartitionSet</a>(&amp;copy_parts);
<a name="l00356"></a>00356 }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 <span class="comment">// Return the bounding boxes of columns at the given y-range</span>
<a name="l00359"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#ae48258575cffe3725081778e493cfa04">00359</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#ae48258575cffe3725081778e493cfa04">ColPartitionSet::GetColumnBoxes</a>(<span class="keywordtype">int</span> y_bottom, <span class="keywordtype">int</span> y_top,
<a name="l00360"></a>00360                                      ColSegment_LIST *segments) {
<a name="l00361"></a>00361   ColPartition_IT it(&amp;parts_);
<a name="l00362"></a>00362   ColSegment_IT col_it(segments);
<a name="l00363"></a>00363   col_it.move_to_last();
<a name="l00364"></a>00364   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00365"></a>00365     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00366"></a>00366     <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> bot_left(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab71e3aebabe8a0a9e3cde26f84ec4f46">LeftAtY</a>(y_top), y_bottom);
<a name="l00367"></a>00367     <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> top_right(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3731935e70135384e25904d65c0ca8f7">RightAtY</a>(y_bottom), y_top);
<a name="l00368"></a>00368     <a class="code" href="classtesseract_1_1_col_segment.html">ColSegment</a> *col_seg = <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_col_segment.html">ColSegment</a>();
<a name="l00369"></a>00369     col_seg-&gt;InsertBox(<a class="code" href="class_t_b_o_x.html">TBOX</a>(bot_left, top_right));
<a name="l00370"></a>00370     col_it.add_after_then_move(col_seg);
<a name="l00371"></a>00371   }
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 <span class="comment">// Display the edges of the columns at the given y coords.</span>
<a name="l00375"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a36859fa1a9497c3b0e52834a90d0acd5">00375</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a36859fa1a9497c3b0e52834a90d0acd5">ColPartitionSet::DisplayColumnEdges</a>(<span class="keywordtype">int</span> y_bottom, <span class="keywordtype">int</span> y_top,
<a name="l00376"></a>00376                                          <a class="code" href="class_scroll_view.html">ScrollView</a>* win) {
<a name="l00377"></a>00377 <span class="preprocessor">  #ifndef GRAPHICS_DISABLED</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>  ColPartition_IT it(&amp;parts_);
<a name="l00379"></a>00379   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00380"></a>00380     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00381"></a>00381     win-&gt;<a class="code" href="class_scroll_view.html#a2ba16f17fc401bb28be1a08160207e45">Line</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab71e3aebabe8a0a9e3cde26f84ec4f46">LeftAtY</a>(y_top), y_top, part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ab71e3aebabe8a0a9e3cde26f84ec4f46">LeftAtY</a>(y_bottom), y_bottom);
<a name="l00382"></a>00382     win-&gt;<a class="code" href="class_scroll_view.html#a2ba16f17fc401bb28be1a08160207e45">Line</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3731935e70135384e25904d65c0ca8f7">RightAtY</a>(y_top), y_top, part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3731935e70135384e25904d65c0ca8f7">RightAtY</a>(y_bottom), y_bottom);
<a name="l00383"></a>00383   }
<a name="l00384"></a>00384 <span class="preprocessor">  #endif  // GRAPHICS_DISABLED</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>}
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 <span class="comment">// Return the ColumnSpanningType that best explains the columns overlapped</span>
<a name="l00388"></a>00388 <span class="comment">// by the given coords(left,right,y), with the given margins.</span>
<a name="l00389"></a>00389 <span class="comment">// Also return the first and last column index touched by the coords and</span>
<a name="l00390"></a>00390 <span class="comment">// the leftmost spanned column.</span>
<a name="l00391"></a>00391 <span class="comment">// Column indices are 2n + 1 for real columns (0 based) and even values</span>
<a name="l00392"></a>00392 <span class="comment">// represent the gaps in between columns, with 0 being left of the leftmost.</span>
<a name="l00393"></a>00393 <span class="comment">// resolution refers to the ppi resolution of the image.</span>
<a name="l00394"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a71afe4ff3ef968e65fb729c7a1a1fd0c">00394</a> <a class="code" href="namespacetesseract.html#a1c442f32007891bd4ea6e885b34cc06a">ColumnSpanningType</a> <a class="code" href="classtesseract_1_1_col_partition_set.html#a71afe4ff3ef968e65fb729c7a1a1fd0c">ColPartitionSet::SpanningType</a>(<span class="keywordtype">int</span> resolution,
<a name="l00395"></a>00395                                                  <span class="keywordtype">int</span> left, <span class="keywordtype">int</span> right, <span class="keywordtype">int</span> y,
<a name="l00396"></a>00396                                                  <span class="keywordtype">int</span> left_margin,
<a name="l00397"></a>00397                                                  <span class="keywordtype">int</span> right_margin,
<a name="l00398"></a>00398                                                  <span class="keywordtype">int</span>* first_col,
<a name="l00399"></a>00399                                                  <span class="keywordtype">int</span>* last_col,
<a name="l00400"></a>00400                                                  <span class="keywordtype">int</span>* first_spanned_col) {
<a name="l00401"></a>00401   *first_col = -1;
<a name="l00402"></a>00402   *last_col = -1;
<a name="l00403"></a>00403   *first_spanned_col = -1;
<a name="l00404"></a>00404   <span class="keywordtype">int</span> margin_columns = 0;
<a name="l00405"></a>00405   ColPartition_IT it(&amp;parts_);
<a name="l00406"></a>00406   <span class="keywordtype">int</span> col_index = 1;
<a name="l00407"></a>00407   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward(), col_index += 2) {
<a name="l00408"></a>00408     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac7729e02ee4765d7612a0ec045681512">ColumnContains</a>(left, y)) {
<a name="l00410"></a>00410       <span class="comment">// In the default case, first_col is set, but columns_spanned remains</span>
<a name="l00411"></a>00411       <span class="comment">// zero, so first_col will get reset in the first column genuinely</span>
<a name="l00412"></a>00412       <span class="comment">// spanned, but we can tell the difference from a noise partition</span>
<a name="l00413"></a>00413       <span class="comment">// that touches no column.</span>
<a name="l00414"></a>00414       *first_col = col_index;
<a name="l00415"></a>00415       <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac7729e02ee4765d7612a0ec045681512">ColumnContains</a>(right, y)) {
<a name="l00416"></a>00416         <span class="comment">// Both within a single column.</span>
<a name="l00417"></a>00417         *last_col = col_index;
<a name="l00418"></a>00418         <span class="keywordflow">return</span> <a class="code" href="namespacetesseract.html#a1c442f32007891bd4ea6e885b34cc06aa53dd9af51c333b786fe51bd5f01543d6">CST_FLOWING</a>;
<a name="l00419"></a>00419       }
<a name="l00420"></a>00420       <span class="keywordflow">if</span> (left_margin &lt;= part-&gt;LeftAtY(y)) {
<a name="l00421"></a>00421         <span class="comment">// It completely spans this column.</span>
<a name="l00422"></a>00422         *first_spanned_col = col_index;
<a name="l00423"></a>00423         margin_columns = 1;
<a name="l00424"></a>00424       }
<a name="l00425"></a>00425     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac7729e02ee4765d7612a0ec045681512">ColumnContains</a>(right, y)) {
<a name="l00426"></a>00426       <span class="keywordflow">if</span> (*first_col &lt; 0) {
<a name="l00427"></a>00427         <span class="comment">// It started in-between.</span>
<a name="l00428"></a>00428         *first_col = col_index - 1;
<a name="l00429"></a>00429       }
<a name="l00430"></a>00430       <span class="keywordflow">if</span> (right_margin &gt;= part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3731935e70135384e25904d65c0ca8f7">RightAtY</a>(y)) {
<a name="l00431"></a>00431         <span class="comment">// It completely spans this column.</span>
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (margin_columns == 0)
<a name="l00433"></a>00433           *first_spanned_col = col_index;
<a name="l00434"></a>00434         ++margin_columns;
<a name="l00435"></a>00435       }
<a name="l00436"></a>00436       *last_col = col_index;
<a name="l00437"></a>00437       <span class="keywordflow">break</span>;
<a name="l00438"></a>00438     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (left &lt; part-&gt;LeftAtY(y) &amp;&amp; right &gt; part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a3731935e70135384e25904d65c0ca8f7">RightAtY</a>(y)) {
<a name="l00439"></a>00439       <span class="comment">// Neither left nor right are contained within, so it spans this</span>
<a name="l00440"></a>00440       <span class="comment">// column.</span>
<a name="l00441"></a>00441       <span class="keywordflow">if</span> (*first_col &lt; 0) {
<a name="l00442"></a>00442         <span class="comment">// It started in between the previous column and the current column.</span>
<a name="l00443"></a>00443         *first_col = col_index - 1;
<a name="l00444"></a>00444       }
<a name="l00445"></a>00445       <span class="keywordflow">if</span> (margin_columns == 0)
<a name="l00446"></a>00446         *first_spanned_col = col_index;
<a name="l00447"></a>00447       *last_col = col_index;
<a name="l00448"></a>00448     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (right &lt; part-&gt;LeftAtY(y)) {
<a name="l00449"></a>00449       <span class="comment">// We have gone past the end.</span>
<a name="l00450"></a>00450       *last_col = col_index - 1;
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (*first_col &lt; 0) {
<a name="l00452"></a>00452         <span class="comment">// It must lie completely between columns =&gt;noise.</span>
<a name="l00453"></a>00453         *first_col = col_index - 1;
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455       <span class="keywordflow">break</span>;
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458   <span class="keywordflow">if</span> (*first_col &lt; 0)
<a name="l00459"></a>00459     *first_col = col_index - 1;  <span class="comment">// The last in-between.</span>
<a name="l00460"></a>00460   <span class="keywordflow">if</span> (*last_col &lt; 0)
<a name="l00461"></a>00461     *last_col = col_index - 1;  <span class="comment">// The last in-between.</span>
<a name="l00462"></a>00462   <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(*first_col &gt;= 0 &amp;&amp; *last_col &gt;= 0);
<a name="l00463"></a>00463   <a class="code" href="errcode_8h.html#a93a603f4063a6b9403d81caa245a583b">ASSERT_HOST</a>(*first_col &lt;= *last_col);
<a name="l00464"></a>00464   <span class="keywordflow">if</span> (*first_col == *last_col &amp;&amp; right - left &lt; <a class="code" href="namespacetesseract.html#aa5d3fda875a0c1990a5e99213d6dc942">kMinColumnWidth</a> * resolution) {
<a name="l00465"></a>00465     <span class="comment">// Neither end was in a column, and it didn&#39;t span any, so it lies</span>
<a name="l00466"></a>00466     <span class="comment">// entirely between columns, therefore noise.</span>
<a name="l00467"></a>00467     <span class="keywordflow">return</span> <a class="code" href="namespacetesseract.html#a1c442f32007891bd4ea6e885b34cc06aad17bb659c6735f37306a6161f4013416">CST_NOISE</a>;
<a name="l00468"></a>00468   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (margin_columns &lt;= 1) {
<a name="l00469"></a>00469     <span class="comment">// An exception for headings that stick outside of single-column text.</span>
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (margin_columns == 1 &amp;&amp; parts_.singleton()) {
<a name="l00471"></a>00471       <span class="keywordflow">return</span> <a class="code" href="namespacetesseract.html#a1c442f32007891bd4ea6e885b34cc06aacf3616b52ca15a43ddfd40b9c91c9cd5">CST_HEADING</a>;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="comment">// It is a pullout, as left and right were not in the same column, but</span>
<a name="l00474"></a>00474     <span class="comment">// it doesn&#39;t go to the edge of its start and end.</span>
<a name="l00475"></a>00475     <span class="keywordflow">return</span> <a class="code" href="namespacetesseract.html#a1c442f32007891bd4ea6e885b34cc06aa8c1a2f43d95cbf09416204e1f5e04163">CST_PULLOUT</a>;
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477   <span class="comment">// Its margins went to the edges of first and last columns =&gt; heading.</span>
<a name="l00478"></a>00478   <span class="keywordflow">return</span> <a class="code" href="namespacetesseract.html#a1c442f32007891bd4ea6e885b34cc06aacf3616b52ca15a43ddfd40b9c91c9cd5">CST_HEADING</a>;
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="comment">// The column_set has changed. Close down all in-progress WorkingPartSets in</span>
<a name="l00482"></a>00482 <span class="comment">// columns that do not match and start new ones for the new columns in this.</span>
<a name="l00483"></a>00483 <span class="comment">// As ColPartitions are turned into BLOCKs, the used ones are put in</span>
<a name="l00484"></a>00484 <span class="comment">// used_parts, as they still need to be referenced in the grid.</span>
<a name="l00485"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a77f3363ca10aa193d51e1f8f45ceb41e">00485</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a77f3363ca10aa193d51e1f8f45ceb41e">ColPartitionSet::ChangeWorkColumns</a>(<span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; bleft,
<a name="l00486"></a>00486                                         <span class="keyword">const</span> <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>&amp; tright,
<a name="l00487"></a>00487                                         <span class="keywordtype">int</span> resolution,
<a name="l00488"></a>00488                                         ColPartition_LIST* used_parts,
<a name="l00489"></a>00489                                         WorkingPartSet_LIST* working_set_list) {
<a name="l00490"></a>00490   <span class="comment">// Move the input list to a temporary location so we can delete its elements</span>
<a name="l00491"></a>00491   <span class="comment">// as we add them to the output working_set.</span>
<a name="l00492"></a>00492   WorkingPartSet_LIST work_src;
<a name="l00493"></a>00493   WorkingPartSet_IT src_it(&amp;work_src);
<a name="l00494"></a>00494   src_it.add_list_after(working_set_list);
<a name="l00495"></a>00495   src_it.move_to_first();
<a name="l00496"></a>00496   WorkingPartSet_IT dest_it(working_set_list);
<a name="l00497"></a>00497   <span class="comment">// Completed blocks and to_blocks are accumulated and given to the first new</span>
<a name="l00498"></a>00498   <span class="comment">// one  whenever we keep a column, or at the end.</span>
<a name="l00499"></a>00499   BLOCK_LIST completed_blocks;
<a name="l00500"></a>00500   TO_BLOCK_LIST to_blocks;
<a name="l00501"></a>00501   <a class="code" href="classtesseract_1_1_working_part_set.html">WorkingPartSet</a>* first_new_set = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00502"></a>00502   <a class="code" href="classtesseract_1_1_working_part_set.html">WorkingPartSet</a>* working_set = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00503"></a>00503   ColPartition_IT col_it(&amp;parts_);
<a name="l00504"></a>00504   <span class="keywordflow">for</span> (col_it.mark_cycle_pt(); !col_it.cycled_list(); col_it.forward()) {
<a name="l00505"></a>00505     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* column = col_it.data();
<a name="l00506"></a>00506     <span class="comment">// Any existing column to the left of column is completed.</span>
<a name="l00507"></a>00507     <span class="keywordflow">while</span> (!src_it.empty() &amp;&amp;
<a name="l00508"></a>00508            ((working_set = src_it.data())-&gt;column() == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> ||
<a name="l00509"></a>00509             working_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#ab0ea1a567feaf0f69bb350724e6a78a0">column</a>()-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>() &lt;= column-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>())) {
<a name="l00510"></a>00510       src_it.extract();
<a name="l00511"></a>00511       working_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#aa7b37ef0a112ab667c351e3a7d51436d">ExtractCompletedBlocks</a>(bleft, tright, resolution,
<a name="l00512"></a>00512                                           used_parts, &amp;completed_blocks,
<a name="l00513"></a>00513                                           &amp;to_blocks);
<a name="l00514"></a>00514       <span class="keyword">delete</span> working_set;
<a name="l00515"></a>00515       src_it.forward();
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     <span class="comment">// Make a new between-column WorkingSet for before the current column.</span>
<a name="l00518"></a>00518     working_set = <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_working_part_set.html">WorkingPartSet</a>(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00519"></a>00519     dest_it.add_after_then_move(working_set);
<a name="l00520"></a>00520     <span class="keywordflow">if</span> (first_new_set == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00521"></a>00521       first_new_set = working_set;
<a name="l00522"></a>00522     <span class="comment">// A matching column gets to stay, and first_new_set gets all the</span>
<a name="l00523"></a>00523     <span class="comment">// completed_sets.</span>
<a name="l00524"></a>00524     working_set = src_it.empty() ? <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : src_it.data();
<a name="l00525"></a>00525     <span class="keywordflow">if</span> (working_set != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp;
<a name="l00526"></a>00526         working_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#ab0ea1a567feaf0f69bb350724e6a78a0">column</a>()-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a75d8f8d4384f5bdb51c2c9e58f6677d3">MatchingColumns</a>(*column)) {
<a name="l00527"></a>00527       working_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#a29052afe85bbf3982f772536504b1e31">set_column</a>(column);
<a name="l00528"></a>00528       dest_it.add_after_then_move(src_it.extract());
<a name="l00529"></a>00529       src_it.forward();
<a name="l00530"></a>00530       first_new_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#ab20df443f0ff6df6f2ba83e31454433c">InsertCompletedBlocks</a>(&amp;completed_blocks, &amp;to_blocks);
<a name="l00531"></a>00531       first_new_set = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00532"></a>00532     } <span class="keywordflow">else</span> {
<a name="l00533"></a>00533       <span class="comment">// Just make a new working set for the current column.</span>
<a name="l00534"></a>00534       working_set = <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_working_part_set.html">WorkingPartSet</a>(column);
<a name="l00535"></a>00535       dest_it.add_after_then_move(working_set);
<a name="l00536"></a>00536     }
<a name="l00537"></a>00537   }
<a name="l00538"></a>00538   <span class="comment">// Complete any remaining src working sets.</span>
<a name="l00539"></a>00539   <span class="keywordflow">while</span> (!src_it.empty()) {
<a name="l00540"></a>00540     working_set = src_it.extract();
<a name="l00541"></a>00541     working_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#aa7b37ef0a112ab667c351e3a7d51436d">ExtractCompletedBlocks</a>(bleft, tright, resolution,
<a name="l00542"></a>00542                                         used_parts, &amp;completed_blocks,
<a name="l00543"></a>00543                                         &amp;to_blocks);
<a name="l00544"></a>00544     <span class="keyword">delete</span> working_set;
<a name="l00545"></a>00545     src_it.forward();
<a name="l00546"></a>00546   }
<a name="l00547"></a>00547   <span class="comment">// Make a new between-column WorkingSet for after the last column.</span>
<a name="l00548"></a>00548   working_set = <span class="keyword">new</span> <a class="code" href="classtesseract_1_1_working_part_set.html">WorkingPartSet</a>(<a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00549"></a>00549   dest_it.add_after_then_move(working_set);
<a name="l00550"></a>00550   <span class="keywordflow">if</span> (first_new_set == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00551"></a>00551     first_new_set = working_set;
<a name="l00552"></a>00552   <span class="comment">// The first_new_set now gets any accumulated completed_parts/blocks.</span>
<a name="l00553"></a>00553   first_new_set-&gt;<a class="code" href="classtesseract_1_1_working_part_set.html#ab20df443f0ff6df6f2ba83e31454433c">InsertCompletedBlocks</a>(&amp;completed_blocks, &amp;to_blocks);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="comment">// Accumulate the widths and gaps into the given variables.</span>
<a name="l00557"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a2269c86ba6ee44b5be119493e7b2246e">00557</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a2269c86ba6ee44b5be119493e7b2246e">ColPartitionSet::AccumulateColumnWidthsAndGaps</a>(<span class="keywordtype">int</span>* total_width,
<a name="l00558"></a>00558                                                     <span class="keywordtype">int</span>* width_samples,
<a name="l00559"></a>00559                                                     <span class="keywordtype">int</span>* total_gap,
<a name="l00560"></a>00560                                                     <span class="keywordtype">int</span>* gap_samples) {
<a name="l00561"></a>00561   ColPartition_IT it(&amp;parts_);
<a name="l00562"></a>00562   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00563"></a>00563     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00564"></a>00564     *total_width += part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a74b26d9aa211f39f58fe9b6c60f324eb">ColumnWidth</a>();
<a name="l00565"></a>00565     ++*width_samples;
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (!it.at_last()) {
<a name="l00567"></a>00567       <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* next_part = it.data_relative(1);
<a name="l00568"></a>00568       <span class="keywordtype">int</span> gap = part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#ac45a47a9427bf943acba1c0ae7d8ed0b">KeyWidth</a>(part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>(), next_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a05a26aa4023ea05c8d243cb66561ea89">left_key</a>());
<a name="l00569"></a>00569       *total_gap += gap;
<a name="l00570"></a>00570       ++*gap_samples;
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572   }
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="comment">// Provide debug output for this ColPartitionSet and all the ColPartitions.</span>
<a name="l00576"></a><a class="code" href="classtesseract_1_1_col_partition_set.html#a51f3aa3845b8ea00943fac4ca72e905f">00576</a> <span class="keywordtype">void</span> <a class="code" href="classtesseract_1_1_col_partition_set.html#a51f3aa3845b8ea00943fac4ca72e905f">ColPartitionSet::Print</a>() {
<a name="l00577"></a>00577   ColPartition_IT it(&amp;parts_);
<a name="l00578"></a>00578   <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Partition set of %d parts, %d good, coverage=%d+%d&quot;</span>
<a name="l00579"></a>00579           <span class="stringliteral">&quot; (%d,%d)-&gt;(%d,%d)\n&quot;</span>,
<a name="l00580"></a>00580           it.length(), good_column_count_, good_coverage_, bad_coverage_,
<a name="l00581"></a>00581           bounding_box_.<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a>(), bounding_box_.<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a>(),
<a name="l00582"></a>00582           bounding_box_.<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>(), bounding_box_.<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a>());
<a name="l00583"></a>00583   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00584"></a>00584     <a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* part = it.data();
<a name="l00585"></a>00585     part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#a156c2af1b74aa05bb4633bbde1e64c22">Print</a>();
<a name="l00586"></a>00586   }
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <span class="comment">// PRIVATE CODE.</span>
<a name="l00590"></a>00590 
<a name="l00591"></a>00591 <span class="comment">// Add the given partition to the list in the appropriate place.</span>
<a name="l00592"></a>00592 <span class="keywordtype">void</span> ColPartitionSet::AddPartition(<a class="code" href="classtesseract_1_1_col_partition.html">ColPartition</a>* new_part,
<a name="l00593"></a>00593                                    ColPartition_IT* it) {
<a name="l00594"></a>00594   AddPartitionCoverageAndBox(*new_part);
<a name="l00595"></a>00595   <span class="keywordtype">int</span> new_right = new_part-&gt;<a class="code" href="classtesseract_1_1_col_partition.html#af8dc1730e816c82cf3007943dc70a363">right_key</a>();
<a name="l00596"></a>00596   <span class="keywordflow">if</span> (it-&gt;data()-&gt;left_key() &gt;= new_right)
<a name="l00597"></a>00597     it-&gt;add_before_stay_put(new_part);
<a name="l00598"></a>00598   <span class="keywordflow">else</span>
<a name="l00599"></a>00599     it-&gt;add_after_stay_put(new_part);
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 <span class="comment">// Compute the coverage and good column count. Coverage is the amount of the</span>
<a name="l00603"></a>00603 <span class="comment">// width of the page (in pixels) that is covered by ColPartitions, which are</span>
<a name="l00604"></a>00604 <span class="comment">// used to provide candidate column layouts.</span>
<a name="l00605"></a>00605 <span class="comment">// Coverage is split into good and bad. Good coverage is provided by</span>
<a name="l00606"></a>00606 <span class="comment">// ColPartitions of a frequent width (according to the callback function</span>
<a name="l00607"></a>00607 <span class="comment">// provided by TabFinder::WidthCB, which accesses stored statistics on the</span>
<a name="l00608"></a>00608 <span class="comment">// widths of ColParititions) and bad coverage is provided by all other</span>
<a name="l00609"></a>00609 <span class="comment">// ColPartitions, even if they have tab vectors at both sides. Thus:</span>
<a name="l00610"></a>00610 <span class="comment">// |-----------------------------------------------------------------|</span>
<a name="l00611"></a>00611 <span class="comment">// |        Double     width    heading                              |</span>
<a name="l00612"></a>00612 <span class="comment">// |-----------------------------------------------------------------|</span>
<a name="l00613"></a>00613 <span class="comment">// |-------------------------------| |-------------------------------|</span>
<a name="l00614"></a>00614 <span class="comment">// |   Common width ColParition    | |  Common width ColPartition    |</span>
<a name="l00615"></a>00615 <span class="comment">// |-------------------------------| |-------------------------------|</span>
<a name="l00616"></a>00616 <span class="comment">// the layout with two common-width columns has better coverage than the</span>
<a name="l00617"></a>00617 <span class="comment">// double width heading, because the coverage is &quot;good,&quot; even though less in</span>
<a name="l00618"></a>00618 <span class="comment">// total coverage than the heading, because the heading coverage is &quot;bad.&quot;</span>
<a name="l00619"></a>00619 <span class="keywordtype">void</span> ColPartitionSet::ComputeCoverage() {
<a name="l00620"></a>00620   <span class="comment">// Count the number of good columns and sum their width.</span>
<a name="l00621"></a>00621   ColPartition_IT it(&amp;parts_);
<a name="l00622"></a>00622   good_column_count_ = 0;
<a name="l00623"></a>00623   good_coverage_ = 0;
<a name="l00624"></a>00624   bad_coverage_ = 0;
<a name="l00625"></a>00625   bounding_box_ = <a class="code" href="class_t_b_o_x.html">TBOX</a>();
<a name="l00626"></a>00626   <span class="keywordflow">for</span> (it.mark_cycle_pt(); !it.cycled_list(); it.forward()) {
<a name="l00627"></a>00627     ColPartition* part = it.data();
<a name="l00628"></a>00628     AddPartitionCoverageAndBox(*part);
<a name="l00629"></a>00629   }
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632 <span class="comment">// Adds the coverage, column count and box for a single partition,</span>
<a name="l00633"></a>00633 <span class="comment">// without adding it to the list. (Helper factored from ComputeCoverage.)</span>
<a name="l00634"></a>00634 <span class="keywordtype">void</span> ColPartitionSet::AddPartitionCoverageAndBox(<span class="keyword">const</span> ColPartition&amp; part) {
<a name="l00635"></a>00635   bounding_box_ += part.bounding_box();
<a name="l00636"></a>00636   <span class="keywordtype">int</span> coverage = part.ColumnWidth();
<a name="l00637"></a>00637   <span class="keywordflow">if</span> (part.good_width()) {
<a name="l00638"></a>00638     good_coverage_ += coverage;
<a name="l00639"></a>00639     good_column_count_ += 2;
<a name="l00640"></a>00640   } <span class="keywordflow">else</span> {
<a name="l00641"></a>00641     <span class="keywordflow">if</span> (part.blob_type() &lt; <a class="code" href="blobbox_8h.html#aebfaf711760a99b60c297d1d619df575a8a98863f18016aa4ccfd2d07dbb092a4">BRT_UNKNOWN</a>)
<a name="l00642"></a>00642       coverage /= 2;
<a name="l00643"></a>00643     <span class="keywordflow">if</span> (part.good_column())
<a name="l00644"></a>00644       ++good_column_count_;
<a name="l00645"></a>00645     bad_coverage_ += coverage;
<a name="l00646"></a>00646   }
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 }  <span class="comment">// namespace tesseract.</span>
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="colpartitionset_8cpp.html">colpartitionset.cpp</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Wed Mar 28 2012 22:38:38 for Tesseract by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
