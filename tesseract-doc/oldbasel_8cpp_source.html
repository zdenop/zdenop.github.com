<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Tesseract: tesseract-ocr/textord/oldbasel.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Tesseract
   &#160;<span id="projectnumber">3.02</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('oldbasel_8cpp.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">tesseract-ocr/textord/oldbasel.cpp</div>  </div>
</div>
<div class="contents">
<a href="oldbasel_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"> * File:        oldbasel.cpp  (Formerly oldbl.c)</span>
<a name="l00003"></a>00003 <span class="comment"> * Description: A re-implementation of the old baseline algorithm.</span>
<a name="l00004"></a>00004 <span class="comment"> * Author:              Ray Smith</span>
<a name="l00005"></a>00005 <span class="comment"> * Created:             Wed Oct  6 09:41:48 BST 1993</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * (C) Copyright 1993, Hewlett-Packard Ltd.</span>
<a name="l00008"></a>00008 <span class="comment"> ** Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00009"></a>00009 <span class="comment"> ** you may not use this file except in compliance with the License.</span>
<a name="l00010"></a>00010 <span class="comment"> ** You may obtain a copy of the License at</span>
<a name="l00011"></a>00011 <span class="comment"> ** http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00012"></a>00012 <span class="comment"> ** Unless required by applicable law or agreed to in writing, software</span>
<a name="l00013"></a>00013 <span class="comment"> ** distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00014"></a>00014 <span class="comment"> ** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00015"></a>00015 <span class="comment"> ** See the License for the specific language governing permissions and</span>
<a name="l00016"></a>00016 <span class="comment"> ** limitations under the License.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> **********************************************************************/</span>
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="mfcpch_8h.html">mfcpch.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="ccstruct_8h.html">ccstruct.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include          &quot;<a class="code" href="statistc_8h.html">statistc.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include          &quot;<a class="code" href="quadlsq_8h.html">quadlsq.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include          &quot;<a class="code" href="detlinefit_8h.html">detlinefit.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include          &quot;<a class="code" href="makerow_8h.html">makerow.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include          &quot;<a class="code" href="drawtord_8h.html">drawtord.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include          &quot;<a class="code" href="oldbasel_8h.html">oldbasel.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include          &quot;<a class="code" href="textord_8h.html">textord.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include          &quot;<a class="code" href="tprintf_8h.html">tprintf.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="comment">// Include automatically generated configuration file if running autoconf.</span>
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="config__auto_8h.html">config_auto.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#endif</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">00036</a> <span class="preprocessor">#define EXTERN</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a160e4b5a4517db072dd572847b673c9c">textord_really_old_xheight</a>, <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,
<a name="l00039"></a><a class="code" href="oldbasel_8h.html#a54ff5eddf4d0cb2635a2c7c7299d99db">00039</a> <span class="stringliteral">&quot;Use original wiseowl xheight&quot;</span>);
<a name="l00040"></a><a class="code" href="oldbasel_8h.html#a7129ef948119d5737f021bb765d0aa82">00040</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>, <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Debug old baseline generation&quot;</span>);
<a name="l00041"></a><a class="code" href="oldbasel_8h.html#a6e09dfd34d61fb64c2cb1691f862c045">00041</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a2522a1ae924de60d6448da45f785b4f8">textord_debug_baselines</a>, <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Debug baseline generation&quot;</span>);
<a name="l00042"></a><a class="code" href="oldbasel_8h.html#a5eb0ad951c39efb0a73d83bfa23eac2a">00042</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a26cc69b976618e872211e3974a7df35f">textord_oldbl_paradef</a>, <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="stringliteral">&quot;Use para default mechanism&quot;</span>);
<a name="l00043"></a><a class="code" href="oldbasel_8h.html#a5530ec9d820f9b94d63cbad396295947">00043</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a65c44b7980901c6716d6af6b5457fb55">textord_oldbl_split_splines</a>, <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="stringliteral">&quot;Split stepped splines&quot;</span>);
<a name="l00044"></a><a class="code" href="oldbasel_8h.html#ab68071363856ebe9b5cf58f5cb7420f0">00044</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#afbc9ce48742715129ec2659c3fcb5584">textord_oldbl_merge_parts</a>, <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="stringliteral">&quot;Merge suspect partitions&quot;</span>);
<a name="l00045"></a><a class="code" href="oldbasel_8cpp.html#a4ac15a4b1008410caf408f3e7d71617b">00045</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a4ac15a4b1008410caf408f3e7d71617b">oldbl_corrfix</a>, <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <span class="stringliteral">&quot;Improve correlation of heights&quot;</span>);
<a name="l00046"></a>00046 <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a96a1495ef629e0595833f43d1e0d8edd">oldbl_xhfix</a>, <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,
<a name="l00047"></a><a class="code" href="oldbasel_8h.html#a9fc3daf2147be858c4418c167686e071">00047</a> <span class="stringliteral">&quot;Fix bug in modes threshold for xheights&quot;</span>);
<a name="l00048"></a><a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">00048</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a442e7f541a050acf5ebda026db177877">BOOL_VAR</a>(<a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">textord_ocropus_mode</a>, <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <span class="stringliteral">&quot;Make baselines for ocropus&quot;</span>);
<a name="l00049"></a><a class="code" href="oldbasel_8cpp.html#a9af9cfbc0c19dbe46551c127ed70e6e4">00049</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#aa855c84dbbf962a5533a96e1f458c690">double_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a9af9cfbc0c19dbe46551c127ed70e6e4">oldbl_xhfract</a>, 0.4, <span class="stringliteral">&quot;Fraction of est allowed in calc&quot;</span>);
<a name="l00050"></a>00050 <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#a554d43d0cf0e3f9552921941d9e147bd">INT_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a74b5ea2ca513022fc65ac2d68d1179fd">oldbl_holed_losscount</a>, 10,
<a name="l00051"></a><a class="code" href="oldbasel_8h.html#afcad344b6fffd4c1d5eae47cb9d39acb">00051</a> <span class="stringliteral">&quot;Max lost before fallback line used&quot;</span>);
<a name="l00052"></a><a class="code" href="oldbasel_8h.html#a9a9cff55a1fcb4db1633b520082aae08">00052</a> <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#aa855c84dbbf962a5533a96e1f458c690">double_VAR</a> (<a class="code" href="oldbasel_8cpp.html#a1c777e24551f3606e42efe3bdb71d56c">oldbl_dot_error_size</a>, 1.26, <span class="stringliteral">&quot;Max aspect ratio of a dot&quot;</span>);
<a name="l00053"></a>00053 <a class="code" href="oldbasel_8cpp.html#a77366c1bd428629dc898e188bfd182a3">EXTERN</a> <a class="code" href="params_8h.html#aa855c84dbbf962a5533a96e1f458c690">double_VAR</a> (<a class="code" href="oldbasel_8cpp.html#aa0ab27b57cde2ce0d3e4c7c269ae58f8">textord_oldbl_jumplimit</a>, 0.15,
<a name="l00054"></a><a class="code" href="oldbasel_8h.html#a1bde55c5bf88027bf4efa2c429a41514">00054</a> <span class="stringliteral">&quot;X fraction for new partition&quot;</span>);
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="oldbasel_8cpp.html#a740201e7bcfb78e2fe8a8674096d13fe">00056</a> <span class="preprocessor">#define TURNLIMIT          1     </span><span class="comment">/*min size for turning point */</span>
<a name="l00057"></a><a class="code" href="oldbasel_8cpp.html#a69d365e20fc65dc84fb7426c5d20fdaf">00057</a> <span class="preprocessor">#define X_HEIGHT_FRACTION  0.7   </span><span class="comment">/*x-height/caps height */</span>
<a name="l00058"></a><a class="code" href="oldbasel_8cpp.html#a636b5d65e6e76c9ed9c87d72e5b743da">00058</a> <span class="preprocessor">#define DESCENDER_FRACTION 0.5   </span><span class="comment">/*descender/x-height */</span>
<a name="l00059"></a><a class="code" href="oldbasel_8cpp.html#adafb7e3ebb2a384efa0f5a1b40476a63">00059</a> <span class="preprocessor">#define MIN_ASC_FRACTION   0.20  </span><span class="comment">/*min size of ascenders */</span>
<a name="l00060"></a><a class="code" href="oldbasel_8cpp.html#ab10df8c6f46b62530ddf3d39eada5cbf">00060</a> <span class="preprocessor">#define MIN_DESC_FRACTION  0.25  </span><span class="comment">/*min size of descenders */</span>
<a name="l00061"></a><a class="code" href="oldbasel_8cpp.html#ae325902750f29296b4fb7ae22ecbb3dd">00061</a> <span class="preprocessor">#define MINASCRISE         2.0   </span><span class="comment">/*min ascender/desc step */</span>
<a name="l00062"></a><a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">00062</a> <span class="preprocessor">#define MAXHEIGHTVARIANCE  0.15  </span><span class="comment">/*accepted variation in x-height */</span>
<a name="l00063"></a><a class="code" href="oldbasel_8cpp.html#ade1da022379102bc94d127f9c6358fe7">00063</a> <span class="preprocessor">#define MAXHEIGHT          300   </span><span class="comment">/*max blob height */</span>
<a name="l00064"></a><a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">00064</a> <span class="preprocessor">#define MAXOVERLAP         0.1   </span><span class="comment">/*max 10% missed overlap */</span>
<a name="l00065"></a><a class="code" href="oldbasel_8cpp.html#a058e03b643cfba9a6b7899b9a91f9bcb">00065</a> <span class="preprocessor">#define MAXBADRUN          2     </span><span class="comment">/*max non best for failed */</span>
<a name="l00066"></a><a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">00066</a> <span class="preprocessor">#define HEIGHTBUCKETS      200   </span><span class="comment">/* Num of buckets */</span>
<a name="l00067"></a><a class="code" href="oldbasel_8cpp.html#a23ca4a264fba12e846d074b48bc37fc2">00067</a> <span class="preprocessor">#define DELTAHEIGHT        5.0   </span><span class="comment">/* Small amount of diff */</span>
<a name="l00068"></a><a class="code" href="oldbasel_8cpp.html#a7cfa5dee1fc7046cb35913d0d4f7a989">00068</a> <span class="preprocessor">#define GOODHEIGHT         5</span>
<a name="l00069"></a><a class="code" href="oldbasel_8cpp.html#a1f977147000cd8a40ccfacafea826a8e">00069</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXLOOPS           10</span>
<a name="l00070"></a><a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define MODENUM            10</span>
<a name="l00071"></a><a class="code" href="oldbasel_8cpp.html#a43c12716e71c3b49f1907bd935376e43">00071</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXPARTS      6</span>
<a name="l00072"></a><a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define SPLINESIZE      23</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">00074</a> <span class="preprocessor">#define ABS(x) ((x)&lt;0 ? (-(x)) : (x))</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>
<a name="l00076"></a>00076 <span class="keyword">namespace </span>tesseract {
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="comment">/**********************************************************************</span>
<a name="l00079"></a>00079 <span class="comment"> * make_old_baselines</span>
<a name="l00080"></a>00080 <span class="comment"> *</span>
<a name="l00081"></a>00081 <span class="comment"> * Top level function to make baselines the old way.</span>
<a name="l00082"></a>00082 <span class="comment"> **********************************************************************/</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 <span class="keywordtype">void</span> Textord::make_old_baselines(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a> *block,   <span class="comment">// block to do</span>
<a name="l00085"></a>00085                                  <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> testing_on,  <span class="comment">// correct orientation</span>
<a name="l00086"></a>00086                                  <span class="keywordtype">float</span> gradient) {
<a name="l00087"></a>00087   <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> *prev_baseline;        <span class="comment">// baseline of previous row</span>
<a name="l00088"></a>00088   <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> *row;                   <span class="comment">// current row</span>
<a name="l00089"></a>00089   TO_ROW_IT row_it = block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4846ebdcc832b4b0a762d87c0d83a056">get_rows</a>();
<a name="l00090"></a>00090   BLOBNBOX_IT blob_it;
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   prev_baseline = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;          <span class="comment">// nothing yet</span>
<a name="l00093"></a>00093   <span class="keywordflow">for</span> (row_it.mark_cycle_pt(); !row_it.cycled_list(); row_it.forward()) {
<a name="l00094"></a>00094     row = row_it.data();
<a name="l00095"></a>00095     find_textlines(block, row, 2, <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00096"></a>00096     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt;= 0 &amp;&amp; prev_baseline != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00097"></a>00097       find_textlines(block, row, 2, prev_baseline);
<a name="l00098"></a>00098     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &gt; 0) {  <span class="comment">// was a good one</span>
<a name="l00099"></a>00099       prev_baseline = &amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>;
<a name="l00100"></a>00100     } <span class="keywordflow">else</span> {
<a name="l00101"></a>00101       prev_baseline = <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00102"></a>00102       blob_it.set_to_list(row-&gt;<a class="code" href="class_t_o___r_o_w.html#a39cee94572e70d35179c27cdf21a3022">blob_list</a>());
<a name="l00103"></a>00103       <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a2522a1ae924de60d6448da45f785b4f8">textord_debug_baselines</a>)
<a name="l00104"></a>00104         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>(<span class="stringliteral">&quot;Row baseline generation failed on row at (%d,%d)\n&quot;</span>,
<a name="l00105"></a>00105           blob_it.data()-&gt;bounding_box().left(),
<a name="l00106"></a>00106           blob_it.data()-&gt;bounding_box().bottom());
<a name="l00107"></a>00107     }
<a name="l00108"></a>00108   }
<a name="l00109"></a>00109   correlate_lines(block, gradient);
<a name="l00110"></a>00110   block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a16e698664028b0d6d2193db64560c16b">block</a>-&gt;<a class="code" href="class_b_l_o_c_k.html#a761f9b58bfeef6d485001b707fb9939b" title="set char size">set_xheight</a>(block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a>);
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 <span class="comment">/**********************************************************************</span>
<a name="l00115"></a>00115 <span class="comment"> * correlate_lines</span>
<a name="l00116"></a>00116 <span class="comment"> *</span>
<a name="l00117"></a>00117 <span class="comment"> * Correlate the x-heights and ascender heights of a block to fill-in</span>
<a name="l00118"></a>00118 <span class="comment"> * the ascender height and descender height for rows without one.</span>
<a name="l00119"></a>00119 <span class="comment"> * Also fix baselines of rows without a decent fit.</span>
<a name="l00120"></a>00120 <span class="comment"> **********************************************************************/</span>
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keywordtype">void</span> Textord::correlate_lines(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a> *block, <span class="keywordtype">float</span> gradient) {
<a name="l00123"></a>00123   <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> **rows;                 <span class="comment">//array of ptrs</span>
<a name="l00124"></a>00124   <span class="keywordtype">int</span> rowcount;                  <span class="comment">/*no of rows to do */</span>
<a name="l00125"></a>00125   <span class="keyword">register</span> <span class="keywordtype">int</span> rowindex;         <span class="comment">/*no of row */</span>
<a name="l00126"></a>00126                                  <span class="comment">//iterator</span>
<a name="l00127"></a>00127   TO_ROW_IT row_it = block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4846ebdcc832b4b0a762d87c0d83a056">get_rows</a> ();
<a name="l00128"></a>00128 
<a name="l00129"></a>00129   rowcount = row_it.length ();
<a name="l00130"></a>00130   <span class="keywordflow">if</span> (rowcount == 0) {
<a name="l00131"></a>00131                                  <span class="comment">//default value</span>
<a name="l00132"></a>00132     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a> = block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a>;
<a name="l00133"></a>00133     <span class="keywordflow">return</span>;                      <span class="comment">/*none to do */</span>
<a name="l00134"></a>00134   }
<a name="l00135"></a>00135   rows = (<a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> **) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (rowcount * <span class="keyword">sizeof</span> (<a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> *));
<a name="l00136"></a>00136   rowindex = 0;
<a name="l00137"></a>00137   <span class="keywordflow">for</span> (row_it.mark_cycle_pt (); !row_it.cycled_list (); row_it.forward ())
<a name="l00138"></a>00138                                  <span class="comment">//make array</span>
<a name="l00139"></a>00139     rows[rowindex++] = row_it.data ();
<a name="l00140"></a>00140 
<a name="l00141"></a>00141                                  <span class="comment">/*try to fix bad lines */</span>
<a name="l00142"></a>00142   correlate_neighbours(block, rows, rowcount);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a160e4b5a4517db072dd572847b673c9c">textord_really_old_xheight</a> || <a class="code" href="makerow_8cpp.html#a7718429051854813a160987de497731c">textord_old_xheight</a>) {
<a name="l00145"></a>00145     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a> = (float) correlate_with_stats(rows, rowcount, block);
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a> &lt;= 0)
<a name="l00147"></a>00147       block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a> = block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a> * <a class="code" href="classtesseract_1_1_c_c_struct.html#a737fdb37b9401ad3d04371c1bd4a0b17">tesseract::CCStruct::kXHeightFraction</a>;
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a> &lt; <a class="code" href="makerow_8cpp.html#a995fba1cadc1bb12bd1861d2e1d4bf4a">textord_min_xheight</a>)
<a name="l00149"></a>00149       block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a4d0f99a557a4950af5123a31a157749f">xheight</a> = (float) <a class="code" href="makerow_8cpp.html#a995fba1cadc1bb12bd1861d2e1d4bf4a">textord_min_xheight</a>;
<a name="l00150"></a>00150   } <span class="keywordflow">else</span> {
<a name="l00151"></a>00151     compute_block_xheight(block, gradient);
<a name="l00152"></a>00152   }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(rows);
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">/**********************************************************************</span>
<a name="l00159"></a>00159 <span class="comment"> * correlate_neighbours</span>
<a name="l00160"></a>00160 <span class="comment"> *</span>
<a name="l00161"></a>00161 <span class="comment"> * Try to fix rows that had a bad spline fit by using neighbours.</span>
<a name="l00162"></a>00162 <span class="comment"> **********************************************************************/</span>
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="keywordtype">void</span> Textord::correlate_neighbours(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a> *block,  <span class="comment">// block rows are in.</span>
<a name="l00165"></a>00165                                    <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> **rows,    <span class="comment">// rows of block.</span>
<a name="l00166"></a>00166                                    <span class="keywordtype">int</span> rowcount) {   <span class="comment">// no of rows to do.</span>
<a name="l00167"></a>00167   <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> *row;                   <span class="comment">/*current row */</span>
<a name="l00168"></a>00168   <span class="keyword">register</span> <span class="keywordtype">int</span> rowindex;         <span class="comment">/*no of row */</span>
<a name="l00169"></a>00169   <span class="keyword">register</span> <span class="keywordtype">int</span> otherrow;         <span class="comment">/*second row */</span>
<a name="l00170"></a>00170   <span class="keywordtype">int</span> upperrow;                  <span class="comment">/*row above to use */</span>
<a name="l00171"></a>00171   <span class="keywordtype">int</span> lowerrow;                  <span class="comment">/*row below to use */</span>
<a name="l00172"></a>00172   <span class="keywordtype">float</span> biggest;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   <span class="keywordflow">for</span> (rowindex = 0; rowindex &lt; rowcount; rowindex++) {
<a name="l00175"></a>00175     row = rows[rowindex];        <span class="comment">/*current row */</span>
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0) {
<a name="l00177"></a>00177                                  <span class="comment">/*quadratic failed */</span>
<a name="l00178"></a>00178       <span class="keywordflow">for</span> (otherrow = rowindex - 2;
<a name="l00179"></a>00179         otherrow &gt;= 0
<a name="l00180"></a>00180         &amp;&amp; (rows[otherrow]-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0.0
<a name="l00181"></a>00181         || !row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>.<a class="code" href="class_q_s_p_l_i_n_e.html#af5a1e056b6b5c0348b640b5eaa987184">overlap</a> (&amp;rows[otherrow]-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,
<a name="l00182"></a>00182         <a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">MAXOVERLAP</a>)); otherrow--);
<a name="l00183"></a>00183       upperrow = otherrow;       <span class="comment">/*decent row above */</span>
<a name="l00184"></a>00184       <span class="keywordflow">for</span> (otherrow = rowindex + 1;
<a name="l00185"></a>00185         otherrow &lt; rowcount
<a name="l00186"></a>00186         &amp;&amp; (rows[otherrow]-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0.0
<a name="l00187"></a>00187         || !row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>.<a class="code" href="class_q_s_p_l_i_n_e.html#af5a1e056b6b5c0348b640b5eaa987184">overlap</a> (&amp;rows[otherrow]-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,
<a name="l00188"></a>00188         <a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">MAXOVERLAP</a>)); otherrow++);
<a name="l00189"></a>00189       lowerrow = otherrow;       <span class="comment">/*decent row below */</span>
<a name="l00190"></a>00190       <span class="keywordflow">if</span> (upperrow &gt;= 0)
<a name="l00191"></a>00191         find_textlines(block, row, 2, &amp;rows[upperrow]-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>);
<a name="l00192"></a>00192       <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0 &amp;&amp; lowerrow &lt; rowcount)
<a name="l00193"></a>00193         find_textlines(block, row, 2, &amp;rows[lowerrow]-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>);
<a name="l00194"></a>00194       <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0) {
<a name="l00195"></a>00195         <span class="keywordflow">if</span> (upperrow &gt;= 0)
<a name="l00196"></a>00196           find_textlines(block, row, 1, &amp;rows[upperrow]-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>);
<a name="l00197"></a>00197         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lowerrow &lt; rowcount)
<a name="l00198"></a>00198           find_textlines(block, row, 1, &amp;rows[lowerrow]-&gt;<a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>);
<a name="l00199"></a>00199       }
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201   }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   <span class="keywordflow">for</span> (biggest = 0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>, rowindex = 0; rowindex &lt; rowcount; rowindex++) {
<a name="l00204"></a>00204     row = rows[rowindex];        <span class="comment">/*current row */</span>
<a name="l00205"></a>00205     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0)        <span class="comment">/*linear failed */</span>
<a name="l00206"></a>00206                                  <span class="comment">/*make do */</span>
<a name="l00207"></a>00207         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = -row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>;
<a name="l00208"></a>00208     biggest = <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a> (biggest, row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>);
<a name="l00209"></a>00209   }
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment">/**********************************************************************</span>
<a name="l00214"></a>00214 <span class="comment"> * correlate_with_stats</span>
<a name="l00215"></a>00215 <span class="comment"> *</span>
<a name="l00216"></a>00216 <span class="comment"> * correlate the x-heights and ascender heights of a block to fill-in</span>
<a name="l00217"></a>00217 <span class="comment"> * the ascender height and descender height for rows without one.</span>
<a name="l00218"></a>00218 <span class="comment"> **********************************************************************/</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="keywordtype">int</span> Textord::correlate_with_stats(<a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> **rows,  <span class="comment">// rows of block.</span>
<a name="l00221"></a>00221                                   <span class="keywordtype">int</span> rowcount,   <span class="comment">// no of rows to do.</span>
<a name="l00222"></a>00222                                   <a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a>* block) {
<a name="l00223"></a>00223   <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> *row;                   <span class="comment">/*current row */</span>
<a name="l00224"></a>00224   <span class="keyword">register</span> <span class="keywordtype">int</span> rowindex;         <span class="comment">/*no of row */</span>
<a name="l00225"></a>00225   <span class="keywordtype">float</span> lineheight;              <span class="comment">/*mean x-height */</span>
<a name="l00226"></a>00226   <span class="keywordtype">float</span> ascheight;               <span class="comment">/*average ascenders */</span>
<a name="l00227"></a>00227   <span class="keywordtype">float</span> minascheight;            <span class="comment">/*min allowed ascheight */</span>
<a name="l00228"></a>00228   <span class="keywordtype">int</span> xcount;                    <span class="comment">/*no of samples for xheight */</span>
<a name="l00229"></a>00229   <span class="keywordtype">float</span> fullheight;              <span class="comment">/*mean top height */</span>
<a name="l00230"></a>00230   <span class="keywordtype">int</span> fullcount;                 <span class="comment">/*no of samples */</span>
<a name="l00231"></a>00231   <span class="keywordtype">float</span> descheight;              <span class="comment">/*mean descender drop */</span>
<a name="l00232"></a>00232   <span class="keywordtype">float</span> mindescheight;           <span class="comment">/*min allowed descheight */</span>
<a name="l00233"></a>00233   <span class="keywordtype">int</span> desccount;                 <span class="comment">/*no of samples */</span>
<a name="l00234"></a>00234   <span class="keywordtype">float</span> xshift;                  <span class="comment">/*shift in xheight */</span>
<a name="l00235"></a>00235 
<a name="l00236"></a>00236                                  <span class="comment">/*no samples */</span>
<a name="l00237"></a>00237   xcount = fullcount = desccount = 0;
<a name="l00238"></a>00238   lineheight = ascheight = fullheight = descheight = 0.0;
<a name="l00239"></a>00239   <span class="keywordflow">for</span> (rowindex = 0; rowindex &lt; rowcount; rowindex++) {
<a name="l00240"></a>00240     row = rows[rowindex];        <span class="comment">/*current row */</span>
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> &gt; 0.0) {    <span class="comment">/*got ascenders? */</span>
<a name="l00242"></a>00242       lineheight += row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>;<span class="comment">/*average x-heights */</span>
<a name="l00243"></a>00243       ascheight += row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a>; <span class="comment">/*average ascenders */</span>
<a name="l00244"></a>00244       xcount++;
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246     <span class="keywordflow">else</span> {
<a name="l00247"></a>00247       fullheight += row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>;<span class="comment">/*assume full height */</span>
<a name="l00248"></a>00248       fullcount++;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a> &lt; 0.0) {   <span class="comment">/*got descenders? */</span>
<a name="l00251"></a>00251                                  <span class="comment">/*average descenders */</span>
<a name="l00252"></a>00252       descheight += row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a>;
<a name="l00253"></a>00253       desccount++;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255   }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257   <span class="keywordflow">if</span> (xcount &gt; 0 &amp;&amp; (!<a class="code" href="oldbasel_8cpp.html#a4ac15a4b1008410caf408f3e7d71617b">oldbl_corrfix</a> || xcount &gt;= fullcount)) {
<a name="l00258"></a>00258     lineheight /= xcount;        <span class="comment">/*average x-height */</span>
<a name="l00259"></a>00259                                  <span class="comment">/*average caps height */</span>
<a name="l00260"></a>00260     fullheight = lineheight + ascheight / xcount;
<a name="l00261"></a>00261                                  <span class="comment">/*must be decent size */</span>
<a name="l00262"></a>00262     <span class="keywordflow">if</span> (fullheight &lt; lineheight * (1 + <a class="code" href="oldbasel_8cpp.html#adafb7e3ebb2a384efa0f5a1b40476a63">MIN_ASC_FRACTION</a>))
<a name="l00263"></a>00263       fullheight = lineheight * (1 + <a class="code" href="oldbasel_8cpp.html#adafb7e3ebb2a384efa0f5a1b40476a63">MIN_ASC_FRACTION</a>);
<a name="l00264"></a>00264   }
<a name="l00265"></a>00265   <span class="keywordflow">else</span> {
<a name="l00266"></a>00266     fullheight /= fullcount;     <span class="comment">/*average max height */</span>
<a name="l00267"></a>00267                                  <span class="comment">/*guess x-height */</span>
<a name="l00268"></a>00268     lineheight = fullheight * <a class="code" href="oldbasel_8cpp.html#a69d365e20fc65dc84fb7426c5d20fdaf">X_HEIGHT_FRACTION</a>;
<a name="l00269"></a>00269   }
<a name="l00270"></a>00270   <span class="keywordflow">if</span> (desccount &gt; 0 &amp;&amp; (!<a class="code" href="oldbasel_8cpp.html#a4ac15a4b1008410caf408f3e7d71617b">oldbl_corrfix</a> || desccount &gt;= rowcount / 2))
<a name="l00271"></a>00271     descheight /= desccount;     <span class="comment">/*average descenders */</span>
<a name="l00272"></a>00272   <span class="keywordflow">else</span>
<a name="l00273"></a>00273                                  <span class="comment">/*guess descenders */</span>
<a name="l00274"></a>00274     descheight = -lineheight * <a class="code" href="oldbasel_8cpp.html#a636b5d65e6e76c9ed9c87d72e5b743da">DESCENDER_FRACTION</a>;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276   <span class="keywordflow">if</span> (lineheight &gt; 0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>)
<a name="l00277"></a>00277     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a16e698664028b0d6d2193db64560c16b">block</a>-&gt;<a class="code" href="class_b_l_o_c_k.html#aa35e87420154d9fd935a2df0610b7ab4">set_cell_over_xheight</a>((fullheight - descheight) / lineheight);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   minascheight = lineheight * <a class="code" href="oldbasel_8cpp.html#adafb7e3ebb2a384efa0f5a1b40476a63">MIN_ASC_FRACTION</a>;
<a name="l00280"></a>00280   mindescheight = -lineheight * <a class="code" href="oldbasel_8cpp.html#ab10df8c6f46b62530ddf3d39eada5cbf">MIN_DESC_FRACTION</a>;
<a name="l00281"></a>00281   <span class="keywordflow">for</span> (rowindex = 0; rowindex &lt; rowcount; rowindex++) {
<a name="l00282"></a>00282     row = rows[rowindex];        <span class="comment">/*do each row */</span>
<a name="l00283"></a>00283     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a28ff791a1040472676085babab439e43">all_caps</a> = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00284"></a>00284     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> / row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; MIN_ASC_FRACTION) {
<a name="l00285"></a>00285     <span class="comment">/*no ascenders */</span>
<a name="l00286"></a>00286       <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &gt;= lineheight * (1 - <a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">MAXHEIGHTVARIANCE</a>)
<a name="l00287"></a>00287       &amp;&amp; row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt;= lineheight * (1 + <a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">MAXHEIGHTVARIANCE</a>)) {
<a name="l00288"></a>00288         row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = fullheight - lineheight;
<a name="l00289"></a>00289                                  <span class="comment">/*shift in x */</span>
<a name="l00290"></a>00290         xshift = lineheight - row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>;
<a name="l00291"></a>00291                                  <span class="comment">/*set to average */</span>
<a name="l00292"></a>00292         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = lineheight;
<a name="l00293"></a>00293 
<a name="l00294"></a>00294       }
<a name="l00295"></a>00295       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &gt;= fullheight * (1 - <a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">MAXHEIGHTVARIANCE</a>)
<a name="l00296"></a>00296       &amp;&amp; row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt;= fullheight * (1 + <a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">MAXHEIGHTVARIANCE</a>)) {
<a name="l00297"></a>00297         row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> - lineheight;
<a name="l00298"></a>00298         xshift = -row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a>;  <span class="comment">/*shift in x */</span>
<a name="l00299"></a>00299                                  <span class="comment">/*set to average */</span>
<a name="l00300"></a>00300         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = lineheight;
<a name="l00301"></a>00301         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a28ff791a1040472676085babab439e43">all_caps</a> = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00302"></a>00302       }
<a name="l00303"></a>00303       <span class="keywordflow">else</span> {
<a name="l00304"></a>00304         row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = (fullheight - lineheight) * row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>
<a name="l00305"></a>00305           / fullheight;
<a name="l00306"></a>00306         xshift = -row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a>;  <span class="comment">/*shift in x */</span>
<a name="l00307"></a>00307                                  <span class="comment">/*scale it */</span>
<a name="l00308"></a>00308         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> -= row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a>;
<a name="l00309"></a>00309         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a28ff791a1040472676085babab439e43">all_caps</a> = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00310"></a>00310       }
<a name="l00311"></a>00311       <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> &lt; minascheight)
<a name="l00312"></a>00312         row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> =
<a name="l00313"></a>00313           row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> * ((1.0 - <a class="code" href="oldbasel_8cpp.html#a69d365e20fc65dc84fb7426c5d20fdaf">X_HEIGHT_FRACTION</a>) / <a class="code" href="oldbasel_8cpp.html#a69d365e20fc65dc84fb7426c5d20fdaf">X_HEIGHT_FRACTION</a>);
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a> &gt; mindescheight) {
<a name="l00316"></a>00316       <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &gt;= lineheight * (1 - <a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">MAXHEIGHTVARIANCE</a>)
<a name="l00317"></a>00317         &amp;&amp; row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt;= lineheight * (1 + <a class="code" href="oldbasel_8cpp.html#af1babcc3994c55728d10e3de8a5f01c5">MAXHEIGHTVARIANCE</a>))
<a name="l00318"></a>00318                                  <span class="comment">/*set to average */</span>
<a name="l00319"></a>00319           row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a> = descheight;
<a name="l00320"></a>00320       <span class="keywordflow">else</span>
<a name="l00321"></a>00321         row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a> = -row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> * <a class="code" href="oldbasel_8cpp.html#a636b5d65e6e76c9ed9c87d72e5b743da">DESCENDER_FRACTION</a>;
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323   }
<a name="l00324"></a>00324   <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) lineheight;       <span class="comment">//block xheight</span>
<a name="l00325"></a>00325 }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="comment">/**********************************************************************</span>
<a name="l00329"></a>00329 <span class="comment"> * find_textlines</span>
<a name="l00330"></a>00330 <span class="comment"> *</span>
<a name="l00331"></a>00331 <span class="comment"> * Compute the baseline for the given row.</span>
<a name="l00332"></a>00332 <span class="comment"> **********************************************************************/</span>
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="keywordtype">void</span> Textord::find_textlines(<a class="code" href="class_t_o___b_l_o_c_k.html">TO_BLOCK</a> *block,  <span class="comment">// block row is in</span>
<a name="l00335"></a>00335                              <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> *row,      <span class="comment">// row to do</span>
<a name="l00336"></a>00336                              <span class="keywordtype">int</span> degree,       <span class="comment">// required approximation</span>
<a name="l00337"></a>00337                              <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> *spline) {  <span class="comment">// starting spline</span>
<a name="l00338"></a>00338   <span class="keywordtype">int</span> partcount;                 <span class="comment">/*no of partitions of */</span>
<a name="l00339"></a>00339   <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> holed_line = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;      <span class="comment">//lost too many blobs</span>
<a name="l00340"></a>00340   <span class="keywordtype">int</span> bestpart;                  <span class="comment">/*biggest partition */</span>
<a name="l00341"></a>00341   <span class="keywordtype">char</span> *partids;                 <span class="comment">/*partition no of each blob */</span>
<a name="l00342"></a>00342   <span class="keywordtype">int</span> partsizes[<a class="code" href="oldbasel_8cpp.html#a43c12716e71c3b49f1907bd935376e43">MAXPARTS</a>];       <span class="comment">/*no in each partition */</span>
<a name="l00343"></a>00343   <span class="keywordtype">int</span> lineheight;                <span class="comment">/*guessed x-height */</span>
<a name="l00344"></a>00344   <span class="keywordtype">float</span> jumplimit;               <span class="comment">/*allowed delta change */</span>
<a name="l00345"></a>00345   <span class="keywordtype">int</span> *xcoords;                  <span class="comment">/*useful sample points */</span>
<a name="l00346"></a>00346   <span class="keywordtype">int</span> *ycoords;                  <span class="comment">/*useful sample points */</span>
<a name="l00347"></a>00347   <a class="code" href="class_t_b_o_x.html">TBOX</a> *blobcoords;               <span class="comment">/*edges of blob rectangles */</span>
<a name="l00348"></a>00348   <span class="keywordtype">int</span> blobcount;                 <span class="comment">/*no of blobs on line */</span>
<a name="l00349"></a>00349   <span class="keywordtype">float</span> *ydiffs;                 <span class="comment">/*diffs from 1st approx */</span>
<a name="l00350"></a>00350   <span class="keywordtype">int</span> pointcount;                <span class="comment">/*no of coords */</span>
<a name="l00351"></a>00351   <span class="keywordtype">int</span> xstarts[<a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> + 1];   <span class="comment">//segment boundaries</span>
<a name="l00352"></a>00352   <span class="keywordtype">int</span> segments;                  <span class="comment">//no of segments</span>
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                                  <span class="comment">//no of blobs in row</span>
<a name="l00355"></a>00355   blobcount = row-&gt;<a class="code" href="class_t_o___r_o_w.html#a39cee94572e70d35179c27cdf21a3022">blob_list</a> ()-&gt;length ();
<a name="l00356"></a>00356   partids = (<span class="keywordtype">char</span> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (blobcount * <span class="keyword">sizeof</span> (<span class="keywordtype">char</span>));
<a name="l00357"></a>00357   xcoords = (<span class="keywordtype">int</span> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (blobcount * <span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));
<a name="l00358"></a>00358   ycoords = (<span class="keywordtype">int</span> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (blobcount * <span class="keyword">sizeof</span> (<span class="keywordtype">int</span>));
<a name="l00359"></a>00359   blobcoords = (<a class="code" href="class_t_b_o_x.html">TBOX</a> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (blobcount * <span class="keyword">sizeof</span> (<a class="code" href="class_t_b_o_x.html">TBOX</a>));
<a name="l00360"></a>00360   ydiffs = (<span class="keywordtype">float</span> *) <a class="code" href="memry_8cpp.html#a4c14b091498fb7866a1dd0af51a591fe">alloc_mem</a> (blobcount * <span class="keyword">sizeof</span> (<span class="keywordtype">float</span>));
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   lineheight = <a class="code" href="oldbasel_8cpp.html#a8bbd79e9db94d47b2998e03850b18181">get_blob_coords</a> (row, (<span class="keywordtype">int</span>) block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a>, blobcoords,
<a name="l00363"></a>00363     holed_line, blobcount);
<a name="l00364"></a>00364                                  <span class="comment">/*limit for line change */</span>
<a name="l00365"></a>00365   jumplimit = lineheight * <a class="code" href="oldbasel_8cpp.html#aa0ab27b57cde2ce0d3e4c7c269ae58f8">textord_oldbl_jumplimit</a>;
<a name="l00366"></a>00366   <span class="keywordflow">if</span> (jumplimit &lt; <a class="code" href="oldbasel_8cpp.html#ae325902750f29296b4fb7ae22ecbb3dd">MINASCRISE</a>)
<a name="l00367"></a>00367     jumplimit = <a class="code" href="oldbasel_8cpp.html#ae325902750f29296b4fb7ae22ecbb3dd">MINASCRISE</a>;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l00370"></a>00370     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>
<a name="l00371"></a>00371       (<span class="stringliteral">&quot;\nInput height=%g, Estimate x-height=%d pixels, jumplimit=%.2f\n&quot;</span>,
<a name="l00372"></a>00372       block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a>, lineheight, jumplimit);
<a name="l00373"></a>00373   }
<a name="l00374"></a>00374   <span class="keywordflow">if</span> (holed_line)
<a name="l00375"></a>00375     <a class="code" href="oldbasel_8cpp.html#a6640bd141affa5aec1d6d3ee0e724e66">make_holed_baseline</a> (blobcoords, blobcount, spline, &amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>,
<a name="l00376"></a>00376       row-&gt;<a class="code" href="class_t_o___r_o_w.html#a51cc690153d9cabdc8217e2ac336d414">line_m</a> ());
<a name="l00377"></a>00377   <span class="keywordflow">else</span>
<a name="l00378"></a>00378     <a class="code" href="oldbasel_8cpp.html#a8183cffcfbc4d5ea44607619f14b44f5">make_first_baseline</a> (blobcoords, blobcount,
<a name="l00379"></a>00379       xcoords, ycoords, spline, &amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>, jumplimit);
<a name="l00380"></a>00380 <span class="preprocessor">#ifndef GRAPHICS_DISABLED</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="makerow_8cpp.html#a73aa7e6e50011cbd9114a4cd34dbcf47">textord_show_final_rows</a>)
<a name="l00382"></a>00382     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>.<a class="code" href="class_q_s_p_l_i_n_e.html#ae2fb284b33116e4d3a0f9e1eaa125dff">plot</a> (<a class="code" href="drawtord_8cpp.html#a65aeba67da16b0fd87082f9966362f0e">to_win</a>, <a class="code" href="class_scroll_view.html#a100504544a5423a94222149ee9ed0fe8a8c6bd80ef295f1fcdb8e79549a0b9385">ScrollView::GOLDENROD</a>);
<a name="l00383"></a>00383 <span class="preprocessor">#endif</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (blobcount &gt; 1) {
<a name="l00385"></a>00385     bestpart = <a class="code" href="oldbasel_8cpp.html#a75f15842c2f303b5343bdc22504098a0">partition_line</a> (blobcoords, blobcount,
<a name="l00386"></a>00386       &amp;partcount, partids, partsizes,
<a name="l00387"></a>00387       &amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>, jumplimit, ydiffs);
<a name="l00388"></a>00388     pointcount = <a class="code" href="oldbasel_8cpp.html#aad2034679e53c7d16b8306b773c552a7" title="*merge_partitions(partids,partcount,blobcount,bestpart) discards funny looking">partition_coords</a> (blobcoords, blobcount,
<a name="l00389"></a>00389       partids, bestpart, xcoords, ycoords);
<a name="l00390"></a>00390     segments = <a class="code" href="oldbasel_8cpp.html#a320b77e1f7ecd371bdab9b4a0c3e10db">segment_spline</a> (blobcoords, blobcount,
<a name="l00391"></a>00391       xcoords, ycoords,
<a name="l00392"></a>00392       degree, pointcount, xstarts);
<a name="l00393"></a>00393     <span class="keywordflow">if</span> (!holed_line) {
<a name="l00394"></a>00394       <span class="keywordflow">do</span> {
<a name="l00395"></a>00395         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a> = <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> (xstarts, segments,
<a name="l00396"></a>00396           xcoords, ycoords, pointcount, degree);
<a name="l00397"></a>00397       }
<a name="l00398"></a>00398       <span class="keywordflow">while</span> (<a class="code" href="oldbasel_8cpp.html#a65c44b7980901c6716d6af6b5457fb55">textord_oldbl_split_splines</a>
<a name="l00399"></a>00399         &amp;&amp; <a class="code" href="oldbasel_8cpp.html#a7ebf232cd4ed4b8feb53a47b8248903f">split_stepped_spline</a> (&amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>, jumplimit / 2,
<a name="l00400"></a>00400         xcoords, xstarts, segments));
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402     <a class="code" href="oldbasel_8cpp.html#a010670c118cee8bc7b8c74125084ac30">find_lesser_parts</a>(row,
<a name="l00403"></a>00403                       blobcoords,
<a name="l00404"></a>00404                       blobcount,
<a name="l00405"></a>00405                       partids,
<a name="l00406"></a>00406                       partsizes,
<a name="l00407"></a>00407                       partcount,
<a name="l00408"></a>00408                       bestpart);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410   }
<a name="l00411"></a>00411   <span class="keywordflow">else</span> {
<a name="l00412"></a>00412     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = -1.0f;        <span class="comment">/*failed */</span>
<a name="l00413"></a>00413     row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a> = 0.0f;
<a name="l00414"></a>00414     row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = 0.0f;
<a name="l00415"></a>00415   }
<a name="l00416"></a>00416   row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>.<a class="code" href="class_q_s_p_l_i_n_e.html#a2459d3e247a16f9f01d6b77597193812">extrapolate</a> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a51cc690153d9cabdc8217e2ac336d414">line_m</a> (),
<a name="l00417"></a>00417     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a16e698664028b0d6d2193db64560c16b">block</a>-&gt;<a class="code" href="class_p_d_b_l_k.html#a91950a96127b4a0bb9b237e1f5f889a4" title="get box">bounding_box</a> ().left (),
<a name="l00418"></a>00418     block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a16e698664028b0d6d2193db64560c16b">block</a>-&gt;<a class="code" href="class_p_d_b_l_k.html#a91950a96127b4a0bb9b237e1f5f889a4" title="get box">bounding_box</a> ().right ());
<a name="l00419"></a>00419 
<a name="l00420"></a>00420   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a160e4b5a4517db072dd572847b673c9c">textord_really_old_xheight</a>) {
<a name="l00421"></a>00421     <a class="code" href="oldbasel_8cpp.html#a7d9be1c4d4bb8e4df217ddd66862b8ee">old_first_xheight</a> (row, blobcoords, lineheight,
<a name="l00422"></a>00422       blobcount, &amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>, jumplimit);
<a name="l00423"></a>00423   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="makerow_8cpp.html#a7718429051854813a160987de497731c">textord_old_xheight</a>) {
<a name="l00424"></a>00424     <a class="code" href="oldbasel_8cpp.html#a57a9e3ff2547db03b8a316f2fb25f017">make_first_xheight</a> (row, blobcoords, lineheight, (<span class="keywordtype">int</span>) block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a>,
<a name="l00425"></a>00425                         blobcount, &amp;row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>, jumplimit);
<a name="l00426"></a>00426   } <span class="keywordflow">else</span> {
<a name="l00427"></a>00427     compute_row_xheight(row, block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#a16e698664028b0d6d2193db64560c16b">block</a>-&gt;<a class="code" href="class_b_l_o_c_k.html#a34b02293bd58bf10ce6e62fd7d3953ef">classify_rotation</a>(),
<a name="l00428"></a>00428                         row-&gt;<a class="code" href="class_t_o___r_o_w.html#a51cc690153d9cabdc8217e2ac336d414">line_m</a>(), block-&gt;<a class="code" href="class_t_o___b_l_o_c_k.html#ab106233da0599f3e1595c1c765acadec">line_size</a>);
<a name="l00429"></a>00429   }
<a name="l00430"></a>00430   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(partids);
<a name="l00431"></a>00431   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(xcoords);
<a name="l00432"></a>00432   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(ycoords);
<a name="l00433"></a>00433   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(blobcoords);
<a name="l00434"></a>00434   <a class="code" href="memry_8cpp.html#a9ef1862b8e026e23eef238af032858e4">free_mem</a>(ydiffs);
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 }  <span class="comment">// namespace tesseract.</span>
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="comment">/**********************************************************************</span>
<a name="l00441"></a>00441 <span class="comment"> * get_blob_coords</span>
<a name="l00442"></a>00442 <span class="comment"> *</span>
<a name="l00443"></a>00443 <span class="comment"> * Fill the blobcoords array with the coordinates of the blobs</span>
<a name="l00444"></a>00444 <span class="comment"> * in the row. The return value is the first guess at the line height.</span>
<a name="l00445"></a>00445 <span class="comment"> **********************************************************************/</span>
<a name="l00446"></a>00446 
<a name="l00447"></a><a class="code" href="oldbasel_8h.html#a8bbd79e9db94d47b2998e03850b18181">00447</a> <span class="keywordtype">int</span> <a class="code" href="oldbasel_8cpp.html#a8bbd79e9db94d47b2998e03850b18181">get_blob_coords</a>(                    <span class="comment">//get boxes</span>
<a name="l00448"></a>00448                     <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> *row,        <span class="comment">//row to use</span>
<a name="l00449"></a>00449                     <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> lineheight,   <span class="comment">//block level</span>
<a name="l00450"></a>00450                     <a class="code" href="class_t_b_o_x.html">TBOX</a> *blobcoords,    <span class="comment">//ouput boxes</span>
<a name="l00451"></a>00451                     <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> &amp;holed_line,  <span class="comment">//lost a lot of blobs</span>
<a name="l00452"></a>00452                     <span class="keywordtype">int</span> &amp;outcount       <span class="comment">//no of real blobs</span>
<a name="l00453"></a>00453                    ) {
<a name="l00454"></a>00454                                  <span class="comment">//blobs</span>
<a name="l00455"></a>00455   BLOBNBOX_IT blob_it = row-&gt;<a class="code" href="class_t_o___r_o_w.html#a39cee94572e70d35179c27cdf21a3022">blob_list</a> ();
<a name="l00456"></a>00456   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*no along text line */</span>
<a name="l00457"></a>00457   <span class="keywordtype">int</span> losscount;                 <span class="comment">//lost blobs</span>
<a name="l00458"></a>00458   <span class="keywordtype">int</span> maxlosscount;              <span class="comment">//greatest lost blobs</span>
<a name="l00459"></a>00459                                  <span class="comment">/*height stat collection */</span>
<a name="l00460"></a>00460   <a class="code" href="class_s_t_a_t_s.html">STATS</a> heightstat (0, <a class="code" href="oldbasel_8cpp.html#ade1da022379102bc94d127f9c6358fe7">MAXHEIGHT</a>);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   <span class="keywordflow">if</span> (blob_it.empty ())
<a name="l00463"></a>00463     <span class="keywordflow">return</span> 0;                    <span class="comment">//none</span>
<a name="l00464"></a>00464   maxlosscount = 0;
<a name="l00465"></a>00465   losscount = 0;
<a name="l00466"></a>00466   blob_it.mark_cycle_pt ();
<a name="l00467"></a>00467   blobindex = 0;
<a name="l00468"></a>00468   <span class="keywordflow">do</span> {
<a name="l00469"></a>00469     blobcoords[blobindex] = <a class="code" href="blobbox_8cpp.html#a3728c3433d1e8f6a2178bb796aa21fad">box_next_pre_chopped</a> (&amp;blob_it);
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (blobcoords[blobindex].height () &gt; lineheight * 0.25)
<a name="l00471"></a>00471       heightstat.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a> (blobcoords[blobindex].height (), 1);
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (blobindex == 0
<a name="l00473"></a>00473       || blobcoords[blobindex].height () &gt; lineheight * 0.25
<a name="l00474"></a>00474     || blob_it.cycled_list ()) {
<a name="l00475"></a>00475       blobindex++;               <span class="comment">/*no of merged blobs */</span>
<a name="l00476"></a>00476       losscount = 0;
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478     <span class="keywordflow">else</span> {
<a name="l00479"></a>00479       <span class="keywordflow">if</span> (blobcoords[blobindex].height ()
<a name="l00480"></a>00480         &lt; blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> () * <a class="code" href="oldbasel_8cpp.html#a1c777e24551f3606e42efe3bdb71d56c">oldbl_dot_error_size</a>
<a name="l00481"></a>00481         &amp;&amp; blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#af95494a2ccacc70cc2b83820b2948619">width</a> ()
<a name="l00482"></a>00482       &lt; blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> () * <a class="code" href="oldbasel_8cpp.html#a1c777e24551f3606e42efe3bdb71d56c">oldbl_dot_error_size</a>) {
<a name="l00483"></a>00483                                  <span class="comment">//counts as dot</span>
<a name="l00484"></a>00484         blobindex++;
<a name="l00485"></a>00485         losscount = 0;
<a name="l00486"></a>00486       }
<a name="l00487"></a>00487       <span class="keywordflow">else</span> {
<a name="l00488"></a>00488         losscount++;             <span class="comment">//lost it</span>
<a name="l00489"></a>00489         <span class="keywordflow">if</span> (losscount &gt; maxlosscount)
<a name="l00490"></a>00490                                  <span class="comment">//remember max</span>
<a name="l00491"></a>00491             maxlosscount = losscount;
<a name="l00492"></a>00492       }
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494   }
<a name="l00495"></a>00495   <span class="keywordflow">while</span> (!blob_it.cycled_list ());
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   holed_line = maxlosscount &gt; <a class="code" href="oldbasel_8cpp.html#a74b5ea2ca513022fc65ac2d68d1179fd">oldbl_holed_losscount</a>;
<a name="l00498"></a>00498   outcount = blobindex;          <span class="comment">/*total blobs */</span>
<a name="l00499"></a>00499 
<a name="l00500"></a>00500   <span class="keywordflow">if</span> (heightstat.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a> () &gt; 1)
<a name="l00501"></a>00501                                  <span class="comment">/*guess x-height */</span>
<a name="l00502"></a>00502     <span class="keywordflow">return</span> (<span class="keywordtype">int</span>) heightstat.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a> (0.25);
<a name="l00503"></a>00503   <span class="keywordflow">else</span>
<a name="l00504"></a>00504     <span class="keywordflow">return</span> blobcoords[0].<a class="code" href="class_t_b_o_x.html#a8379d4bbc72bdbb1f069fc14790e632d">height</a> ();
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 
<a name="l00508"></a>00508 <span class="comment">/**********************************************************************</span>
<a name="l00509"></a>00509 <span class="comment"> * make_first_baseline</span>
<a name="l00510"></a>00510 <span class="comment"> *</span>
<a name="l00511"></a>00511 <span class="comment"> * Make the first estimate at a baseline, either by shifting</span>
<a name="l00512"></a>00512 <span class="comment"> * a supplied previous spline, or by doing a piecewise linear</span>
<a name="l00513"></a>00513 <span class="comment"> * approximation using all the blobs.</span>
<a name="l00514"></a>00514 <span class="comment"> **********************************************************************/</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="keywordtype">void</span>
<a name="l00517"></a><a class="code" href="oldbasel_8h.html#a8183cffcfbc4d5ea44607619f14b44f5">00517</a> <a class="code" href="oldbasel_8cpp.html#a8183cffcfbc4d5ea44607619f14b44f5">make_first_baseline</a> (            <span class="comment">//initial approximation</span>
<a name="l00518"></a>00518 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">/*blob bounding boxes */</span>
<a name="l00519"></a>00519 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobcoords */</span>
<a name="l00520"></a>00520 <span class="keywordtype">int</span> xcoords[],                   <span class="comment">/*coords for spline */</span>
<a name="l00521"></a>00521 <span class="keywordtype">int</span> ycoords[],                   <span class="comment">/*approximator */</span>
<a name="l00522"></a>00522 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * spline,                <span class="comment">/*initial spline */</span>
<a name="l00523"></a>00523 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * <a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,              <span class="comment">/*output spline */</span>
<a name="l00524"></a>00524 <span class="keywordtype">float</span> jumplimit                  <span class="comment">/*guess half descenders */</span>
<a name="l00525"></a>00525 ) {
<a name="l00526"></a>00526   <span class="keywordtype">int</span> leftedge;                  <span class="comment">/*left edge of line */</span>
<a name="l00527"></a>00527   <span class="keywordtype">int</span> rightedge;                 <span class="comment">/*right edge of line */</span>
<a name="l00528"></a>00528   <span class="keywordtype">int</span> blobindex;                 <span class="comment">/*current blob */</span>
<a name="l00529"></a>00529   <span class="keywordtype">int</span> segment;                   <span class="comment">/*current segment */</span>
<a name="l00530"></a>00530   <span class="keywordtype">float</span> prevy, thisy, nexty;     <span class="comment">/*3 y coords */</span>
<a name="l00531"></a>00531   <span class="keywordtype">float</span> y1, y2, y3;              <span class="comment">/*3 smooth blobs */</span>
<a name="l00532"></a>00532   <span class="keywordtype">float</span> maxmax, minmin;          <span class="comment">/*absolute limits */</span>
<a name="l00533"></a>00533   <span class="keywordtype">int</span> x2 = 0;                    <span class="comment">/*right edge of old y3 */</span>
<a name="l00534"></a>00534   <span class="keywordtype">int</span> ycount;                    <span class="comment">/*no of ycoords in use */</span>
<a name="l00535"></a>00535   <span class="keywordtype">float</span> yturns[<a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a>];      <span class="comment">/*y coords of turn pts */</span>
<a name="l00536"></a>00536   <span class="keywordtype">int</span> xturns[<a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a>];        <span class="comment">/*xcoords of turn pts */</span>
<a name="l00537"></a>00537   <span class="keywordtype">int</span> xstarts[<a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> + 1];
<a name="l00538"></a>00538   <span class="keywordtype">int</span> segments;                  <span class="comment">//no of segments</span>
<a name="l00539"></a>00539   <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> shift;                  <span class="comment">//shift of spline</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541   prevy = 0;
<a name="l00542"></a>00542                                  <span class="comment">/*left edge of row */</span>
<a name="l00543"></a>00543   leftedge = blobcoords[0].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ();
<a name="l00544"></a>00544                                  <span class="comment">/*right edge of line */</span>
<a name="l00545"></a>00545   rightedge = blobcoords[blobcount - 1].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ();
<a name="l00546"></a>00546   <span class="keywordflow">if</span> (spline == <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>             <span class="comment">/*no given spline */</span>
<a name="l00547"></a>00547     || spline-&gt;segments &lt; 3      <span class="comment">/*or trivial */</span>
<a name="l00548"></a>00548                                  <span class="comment">/*or too non-overlap */</span>
<a name="l00549"></a>00549     || spline-&gt;xcoords[1] &gt; leftedge + <a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">MAXOVERLAP</a> * (rightedge - leftedge)
<a name="l00550"></a>00550     || spline-&gt;xcoords[spline-&gt;segments - 1] &lt; rightedge
<a name="l00551"></a>00551   - <a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">MAXOVERLAP</a> * (rightedge - leftedge)) {
<a name="l00552"></a>00552     <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a26cc69b976618e872211e3974a7df35f">textord_oldbl_paradef</a>)
<a name="l00553"></a>00553       <span class="keywordflow">return</span>;                    <span class="comment">//use default</span>
<a name="l00554"></a>00554     xstarts[0] = blobcoords[0].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () - 1;
<a name="l00555"></a>00555     <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l00556"></a>00556       xcoords[blobindex] = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ()
<a name="l00557"></a>00557         + blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) / 2;
<a name="l00558"></a>00558       ycoords[blobindex] = blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ();
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     xstarts[1] = blobcoords[blobcount - 1].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> () + 1;
<a name="l00561"></a>00561     segments = 1;                <span class="comment">/*no of segments */</span>
<a name="l00562"></a>00562 
<a name="l00563"></a>00563                                  <span class="comment">/*linear */</span>
<a name="l00564"></a>00564     *baseline = <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> (xstarts, segments, xcoords, ycoords, blobcount, 1);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (blobcount &gt;= 3) {
<a name="l00567"></a>00567       y1 = y2 = y3 = 0.0f;
<a name="l00568"></a>00568       ycount = 0;
<a name="l00569"></a>00569       segment = 0;               <span class="comment">/*no of segments */</span>
<a name="l00570"></a>00570       maxmax = minmin = 0.0f;
<a name="l00571"></a>00571       thisy = ycoords[0] - baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcoords[0]);
<a name="l00572"></a>00572       nexty = ycoords[1] - baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcoords[1]);
<a name="l00573"></a>00573       <span class="keywordflow">for</span> (blobindex = 2; blobindex &lt; blobcount; blobindex++) {
<a name="l00574"></a>00574         prevy = thisy;           <span class="comment">/*shift ycoords */</span>
<a name="l00575"></a>00575         thisy = nexty;
<a name="l00576"></a>00576         nexty = ycoords[blobindex] - baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcoords[blobindex]);
<a name="l00577"></a>00577                                  <span class="comment">/*middle of smooth y */</span>
<a name="l00578"></a>00578         <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (thisy - prevy) &lt; jumplimit &amp;&amp; <a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (thisy - nexty) &lt; jumplimit) {
<a name="l00579"></a>00579           y1 = y2;               <span class="comment">/*shift window */</span>
<a name="l00580"></a>00580           y2 = y3;
<a name="l00581"></a>00581           y3 = thisy;            <span class="comment">/*middle point */</span>
<a name="l00582"></a>00582           ycount++;
<a name="l00583"></a>00583                                  <span class="comment">/*local max */</span>
<a name="l00584"></a>00584           <span class="keywordflow">if</span> (ycount &gt;= 3 &amp;&amp; ((y1 &lt; y2 &amp;&amp; y2 &gt;= y3)
<a name="l00585"></a>00585                                  <span class="comment">/*local min */</span>
<a name="l00586"></a>00586           || (y1 &gt; y2 &amp;&amp; y2 &lt;= y3))) {
<a name="l00587"></a>00587             <span class="keywordflow">if</span> (segment &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 2) {
<a name="l00588"></a>00588                                  <span class="comment">/*turning pt */</span>
<a name="l00589"></a>00589               xturns[segment] = x2;
<a name="l00590"></a>00590               yturns[segment] = y2;
<a name="l00591"></a>00591               segment++;         <span class="comment">/*no of spline segs */</span>
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593           }
<a name="l00594"></a>00594           <span class="keywordflow">if</span> (ycount == 1) {
<a name="l00595"></a>00595             maxmax = minmin = y3;<span class="comment">/*initialise limits */</span>
<a name="l00596"></a>00596           }
<a name="l00597"></a>00597           <span class="keywordflow">else</span> {
<a name="l00598"></a>00598             <span class="keywordflow">if</span> (y3 &gt; maxmax)
<a name="l00599"></a>00599               maxmax = y3;       <span class="comment">/*biggest max */</span>
<a name="l00600"></a>00600             <span class="keywordflow">if</span> (y3 &lt; minmin)
<a name="l00601"></a>00601               minmin = y3;       <span class="comment">/*smallest min */</span>
<a name="l00602"></a>00602           }
<a name="l00603"></a>00603                                  <span class="comment">/*possible turning pt */</span>
<a name="l00604"></a>00604           x2 = blobcoords[blobindex - 1].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ();
<a name="l00605"></a>00605         }
<a name="l00606"></a>00606       }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608       jumplimit *= 1.2;
<a name="l00609"></a>00609                                  <span class="comment">/*must be wavy */</span>
<a name="l00610"></a>00610       <span class="keywordflow">if</span> (maxmax - minmin &gt; jumplimit) {
<a name="l00611"></a>00611         ycount = segment;        <span class="comment">/*no of segments */</span>
<a name="l00612"></a>00612         <span class="keywordflow">for</span> (blobindex = 0, segment = 1; blobindex &lt; ycount;
<a name="l00613"></a>00613         blobindex++) {
<a name="l00614"></a>00614           <span class="keywordflow">if</span> (yturns[blobindex] &gt; minmin + jumplimit
<a name="l00615"></a>00615           || yturns[blobindex] &lt; maxmax - jumplimit) {
<a name="l00616"></a>00616                                  <span class="comment">/*significant peak */</span>
<a name="l00617"></a>00617             <span class="keywordflow">if</span> (segment == 1
<a name="l00618"></a>00618               || yturns[blobindex] &gt; prevy + jumplimit
<a name="l00619"></a>00619             || yturns[blobindex] &lt; prevy - jumplimit) {
<a name="l00620"></a>00620                                  <span class="comment">/*different to previous */</span>
<a name="l00621"></a>00621               xstarts[segment] = xturns[blobindex];
<a name="l00622"></a>00622               segment++;
<a name="l00623"></a>00623               prevy = yturns[blobindex];
<a name="l00624"></a>00624             }
<a name="l00625"></a>00625                                  <span class="comment">/*bigger max */</span>
<a name="l00626"></a>00626             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((prevy &gt; minmin + jumplimit &amp;&amp; yturns[blobindex] &gt; prevy)
<a name="l00627"></a>00627                                  <span class="comment">/*smaller min */</span>
<a name="l00628"></a>00628             || (prevy &lt; maxmax - jumplimit &amp;&amp; yturns[blobindex] &lt; prevy)) {
<a name="l00629"></a>00629               xstarts[segment - 1] = xturns[blobindex];
<a name="l00630"></a>00630                                  <span class="comment">/*improved previous */</span>
<a name="l00631"></a>00631               prevy = yturns[blobindex];
<a name="l00632"></a>00632             }
<a name="l00633"></a>00633           }
<a name="l00634"></a>00634         }
<a name="l00635"></a>00635         xstarts[segment] = blobcoords[blobcount - 1].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> () + 1;
<a name="l00636"></a>00636         segments = segment;      <span class="comment">/*no of segments */</span>
<a name="l00637"></a>00637                                  <span class="comment">/*linear */</span>
<a name="l00638"></a>00638         *baseline = <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> (xstarts, segments, xcoords, ycoords, blobcount, 1);
<a name="l00639"></a>00639       }
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641   }
<a name="l00642"></a>00642   <span class="keywordflow">else</span> {
<a name="l00643"></a>00643     *baseline = *spline;         <span class="comment">/*copy it */</span>
<a name="l00644"></a>00644     shift = <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> (0, (<a class="code" href="host_8h.html#a8d41499d38c24d39b221ab0c158fe5a8">inT16</a>) (blobcoords[0].bottom ()
<a name="l00645"></a>00645       - spline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (blobcoords[0].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ())));
<a name="l00646"></a>00646     baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#a3d1808becf8a69d00747b444d9c76cf6">move</a> (shift);
<a name="l00647"></a>00647   }
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="comment">/**********************************************************************</span>
<a name="l00652"></a>00652 <span class="comment"> * make_holed_baseline</span>
<a name="l00653"></a>00653 <span class="comment"> *</span>
<a name="l00654"></a>00654 <span class="comment"> * Make the first estimate at a baseline, either by shifting</span>
<a name="l00655"></a>00655 <span class="comment"> * a supplied previous spline, or by doing a piecewise linear</span>
<a name="l00656"></a>00656 <span class="comment"> * approximation using all the blobs.</span>
<a name="l00657"></a>00657 <span class="comment"> **********************************************************************/</span>
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 <span class="keywordtype">void</span>
<a name="l00660"></a><a class="code" href="oldbasel_8h.html#a6640bd141affa5aec1d6d3ee0e724e66">00660</a> <a class="code" href="oldbasel_8cpp.html#a6640bd141affa5aec1d6d3ee0e724e66">make_holed_baseline</a> (            <span class="comment">//initial approximation</span>
<a name="l00661"></a>00661 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">/*blob bounding boxes */</span>
<a name="l00662"></a>00662 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobcoords */</span>
<a name="l00663"></a>00663 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * spline,                <span class="comment">/*initial spline */</span>
<a name="l00664"></a>00664 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * <a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,              <span class="comment">/*output spline */</span>
<a name="l00665"></a>00665 <span class="keywordtype">float</span> gradient                   <span class="comment">//of line</span>
<a name="l00666"></a>00666 ) {
<a name="l00667"></a>00667   <span class="keywordtype">int</span> leftedge;                  <span class="comment">/*left edge of line */</span>
<a name="l00668"></a>00668   <span class="keywordtype">int</span> rightedge;                 <span class="comment">/*right edge of line */</span>
<a name="l00669"></a>00669   <span class="keywordtype">int</span> blobindex;                 <span class="comment">/*current blob */</span>
<a name="l00670"></a>00670   <span class="keywordtype">float</span> x;                       <span class="comment">//centre of row</span>
<a name="l00671"></a>00671   <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> shift;                  <span class="comment">//shift of spline</span>
<a name="l00672"></a>00672 
<a name="l00673"></a>00673   <a class="code" href="classtesseract_1_1_det_line_fit.html">tesseract::DetLineFit</a> lms;  <span class="comment">// straight baseline</span>
<a name="l00674"></a>00674   <a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a> xstarts[2];              <span class="comment">//straight line</span>
<a name="l00675"></a>00675   <span class="keywordtype">double</span> coeffs[3];
<a name="l00676"></a>00676   <span class="keywordtype">float</span> c;                       <span class="comment">//line parameter</span>
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                                  <span class="comment">/*left edge of row */</span>
<a name="l00679"></a>00679   leftedge = blobcoords[0].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ();
<a name="l00680"></a>00680                                  <span class="comment">/*right edge of line */</span>
<a name="l00681"></a>00681   rightedge = blobcoords[blobcount - 1].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a>();
<a name="l00682"></a>00682   <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l00683"></a>00683     lms.<a class="code" href="classtesseract_1_1_det_line_fit.html#a4eba2b6e761080e5d1a48c9c797257b2">Add</a>(<a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a>((blobcoords[blobindex].left() +
<a name="l00684"></a>00684                     blobcoords[blobindex].right()) / 2,
<a name="l00685"></a>00685                    blobcoords[blobindex].bottom()));
<a name="l00686"></a>00686   }
<a name="l00687"></a>00687   lms.<a class="code" href="classtesseract_1_1_det_line_fit.html#a58c6ff442c9ab172952eea607f83dca8">ConstrainedFit</a>(gradient, &amp;c);
<a name="l00688"></a>00688   xstarts[0] = leftedge;
<a name="l00689"></a>00689   xstarts[1] = rightedge;
<a name="l00690"></a>00690   coeffs[0] = 0;
<a name="l00691"></a>00691   coeffs[1] = gradient;
<a name="l00692"></a>00692   coeffs[2] = c;
<a name="l00693"></a>00693   *baseline = <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> (1, xstarts, coeffs);
<a name="l00694"></a>00694   <span class="keywordflow">if</span> (spline != <a class="code" href="host_8h.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>             <span class="comment">/*no given spline */</span>
<a name="l00695"></a>00695     &amp;&amp; spline-&gt;segments &gt;= 3     <span class="comment">/*or trivial */</span>
<a name="l00696"></a>00696                                  <span class="comment">/*or too non-overlap */</span>
<a name="l00697"></a>00697     &amp;&amp; spline-&gt;xcoords[1] &lt;= leftedge + <a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">MAXOVERLAP</a> * (rightedge - leftedge)
<a name="l00698"></a>00698     &amp;&amp; spline-&gt;xcoords[spline-&gt;segments - 1] &gt;= rightedge
<a name="l00699"></a>00699   - <a class="code" href="oldbasel_8cpp.html#a2789b0522b4b2520ddc257d0a2ba472a">MAXOVERLAP</a> * (rightedge - leftedge)) {
<a name="l00700"></a>00700     *baseline = *spline;         <span class="comment">/*copy it */</span>
<a name="l00701"></a>00701     x = (leftedge + rightedge) / 2.0;
<a name="l00702"></a>00702     shift = <a class="code" href="class_i_c_o_o_r_d.html" title="integer coordinate">ICOORD</a> (0, (<a class="code" href="host_8h.html#a8d41499d38c24d39b221ab0c158fe5a8">inT16</a>) (gradient * x + c - spline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (x)));
<a name="l00703"></a>00703     baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#a3d1808becf8a69d00747b444d9c76cf6">move</a> (shift);
<a name="l00704"></a>00704   }
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 
<a name="l00708"></a>00708 <span class="comment">/**********************************************************************</span>
<a name="l00709"></a>00709 <span class="comment"> * partition_line</span>
<a name="l00710"></a>00710 <span class="comment"> *</span>
<a name="l00711"></a>00711 <span class="comment"> * Partition a row of blobs into different groups of continuous</span>
<a name="l00712"></a>00712 <span class="comment"> * y position. jumplimit specifies the max allowable limit on a jump</span>
<a name="l00713"></a>00713 <span class="comment"> * before a new partition is started.</span>
<a name="l00714"></a>00714 <span class="comment"> * The return value is the biggest partition</span>
<a name="l00715"></a>00715 <span class="comment"> **********************************************************************/</span>
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 <span class="keywordtype">int</span>
<a name="l00718"></a><a class="code" href="oldbasel_8h.html#a75f15842c2f303b5343bdc22504098a0">00718</a> <a class="code" href="oldbasel_8cpp.html#a75f15842c2f303b5343bdc22504098a0">partition_line</a> (                 <span class="comment">//partition blobs</span>
<a name="l00719"></a>00719 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">//bounding boxes</span>
<a name="l00720"></a>00720 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobs on row */</span>
<a name="l00721"></a>00721 <span class="keywordtype">int</span> *numparts,                   <span class="comment">/*number of partitions */</span>
<a name="l00722"></a>00722 <span class="keywordtype">char</span> partids[],                  <span class="comment">/*partition no of each blob */</span>
<a name="l00723"></a>00723 <span class="keywordtype">int</span> partsizes[],                 <span class="comment">/*no in each partition */</span>
<a name="l00724"></a>00724 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * spline,                <span class="comment">/*curve to fit to */</span>
<a name="l00725"></a>00725 <span class="keywordtype">float</span> jumplimit,                 <span class="comment">/*allowed delta change */</span>
<a name="l00726"></a>00726 <span class="keywordtype">float</span> ydiffs[]                   <span class="comment">/*diff from spline */</span>
<a name="l00727"></a>00727 ) {
<a name="l00728"></a>00728   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*no along text line */</span>
<a name="l00729"></a>00729   <span class="keywordtype">int</span> bestpart;                  <span class="comment">/*best new partition */</span>
<a name="l00730"></a>00730   <span class="keywordtype">int</span> biggestpart;               <span class="comment">/*part with most members */</span>
<a name="l00731"></a>00731   <span class="keywordtype">float</span> diff;                    <span class="comment">/*difference from line */</span>
<a name="l00732"></a>00732   <span class="keywordtype">int</span> startx;                    <span class="comment">/*index of start blob */</span>
<a name="l00733"></a>00733   <span class="keywordtype">float</span> partdiffs[<a class="code" href="oldbasel_8cpp.html#a43c12716e71c3b49f1907bd935376e43">MAXPARTS</a>];     <span class="comment">/*step between parts */</span>
<a name="l00734"></a>00734 
<a name="l00735"></a>00735   <span class="keywordflow">for</span> (bestpart = 0; bestpart &lt; <a class="code" href="oldbasel_8cpp.html#a43c12716e71c3b49f1907bd935376e43">MAXPARTS</a>; bestpart++)
<a name="l00736"></a>00736     partsizes[bestpart] = 0;     <span class="comment">/*zero them all */</span>
<a name="l00737"></a>00737 
<a name="l00738"></a>00738   startx = <a class="code" href="oldbasel_8cpp.html#a8be53753ccb635852471514dcbf65b9f">get_ydiffs</a> (blobcoords, blobcount, spline, ydiffs);
<a name="l00739"></a>00739   *numparts = 1;                 <span class="comment">/*1 partition */</span>
<a name="l00740"></a>00740   bestpart = -1;                 <span class="comment">/*first point */</span>
<a name="l00741"></a>00741   <span class="keywordtype">float</span> drift = 0.0f;
<a name="l00742"></a>00742   <span class="keywordtype">float</span> last_delta = 0.0f;
<a name="l00743"></a>00743   <span class="keywordflow">for</span> (blobindex = startx; blobindex &lt; blobcount; blobindex++) {
<a name="l00744"></a>00744   <span class="comment">/*do each blob in row */</span>
<a name="l00745"></a>00745     diff = ydiffs[blobindex];    <span class="comment">/*diff from line */</span>
<a name="l00746"></a>00746     <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l00747"></a>00747       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;%d(%d,%d), &quot;</span>, blobindex,
<a name="l00748"></a>00748         blobcoords[blobindex].left (),
<a name="l00749"></a>00749         blobcoords[blobindex].bottom ());
<a name="l00750"></a>00750     }
<a name="l00751"></a>00751     bestpart = <a class="code" href="oldbasel_8cpp.html#a686c8b34dade68c0dd9e68ec7206739a">choose_partition</a>(diff, partdiffs, bestpart, jumplimit,
<a name="l00752"></a>00752                                 &amp;drift, &amp;last_delta, numparts);
<a name="l00753"></a>00753                                  <span class="comment">/*record partition */</span>
<a name="l00754"></a>00754     partids[blobindex] = bestpart;
<a name="l00755"></a>00755     partsizes[bestpart]++;       <span class="comment">/*another in it */</span>
<a name="l00756"></a>00756   }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   bestpart = -1;                 <span class="comment">/*first point */</span>
<a name="l00759"></a>00759   drift = 0.0f;
<a name="l00760"></a>00760   last_delta = 0.0f;
<a name="l00761"></a>00761   partsizes[0]--;                <span class="comment">/*doing 1st pt again */</span>
<a name="l00762"></a>00762                                  <span class="comment">/*do each blob in row */</span>
<a name="l00763"></a>00763   <span class="keywordflow">for</span> (blobindex = startx; blobindex &gt;= 0; blobindex--) {
<a name="l00764"></a>00764     diff = ydiffs[blobindex];    <span class="comment">/*diff from line */</span>
<a name="l00765"></a>00765     <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l00766"></a>00766       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;%d(%d,%d), &quot;</span>, blobindex,
<a name="l00767"></a>00767         blobcoords[blobindex].left (),
<a name="l00768"></a>00768         blobcoords[blobindex].bottom ());
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770     bestpart = <a class="code" href="oldbasel_8cpp.html#a686c8b34dade68c0dd9e68ec7206739a">choose_partition</a>(diff, partdiffs, bestpart, jumplimit,
<a name="l00771"></a>00771                                 &amp;drift, &amp;last_delta, numparts);
<a name="l00772"></a>00772                                  <span class="comment">/*record partition */</span>
<a name="l00773"></a>00773     partids[blobindex] = bestpart;
<a name="l00774"></a>00774     partsizes[bestpart]++;       <span class="comment">/*another in it */</span>
<a name="l00775"></a>00775   }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777   <span class="keywordflow">for</span> (biggestpart = 0, bestpart = 1; bestpart &lt; *numparts; bestpart++)
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (partsizes[bestpart] &gt;= partsizes[biggestpart])
<a name="l00779"></a>00779       biggestpart = bestpart;    <span class="comment">/*new biggest */</span>
<a name="l00780"></a>00780   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#afbc9ce48742715129ec2659c3fcb5584">textord_oldbl_merge_parts</a>)
<a name="l00781"></a>00781     <a class="code" href="oldbasel_8cpp.html#a0024caf13f4e7f27e9c6ed3161138def">merge_oldbl_parts</a>(blobcoords,
<a name="l00782"></a>00782                       blobcount,
<a name="l00783"></a>00783                       partids,
<a name="l00784"></a>00784                       partsizes,
<a name="l00785"></a>00785                       biggestpart,
<a name="l00786"></a>00786                       jumplimit);
<a name="l00787"></a>00787   <span class="keywordflow">return</span> biggestpart;            <span class="comment">/*biggest partition */</span>
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="comment">/**********************************************************************</span>
<a name="l00792"></a>00792 <span class="comment"> * merge_oldbl_parts</span>
<a name="l00793"></a>00793 <span class="comment"> *</span>
<a name="l00794"></a>00794 <span class="comment"> * For any adjacent group of blobs in a different part, put them in the</span>
<a name="l00795"></a>00795 <span class="comment"> * main part if they fit closely to neighbours in the main part.</span>
<a name="l00796"></a>00796 <span class="comment"> **********************************************************************/</span>
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 <span class="keywordtype">void</span>
<a name="l00799"></a><a class="code" href="oldbasel_8h.html#a0024caf13f4e7f27e9c6ed3161138def">00799</a> <a class="code" href="oldbasel_8cpp.html#a0024caf13f4e7f27e9c6ed3161138def">merge_oldbl_parts</a> (              <span class="comment">//partition blobs</span>
<a name="l00800"></a>00800 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">//bounding boxes</span>
<a name="l00801"></a>00801 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobs on row */</span>
<a name="l00802"></a>00802 <span class="keywordtype">char</span> partids[],                  <span class="comment">/*partition no of each blob */</span>
<a name="l00803"></a>00803 <span class="keywordtype">int</span> partsizes[],                 <span class="comment">/*no in each partition */</span>
<a name="l00804"></a>00804 <span class="keywordtype">int</span> biggestpart,                 <span class="comment">//major partition</span>
<a name="l00805"></a>00805 <span class="keywordtype">float</span> jumplimit                  <span class="comment">/*allowed delta change */</span>
<a name="l00806"></a>00806 ) {
<a name="l00807"></a>00807   <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> found_one;               <span class="comment">//found a bestpart blob</span>
<a name="l00808"></a>00808   <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> close_one;               <span class="comment">//found was close enough</span>
<a name="l00809"></a>00809   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*no along text line */</span>
<a name="l00810"></a>00810   <span class="keywordtype">int</span> prevpart;                  <span class="comment">//previous iteration</span>
<a name="l00811"></a>00811   <span class="keywordtype">int</span> runlength;                 <span class="comment">//no in this part</span>
<a name="l00812"></a>00812   <span class="keywordtype">float</span> diff;                    <span class="comment">/*difference from line */</span>
<a name="l00813"></a>00813   <span class="keywordtype">int</span> startx;                    <span class="comment">/*index of start blob */</span>
<a name="l00814"></a>00814   <span class="keywordtype">int</span> test_blob;                 <span class="comment">//another index</span>
<a name="l00815"></a>00815   <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a> coord;                  <span class="comment">//blob coordinate</span>
<a name="l00816"></a>00816   <span class="keywordtype">float</span> m, c;                    <span class="comment">//fitted line</span>
<a name="l00817"></a>00817   <a class="code" href="class_q_l_s_q.html">QLSQ</a> stats;                    <span class="comment">//line stuff</span>
<a name="l00818"></a>00818 
<a name="l00819"></a>00819   prevpart = biggestpart;
<a name="l00820"></a>00820   runlength = 0;
<a name="l00821"></a>00821   startx = 0;
<a name="l00822"></a>00822   <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l00823"></a>00823     <span class="keywordflow">if</span> (partids[blobindex] != prevpart) {
<a name="l00824"></a>00824       <span class="comment">//                      tprintf(&quot;Partition change at (%d,%d) from %d to %d after run of %d\n&quot;,</span>
<a name="l00825"></a>00825       <span class="comment">//                              blobcoords[blobindex].left(),blobcoords[blobindex].bottom(),</span>
<a name="l00826"></a>00826       <span class="comment">//                              prevpart,partids[blobindex],runlength);</span>
<a name="l00827"></a>00827       <span class="keywordflow">if</span> (prevpart != biggestpart &amp;&amp; runlength &gt; <a class="code" href="oldbasel_8cpp.html#a058e03b643cfba9a6b7899b9a91f9bcb">MAXBADRUN</a>) {
<a name="l00828"></a>00828         stats.<a class="code" href="class_q_l_s_q.html#a9f6ee88370df57093e248a2918ab20b2">clear</a> ();
<a name="l00829"></a>00829         <span class="keywordflow">for</span> (test_blob = startx; test_blob &lt; blobindex; test_blob++) {
<a name="l00830"></a>00830           coord = <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a> ((blobcoords[test_blob].left ()
<a name="l00831"></a>00831             + blobcoords[test_blob].right ()) / 2.0,
<a name="l00832"></a>00832             blobcoords[test_blob].bottom ());
<a name="l00833"></a>00833           stats.<a class="code" href="class_q_l_s_q.html#adbbaa8f4d49392cc26b46fabc476cc88">add</a> (coord.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a> (), coord.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a> ());
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835         stats.<a class="code" href="class_q_l_s_q.html#a847b2fa0f918e971a56e8db0ce8ed18f">fit</a> (1);
<a name="l00836"></a>00836         m = stats.<a class="code" href="class_q_l_s_q.html#ab8de83e0968609f28aa83854431e2593">get_b</a> ();
<a name="l00837"></a>00837         c = stats.<a class="code" href="class_q_l_s_q.html#aeeedb9b168cef907167e4530dd4bf68a">get_c</a> ();
<a name="l00838"></a>00838         <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l00839"></a>00839           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Fitted line y=%g x + %g\n&quot;</span>, m, c);
<a name="l00840"></a>00840         found_one = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00841"></a>00841         close_one = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00842"></a>00842         <span class="keywordflow">for</span> (test_blob = 1; !found_one
<a name="l00843"></a>00843           &amp;&amp; (startx - test_blob &gt;= 0
<a name="l00844"></a>00844         || blobindex + test_blob &lt;= blobcount); test_blob++) {
<a name="l00845"></a>00845           <span class="keywordflow">if</span> (startx - test_blob &gt;= 0
<a name="l00846"></a>00846           &amp;&amp; partids[startx - test_blob] == biggestpart) {
<a name="l00847"></a>00847             found_one = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00848"></a>00848             coord = <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a> ((blobcoords[startx - test_blob].left ()
<a name="l00849"></a>00849               + blobcoords[startx -
<a name="l00850"></a>00850               test_blob].right ()) /
<a name="l00851"></a>00851               2.0,
<a name="l00852"></a>00852               blobcoords[startx -
<a name="l00853"></a>00853               test_blob].bottom ());
<a name="l00854"></a>00854             diff = m * coord.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a> () + c - coord.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a> ();
<a name="l00855"></a>00855             <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l00856"></a>00856               <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>
<a name="l00857"></a>00857                 (<span class="stringliteral">&quot;Diff of common blob to suspect part=%g at (%g,%g)\n&quot;</span>,
<a name="l00858"></a>00858                 diff, coord.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a> (), coord.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a> ());
<a name="l00859"></a>00859             <span class="keywordflow">if</span> (diff &lt; jumplimit &amp;&amp; -diff &lt; jumplimit)
<a name="l00860"></a>00860               close_one = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00861"></a>00861           }
<a name="l00862"></a>00862           <span class="keywordflow">if</span> (blobindex + test_blob &lt;= blobcount
<a name="l00863"></a>00863           &amp;&amp; partids[blobindex + test_blob - 1] == biggestpart) {
<a name="l00864"></a>00864             found_one = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00865"></a>00865             coord =
<a name="l00866"></a>00866               <a class="code" href="class_f_c_o_o_r_d.html">FCOORD</a> ((blobcoords[blobindex + test_blob - 1].
<a name="l00867"></a>00867               left () + blobcoords[blobindex + test_blob -
<a name="l00868"></a>00868               1].right ()) / 2.0,
<a name="l00869"></a>00869               blobcoords[blobindex + test_blob -
<a name="l00870"></a>00870               1].bottom ());
<a name="l00871"></a>00871             diff = m * coord.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a> () + c - coord.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a> ();
<a name="l00872"></a>00872             <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l00873"></a>00873               <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>
<a name="l00874"></a>00874                 (<span class="stringliteral">&quot;Diff of common blob to suspect part=%g at (%g,%g)\n&quot;</span>,
<a name="l00875"></a>00875                 diff, coord.<a class="code" href="class_f_c_o_o_r_d.html#a9edadbfc357c730f62fa3c92677b0d58">x</a> (), coord.<a class="code" href="class_f_c_o_o_r_d.html#a397f7ce997b246df18e7bd5a20cc422e">y</a> ());
<a name="l00876"></a>00876             <span class="keywordflow">if</span> (diff &lt; jumplimit &amp;&amp; -diff &lt; jumplimit)
<a name="l00877"></a>00877               close_one = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00878"></a>00878           }
<a name="l00879"></a>00879         }
<a name="l00880"></a>00880         <span class="keywordflow">if</span> (close_one) {
<a name="l00881"></a>00881           <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l00882"></a>00882             <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>
<a name="l00883"></a>00883               (<span class="stringliteral">&quot;Merged %d blobs back into part %d from %d starting at (%d,%d)\n&quot;</span>,
<a name="l00884"></a>00884               runlength, biggestpart, prevpart,
<a name="l00885"></a>00885               blobcoords[startx].left (),
<a name="l00886"></a>00886               blobcoords[startx].bottom ());
<a name="l00887"></a>00887                                  <span class="comment">//switch sides</span>
<a name="l00888"></a>00888           partsizes[prevpart] -= runlength;
<a name="l00889"></a>00889           <span class="keywordflow">for</span> (test_blob = startx; test_blob &lt; blobindex; test_blob++)
<a name="l00890"></a>00890             partids[test_blob] = biggestpart;
<a name="l00891"></a>00891         }
<a name="l00892"></a>00892       }
<a name="l00893"></a>00893       prevpart = partids[blobindex];
<a name="l00894"></a>00894       runlength = 1;
<a name="l00895"></a>00895       startx = blobindex;
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     <span class="keywordflow">else</span>
<a name="l00898"></a>00898       runlength++;
<a name="l00899"></a>00899   }
<a name="l00900"></a>00900 }
<a name="l00901"></a>00901 
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="comment">/**********************************************************************</span>
<a name="l00904"></a>00904 <span class="comment"> * get_ydiffs</span>
<a name="l00905"></a>00905 <span class="comment"> *</span>
<a name="l00906"></a>00906 <span class="comment"> * Get the differences between the blobs and the spline,</span>
<a name="l00907"></a>00907 <span class="comment"> * putting them in ydiffs.  The return value is the index</span>
<a name="l00908"></a>00908 <span class="comment"> * of the blob in the middle of the &quot;best behaved&quot; region</span>
<a name="l00909"></a>00909 <span class="comment"> **********************************************************************/</span>
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 <span class="keywordtype">int</span>
<a name="l00912"></a><a class="code" href="oldbasel_8h.html#a8be53753ccb635852471514dcbf65b9f">00912</a> <a class="code" href="oldbasel_8cpp.html#a8be53753ccb635852471514dcbf65b9f">get_ydiffs</a> (                     <span class="comment">//evaluate differences</span>
<a name="l00913"></a>00913 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">//bounding boxes</span>
<a name="l00914"></a>00914 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobs */</span>
<a name="l00915"></a>00915 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * spline,                <span class="comment">/*approximating spline */</span>
<a name="l00916"></a>00916 <span class="keywordtype">float</span> ydiffs[]                   <span class="comment">/*output */</span>
<a name="l00917"></a>00917 ) {
<a name="l00918"></a>00918   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*current blob */</span>
<a name="l00919"></a>00919   <span class="keywordtype">int</span> xcentre;                   <span class="comment">/*xcoord */</span>
<a name="l00920"></a>00920   <span class="keywordtype">int</span> lastx;                     <span class="comment">/*last xcentre */</span>
<a name="l00921"></a>00921   <span class="keywordtype">float</span> diffsum;                 <span class="comment">/*sum of diffs */</span>
<a name="l00922"></a>00922   <span class="keywordtype">float</span> diff;                    <span class="comment">/*current difference */</span>
<a name="l00923"></a>00923   <span class="keywordtype">float</span> drift;                   <span class="comment">/*sum of spline steps */</span>
<a name="l00924"></a>00924   <span class="keywordtype">float</span> bestsum;                 <span class="comment">/*smallest diffsum */</span>
<a name="l00925"></a>00925   <span class="keywordtype">int</span> bestindex;                 <span class="comment">/*index of bestsum */</span>
<a name="l00926"></a>00926 
<a name="l00927"></a>00927   diffsum = 0.0f;
<a name="l00928"></a>00928   bestindex = 0;
<a name="l00929"></a>00929   bestsum = (float) <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l00930"></a>00930   drift = 0.0f;
<a name="l00931"></a>00931   lastx = blobcoords[0].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ();
<a name="l00932"></a>00932                                  <span class="comment">/*do each blob in row */</span>
<a name="l00933"></a>00933   <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l00934"></a>00934                                  <span class="comment">/*centre of blob */</span>
<a name="l00935"></a>00935     xcentre = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () + blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) &gt;&gt; 1;
<a name="l00936"></a>00936                                  <span class="comment">//step functions in spline</span>
<a name="l00937"></a>00937     drift += spline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#aaebd602e34d8b7f4e7b73884f1701a75">step</a> (lastx, xcentre);
<a name="l00938"></a>00938     lastx = xcentre;
<a name="l00939"></a>00939     diff = blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ();
<a name="l00940"></a>00940     diff -= spline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcentre);
<a name="l00941"></a>00941     diff += drift;
<a name="l00942"></a>00942     ydiffs[blobindex] = diff;    <span class="comment">/*store difference */</span>
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (blobindex &gt; 2)
<a name="l00944"></a>00944                                  <span class="comment">/*remove old one */</span>
<a name="l00945"></a>00945       diffsum -= <a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (ydiffs[blobindex - 3]);
<a name="l00946"></a>00946     diffsum += <a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (diff);       <span class="comment">/*add new one */</span>
<a name="l00947"></a>00947     <span class="keywordflow">if</span> (blobindex &gt;= 2 &amp;&amp; diffsum &lt; bestsum) {
<a name="l00948"></a>00948       bestsum = diffsum;         <span class="comment">/*find min sum */</span>
<a name="l00949"></a>00949       bestindex = blobindex - 1; <span class="comment">/*middle of set */</span>
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951   }
<a name="l00952"></a>00952   <span class="keywordflow">return</span> bestindex;
<a name="l00953"></a>00953 }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="comment">/**********************************************************************</span>
<a name="l00957"></a>00957 <span class="comment"> * choose_partition</span>
<a name="l00958"></a>00958 <span class="comment"> *</span>
<a name="l00959"></a>00959 <span class="comment"> * Choose a partition for the point and return the index.</span>
<a name="l00960"></a>00960 <span class="comment"> **********************************************************************/</span>
<a name="l00961"></a>00961 
<a name="l00962"></a>00962 <span class="keywordtype">int</span>
<a name="l00963"></a><a class="code" href="oldbasel_8h.html#a2539b6c864909f4e310c90caef909099">00963</a> <a class="code" href="oldbasel_8cpp.html#a686c8b34dade68c0dd9e68ec7206739a">choose_partition</a> (               <span class="comment">//select partition</span>
<a name="l00964"></a>00964 <span class="keyword">register</span> <span class="keywordtype">float</span> diff,             <span class="comment">/*diff from spline */</span>
<a name="l00965"></a>00965 <span class="keywordtype">float</span> partdiffs[],               <span class="comment">/*diff on all parts */</span>
<a name="l00966"></a>00966 <span class="keywordtype">int</span> lastpart,                    <span class="comment">/*last assigned partition */</span>
<a name="l00967"></a>00967 <span class="keywordtype">float</span> jumplimit,                 <span class="comment">/*new part threshold */</span>
<a name="l00968"></a>00968 <span class="keywordtype">float</span>* drift,
<a name="l00969"></a>00969 <span class="keywordtype">float</span>* lastdelta,
<a name="l00970"></a>00970 <span class="keywordtype">int</span> *partcount                   <span class="comment">/*no of partitions */</span>
<a name="l00971"></a>00971 ) {
<a name="l00972"></a>00972   <span class="keyword">register</span> <span class="keywordtype">int</span> partition;        <span class="comment">/*partition no */</span>
<a name="l00973"></a>00973   <span class="keywordtype">int</span> bestpart;                  <span class="comment">/*best new partition */</span>
<a name="l00974"></a>00974   <span class="keywordtype">float</span> bestdelta;               <span class="comment">/*best gap from a part */</span>
<a name="l00975"></a>00975   <span class="keywordtype">float</span> delta;                   <span class="comment">/*diff from part */</span>
<a name="l00976"></a>00976 
<a name="l00977"></a>00977   <span class="keywordflow">if</span> (lastpart &lt; 0) {
<a name="l00978"></a>00978     partdiffs[0] = diff;
<a name="l00979"></a>00979     lastpart = 0;                <span class="comment">/*first point */</span>
<a name="l00980"></a>00980     *drift = 0.0f;
<a name="l00981"></a>00981     *lastdelta = 0.0f;
<a name="l00982"></a>00982   }
<a name="l00983"></a>00983                                  <span class="comment">/*adjusted diff from part */</span>
<a name="l00984"></a>00984   delta = diff - partdiffs[lastpart] - *drift;
<a name="l00985"></a>00985   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l00986"></a>00986     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Diff=%.2f, Delta=%.3f, Drift=%.3f, &quot;</span>, diff, delta, *drift);
<a name="l00987"></a>00987   }
<a name="l00988"></a>00988   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (delta) &gt; jumplimit / 2) {
<a name="l00989"></a>00989                                  <span class="comment">/*delta on part 0 */</span>
<a name="l00990"></a>00990     bestdelta = diff - partdiffs[0] - *drift;
<a name="l00991"></a>00991     bestpart = 0;                <span class="comment">/*0 best so far */</span>
<a name="l00992"></a>00992     <span class="keywordflow">for</span> (partition = 1; partition &lt; *partcount; partition++) {
<a name="l00993"></a>00993       delta = diff - partdiffs[partition] - *drift;
<a name="l00994"></a>00994       <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (delta) &lt; <a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (bestdelta)) {
<a name="l00995"></a>00995         bestdelta = delta;
<a name="l00996"></a>00996         bestpart = partition;    <span class="comment">/*part with nearest jump */</span>
<a name="l00997"></a>00997       }
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999     delta = bestdelta;
<a name="l01000"></a>01000                                  <span class="comment">/*too far away */</span>
<a name="l01001"></a>01001     <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (bestdelta) &gt; jumplimit
<a name="l01002"></a>01002     &amp;&amp; *partcount &lt; <a class="code" href="oldbasel_8cpp.html#a43c12716e71c3b49f1907bd935376e43">MAXPARTS</a>) {  <span class="comment">/*and spare part left */</span>
<a name="l01003"></a>01003       bestpart = (*partcount)++; <span class="comment">/*best was new one */</span>
<a name="l01004"></a>01004                                  <span class="comment">/*start new one */</span>
<a name="l01005"></a>01005       partdiffs[bestpart] = diff - *drift;
<a name="l01006"></a>01006       delta = 0.0f;
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008   }
<a name="l01009"></a>01009   <span class="keywordflow">else</span> {
<a name="l01010"></a>01010     bestpart = lastpart;         <span class="comment">/*best was last one */</span>
<a name="l01011"></a>01011   }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013   <span class="keywordflow">if</span> (bestpart == lastpart
<a name="l01014"></a>01014     &amp;&amp; (<a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (delta - *lastdelta) &lt; jumplimit / 2
<a name="l01015"></a>01015     || <a class="code" href="oldbasel_8cpp.html#a996f7be338ccb40d1a2a5abc1ad61759">ABS</a> (delta) &lt; jumplimit / 2))
<a name="l01016"></a>01016                                  <span class="comment">/*smooth the drift */</span>
<a name="l01017"></a>01017     *drift = (3 * *drift + delta) / 3;
<a name="l01018"></a>01018   *lastdelta = delta;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l01021"></a>01021     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;P=%d\n&quot;</span>, bestpart);
<a name="l01022"></a>01022   }
<a name="l01023"></a>01023 
<a name="l01024"></a>01024   <span class="keywordflow">return</span> bestpart;
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01027"></a>01027 
<a name="l01029"></a>01029 <span class="comment">//partitions and gives all the rest partid 0*/</span>
<a name="l01030"></a>01030 <span class="comment">//</span>
<a name="l01031"></a>01031 <span class="comment">//merge_partitions(partids,partcount,blobcount,bestpart)</span>
<a name="l01032"></a>01032 <span class="comment">//register char              *partids;                     /*partition numbers*/</span>
<a name="l01033"></a>01033 <span class="comment">//int                        partcount;                    /*no of partitions*/</span>
<a name="l01034"></a>01034 <span class="comment">//int                        blobcount;                    /*no of blobs*/</span>
<a name="l01035"></a>01035 <span class="comment">//int                        bestpart;                     /*best partition*/</span>
<a name="l01036"></a>01036 <span class="comment">//{</span>
<a name="l01037"></a>01037 <span class="comment">//   register int            blobindex;                    /*no along text line*/</span>
<a name="l01038"></a>01038 <span class="comment">//   int                     runlength;                    /*run of same partition*/</span>
<a name="l01039"></a>01039 <span class="comment">//   int                     bestrun;                      /*biggest runlength*/</span>
<a name="l01040"></a>01040 <span class="comment">//</span>
<a name="l01041"></a>01041 <span class="comment">//   bestrun=0;                                            /*no runs yet*/</span>
<a name="l01042"></a>01042 <span class="comment">//   runlength=1;</span>
<a name="l01043"></a>01043 <span class="comment">//   for (blobindex=1;blobindex&lt;blobcount;blobindex++)</span>
<a name="l01044"></a>01044 <span class="comment">//   {  if (partids[blobindex]!=partids[blobindex-1])</span>
<a name="l01045"></a>01045 <span class="comment">//      {  if (runlength&gt;bestrun)</span>
<a name="l01046"></a>01046 <span class="comment">//            bestrun=runlength;                           /*find biggest run*/</span>
<a name="l01047"></a>01047 <span class="comment">//         runlength=1;                                    /*new run*/</span>
<a name="l01048"></a>01048 <span class="comment">//      }</span>
<a name="l01049"></a>01049 <span class="comment">//      else</span>
<a name="l01050"></a>01050 <span class="comment">//      {  runlength++;</span>
<a name="l01051"></a>01051 <span class="comment">//      }</span>
<a name="l01052"></a>01052 <span class="comment">//   }</span>
<a name="l01053"></a>01053 <span class="comment">//   if (runlength&gt;bestrun)</span>
<a name="l01054"></a>01054 <span class="comment">//      bestrun=runlength;</span>
<a name="l01055"></a>01055 <span class="comment">//</span>
<a name="l01056"></a>01056 <span class="comment">//   for (blobindex=0;blobindex&lt;blobcount;blobindex++)</span>
<a name="l01057"></a>01057 <span class="comment">//   {  if (blobindex&lt;1</span>
<a name="l01058"></a>01058 <span class="comment">//      || partids[blobindex]!=partids[blobindex-1])</span>
<a name="l01059"></a>01059 <span class="comment">//      {  if ((blobindex+1&gt;=blobcount</span>
<a name="l01060"></a>01060 <span class="comment">//         || partids[blobindex]!=partids[blobindex+1])</span>
<a name="l01061"></a>01061 <span class="comment">//                                                         /*loner*/</span>
<a name="l01062"></a>01062 <span class="comment">//         &amp;&amp; (bestrun&gt;2 || partids[blobindex]!=bestpart))</span>
<a name="l01063"></a>01063 <span class="comment">//         {  partids[blobindex]=partcount;                /*discard loner*/</span>
<a name="l01064"></a>01064 <span class="comment">//         }</span>
<a name="l01065"></a>01065 <span class="comment">//         else if (blobindex+1&lt;blobcount</span>
<a name="l01066"></a>01066 <span class="comment">//         &amp;&amp; partids[blobindex]==partids[blobindex+1]</span>
<a name="l01067"></a>01067 <span class="comment">//                                                         /*pair*/</span>
<a name="l01068"></a>01068 <span class="comment">//         &amp;&amp; (blobindex+2&gt;=blobcount</span>
<a name="l01069"></a>01069 <span class="comment">//         || partids[blobindex]!=partids[blobindex+2])</span>
<a name="l01070"></a>01070 <span class="comment">//         &amp;&amp; (bestrun&gt;3 || partids[blobindex]!=bestpart))</span>
<a name="l01071"></a>01071 <span class="comment">//         {  partids[blobindex]=partcount;                /*discard both*/</span>
<a name="l01072"></a>01072 <span class="comment">//            partids[blobindex+1]=partcount;</span>
<a name="l01073"></a>01073 <span class="comment">//         }</span>
<a name="l01074"></a>01074 <span class="comment">//      }</span>
<a name="l01075"></a>01075 <span class="comment">//   }</span>
<a name="l01076"></a>01076 <span class="comment">//   for (blobindex=0;blobindex&lt;blobcount;blobindex++)</span>
<a name="l01077"></a>01077 <span class="comment">//   {  if (partids[blobindex]&lt;partcount)</span>
<a name="l01078"></a>01078 <span class="comment">//         partids[blobindex]=0;                           /*all others together*/</span>
<a name="l01079"></a>01079 <span class="comment">//   }</span>
<a name="l01080"></a>01080 <span class="comment">//}</span>
<a name="l01081"></a>01081 
<a name="l01082"></a>01082 <span class="comment">/**********************************************************************</span>
<a name="l01083"></a>01083 <span class="comment"> * partition_coords</span>
<a name="l01084"></a>01084 <span class="comment"> *</span>
<a name="l01085"></a>01085 <span class="comment"> * Get the x,y coordinates of all points in the bestpart and put them</span>
<a name="l01086"></a>01086 <span class="comment"> * in xcoords,ycoords. Return the number of points found.</span>
<a name="l01087"></a>01087 <span class="comment"> **********************************************************************/</span>
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 <span class="keywordtype">int</span>
<a name="l01090"></a><a class="code" href="oldbasel_8h.html#aad2034679e53c7d16b8306b773c552a7">01090</a> <a class="code" href="oldbasel_8cpp.html#aad2034679e53c7d16b8306b773c552a7" title="*merge_partitions(partids,partcount,blobcount,bestpart) discards funny looking">partition_coords</a> (               <span class="comment">//find relevant coords</span>
<a name="l01091"></a>01091 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">//bounding boxes</span>
<a name="l01092"></a>01092 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobs in row */</span>
<a name="l01093"></a>01093 <span class="keywordtype">char</span> partids[],                  <span class="comment">/*partition no of each blob */</span>
<a name="l01094"></a>01094 <span class="keywordtype">int</span> bestpart,                    <span class="comment">/*best new partition */</span>
<a name="l01095"></a>01095 <span class="keywordtype">int</span> xcoords[],                   <span class="comment">/*points to work on */</span>
<a name="l01096"></a>01096 <span class="keywordtype">int</span> ycoords[]                    <span class="comment">/*points to work on */</span>
<a name="l01097"></a>01097 ) {
<a name="l01098"></a>01098   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*no along text line */</span>
<a name="l01099"></a>01099   <span class="keywordtype">int</span> pointcount;                <span class="comment">/*no of points */</span>
<a name="l01100"></a>01100 
<a name="l01101"></a>01101   pointcount = 0;
<a name="l01102"></a>01102   <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l01103"></a>01103     <span class="keywordflow">if</span> (partids[blobindex] == bestpart) {
<a name="l01104"></a>01104                                  <span class="comment">/*centre of blob */</span>
<a name="l01105"></a>01105       xcoords[pointcount] = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () + blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) &gt;&gt; 1;
<a name="l01106"></a>01106       ycoords[pointcount++] = blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ();
<a name="l01107"></a>01107     }
<a name="l01108"></a>01108   }
<a name="l01109"></a>01109   <span class="keywordflow">return</span> pointcount;             <span class="comment">/*no of points found */</span>
<a name="l01110"></a>01110 }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="comment">/**********************************************************************</span>
<a name="l01114"></a>01114 <span class="comment"> * segment_spline</span>
<a name="l01115"></a>01115 <span class="comment"> *</span>
<a name="l01116"></a>01116 <span class="comment"> * Segment the row at midpoints between maxima and minima of the x,y pairs.</span>
<a name="l01117"></a>01117 <span class="comment"> * The xstarts of the segments are returned and the number found.</span>
<a name="l01118"></a>01118 <span class="comment"> **********************************************************************/</span>
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 <span class="keywordtype">int</span>
<a name="l01121"></a><a class="code" href="oldbasel_8h.html#a320b77e1f7ecd371bdab9b4a0c3e10db">01121</a> <a class="code" href="oldbasel_8cpp.html#a320b77e1f7ecd371bdab9b4a0c3e10db">segment_spline</a> (                 <span class="comment">//make xstarts</span>
<a name="l01122"></a>01122 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">//boundign boxes</span>
<a name="l01123"></a>01123 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobs in row */</span>
<a name="l01124"></a>01124 <span class="keywordtype">int</span> xcoords[],                   <span class="comment">/*points to work on */</span>
<a name="l01125"></a>01125 <span class="keywordtype">int</span> ycoords[],                   <span class="comment">/*points to work on */</span>
<a name="l01126"></a>01126 <span class="keywordtype">int</span> degree, <span class="keywordtype">int</span> pointcount,      <span class="comment">/*no of points */</span>
<a name="l01127"></a>01127 <span class="keywordtype">int</span> xstarts[]                    <span class="comment">//result</span>
<a name="l01128"></a>01128 ) {
<a name="l01129"></a>01129   <span class="keyword">register</span> <span class="keywordtype">int</span> ptindex;          <span class="comment">/*no along text line */</span>
<a name="l01130"></a>01130   <span class="keyword">register</span> <span class="keywordtype">int</span> segment;          <span class="comment">/*partition no */</span>
<a name="l01131"></a>01131   <span class="keywordtype">int</span> lastmin, lastmax;          <span class="comment">/*possible turn points */</span>
<a name="l01132"></a>01132   <span class="keywordtype">int</span> turnpoints[<a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a>];    <span class="comment">/*good turning points */</span>
<a name="l01133"></a>01133   <span class="keywordtype">int</span> turncount;                 <span class="comment">/*no of turning points */</span>
<a name="l01134"></a>01134   <span class="keywordtype">int</span> max_x;                     <span class="comment">//max specified coord</span>
<a name="l01135"></a>01135 
<a name="l01136"></a>01136   xstarts[0] = xcoords[0] - 1;   <span class="comment">//leftmost defined pt</span>
<a name="l01137"></a>01137   max_x = xcoords[pointcount - 1] + 1;
<a name="l01138"></a>01138   <span class="keywordflow">if</span> (degree &lt; 2)
<a name="l01139"></a>01139     pointcount = 0;
<a name="l01140"></a>01140   turncount = 0;                 <span class="comment">/*no turning points yet */</span>
<a name="l01141"></a>01141   <span class="keywordflow">if</span> (pointcount &gt; 3) {
<a name="l01142"></a>01142     ptindex = 1;
<a name="l01143"></a>01143     lastmax = lastmin = 0;       <span class="comment">/*start with first one */</span>
<a name="l01144"></a>01144     <span class="keywordflow">while</span> (ptindex &lt; pointcount - 1 &amp;&amp; turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1) {
<a name="l01145"></a>01145                                  <span class="comment">/*minimum */</span>
<a name="l01146"></a>01146       <span class="keywordflow">if</span> (ycoords[ptindex - 1] &gt; ycoords[ptindex] &amp;&amp; ycoords[ptindex] &lt;= ycoords[ptindex + 1]) {
<a name="l01147"></a>01147         <span class="keywordflow">if</span> (ycoords[ptindex] &lt; ycoords[lastmax] - <a class="code" href="oldbasel_8cpp.html#a740201e7bcfb78e2fe8a8674096d13fe">TURNLIMIT</a>) {
<a name="l01148"></a>01148           <span class="keywordflow">if</span> (turncount == 0 || turnpoints[turncount - 1] != lastmax)
<a name="l01149"></a>01149                                  <span class="comment">/*new max point */</span>
<a name="l01150"></a>01150             turnpoints[turncount++] = lastmax;
<a name="l01151"></a>01151           lastmin = ptindex;     <span class="comment">/*latest minimum */</span>
<a name="l01152"></a>01152         }
<a name="l01153"></a>01153         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ycoords[ptindex] &lt; ycoords[lastmin]) {
<a name="l01154"></a>01154           lastmin = ptindex;     <span class="comment">/*lower minimum */</span>
<a name="l01155"></a>01155         }
<a name="l01156"></a>01156       }
<a name="l01157"></a>01157 
<a name="l01158"></a>01158                                  <span class="comment">/*maximum */</span>
<a name="l01159"></a>01159       <span class="keywordflow">if</span> (ycoords[ptindex - 1] &lt; ycoords[ptindex] &amp;&amp; ycoords[ptindex] &gt;= ycoords[ptindex + 1]) {
<a name="l01160"></a>01160         <span class="keywordflow">if</span> (ycoords[ptindex] &gt; ycoords[lastmin] + <a class="code" href="oldbasel_8cpp.html#a740201e7bcfb78e2fe8a8674096d13fe">TURNLIMIT</a>) {
<a name="l01161"></a>01161           <span class="keywordflow">if</span> (turncount == 0 || turnpoints[turncount - 1] != lastmin)
<a name="l01162"></a>01162                                  <span class="comment">/*new min point */</span>
<a name="l01163"></a>01163             turnpoints[turncount++] = lastmin;
<a name="l01164"></a>01164           lastmax = ptindex;     <span class="comment">/*latest maximum */</span>
<a name="l01165"></a>01165         }
<a name="l01166"></a>01166         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ycoords[ptindex] &gt; ycoords[lastmax]) {
<a name="l01167"></a>01167           lastmax = ptindex;     <span class="comment">/*higher maximum */</span>
<a name="l01168"></a>01168         }
<a name="l01169"></a>01169       }
<a name="l01170"></a>01170       ptindex++;
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172                                  <span class="comment">/*possible global min */</span>
<a name="l01173"></a>01173     <span class="keywordflow">if</span> (ycoords[ptindex] &lt; ycoords[lastmax] - <a class="code" href="oldbasel_8cpp.html#a740201e7bcfb78e2fe8a8674096d13fe">TURNLIMIT</a>
<a name="l01174"></a>01174     &amp;&amp; (turncount == 0 || turnpoints[turncount - 1] != lastmax)) {
<a name="l01175"></a>01175       <span class="keywordflow">if</span> (turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1)
<a name="l01176"></a>01176                                  <span class="comment">/*2 more turns */</span>
<a name="l01177"></a>01177         turnpoints[turncount++] = lastmax;
<a name="l01178"></a>01178       <span class="keywordflow">if</span> (turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1)
<a name="l01179"></a>01179         turnpoints[turncount++] = ptindex;
<a name="l01180"></a>01180     }
<a name="l01181"></a>01181     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ycoords[ptindex] &gt; ycoords[lastmin] + <a class="code" href="oldbasel_8cpp.html#a740201e7bcfb78e2fe8a8674096d13fe">TURNLIMIT</a>
<a name="l01182"></a>01182       <span class="comment">/*possible global max */</span>
<a name="l01183"></a>01183     &amp;&amp; (turncount == 0 || turnpoints[turncount - 1] != lastmin)) {
<a name="l01184"></a>01184       <span class="keywordflow">if</span> (turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1)
<a name="l01185"></a>01185                                  <span class="comment">/*2 more turns */</span>
<a name="l01186"></a>01186         turnpoints[turncount++] = lastmin;
<a name="l01187"></a>01187       <span class="keywordflow">if</span> (turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1)
<a name="l01188"></a>01188         turnpoints[turncount++] = ptindex;
<a name="l01189"></a>01189     }
<a name="l01190"></a>01190     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (turncount &gt; 0 &amp;&amp; turnpoints[turncount - 1] == lastmin
<a name="l01191"></a>01191     &amp;&amp; turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1) {
<a name="l01192"></a>01192       <span class="keywordflow">if</span> (ycoords[ptindex] &gt; ycoords[lastmax])
<a name="l01193"></a>01193         turnpoints[turncount++] = ptindex;
<a name="l01194"></a>01194       <span class="keywordflow">else</span>
<a name="l01195"></a>01195         turnpoints[turncount++] = lastmax;
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (turncount &gt; 0 &amp;&amp; turnpoints[turncount - 1] == lastmax
<a name="l01198"></a>01198     &amp;&amp; turncount &lt; <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a> - 1) {
<a name="l01199"></a>01199       <span class="keywordflow">if</span> (ycoords[ptindex] &lt; ycoords[lastmin])
<a name="l01200"></a>01200         turnpoints[turncount++] = ptindex;
<a name="l01201"></a>01201       <span class="keywordflow">else</span>
<a name="l01202"></a>01202         turnpoints[turncount++] = lastmin;
<a name="l01203"></a>01203     }
<a name="l01204"></a>01204   }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a> &amp;&amp; turncount &gt; 0)
<a name="l01207"></a>01207     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;First turn is %d at (%d,%d)\n&quot;</span>,
<a name="l01208"></a>01208       turnpoints[0], xcoords[turnpoints[0]], ycoords[turnpoints[0]]);
<a name="l01209"></a>01209   <span class="keywordflow">for</span> (segment = 1; segment &lt; turncount; segment++) {
<a name="l01210"></a>01210                                  <span class="comment">/*centre y coord */</span>
<a name="l01211"></a>01211     lastmax = (ycoords[turnpoints[segment - 1]] + ycoords[turnpoints[segment]]) / 2;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213     <span class="comment">/* fix alg so that it works with both rising and falling sections */</span>
<a name="l01214"></a>01214     <span class="keywordflow">if</span> (ycoords[turnpoints[segment - 1]] &lt; ycoords[turnpoints[segment]])
<a name="l01215"></a>01215                                  <span class="comment">/*find rising y centre */</span>
<a name="l01216"></a>01216       <span class="keywordflow">for</span> (ptindex = turnpoints[segment - 1] + 1; ptindex &lt; turnpoints[segment] &amp;&amp; ycoords[ptindex + 1] &lt;= lastmax; ptindex++);
<a name="l01217"></a>01217     <span class="keywordflow">else</span>
<a name="l01218"></a>01218                                  <span class="comment">/*find falling y centre */</span>
<a name="l01219"></a>01219       <span class="keywordflow">for</span> (ptindex = turnpoints[segment - 1] + 1; ptindex &lt; turnpoints[segment] &amp;&amp; ycoords[ptindex + 1] &gt;= lastmax; ptindex++);
<a name="l01220"></a>01220 
<a name="l01221"></a>01221                                  <span class="comment">/*centre x */</span>
<a name="l01222"></a>01222     xstarts[segment] = (xcoords[ptindex - 1] + xcoords[ptindex]
<a name="l01223"></a>01223       + xcoords[turnpoints[segment - 1]]
<a name="l01224"></a>01224       + xcoords[turnpoints[segment]] + 2) / 4;
<a name="l01225"></a>01225     <span class="comment">/*halfway between turns */</span>
<a name="l01226"></a>01226     <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l01227"></a>01227       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Turn %d is %d at (%d,%d), mid pt is %d@%d, final @%d\n&quot;</span>,
<a name="l01228"></a>01228         segment, turnpoints[segment],
<a name="l01229"></a>01229         xcoords[turnpoints[segment]], ycoords[turnpoints[segment]],
<a name="l01230"></a>01230         ptindex - 1, xcoords[ptindex - 1], xstarts[segment]);
<a name="l01231"></a>01231   }
<a name="l01232"></a>01232 
<a name="l01233"></a>01233   xstarts[segment] = max_x;
<a name="l01234"></a>01234   <span class="keywordflow">return</span> segment;                <span class="comment">/*no of splines */</span>
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 <span class="comment">/**********************************************************************</span>
<a name="l01239"></a>01239 <span class="comment"> * split_stepped_spline</span>
<a name="l01240"></a>01240 <span class="comment"> *</span>
<a name="l01241"></a>01241 <span class="comment"> * Re-segment the spline in cases where there is a big step function.</span>
<a name="l01242"></a>01242 <span class="comment"> * Return TRUE if any were done.</span>
<a name="l01243"></a>01243 <span class="comment"> **********************************************************************/</span>
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a>
<a name="l01246"></a><a class="code" href="oldbasel_8h.html#a7ebf232cd4ed4b8feb53a47b8248903f">01246</a> <a class="code" href="oldbasel_8cpp.html#a7ebf232cd4ed4b8feb53a47b8248903f">split_stepped_spline</a> (           <span class="comment">//make xstarts</span>
<a name="l01247"></a>01247 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * <a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,              <span class="comment">//current shot</span>
<a name="l01248"></a>01248 <span class="keywordtype">float</span> jumplimit,                 <span class="comment">//max step fuction</span>
<a name="l01249"></a>01249 <span class="keywordtype">int</span> xcoords[],                   <span class="comment">/*points to work on */</span>
<a name="l01250"></a>01250 <span class="keywordtype">int</span> xstarts[],                   <span class="comment">//result</span>
<a name="l01251"></a>01251 <span class="keywordtype">int</span> &amp;segments                    <span class="comment">//no of segments</span>
<a name="l01252"></a>01252 ) {
<a name="l01253"></a>01253   <a class="code" href="host_8h.html#a7712a7e28433d0ade59219a129549b6f">BOOL8</a> doneany;                 <span class="comment">//return value</span>
<a name="l01254"></a>01254   <span class="keyword">register</span> <span class="keywordtype">int</span> segment;          <span class="comment">/*partition no */</span>
<a name="l01255"></a>01255   <span class="keywordtype">int</span> startindex, centreindex, endindex;
<a name="l01256"></a>01256   <span class="keywordtype">float</span> leftcoord, rightcoord;
<a name="l01257"></a>01257   <span class="keywordtype">int</span> leftindex, rightindex;
<a name="l01258"></a>01258   <span class="keywordtype">float</span> step;                    <span class="comment">//spline step</span>
<a name="l01259"></a>01259 
<a name="l01260"></a>01260   doneany = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01261"></a>01261   startindex = 0;
<a name="l01262"></a>01262   <span class="keywordflow">for</span> (segment = 1; segment &lt; segments - 1; segment++) {
<a name="l01263"></a>01263     step = baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#aaebd602e34d8b7f4e7b73884f1701a75">step</a> ((xstarts[segment - 1] + xstarts[segment]) / 2.0,
<a name="l01264"></a>01264       (xstarts[segment] + xstarts[segment + 1]) / 2.0);
<a name="l01265"></a>01265     <span class="keywordflow">if</span> (step &lt; 0)
<a name="l01266"></a>01266       step = -step;
<a name="l01267"></a>01267     <span class="keywordflow">if</span> (step &gt; jumplimit) {
<a name="l01268"></a>01268       <span class="keywordflow">while</span> (xcoords[startindex] &lt; xstarts[segment - 1])
<a name="l01269"></a>01269         startindex++;
<a name="l01270"></a>01270       centreindex = startindex;
<a name="l01271"></a>01271       <span class="keywordflow">while</span> (xcoords[centreindex] &lt; xstarts[segment])
<a name="l01272"></a>01272         centreindex++;
<a name="l01273"></a>01273       endindex = centreindex;
<a name="l01274"></a>01274       <span class="keywordflow">while</span> (xcoords[endindex] &lt; xstarts[segment + 1])
<a name="l01275"></a>01275         endindex++;
<a name="l01276"></a>01276       <span class="keywordflow">if</span> (segments &gt;= <a class="code" href="oldbasel_8cpp.html#a28ed3351013f0697aa3189e7cfb669fd">SPLINESIZE</a>) {
<a name="l01277"></a>01277         <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a2522a1ae924de60d6448da45f785b4f8">textord_debug_baselines</a>)
<a name="l01278"></a>01278           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Too many segments to resegment spline!!\n&quot;</span>);
<a name="l01279"></a>01279       }
<a name="l01280"></a>01280       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (endindex - startindex &gt;= <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a> * 3) {
<a name="l01281"></a>01281         <span class="keywordflow">while</span> (centreindex - startindex &lt;
<a name="l01282"></a>01282           <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a> * 3 / 2)
<a name="l01283"></a>01283           centreindex++;
<a name="l01284"></a>01284         <span class="keywordflow">while</span> (endindex - centreindex &lt;
<a name="l01285"></a>01285           <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a> * 3 / 2)
<a name="l01286"></a>01286           centreindex--;
<a name="l01287"></a>01287         leftindex = (startindex + startindex + centreindex) / 3;
<a name="l01288"></a>01288         rightindex = (centreindex + endindex + endindex) / 3;
<a name="l01289"></a>01289         leftcoord =
<a name="l01290"></a>01290           (xcoords[startindex] * 2 + xcoords[centreindex]) / 3.0;
<a name="l01291"></a>01291         rightcoord =
<a name="l01292"></a>01292           (xcoords[centreindex] + xcoords[endindex] * 2) / 3.0;
<a name="l01293"></a>01293         <span class="keywordflow">while</span> (xcoords[leftindex] &gt; leftcoord
<a name="l01294"></a>01294           &amp;&amp; leftindex - startindex &gt; <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a>)
<a name="l01295"></a>01295           leftindex--;
<a name="l01296"></a>01296         <span class="keywordflow">while</span> (xcoords[leftindex] &lt; leftcoord
<a name="l01297"></a>01297           &amp;&amp; centreindex - leftindex &gt;
<a name="l01298"></a>01298           <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a> / 2)
<a name="l01299"></a>01299           leftindex++;
<a name="l01300"></a>01300         <span class="keywordflow">if</span> (xcoords[leftindex] - leftcoord &gt;
<a name="l01301"></a>01301           leftcoord - xcoords[leftindex - 1])
<a name="l01302"></a>01302           leftindex--;
<a name="l01303"></a>01303         <span class="keywordflow">while</span> (xcoords[rightindex] &gt; rightcoord
<a name="l01304"></a>01304           &amp;&amp; rightindex - centreindex &gt;
<a name="l01305"></a>01305           <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a> / 2)
<a name="l01306"></a>01306           rightindex--;
<a name="l01307"></a>01307         <span class="keywordflow">while</span> (xcoords[rightindex] &lt; rightcoord
<a name="l01308"></a>01308           &amp;&amp; endindex - rightindex &gt; <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a>)
<a name="l01309"></a>01309           rightindex++;
<a name="l01310"></a>01310         <span class="keywordflow">if</span> (xcoords[rightindex] - rightcoord &gt;
<a name="l01311"></a>01311           rightcoord - xcoords[rightindex - 1])
<a name="l01312"></a>01312           rightindex--;
<a name="l01313"></a>01313         <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a2522a1ae924de60d6448da45f785b4f8">textord_debug_baselines</a>)
<a name="l01314"></a>01314           <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Splitting spline at %d with step %g at (%d,%d)\n&quot;</span>,
<a name="l01315"></a>01315             xstarts[segment],
<a name="l01316"></a>01316             baseline-&gt;
<a name="l01317"></a>01317             step ((xstarts[segment - 1] +
<a name="l01318"></a>01318             xstarts[segment]) / 2.0,
<a name="l01319"></a>01319             (xstarts[segment] +
<a name="l01320"></a>01320             xstarts[segment + 1]) / 2.0),
<a name="l01321"></a>01321             (xcoords[leftindex - 1] + xcoords[leftindex]) / 2,
<a name="l01322"></a>01322             (xcoords[rightindex - 1] + xcoords[rightindex]) / 2);
<a name="l01323"></a>01323         <a class="code" href="oldbasel_8cpp.html#a64dfef97655fe4ff4565ed05d7d0f53a">insert_spline_point</a> (xstarts, segment,
<a name="l01324"></a>01324           (xcoords[leftindex - 1] +
<a name="l01325"></a>01325           xcoords[leftindex]) / 2,
<a name="l01326"></a>01326           (xcoords[rightindex - 1] +
<a name="l01327"></a>01327           xcoords[rightindex]) / 2, segments);
<a name="l01328"></a>01328         doneany = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01329"></a>01329       }
<a name="l01330"></a>01330       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a2522a1ae924de60d6448da45f785b4f8">textord_debug_baselines</a>) {
<a name="l01331"></a>01331         <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a>
<a name="l01332"></a>01332           (<span class="stringliteral">&quot;Resegmenting spline failed - insufficient pts (%d,%d,%d,%d)\n&quot;</span>,
<a name="l01333"></a>01333           startindex, centreindex, endindex,
<a name="l01334"></a>01334           (<a class="code" href="host_8h.html#aba1f582fd0168f3ff9225d8c90fa9eb8">inT32</a>) <a class="code" href="makerow_8cpp.html#aa3f1e0813b0d1a67ec8fb489e1d11034">textord_spline_medianwin</a>);
<a name="l01335"></a>01335       }
<a name="l01336"></a>01336     }
<a name="l01337"></a>01337     <span class="comment">//              else tprintf(&quot;Spline step at %d is %g\n&quot;,</span>
<a name="l01338"></a>01338     <span class="comment">//                      xstarts[segment],</span>
<a name="l01339"></a>01339     <span class="comment">//                      baseline-&gt;step((xstarts[segment-1]+xstarts[segment])/2.0,</span>
<a name="l01340"></a>01340     <span class="comment">//                      (xstarts[segment]+xstarts[segment+1])/2.0));</span>
<a name="l01341"></a>01341   }
<a name="l01342"></a>01342   <span class="keywordflow">return</span> doneany;
<a name="l01343"></a>01343 }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 <span class="comment">/**********************************************************************</span>
<a name="l01347"></a>01347 <span class="comment"> * insert_spline_point</span>
<a name="l01348"></a>01348 <span class="comment"> *</span>
<a name="l01349"></a>01349 <span class="comment"> * Insert a new spline point and shuffle up the others.</span>
<a name="l01350"></a>01350 <span class="comment"> **********************************************************************/</span>
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 <span class="keywordtype">void</span>
<a name="l01353"></a><a class="code" href="oldbasel_8h.html#a64dfef97655fe4ff4565ed05d7d0f53a">01353</a> <a class="code" href="oldbasel_8cpp.html#a64dfef97655fe4ff4565ed05d7d0f53a">insert_spline_point</a> (            <span class="comment">//get descenders</span>
<a name="l01354"></a>01354 <span class="keywordtype">int</span> xstarts[],                   <span class="comment">//starts to shuffle</span>
<a name="l01355"></a>01355 <span class="keywordtype">int</span> segment,                     <span class="comment">//insertion pt</span>
<a name="l01356"></a>01356 <span class="keywordtype">int</span> coord1,                      <span class="comment">//coords to add</span>
<a name="l01357"></a>01357 <span class="keywordtype">int</span> coord2, <span class="keywordtype">int</span> &amp;segments        <span class="comment">//total segments</span>
<a name="l01358"></a>01358 ) {
<a name="l01359"></a>01359   <span class="keywordtype">int</span> index;                     <span class="comment">//for shuffling</span>
<a name="l01360"></a>01360 
<a name="l01361"></a>01361   <span class="keywordflow">for</span> (index = segments; index &gt; segment; index--)
<a name="l01362"></a>01362     xstarts[index + 1] = xstarts[index];
<a name="l01363"></a>01363   segments++;
<a name="l01364"></a>01364   xstarts[segment] = coord1;
<a name="l01365"></a>01365   xstarts[segment + 1] = coord2;
<a name="l01366"></a>01366 }
<a name="l01367"></a>01367 
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 <span class="comment">/**********************************************************************</span>
<a name="l01370"></a>01370 <span class="comment"> * find_lesser_parts</span>
<a name="l01371"></a>01371 <span class="comment"> *</span>
<a name="l01372"></a>01372 <span class="comment"> * Average the step from the spline for the other partitions</span>
<a name="l01373"></a>01373 <span class="comment"> * and find the commonest partition which has a descender.</span>
<a name="l01374"></a>01374 <span class="comment"> **********************************************************************/</span>
<a name="l01375"></a>01375 
<a name="l01376"></a>01376 <span class="keywordtype">void</span>
<a name="l01377"></a><a class="code" href="oldbasel_8h.html#a010670c118cee8bc7b8c74125084ac30">01377</a> <a class="code" href="oldbasel_8cpp.html#a010670c118cee8bc7b8c74125084ac30">find_lesser_parts</a> (              <span class="comment">//get descenders</span>
<a name="l01378"></a>01378 <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> * row,                    <span class="comment">//row to process</span>
<a name="l01379"></a>01379 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">//bounding boxes</span>
<a name="l01380"></a>01380 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*no of blobs */</span>
<a name="l01381"></a>01381 <span class="keywordtype">char</span> partids[],                  <span class="comment">/*partition of each blob */</span>
<a name="l01382"></a>01382 <span class="keywordtype">int</span> partsizes[],                 <span class="comment">/*size of each part */</span>
<a name="l01383"></a>01383 <span class="keywordtype">int</span> partcount,                   <span class="comment">/*no of partitions */</span>
<a name="l01384"></a>01384 <span class="keywordtype">int</span> bestpart                     <span class="comment">/*biggest partition */</span>
<a name="l01385"></a>01385 ) {
<a name="l01386"></a>01386   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*index of blob */</span>
<a name="l01387"></a>01387   <span class="keyword">register</span> <span class="keywordtype">int</span> partition;        <span class="comment">/*current partition */</span>
<a name="l01388"></a>01388   <span class="keywordtype">int</span> xcentre;                   <span class="comment">/*centre of blob */</span>
<a name="l01389"></a>01389   <span class="keywordtype">int</span> poscount;                  <span class="comment">/*count of best up step */</span>
<a name="l01390"></a>01390   <span class="keywordtype">int</span> negcount;                  <span class="comment">/*count of best down step */</span>
<a name="l01391"></a>01391   <span class="keywordtype">float</span> partsteps[<a class="code" href="oldbasel_8cpp.html#a43c12716e71c3b49f1907bd935376e43">MAXPARTS</a>];     <span class="comment">/*average step to part */</span>
<a name="l01392"></a>01392   <span class="keywordtype">float</span> bestpos;                 <span class="comment">/*best up step */</span>
<a name="l01393"></a>01393   <span class="keywordtype">float</span> bestneg;                 <span class="comment">/*best down step */</span>
<a name="l01394"></a>01394   <span class="keywordtype">int</span> runlength;                 <span class="comment">/*length of bad run */</span>
<a name="l01395"></a>01395   <span class="keywordtype">int</span> biggestrun;                <span class="comment">/*biggest bad run */</span>
<a name="l01396"></a>01396 
<a name="l01397"></a>01397   biggestrun = 0;
<a name="l01398"></a>01398   <span class="keywordflow">for</span> (partition = 0; partition &lt; partcount; partition++)
<a name="l01399"></a>01399     partsteps[partition] = 0.0;  <span class="comment">/*zero accumulators */</span>
<a name="l01400"></a>01400   <span class="keywordflow">for</span> (runlength = 0, blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l01401"></a>01401     xcentre = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ()
<a name="l01402"></a>01402       + blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) &gt;&gt; 1;
<a name="l01403"></a>01403                                  <span class="comment">/*in other parts */</span>
<a name="l01404"></a>01404     <span class="keywordflow">if</span> (partids[blobindex] != bestpart) {
<a name="l01405"></a>01405       runlength++;               <span class="comment">/*run of non bests */</span>
<a name="l01406"></a>01406       <span class="keywordflow">if</span> (runlength &gt; biggestrun)
<a name="l01407"></a>01407         biggestrun = runlength;
<a name="l01408"></a>01408       partsteps[partids[blobindex]] += blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a4451d237f1cd18c4982d63fe36a11fc3">bottom</a> ()
<a name="l01409"></a>01409         - row-&gt;<a class="code" href="class_t_o___r_o_w.html#a611050c4612df0ccd0f2d64ca0005b9b">baseline</a>.<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcentre);
<a name="l01410"></a>01410     }
<a name="l01411"></a>01411     <span class="keywordflow">else</span>
<a name="l01412"></a>01412       runlength = 0;
<a name="l01413"></a>01413   }
<a name="l01414"></a>01414   <span class="keywordflow">if</span> (biggestrun &gt; <a class="code" href="oldbasel_8cpp.html#a058e03b643cfba9a6b7899b9a91f9bcb">MAXBADRUN</a>)
<a name="l01415"></a>01415     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = -1.0f;        <span class="comment">/*failed */</span>
<a name="l01416"></a>01416   <span class="keywordflow">else</span>
<a name="l01417"></a>01417     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = 1.0f;         <span class="comment">/*success */</span>
<a name="l01418"></a>01418   poscount = negcount = 0;
<a name="l01419"></a>01419   bestpos = bestneg = 0.0;       <span class="comment">/*no step yet */</span>
<a name="l01420"></a>01420   <span class="keywordflow">for</span> (partition = 0; partition &lt; partcount; partition++) {
<a name="l01421"></a>01421     <span class="keywordflow">if</span> (partition != bestpart) {
<a name="l01422"></a>01422 
<a name="l01423"></a>01423         <span class="comment">//by jetsoft divide by zero possible</span>
<a name="l01424"></a>01424                 <span class="keywordflow">if</span> (partsizes[partition]==0)
<a name="l01425"></a>01425                 partsteps[partition]=0;
<a name="l01426"></a>01426        <span class="keywordflow">else</span>
<a name="l01427"></a>01427                 partsteps[partition] /= partsizes[partition];
<a name="l01428"></a>01428         <span class="comment">//</span>
<a name="l01429"></a>01429 
<a name="l01430"></a>01430 
<a name="l01431"></a>01431       <span class="keywordflow">if</span> (partsteps[partition] &gt;= <a class="code" href="oldbasel_8cpp.html#ae325902750f29296b4fb7ae22ecbb3dd">MINASCRISE</a>
<a name="l01432"></a>01432       &amp;&amp; partsizes[partition] &gt; poscount) {
<a name="l01433"></a>01433                                  <span class="comment">/*ascender rise */</span>
<a name="l01434"></a>01434         bestpos = partsteps[partition];
<a name="l01435"></a>01435                                  <span class="comment">/*2nd most popular */</span>
<a name="l01436"></a>01436         poscount = partsizes[partition];
<a name="l01437"></a>01437       }
<a name="l01438"></a>01438       <span class="keywordflow">if</span> (partsteps[partition] &lt;= -<a class="code" href="oldbasel_8cpp.html#ae325902750f29296b4fb7ae22ecbb3dd">MINASCRISE</a>
<a name="l01439"></a>01439       &amp;&amp; partsizes[partition] &gt; negcount) {
<a name="l01440"></a>01440                                  <span class="comment">/*ascender rise */</span>
<a name="l01441"></a>01441         bestneg = partsteps[partition];
<a name="l01442"></a>01442                                  <span class="comment">/*2nd most popular */</span>
<a name="l01443"></a>01443         negcount = partsizes[partition];
<a name="l01444"></a>01444       }
<a name="l01445"></a>01445     }
<a name="l01446"></a>01446   }
<a name="l01447"></a>01447                                  <span class="comment">/*average x-height */</span>
<a name="l01448"></a>01448   partsteps[bestpart] /= blobcount;
<a name="l01449"></a>01449   row-&gt;<a class="code" href="class_t_o___r_o_w.html#acc50308b9a0cd5c73184de33971c55a8">descdrop</a> = bestneg;
<a name="l01450"></a>01450 }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452 
<a name="l01453"></a>01453 <span class="comment">/**********************************************************************</span>
<a name="l01454"></a>01454 <span class="comment"> * old_first_xheight</span>
<a name="l01455"></a>01455 <span class="comment"> *</span>
<a name="l01456"></a>01456 <span class="comment"> * Makes an x-height spline by copying the baseline and shifting it.</span>
<a name="l01457"></a>01457 <span class="comment"> * It estimates the x-height across the line to use as the shift.</span>
<a name="l01458"></a>01458 <span class="comment"> * It also finds the ascender height if it can.</span>
<a name="l01459"></a>01459 <span class="comment"> **********************************************************************/</span>
<a name="l01460"></a>01460 
<a name="l01461"></a>01461 <span class="keywordtype">void</span>
<a name="l01462"></a><a class="code" href="oldbasel_8h.html#a7d9be1c4d4bb8e4df217ddd66862b8ee">01462</a> <a class="code" href="oldbasel_8cpp.html#a7d9be1c4d4bb8e4df217ddd66862b8ee">old_first_xheight</a> (              <span class="comment">//the wiseowl way</span>
<a name="l01463"></a>01463 <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> * row,                    <span class="comment">/*current row */</span>
<a name="l01464"></a>01464 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">/*blob bounding boxes */</span>
<a name="l01465"></a>01465 <span class="keywordtype">int</span> initialheight,               <span class="comment">//initial guess</span>
<a name="l01466"></a>01466 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*blobs in blobcoords */</span>
<a name="l01467"></a>01467 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * <a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,              <span class="comment">/*established */</span>
<a name="l01468"></a>01468 <span class="keywordtype">float</span> jumplimit                  <span class="comment">/*min ascender height */</span>
<a name="l01469"></a>01469 ) {
<a name="l01470"></a>01470   <span class="keyword">register</span> <span class="keywordtype">int</span> blobindex;        <span class="comment">/*current blob */</span>
<a name="l01471"></a>01471                                  <span class="comment">/*height statistics */</span>
<a name="l01472"></a>01472   <a class="code" href="class_s_t_a_t_s.html">STATS</a> heightstat (0, <a class="code" href="oldbasel_8cpp.html#ade1da022379102bc94d127f9c6358fe7">MAXHEIGHT</a>);
<a name="l01473"></a>01473   <span class="keywordtype">int</span> height;                    <span class="comment">/*height of blob */</span>
<a name="l01474"></a>01474   <span class="keywordtype">int</span> xcentre;                   <span class="comment">/*centre of blob */</span>
<a name="l01475"></a>01475   <span class="keywordtype">int</span> lineheight;                <span class="comment">/*approx xheight */</span>
<a name="l01476"></a>01476   <span class="keywordtype">float</span> ascenders;               <span class="comment">/*ascender sum */</span>
<a name="l01477"></a>01477   <span class="keywordtype">int</span> asccount;                  <span class="comment">/*no of ascenders */</span>
<a name="l01478"></a>01478   <span class="keywordtype">float</span> xsum;                    <span class="comment">/*xheight sum */</span>
<a name="l01479"></a>01479   <span class="keywordtype">int</span> xcount;                    <span class="comment">/*xheight count */</span>
<a name="l01480"></a>01480   <span class="keyword">register</span> <span class="keywordtype">float</span> diff;           <span class="comment">/*height difference */</span>
<a name="l01481"></a>01481 
<a name="l01482"></a>01482   <span class="keywordflow">if</span> (blobcount &gt; 1) {
<a name="l01483"></a>01483     <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l01484"></a>01484       xcentre = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ()
<a name="l01485"></a>01485         + blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) / 2;
<a name="l01486"></a>01486                                  <span class="comment">/*height of blob */</span>
<a name="l01487"></a>01487       height = (int) (blobcoords[blobindex].top () - baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcentre) + 0.5);
<a name="l01488"></a>01488       <span class="keywordflow">if</span> (height &gt; initialheight * <a class="code" href="oldbasel_8cpp.html#a9af9cfbc0c19dbe46551c127ed70e6e4">oldbl_xhfract</a>
<a name="l01489"></a>01489         &amp;&amp; height &gt; <a class="code" href="makerow_8cpp.html#a995fba1cadc1bb12bd1861d2e1d4bf4a">textord_min_xheight</a>)
<a name="l01490"></a>01490         heightstat.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a> (height, 1);
<a name="l01491"></a>01491     }
<a name="l01492"></a>01492     <span class="keywordflow">if</span> (heightstat.<a class="code" href="class_s_t_a_t_s.html#a83ad18e6ba02e9f63f4f7d84fcf76aa4">get_total</a> () &gt; 3) {
<a name="l01493"></a>01493       lineheight = (int) heightstat.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a> (0.25);
<a name="l01494"></a>01494       <span class="keywordflow">if</span> (lineheight &lt;= 0)
<a name="l01495"></a>01495         lineheight = (int) heightstat.<a class="code" href="class_s_t_a_t_s.html#a3fc40518660ac7a89adef4919361270c">ile</a> (0.5);
<a name="l01496"></a>01496     }
<a name="l01497"></a>01497     <span class="keywordflow">else</span>
<a name="l01498"></a>01498       lineheight = initialheight;
<a name="l01499"></a>01499   }
<a name="l01500"></a>01500   <span class="keywordflow">else</span> {
<a name="l01501"></a>01501     lineheight = (int) (blobcoords[0].top ()
<a name="l01502"></a>01502       - baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> ((blobcoords[0].left ()
<a name="l01503"></a>01503       + blobcoords[0].right ()) / 2) +
<a name="l01504"></a>01504       0.5);
<a name="l01505"></a>01505   }
<a name="l01506"></a>01506 
<a name="l01507"></a>01507   xsum = 0.0f;
<a name="l01508"></a>01508   xcount = 0;
<a name="l01509"></a>01509   <span class="keywordflow">for</span> (ascenders = 0.0<a class="code" href="imgscale_8cpp.html#a469169df397b589e709dc744f1346831">f</a>, asccount = 0, blobindex = 0; blobindex &lt; blobcount;
<a name="l01510"></a>01510   blobindex++) {
<a name="l01511"></a>01511     xcentre = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> ()
<a name="l01512"></a>01512       + blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) / 2;
<a name="l01513"></a>01513     diff = blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a> () - baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a> (xcentre);
<a name="l01514"></a>01514                                  <span class="comment">/*is it ascender */</span>
<a name="l01515"></a>01515     <span class="keywordflow">if</span> (diff &gt; lineheight + jumplimit) {
<a name="l01516"></a>01516       ascenders += diff;
<a name="l01517"></a>01517       asccount++;                <span class="comment">/*count ascenders */</span>
<a name="l01518"></a>01518     }
<a name="l01519"></a>01519     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (diff &gt; lineheight - jumplimit) {
<a name="l01520"></a>01520       xsum += diff;              <span class="comment">/*mean xheight */</span>
<a name="l01521"></a>01521       xcount++;
<a name="l01522"></a>01522     }
<a name="l01523"></a>01523   }
<a name="l01524"></a>01524   <span class="keywordflow">if</span> (xcount &gt; 0)
<a name="l01525"></a>01525     xsum /= xcount;              <span class="comment">/*average xheight */</span>
<a name="l01526"></a>01526   <span class="keywordflow">else</span>
<a name="l01527"></a>01527     xsum = (float) lineheight;   <span class="comment">/*guess it */</span>
<a name="l01528"></a>01528   row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> *= xsum;
<a name="l01529"></a>01529   <span class="keywordflow">if</span> (asccount &gt; 0)
<a name="l01530"></a>01530     row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = ascenders / asccount - xsum;
<a name="l01531"></a>01531   <span class="keywordflow">else</span>
<a name="l01532"></a>01532     row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = 0.0f;         <span class="comment">/*had none */</span>
<a name="l01533"></a>01533   <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> == 0)
<a name="l01534"></a>01534     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = -1.0f;
<a name="l01535"></a>01535 }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537 
<a name="l01538"></a>01538 <span class="comment">/**********************************************************************</span>
<a name="l01539"></a>01539 <span class="comment"> * make_first_xheight</span>
<a name="l01540"></a>01540 <span class="comment"> *</span>
<a name="l01541"></a>01541 <span class="comment"> * Makes an x-height spline by copying the baseline and shifting it.</span>
<a name="l01542"></a>01542 <span class="comment"> * It estimates the x-height across the line to use as the shift.</span>
<a name="l01543"></a>01543 <span class="comment"> * It also finds the ascender height if it can.</span>
<a name="l01544"></a>01544 <span class="comment"> **********************************************************************/</span>
<a name="l01545"></a>01545 
<a name="l01546"></a>01546 <span class="keywordtype">void</span>
<a name="l01547"></a><a class="code" href="oldbasel_8h.html#a57a9e3ff2547db03b8a316f2fb25f017">01547</a> <a class="code" href="oldbasel_8cpp.html#a57a9e3ff2547db03b8a316f2fb25f017">make_first_xheight</a> (             <span class="comment">//find xheight</span>
<a name="l01548"></a>01548 <a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> * row,                    <span class="comment">/*current row */</span>
<a name="l01549"></a>01549 <a class="code" href="class_t_b_o_x.html">TBOX</a> blobcoords[],                <span class="comment">/*blob bounding boxes */</span>
<a name="l01550"></a>01550 <span class="keywordtype">int</span> lineheight,                  <span class="comment">//initial guess</span>
<a name="l01551"></a>01551 <span class="keywordtype">int</span> init_lineheight,             <span class="comment">//block level guess</span>
<a name="l01552"></a>01552 <span class="keywordtype">int</span> blobcount,                   <span class="comment">/*blobs in blobcoords */</span>
<a name="l01553"></a>01553 <a class="code" href="class_q_s_p_l_i_n_e.html">QSPLINE</a> * <a class="code" href="mfoutline_8h.html#a2a4b69f9a2827dc98bc4cbc233118865a83297de004f4e58b9be2108c6cd08a23">baseline</a>,              <span class="comment">/*established */</span>
<a name="l01554"></a>01554 <span class="keywordtype">float</span> jumplimit                  <span class="comment">/*min ascender height */</span>
<a name="l01555"></a>01555 ) {
<a name="l01556"></a>01556   <a class="code" href="class_s_t_a_t_s.html">STATS</a> heightstat (0, <a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a>);
<a name="l01557"></a>01557   <span class="keywordtype">int</span> lefts[<a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a>];
<a name="l01558"></a>01558   <span class="keywordtype">int</span> rights[<a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a>];
<a name="l01559"></a>01559   <span class="keywordtype">int</span> modelist[<a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>];
<a name="l01560"></a>01560   <span class="keywordtype">int</span> blobindex;
<a name="l01561"></a>01561   <span class="keywordtype">int</span> mode_count;                <span class="comment">//blobs to count in thr</span>
<a name="l01562"></a>01562   <span class="keywordtype">int</span> sign_bit;
<a name="l01563"></a>01563   <span class="keywordtype">int</span> mode_threshold;
<a name="l01564"></a>01564   <span class="keyword">const</span> <span class="keywordtype">int</span> kBaselineTouch = 2;  <span class="comment">// This really should change with resolution.</span>
<a name="l01565"></a>01565   <span class="keyword">const</span> <span class="keywordtype">int</span> kGoodStrength = 8;  <span class="comment">// Strength of baseline-touching heights.</span>
<a name="l01566"></a>01566   <span class="keyword">const</span> <span class="keywordtype">float</span> kMinHeight = 0.25;  <span class="comment">// Min fraction of lineheight to use.</span>
<a name="l01567"></a>01567 
<a name="l01568"></a>01568   sign_bit = row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &gt; 0 ? 1 : -1;
<a name="l01569"></a>01569 
<a name="l01570"></a>01570   memset(lefts, 0, <a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a> * <span class="keyword">sizeof</span>(lefts[0]));
<a name="l01571"></a>01571   memset(rights, 0, <a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a> * <span class="keyword">sizeof</span>(rights[0]));
<a name="l01572"></a>01572   mode_count = 0;
<a name="l01573"></a>01573   <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; blobcount; blobindex++) {
<a name="l01574"></a>01574     <span class="keywordtype">int</span> xcenter = (blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a724fabf566586b663577dfa944ffbc61">left</a> () +
<a name="l01575"></a>01575         blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#a8703081c1a1c26db3a4dddaca1028e34">right</a> ()) / 2;
<a name="l01576"></a>01576     <span class="keywordtype">float</span> base = baseline-&gt;<a class="code" href="class_q_s_p_l_i_n_e.html#ab9f77ca80057e3844e880a1bf003beca">y</a>(xcenter);
<a name="l01577"></a>01577     <span class="keywordtype">float</span> bottomdiff = fabs(base - blobcoords[blobindex].bottom());
<a name="l01578"></a>01578     <span class="keywordtype">int</span> strength = <a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">textord_ocropus_mode</a> &amp;&amp;
<a name="l01579"></a>01579                    bottomdiff &lt;= kBaselineTouch ? kGoodStrength : 1;
<a name="l01580"></a>01580     <span class="keywordtype">int</span> height = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(blobcoords[blobindex].<a class="code" href="class_t_b_o_x.html#adf92e9fdac1bdf11c10d1c4d1178791a">top</a> () - base + 0.5);
<a name="l01581"></a>01581     <span class="keywordflow">if</span> (blobcoords[blobindex].height () &gt; init_lineheight * kMinHeight) {
<a name="l01582"></a>01582       <span class="keywordflow">if</span> (height &gt; lineheight * <a class="code" href="oldbasel_8cpp.html#a9af9cfbc0c19dbe46551c127ed70e6e4">oldbl_xhfract</a>
<a name="l01583"></a>01583         &amp;&amp; height &gt; <a class="code" href="makerow_8cpp.html#a995fba1cadc1bb12bd1861d2e1d4bf4a">textord_min_xheight</a>) {
<a name="l01584"></a>01584         heightstat.<a class="code" href="class_s_t_a_t_s.html#ab8cacba14df28eed1bffc4cea0b2f87f">add</a> (height, strength);
<a name="l01585"></a>01585         <span class="keywordflow">if</span> (height &lt; <a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a>) {
<a name="l01586"></a>01586           <span class="keywordflow">if</span> (xcenter &gt; rights[height])
<a name="l01587"></a>01587             rights[height] = xcenter;
<a name="l01588"></a>01588           <span class="keywordflow">if</span> (xcenter &gt; 0 &amp;&amp; (lefts[height] == 0 || xcenter &lt; lefts[height]))
<a name="l01589"></a>01589             lefts[height] = xcenter;
<a name="l01590"></a>01590         }
<a name="l01591"></a>01591       }
<a name="l01592"></a>01592       mode_count += strength;
<a name="l01593"></a>01593     }
<a name="l01594"></a>01594   }
<a name="l01595"></a>01595 
<a name="l01596"></a>01596   mode_threshold = (int) (blobcount * 0.1);
<a name="l01597"></a>01597   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a1c777e24551f3606e42efe3bdb71d56c">oldbl_dot_error_size</a> &gt; 1 || <a class="code" href="oldbasel_8cpp.html#a96a1495ef629e0595833f43d1e0d8edd">oldbl_xhfix</a>)
<a name="l01598"></a>01598     mode_threshold = (int) (mode_count * 0.1);
<a name="l01599"></a>01599 
<a name="l01600"></a>01600   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l01601"></a>01601     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;blobcount=%d, mode_count=%d, mode_t=%d\n&quot;</span>,
<a name="l01602"></a>01602       blobcount, mode_count, mode_threshold);
<a name="l01603"></a>01603   }
<a name="l01604"></a>01604   <a class="code" href="oldbasel_8cpp.html#a2f17754e45de03ca3f0e2be965f8d4f4">find_top_modes</a>(&amp;heightstat, <a class="code" href="oldbasel_8cpp.html#a63c525ba0f53cbbfe37cb7900e8df67d">HEIGHTBUCKETS</a>, modelist, <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>);
<a name="l01605"></a>01605   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>) {
<a name="l01606"></a>01606     <span class="keywordflow">for</span> (blobindex = 0; blobindex &lt; <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>; blobindex++)
<a name="l01607"></a>01607       <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;mode[%d]=%d &quot;</span>, blobindex, modelist[blobindex]);
<a name="l01608"></a>01608     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01609"></a>01609   }
<a name="l01610"></a>01610   <a class="code" href="oldbasel_8cpp.html#a7cfd63f215d5f9d728d795ea43eaf7af">pick_x_height</a>(row, modelist, lefts, rights, &amp;heightstat, mode_threshold);
<a name="l01611"></a>01611 
<a name="l01612"></a>01612   <span class="keywordflow">if</span> (<a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l01613"></a>01613     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;Output xheight=%g\n&quot;</span>, row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>);
<a name="l01614"></a>01614   <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> &lt; 0 &amp;&amp; <a class="code" href="oldbasel_8cpp.html#a49b3afd2bc9858de5ba264e9e0ce74c7">textord_oldbl_debug</a>)
<a name="l01615"></a>01615     <a class="code" href="tprintf_8cpp.html#a0c2bcd4462ec67ab0971b34a0f610f55">tprintf</a> (<span class="stringliteral">&quot;warning: Row Line height &lt; 0; %4.2f\n&quot;</span>, row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>);
<a name="l01616"></a>01616 
<a name="l01617"></a>01617   <span class="keywordflow">if</span> (sign_bit &lt; 0)
<a name="l01618"></a>01618     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = -row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a>;
<a name="l01619"></a>01619 }
<a name="l01620"></a>01620 
<a name="l01621"></a>01621 <span class="comment">/**********************************************************************</span>
<a name="l01622"></a>01622 <span class="comment"> * find_top_modes</span>
<a name="l01623"></a>01623 <span class="comment"> *</span>
<a name="l01624"></a>01624 <span class="comment"> * Fill the input array with the indices of the top ten modes of the</span>
<a name="l01625"></a>01625 <span class="comment"> * input distribution.</span>
<a name="l01626"></a>01626 <span class="comment"> **********************************************************************/</span>
<a name="l01627"></a>01627 
<a name="l01628"></a><a class="code" href="oldbasel_8cpp.html#a4b62dc4268d026719e353774ec602bec">01628</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="oldbasel_8cpp.html#a4b62dc4268d026719e353774ec602bec">kMinModeFactorOcropus</a> = 32;
<a name="l01629"></a><a class="code" href="oldbasel_8cpp.html#a8cc0a8bda114c498330f8b2a23e67453">01629</a> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="oldbasel_8cpp.html#a8cc0a8bda114c498330f8b2a23e67453">kMinModeFactor</a> = 12;
<a name="l01630"></a>01630 
<a name="l01631"></a>01631 <span class="keywordtype">void</span>
<a name="l01632"></a><a class="code" href="oldbasel_8h.html#a2f17754e45de03ca3f0e2be965f8d4f4">01632</a> <a class="code" href="oldbasel_8cpp.html#a2f17754e45de03ca3f0e2be965f8d4f4">find_top_modes</a> (                 <span class="comment">//get modes</span>
<a name="l01633"></a>01633 <a class="code" href="class_s_t_a_t_s.html">STATS</a> * stats,                   <span class="comment">//stats to hack</span>
<a name="l01634"></a>01634 <span class="keywordtype">int</span> statnum,                     <span class="comment">//no of piles</span>
<a name="l01635"></a>01635 <span class="keywordtype">int</span> modelist[], <span class="keywordtype">int</span> modenum      <span class="comment">//no of modes to get</span>
<a name="l01636"></a>01636 ) {
<a name="l01637"></a>01637   <span class="keywordtype">int</span> mode_count;
<a name="l01638"></a>01638   <span class="keywordtype">int</span> last_i = 0;
<a name="l01639"></a>01639   <span class="keywordtype">int</span> last_max = <a class="code" href="host_8h.html#aac62d87844689a18b6f5339a89ed6e7f">MAX_INT32</a>;
<a name="l01640"></a>01640   <span class="keywordtype">int</span> i;
<a name="l01641"></a>01641   <span class="keywordtype">int</span> <a class="code" href="pgedit_8cpp.html#afc03cf3e39248c2e339fee4d31f5f750">mode</a>;
<a name="l01642"></a>01642   <span class="keywordtype">int</span> total_max = 0;
<a name="l01643"></a>01643   <span class="keywordtype">int</span> mode_factor = <a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">textord_ocropus_mode</a> ?
<a name="l01644"></a>01644                     <a class="code" href="oldbasel_8cpp.html#a4b62dc4268d026719e353774ec602bec">kMinModeFactorOcropus</a> : <a class="code" href="oldbasel_8cpp.html#a8cc0a8bda114c498330f8b2a23e67453">kMinModeFactor</a>;
<a name="l01645"></a>01645 
<a name="l01646"></a>01646   <span class="keywordflow">for</span> (mode_count = 0; mode_count &lt; modenum; mode_count++) {
<a name="l01647"></a>01647     mode = 0;
<a name="l01648"></a>01648     <span class="keywordflow">for</span> (i = 0; i &lt; statnum; i++) {
<a name="l01649"></a>01649       <span class="keywordflow">if</span> (stats-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (i) &gt; stats-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (mode)) {
<a name="l01650"></a>01650         <span class="keywordflow">if</span> ((stats-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (i) &lt; last_max) ||
<a name="l01651"></a>01651         ((stats-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (i) == last_max) &amp;&amp; (i &gt; last_i))) {
<a name="l01652"></a>01652           mode = i;
<a name="l01653"></a>01653         }
<a name="l01654"></a>01654       }
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656     last_i = <a class="code" href="pgedit_8cpp.html#afc03cf3e39248c2e339fee4d31f5f750">mode</a>;
<a name="l01657"></a>01657     last_max = stats-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (last_i);
<a name="l01658"></a>01658     total_max += last_max;
<a name="l01659"></a>01659     <span class="keywordflow">if</span> (last_max &lt;= total_max / mode_factor)
<a name="l01660"></a>01660       mode = 0;
<a name="l01661"></a>01661     modelist[mode_count] = <a class="code" href="pgedit_8cpp.html#afc03cf3e39248c2e339fee4d31f5f750">mode</a>;
<a name="l01662"></a>01662   }
<a name="l01663"></a>01663 }
<a name="l01664"></a>01664 
<a name="l01665"></a>01665 
<a name="l01666"></a>01666 <span class="comment">/**********************************************************************</span>
<a name="l01667"></a>01667 <span class="comment"> * pick_x_height</span>
<a name="l01668"></a>01668 <span class="comment"> *</span>
<a name="l01669"></a>01669 <span class="comment"> * Choose based on the height modes the best x height value.</span>
<a name="l01670"></a>01670 <span class="comment"> **********************************************************************/</span>
<a name="l01671"></a>01671 
<a name="l01672"></a><a class="code" href="oldbasel_8h.html#a7cfd63f215d5f9d728d795ea43eaf7af">01672</a> <span class="keywordtype">void</span> <a class="code" href="oldbasel_8cpp.html#a7cfd63f215d5f9d728d795ea43eaf7af">pick_x_height</a>(<a class="code" href="class_t_o___r_o_w.html">TO_ROW</a> * row,                    <span class="comment">//row to do</span>
<a name="l01673"></a>01673                    <span class="keywordtype">int</span> modelist[],
<a name="l01674"></a>01674                    <span class="keywordtype">int</span> lefts[], <span class="keywordtype">int</span> rights[],
<a name="l01675"></a>01675                    <a class="code" href="class_s_t_a_t_s.html">STATS</a> * heightstat,
<a name="l01676"></a>01676                    <span class="keywordtype">int</span> mode_threshold) {
<a name="l01677"></a>01677   <span class="keywordtype">int</span> x;
<a name="l01678"></a>01678   <span class="keywordtype">int</span> y;
<a name="l01679"></a>01679   <span class="keywordtype">int</span> z;
<a name="l01680"></a>01680   <span class="keywordtype">float</span> ratio;
<a name="l01681"></a>01681   <span class="keywordtype">int</span> found_one_bigger = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01682"></a>01682   <span class="keywordtype">int</span> best_x_height = 0;
<a name="l01683"></a>01683   <span class="keywordtype">int</span> best_asc = 0;
<a name="l01684"></a>01684   <span class="keywordtype">int</span> num_in_best;
<a name="l01685"></a>01685 
<a name="l01686"></a>01686   <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>; x++) {
<a name="l01687"></a>01687     <span class="keywordflow">for</span> (y = 0; y &lt; <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>; y++) {
<a name="l01688"></a>01688       <span class="comment">/* Check for two modes */</span>
<a name="l01689"></a>01689       <span class="keywordflow">if</span> (modelist[x] &amp;&amp; modelist[y] &amp;&amp;
<a name="l01690"></a>01690           heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (modelist[x]) &gt; mode_threshold &amp;&amp;
<a name="l01691"></a>01691           (!<a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">textord_ocropus_mode</a> ||
<a name="l01692"></a>01692            <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(rights[modelist[x]], rights[modelist[y]]) &gt;
<a name="l01693"></a>01693            <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(lefts[modelist[x]], lefts[modelist[y]]))) {
<a name="l01694"></a>01694         ratio = (float) modelist[y] / (<span class="keywordtype">float</span>) modelist[x];
<a name="l01695"></a>01695         <span class="keywordflow">if</span> (1.2 &lt; ratio &amp;&amp; ratio &lt; 1.8) {
<a name="l01696"></a>01696           <span class="comment">/* Two modes found */</span>
<a name="l01697"></a>01697           best_x_height = modelist[x];
<a name="l01698"></a>01698           num_in_best = heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (modelist[x]);
<a name="l01699"></a>01699 
<a name="l01700"></a>01700           <span class="comment">/* Try to get one higher */</span>
<a name="l01701"></a>01701           <span class="keywordflow">do</span> {
<a name="l01702"></a>01702             found_one_bigger = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01703"></a>01703             <span class="keywordflow">for</span> (z = 0; z &lt; <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>; z++) {
<a name="l01704"></a>01704               <span class="keywordflow">if</span> (modelist[z] == best_x_height + 1 &amp;&amp;
<a name="l01705"></a>01705                   (!<a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">textord_ocropus_mode</a> ||
<a name="l01706"></a>01706                     <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(rights[modelist[x]], rights[modelist[y]]) &gt;
<a name="l01707"></a>01707                     <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(lefts[modelist[x]], lefts[modelist[y]]))) {
<a name="l01708"></a>01708                 ratio = (float) modelist[y] / (<span class="keywordtype">float</span>) modelist[z];
<a name="l01709"></a>01709                 <span class="keywordflow">if</span> ((1.2 &lt; ratio &amp;&amp; ratio &lt; 1.8) &amp;&amp;
<a name="l01710"></a>01710                                <span class="comment">/* Should be half of best */</span>
<a name="l01711"></a>01711                     heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (modelist[z]) &gt;
<a name="l01712"></a>01712                     num_in_best * 0.5) {
<a name="l01713"></a>01713                   best_x_height++;
<a name="l01714"></a>01714                   found_one_bigger = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01715"></a>01715                   <span class="keywordflow">break</span>;
<a name="l01716"></a>01716                 }
<a name="l01717"></a>01717               }
<a name="l01718"></a>01718             }
<a name="l01719"></a>01719           }
<a name="l01720"></a>01720           <span class="keywordflow">while</span> (found_one_bigger);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722           <span class="comment">/* try to get a higher ascender */</span>
<a name="l01723"></a>01723 
<a name="l01724"></a>01724           best_asc = modelist[y];
<a name="l01725"></a>01725           num_in_best = heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (modelist[y]);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727           <span class="comment">/* Try to get one higher */</span>
<a name="l01728"></a>01728           <span class="keywordflow">do</span> {
<a name="l01729"></a>01729             found_one_bigger = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01730"></a>01730             <span class="keywordflow">for</span> (z = 0; z &lt; <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>; z++) {
<a name="l01731"></a>01731               <span class="keywordflow">if</span> (modelist[z] &gt; best_asc &amp;&amp;
<a name="l01732"></a>01732                   (!<a class="code" href="oldbasel_8cpp.html#ac37e1bbb003c40e45f6375d6451a1659">textord_ocropus_mode</a> ||
<a name="l01733"></a>01733                     <a class="code" href="ndminx_8h.html#a74e75242132eaabbc1c512488a135926">MIN</a>(rights[modelist[x]], rights[modelist[y]]) &gt;
<a name="l01734"></a>01734                     <a class="code" href="ndminx_8h.html#aacc3ee1a7f283f8ef65cea31f4436a95">MAX</a>(lefts[modelist[x]], lefts[modelist[y]]))) {
<a name="l01735"></a>01735                 ratio = (float) modelist[z] / (<span class="keywordtype">float</span>) best_x_height;
<a name="l01736"></a>01736                 <span class="keywordflow">if</span> ((1.2 &lt; ratio &amp;&amp; ratio &lt; 1.8) &amp;&amp;
<a name="l01737"></a>01737                                <span class="comment">/* Should be half of best */</span>
<a name="l01738"></a>01738                     heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (modelist[z]) &gt;
<a name="l01739"></a>01739                     num_in_best * 0.5) {
<a name="l01740"></a>01740                   best_asc = modelist[z];
<a name="l01741"></a>01741                   found_one_bigger = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01742"></a>01742                   <span class="keywordflow">break</span>;
<a name="l01743"></a>01743                 }
<a name="l01744"></a>01744               }
<a name="l01745"></a>01745             }
<a name="l01746"></a>01746           }
<a name="l01747"></a>01747           <span class="keywordflow">while</span> (found_one_bigger);
<a name="l01748"></a>01748 
<a name="l01749"></a>01749           row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = (float) best_x_height;
<a name="l01750"></a>01750           row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = (float) best_asc - best_x_height;
<a name="l01751"></a>01751           <span class="keywordflow">return</span>;
<a name="l01752"></a>01752         }
<a name="l01753"></a>01753       }
<a name="l01754"></a>01754     }
<a name="l01755"></a>01755   }
<a name="l01756"></a>01756 
<a name="l01757"></a>01757   best_x_height = modelist[0];   <span class="comment">/* Single Mode found */</span>
<a name="l01758"></a>01758   num_in_best = heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (best_x_height);
<a name="l01759"></a>01759   <span class="keywordflow">do</span> {
<a name="l01760"></a>01760                                  <span class="comment">/* Try to get one higher */</span>
<a name="l01761"></a>01761     found_one_bigger = <a class="code" href="host_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01762"></a>01762     <span class="keywordflow">for</span> (z = 1; z &lt; <a class="code" href="oldbasel_8cpp.html#a6d5223c09db5f2c89d2d0cb1990cae25">MODENUM</a>; z++) {
<a name="l01763"></a>01763       <span class="comment">/* Should be half of best */</span>
<a name="l01764"></a>01764       <span class="keywordflow">if</span> ((modelist[z] == best_x_height + 1) &amp;&amp;
<a name="l01765"></a>01765       (heightstat-&gt;<a class="code" href="class_s_t_a_t_s.html#a4a3a320660e2092eeaa605df70bea8ea">pile_count</a> (modelist[z]) &gt; num_in_best * 0.5)) {
<a name="l01766"></a>01766         best_x_height++;
<a name="l01767"></a>01767         found_one_bigger = <a class="code" href="host_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01768"></a>01768         <span class="keywordflow">break</span>;
<a name="l01769"></a>01769       }
<a name="l01770"></a>01770     }
<a name="l01771"></a>01771   }
<a name="l01772"></a>01772   <span class="keywordflow">while</span> (found_one_bigger);
<a name="l01773"></a>01773 
<a name="l01774"></a>01774   row-&gt;<a class="code" href="class_t_o___r_o_w.html#acf8bf7f0f335788e106955b8142f832a">ascrise</a> = 0.0f;
<a name="l01775"></a>01775   row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = (float) best_x_height;
<a name="l01776"></a>01776   <span class="keywordflow">if</span> (row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> == 0)
<a name="l01777"></a>01777     row-&gt;<a class="code" href="class_t_o___r_o_w.html#a819d94a95b9aab802acbcba097c67b2b">xheight</a> = -1.0f;
<a name="l01778"></a>01778 }
</pre></div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="oldbasel_8cpp.html">oldbasel.cpp</a>      </li>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>


    <li class="footer">Generated on Thu Mar 29 2012 23:42:13 for Tesseract by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.5.1 </li>
   </ul>
 </div>


</body>
</html>
